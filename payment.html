<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Hamsa Sarees — Payment</title>

  <!-- ✅ FINAL, STABLE CSP FOR RAZORPAY + GOOGLE FORMS -->
  <!-- This version is PROVEN to work with Razorpay checkout -->
  <meta http-equiv="Content-Security-Policy" content="
    default-src 'self' https: data: blob:;
    script-src 'self' 'unsafe-inline' https://checkout.razorpay.com;
    style-src 'self' 'unsafe-inline' https://fonts.googleapis.com;
    font-src https://fonts.gstatic.com data:;
    frame-src https://checkout.razorpay.com https://api.razorpay.com;
    connect-src https://api.razorpay.com https://checkout.razorpay.com https://docs.google.com;
    img-src 'self' data: https:;
  " />

  <link rel="stylesheet" href="style.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Lato:wght@400;700&display=swap" rel="stylesheet">
</head>
<body>

  <div class="card">
    <h1>Secure Payment</h1>
    <div class="small">Powered by Razorpay</div>

    <div class="row">
      <label>Product</label>
      <input id="product" readonly />
    </div>

    <div class="row">
      <label>Amount</label>
      <div class="price" id="priceText">₹0</div>
    </div>

    <div class="row">
      <label>Your Name</label>
      <input id="name" />
    </div>

    <div class="row">
      <label>Email</label>
      <input id="email" type="email" placeholder="optional" />
    </div>

    <div class="row">
      <label>Phone</label>
      <input id="phone" />
    </div>

    <button id="payBtn">Pay Now</button>
  </div>

  <!-- Razorpay checkout MUST be before inline script -->
  <script src="https://checkout.razorpay.com/v1/checkout.js"></script>

  <script>
    // ---------- READ URL PARAMS ----------
    const params = new URLSearchParams(window.location.search);
    const product = params.get('product') || '';
    const price = Number(params.get('price'));

    const productEl = document.getElementById('product');
    const priceText = document.getElementById('priceText');
    const nameEl = document.getElementById('name');
    const phoneEl = document.getElementById('phone');
    const emailEl = document.getElementById('email');
    const payBtn = document.getElementById('payBtn');

    if (!price || isNaN(price) || price <= 0) {
      alert('Invalid payment link. Please place order again.');
      payBtn.disabled = true;
    } else {
      priceText.innerText = '₹' + price;
    }

    productEl.value = product;
    nameEl.value = params.get('name') || '';
    phoneEl.value = params.get('phone') || '';

    // ---------- RAZORPAY ----------
    payBtn.addEventListener('click', function(){
      if (typeof Razorpay === 'undefined') {
        alert('Razorpay SDK not loaded. Open via HTTPS / Live Server.');
        return;
      }

      payBtn.disabled = true;
      const amountPaise = Math.round(price * 100);

      const options = {
        key: 'rzp_live_Rqulhc8rZRz8Iw',
        amount: amountPaise,
        currency: 'INR',
        name: 'Hamsa Sarees',
        description: product || 'Order Payment',
        handler: function (response) {
          alert('Payment successful! Payment ID: ' + response.razorpay_payment_id);

          // ---- SEND TO GOOGLE FORM AFTER PAYMENT ----
          const formUrl = 'https://docs.google.com/forms/d/e/1FAIpQLSfREKvTld9R59UADJQK6jxQIbM64tt1iP0M-XiPq4ykOOwe5w/formResponse';
          const fd = new FormData();
          fd.append('entry.1128392407', nameEl.value || '');
          fd.append('entry.654904844', params.get('address') || '');
          fd.append('entry.1644126654', phoneEl.value || '');
          fd.append('entry.1866699911', product || '');
          fetch(formUrl, { method: 'POST', body: fd, mode: 'no-cors' });
        },
        prefill: {
          name: nameEl.value,
          email: emailEl.value,
          contact: phoneEl.value
        },
        theme: { color: '#00aaff' }
      };

      const rzp = new Razorpay(options);
      rzp.on('payment.failed', function (resp) {
        alert('Payment failed: ' + resp.error.description);
        payBtn.disabled = false;
      });
      rzp.open();
    });
  </script>
</body>
</html>
