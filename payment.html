<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Hamsa Sarees â€” Confirm & Pay</title>

<meta http-equiv="Content-Security-Policy" content="
  default-src 'self' https: data: blob:;
  script-src 'self' 'unsafe-inline' https://checkout.razorpay.com https://www.gstatic.com;
  style-src 'self' 'unsafe-inline' https://fonts.googleapis.com;
  font-src https://fonts.gstatic.com data:;
  frame-src https://checkout.razorpay.com https://api.razorpay.com;
  connect-src https://api.razorpay.com https://checkout.razorpay.com
               https://docs.google.com https://firestore.googleapis.com
               https://identitytoolkit.googleapis.com https://www.gstatic.com;
  img-src 'self' data: https: http:;
" />

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">
<link rel="icon" href="hamsasareeslogo.jpg" type="image/jpeg">

<style>
/* ================= ROOT THEME ================= */
:root{
  --bg-main:#0a0e1a;
  --bg-panel:#11172c;
  --bg-soft:#161e3d;
  --border:rgba(255,255,255,0.08);
  --gold:#e6b566;
  --gold-dark:#cfa34e;
  --text-main:#eef2ff;
  --text-muted:#9fb0d1;
  --success:#3ddc97;
  --danger:#ff6b6b;
}

/* ================= RESET ================= */
*{box-sizing:border-box}

body{
  margin:0;
  font-family:Inter,system-ui,Arial,sans-serif;
  background:
    radial-gradient(900px 400px at 20% -10%, rgba(230,181,102,.12), transparent 60%),
    linear-gradient(180deg,#080c18,#0a0e1a);
  color:var(--text-main);
}
/* ================= SCROLLBAR ================= */
::-webkit-scrollbar { width: 8px; height: 8px; }
::-webkit-scrollbar-track { background: var(--bg-main); }
::-webkit-scrollbar-thumb { background: var(--border); border-radius: 4px; }
::-webkit-scrollbar-thumb:hover { background: var(--text-muted); }
/* ================= SELECTION ================= */
::selection { background: var(--gold); color: #0a0e1a; }
::-moz-selection { background: var(--gold); color: #0a0e1a; }
::placeholder { color: var(--text-muted); opacity: 0.6; }
.bg-noise { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 0; opacity: 0.04; background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)'/%3E%3C/svg%3E"); }
.container{
  position: relative; z-index: 1;
  max-width:1200px;
  margin:auto;
  padding:20px 16px;
}
header{
  display:flex;
  align-items:center;
  gap:18px;
  padding:16px 18px;
  border-radius:16px;
  background: rgba(255, 255, 255, 0.03);
  backdrop-filter: blur(12px);
  border:1px solid rgba(255,255,255,0.05);
  box-shadow:0 20px 50px rgba(0,0,0,0.3);
}
.brand{ display:flex; gap:14px; align-items:center; }
.logo{ width:52px; height:52px; border-radius:14px; overflow:hidden; border: 1px solid rgba(255,255,255,0.1); box-shadow: 0 4px 10px rgba(0,0,0,0.2); flex-shrink: 0; }
.logo img { width: 100%; height: 100%; object-fit: cover; }
.title{ font-weight:800; font-size:18px; letter-spacing: -0.01em; line-height: 1.2; }
.small{ font-size:13px; color:var(--text-muted); }

/* Form Styles */
.payment-card{
  background: rgba(255, 255, 255, 0.02);
  backdrop-filter: blur(10px);
  border:1px solid rgba(255,255,255,0.08);
  border-radius:20px;
  padding:24px;
  max-width:480px;
  margin: 40px auto;
  box-shadow:0 25px 50px -12px rgba(0,0,0,0.5);
}
h1{margin:0 0 6px;font-size:24px;font-weight:800}
.row{margin-bottom:14px}
label{display:block;font-size:13px;color:var(--text-muted);margin-bottom:6px;font-weight:600;}
input,textarea{
  width:100%;
  background:#0f1738;
  border:1px solid var(--border);
  border-radius:12px;
  padding:10px;
  color:var(--text-main);
  font-size:14px;
  transition: all 0.2s ease;
}
input:focus, textarea:focus {
  border-color: var(--gold);
  outline: none;
  box-shadow: 0 0 0 2px var(--bg-main), 0 0 0 4px rgba(230,181,102,0.4);
  transition: box-shadow 0.2s ease, border-color 0.2s ease;
}
input.invalid, textarea.invalid {
  border-color: var(--danger);
}
.error-message {
  font-size: 12px;
  color: var(--danger);
  min-height: 16px; /* Prevents layout shift */
  margin-top: 4px;
}
textarea{min-height:90px;resize:vertical}
.price{
  font-size:22px;
  font-weight:800;
  color:var(--gold);
  margin:8px 0 14px
}
button{
  width:100%;
  font-family:inherit;
  background:linear-gradient(90deg,var(--gold),#f3d48c);
  color:#3b2b08;
  border:none;
  padding:12px 18px;
  border-radius:14px;
  font-weight:800;
  cursor:pointer;
  box-shadow:0 10px 30px rgba(230,181,102,.35);
  transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
  position: relative;
  overflow: hidden;
}
button::after {
  content: '';
  position: absolute;
  top: 0; left: -100%; width: 100%; height: 100%;
  background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
  transition: 0.5s;
}
button:hover::after {
  left: 100%;
}
button:active {
  transform: scale(0.96);
}
button:disabled{
  opacity: 0.6;
  cursor: not-allowed;
  filter: grayscale(0.8);
  box-shadow: none;
  transform: none !important;
}
img{
  max-width:100%;
  max-height:260px;
  object-fit:cover;
  border-radius:14px;
  margin-bottom:12px;
  display:none
}
.btn-ghost{
  background:#0f1738;
  border:1px solid var(--border);
  color:var(--text-main);
  padding:9px 16px;
  border-radius:14px;
  cursor:pointer;
  text-decoration: none;
  transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
}
.btn-ghost:active {
  transform: scale(0.96);
}
/* ================= SPINNER ================= */
.spinner {
  width: 20px;
  height: 20px;
  border: 2px solid rgba(59, 43, 8, 0.3);
  border-radius: 50%;
  border-top-color: #3b2b08;
  animation: spin 1s linear infinite;
  display: inline-block;
  vertical-align: middle;
  margin-right: 8px;
}
@keyframes spin { to { transform: rotate(360deg); } }
</style>
</head>

<body>
<div class="bg-noise"></div>
<div class="container">
  <header>
    <div class="brand">
      <div class="logo" aria-hidden="true"><img src="hamsasareeslogo.jpg" alt="Hamsa Sarees Logo"></div>
      <div>
        <div class="title">Hamsa Sarees</div>
        <div class="small">Secure Checkout</div>
      </div>
    </div>
    <div style="flex:1"></div>
    <a href="index.html" class="btn-ghost">Back to Shop</a>
  </header>

  <main>
    <div class="payment-card">
      <h1>Confirm & Pay</h1>
      <div class="small" style="margin-bottom: 20px;">Please verify all details carefully</div>

      <div class="row">
        <label>Product</label>
        <input id="product" readonly />
      </div>

      <div class="row">
        <img id="productImg" alt="Product image">
      </div>

      <div class="row">
        <label>Amount</label>
        <div class="price" id="priceText">â‚¹0</div>
      </div>

      <div class="row">
        <label>Your Name</label>
        <input id="name" required placeholder="Enter your full name" />
        <div class="error-message"></div>
      </div>

      <div class="row">
        <label>Phone</label>
        <input id="phone" required placeholder="Enter your 10-digit mobile number" />
        <div class="error-message"></div>
      </div>

      <div class="row">
        <label>Delivery Address</label>
        <textarea id="address" required placeholder="Enter your full delivery address"></textarea>
        <div class="error-message"></div>
      </div>

      <button id="payBtn" disabled>Pay Securely</button>
      <div id="paymentError" class="error-message" style="text-align:center; margin-top:12px;"></div>
    </div>
  </main>

  <footer style="text-align:center;padding:18px;color:#9fb8d9;font-size:13px;line-height:1.6;">
    Â©2025 Hamsa Sarees, unauthorized use is strictly prohibited.<br>
    Website designed, created & published by Terminal Joint.
  </footer>
</div>

<script src="https://checkout.razorpay.com/v1/checkout.js"></script>

<script>
/* ---------- LOAD ORDER FROM INDEX ---------- */
const raw = sessionStorage.getItem('pendingOrder');
if (!raw) {
  alert('Invalid access');
  location.href = 'index.html';
}

let order;
try { order = JSON.parse(raw); }
catch { location.href = 'index.html'; }

const productEl = document.getElementById('product');
const priceText = document.getElementById('priceText');
const nameEl = document.getElementById('name');
const phoneEl = document.getElementById('phone');
const addressEl = document.getElementById('address');
const imgEl = document.getElementById('productImg');
const payBtn = document.getElementById('payBtn');
const priceRegex = /^[1-9]\d*(\.\d+)?$/;
const price = Number(String(order.price).replace(/[^\d.]/g, ''));
if (!price || price <= 0) {
  alert('Invalid price');
  location.href = 'index.html';
}

productEl.value = order.product || '';
priceText.textContent = `â‚¹${price}`;
nameEl.value = order.name || '';
phoneEl.value = order.phone || '';
addressEl.value = order.address || '';

if (order.image) {
  imgEl.src = order.image;
  imgEl.onload = () => imgEl.style.display = 'block';
}

// --- âœ… PERFECTION: Real-time validation ---
const validators = {
  name: (el) => {
    const valid = el.value.trim().length >= 2;
    const message = valid ? '' : 'Name must be at least 2 characters.';
    return { valid, message };
  },
  phone: (el) => {
    const valid = /^[6-9]\d{9}$/.test(el.value.trim());
    const message = valid ? '' : 'Please enter a valid 10-digit Indian mobile number.';
    return { valid, message };
  },
  address: (el) => {
    const valid = el.value.trim().length >= 10;
    const message = valid ? '' : 'Please enter a full, valid address (min. 10 characters).';
    return { valid, message };
  }
};

function validateField(el) {
  const validator = validators[el.id];
  if (!validator) return true;

  const { valid, message } = validator(el);
  const errorEl = el.nextElementSibling;

  el.classList.toggle('invalid', !valid);
  if (errorEl && errorEl.classList.contains('error-message')) {
    errorEl.textContent = message;
  }
  return valid;
}

function validateForm() {
  const isNameValid = validateField(nameEl);
  const isPhoneValid = validateField(phoneEl);
  const isAddressValid = validateField(addressEl);
  payBtn.disabled = !(isNameValid && isPhoneValid && isAddressValid);
}

[nameEl, phoneEl, addressEl].forEach(el => {
  el.addEventListener('blur', () => validateField(el)); // Also validate on blur
  el.addEventListener('input', () => {
    if(el.classList.contains('invalid')) validateField(el); // Only show error while typing if already invalid
    validateForm(); // Always check button state
  });
});
</script>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import { getFirestore, doc, getDoc, setDoc, updateDoc, increment, serverTimestamp, collection } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

/* ---------- FIREBASE ---------- */
const app = initializeApp({
  apiKey: "AIzaSyBozW19Rjc9nj0YabOIE3DlW0qVHtU5XLA",
  authDomain: "hamsasarees-24738.firebaseapp.com",
  projectId: "hamsasarees-24738"
});

const auth = getAuth(app);
const db = getFirestore(app);

/* ---------- AUTH + PAY ---------- */
onAuthStateChanged(auth, user => {
  if (!user) {
    // Using alert here is acceptable as it's a hard stop for a non-user.
    alert('Please sign in first');
    location.href = 'index.html';
    return;
  }

  // payBtn is disabled by default. It will be enabled by validation.

  // 7ï¸âƒ£ AUTO-FILL FROM FIRESTORE PROFILE
  const userRef = doc(db, 'users', user.uid);
  getDoc(userRef).then(snap => {
    if(snap.exists()){
      const data = snap.data();
      // ðŸ”’ STRICT CHECK: If profile incomplete, redirect to home
      if(!data.name || !data.phone || !data.address || !/^[6-9]\d{9}$/.test(data.phone)){
        alert('Please complete your profile first.');
        location.href = 'index.html';
        return;
      }
      if(data.name) nameEl.value = data.name;
      if(data.phone) phoneEl.value = data.phone;
      if(data.address) addressEl.value = data.address;
      
      // âœ… PERFECTION: Trigger validation after auto-filling
      validateForm();
    }
  }).catch(err => console.error('Auto-fill error:', err));

  payBtn.onclick = async () => {
    // Validation is now handled in real-time, so we can proceed.
    const name = nameEl.value.trim();
    const phone = phoneEl.value.replace(/\s+/g,'');
    const address = addressEl.value.trim();

    // ðŸ”’ RE-VALIDATE: Ensure inputs are valid even if button was forced enabled
    if (!validateField(nameEl) || !validateField(phoneEl) || !validateField(addressEl)) {
      validateForm(); // Update UI
      return;
    }

    payBtn.disabled = true;
    payBtn.innerHTML = '<div class="spinner"></div> Processing...';
    document.getElementById('paymentError').textContent = ''; // Clear previous errors
    
    // ðŸ”’ STOCK CHECK (PRODUCTION GRADE)
    // Before opening payment, verify stock exists in Firestore
    if(order.pid) {
      try {
        const pRef = doc(db, 'products', order.pid);
        const pSnap = await getDoc(pRef);
        if(pSnap.exists()) {
          const currentStock = pSnap.data().stock;
          if(currentStock === undefined || currentStock <= 0) {
            // This alert is a critical, exceptional state. It's acceptable.
            alert('Sorry, this item just went out of stock while you were checking out.');
            location.href = 'index.html';
            return;
          }
          
          // ðŸ”’ PRICE INTEGRITY CHECK
          // Ensure the price in sessionStorage matches the live price in Firestore
          const livePrice = Number(String(pSnap.data().price || '0').replace(/[^\d.]/g, ''));
          if (livePrice !== price) {
            alert('Product price has changed. Please re-order.');
            location.href = 'index.html';
            return;
          }
        }
      } catch(e) { console.error('Stock check failed', e); }
    }

    const rzp = new Razorpay({
      key: 'rzp_live_Rqulhc8rZRz8Iw',
      amount: Math.round(price * 100),
      currency: 'INR',
      name: 'Hamsa Sarees',
      description: order.product,

      handler: async res => {
        /* -------- FIRESTORE -------- */
        const newOrderRef = doc(collection(db, 'users', user.uid, 'orders'));
        await setDoc(
          newOrderRef,
          {
            product: order.product,
            price,
            name,
            phone,
            address,
            image: order.image || '',
            email: user.email,
            paymentId: res.razorpay_payment_id,
            status: 'PAID',
            createdAt: serverTimestamp()
          }
        );
        
        // ðŸ”’ DECREMENT STOCK
        if(order.pid) {
          try {
            await updateDoc(doc(db, 'products', order.pid), {
              stock: increment(-1)
            });
          } catch(e) { console.error('Failed to decrement stock', e); }
        }

        /* -------- GOOGLE FORM (MAIN ENTRY) -------- */
        const fd = new FormData();
        fd.append('entry.2120009411', name);
        fd.append('entry.6103303', phone);
        fd.append('entry.952475985', order.product);
        fd.append('entry.2008322116', address);
        fd.append('entry.135044268', price);

        fetch('https://docs.google.com/forms/d/e/1FAIpQLSfREKvTld9R59UADJQK6jxQIbM64tt1iP0M-XiPq4ykOOwe5w/formResponse', {
          method: 'POST',
          body: fd,
          mode: 'no-cors'
        });

        sessionStorage.removeItem('pendingOrder');
        // âœ… PERFECTION: No alert, just redirect to a page that confirms success.
        location.href = 'yourorders.html?status=success';
      }
    });

    rzp.on('payment.failed', (response) => {
      // âœ… PERFECTION: Show error inline instead of alert.
      const errorMsg = response.error?.description || 'Payment failed. Please try again.';
      document.getElementById('paymentError').textContent = errorMsg;
      payBtn.disabled = false;
      payBtn.textContent = 'Pay Securely';
    });

    rzp.open();
  };
});
</script>

</body>
</html>
