<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Hamsa Sarees — Premium Collection</title>

<!-- Security Headers -->
<meta http-equiv="Content-Security-Policy" content="
  default-src 'self';
  script-src 'self' 'unsafe-inline' https://www.gstatic.com https://cdnjs.cloudflare.com;
  style-src 'self' 'unsafe-inline' https://fonts.googleapis.com;
  font-src https://fonts.gstatic.com data:;
  img-src 'self' data: https: http:;
  connect-src https://firestore.googleapis.com https://identitytoolkit.googleapis.com https://www.googleapis.com;
">
<meta http-equiv="X-Content-Type-Options" content="nosniff">
<meta http-equiv="X-Frame-Options" content="DENY">
<meta http-equiv="Referrer-Policy" content="strict-origin-when-cross-origin">

<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  

<style>
/* ================= THEME ================= */
:root{
  --bg-primary: #0a0e1a;
  --bg-secondary: #111827;
  --bg-tertiary: #1f2937;
  
  --gold: #d4af37;
  --gold-light: #f4d58d;
  --gold-dark: #b8941f;
  
  --text-primary: #f9fafb;
  --text-secondary: #d1d5db;
  --text-muted: #9ca3af;
  
  --success: #10b981;
  --danger: #ef4444;
  --warning: #f59e0b;
  
  --shadow-sm: 0 1px 2px rgba(0,0,0,0.05);
  --shadow-md: 0 4px 6px rgba(0,0,0,0.1);
  --shadow-lg: 0 10px 25px rgba(0,0,0,0.2);
  --shadow-xl: 0 20px 50px rgba(0,0,0,0.3);
  
  --border-radius: 12px;
  --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

/* ================= RESET ================= */
*{
  box-sizing: border-box;
  margin: 0;
  padding: 0;
}

html,body{
  font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
  background: 
    radial-gradient(ellipse at top, rgba(212,175,55,0.08) 0%, transparent 50%),
    linear-gradient(180deg, #0a0e1a 0%, #050810 100%);
  color: var(--text-primary);
  line-height: 1.6;
  overflow-x: hidden;
}

/* ================= CONTAINER ================= */
.container{
  max-width: 1280px;
  margin: 0 auto;
  padding: 0 20px;
}

/* ================= HEADER ================= */
header{
  background: rgba(17, 24, 39, 0.8);
  backdrop-filter: blur(12px);
  border-bottom: 1px solid rgba(212, 175, 55, 0.1);
  padding: 16px 0;
  position: sticky;
  top: 0;
  z-index: 1000;
  box-shadow: var(--shadow-md);
}

.header-content{
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 24px;
  flex-wrap: wrap;
}

.brand{
  display: flex;
  align-items: center;
  gap: 12px;
}

.logo{
  width: 56px;
  height: 56px;
  border-radius: 12px;
  background: linear-gradient(135deg, var(--gold), var(--gold-light));
  display: flex;
  align-items: center;
  justify-content: center;
  font-family: 'Playfair Display', serif;
  font-weight: 700;
  font-size: 24px;
  color: var(--bg-primary);
  box-shadow: 0 4px 12px rgba(212, 175, 55, 0.3);
}

.logo img{
  width: 100%;
  height: 100%;
  object-fit: cover;
  border-radius: 12px;
}

.brand-info h1{
  font-family: 'Playfair Display', serif;
  font-size: 20px;
  font-weight: 700;
  color: var(--text-primary);
  margin: 0;
}

.brand-info p{
  font-size: 13px;
  color: var(--text-muted);
  margin: 0;
}

/* ================= SEARCH ================= */
.search-wrapper{
  flex: 1;
  max-width: 500px;
}

.search{
  display: flex;
  align-items: center;
  gap: 12px;
  background: var(--bg-tertiary);
  border: 2px solid rgba(212, 175, 55, 0.1);
  padding: 12px 16px;
  border-radius: var(--border-radius);
  transition: var(--transition);
}

.search:focus-within{
  border-color: var(--gold);
  box-shadow: 0 0 0 3px rgba(212, 175, 55, 0.1);
}

.search input{
  flex: 1;
  background: none;
  border: none;
  outline: none;
  color: var(--text-primary);
  font-size: 15px;
}

.search input::placeholder{
  color: var(--text-muted);
}

/* ================= BUTTONS ================= */
.btn{
  padding: 10px 20px;
  border-radius: var(--border-radius);
  font-weight: 600;
  font-size: 14px;
  cursor: pointer;
  border: none;
  transition: var(--transition);
  white-space: nowrap;
}

.btn-primary{
  background: linear-gradient(135deg, var(--gold), var(--gold-light));
  color: var(--bg-primary);
  box-shadow: 0 4px 12px rgba(212, 175, 55, 0.3);
}

.btn-primary:hover{
  transform: translateY(-2px);
  box-shadow: 0 6px 16px rgba(212, 175, 55, 0.4);
}

.btn-secondary{
  background: var(--bg-tertiary);
  color: var(--text-primary);
  border: 1px solid rgba(212, 175, 55, 0.2);
}

.btn-secondary:hover{
  background: var(--bg-secondary);
  border-color: var(--gold);
}

/* ================= HERO ================= */
.hero{
  margin: 40px 0;
  padding: 60px 40px;
  background: 
    linear-gradient(135deg, rgba(212,175,55,0.05) 0%, rgba(17,24,39,0.8) 100%),
    var(--bg-secondary);
  border-radius: 24px;
  border: 1px solid rgba(212, 175, 55, 0.1);
  text-align: center;
  box-shadow: var(--shadow-xl);
}

.hero h2{
  font-family: 'Playfair Display', serif;
  font-size: 36px;
  font-weight: 700;
  color: var(--gold);
  margin-bottom: 16px;
}

.hero p{
  font-size: 16px;
  color: var(--text-secondary);
  max-width: 800px;
  margin: 0 auto 32px;
  line-height: 1.8;
}

/* ================= FILTERS ================= */
.filters{
  background: var(--bg-secondary);
  border: 1px solid rgba(212, 175, 55, 0.1);
  border-radius: 20px;
  padding: 24px;
  margin: 32px 0;
  box-shadow: var(--shadow-lg);
}

.filters-header{
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20px;
}

.filters-header h3{
  font-size: 18px;
  font-weight: 600;
  color: var(--text-primary);
}

.filter-group{
  margin-bottom: 24px;
}

.filter-group:last-child{
  margin-bottom: 0;
}

.filter-label{
  font-size: 14px;
  font-weight: 600;
  color: var(--text-secondary);
  margin-bottom: 12px;
  display: block;
}

.filter-items{
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
}

.filter-item{
  padding: 8px 16px;
  background: var(--bg-tertiary);
  border: 2px solid rgba(212, 175, 55, 0.1);
  border-radius: 20px;
  font-size: 13px;
  cursor: pointer;
  transition: var(--transition);
  display: flex;
  align-items: center;
  gap: 8px;
}

.filter-item:hover{
  border-color: var(--gold);
  background: rgba(212, 175, 55, 0.05);
}

.filter-item.active{
  background: var(--gold);
  color: var(--bg-primary);
  border-color: var(--gold);
  font-weight: 600;
}

.color-swatch{
  width: 18px;
  height: 18px;
  border-radius: 50%;
  border: 2px solid rgba(255, 255, 255, 0.2);
}

/* ================= PRODUCT GRID ================= */
.products-section{
  margin: 48px 0;
}

.section-header{
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 24px;
}

.section-header h2{
  font-family: 'Playfair Display', serif;
  font-size: 28px;
  font-weight: 700;
  color: var(--text-primary);
}

.product-grid{
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
  gap: 24px;
}

/* ================= PRODUCT CARD ================= */
.product-card{
  background: var(--bg-secondary);
  border: 1px solid rgba(212, 175, 55, 0.1);
  border-radius: 20px;
  overflow: hidden;
  transition: var(--transition);
  cursor:pointer;
  box-shadow: var(--shadow-md);
}

.product-card:hover{
  transform: translateY(-8px);
  box-shadow: var(--shadow-xl);
  border-color: var(--gold);
}

.product-image{
  position: relative;
  width: 100%;
  aspect-ratio: 3/4;
  overflow: hidden;
  background: var(--bg-tertiary);
}

.product-image img{
  width: 100%;
  height: 100%;
  object-fit: cover;
  transition: transform 0.4s ease;
}

.product-card:hover .product-image img{
  transform: scale(1.08);
}

.product-tag{
  position: absolute;
  top: 12px;
  left: 12px;
  padding: 6px 14px;
  background: var(--gold);
  color: var(--bg-primary);
  border-radius: 20px;
  font-size: 12px;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  z-index: 10;
}

.product-info{
  padding: 20px;
}

.product-title{
  font-size: 16px;
  font-weight: 600;
  color: var(--text-primary);
  margin-bottom: 12px;
  line-height: 1.4;
}

.product-details{
  font-size: 13px;
  color: var(--text-muted);
  margin-bottom: 12px;
}

.product-pricing{
  display: flex;
  align-items: baseline;
  gap: 10px;
  margin-bottom: 12px;
}

.product-price{
  font-size: 22px;
  font-weight: 700;
  color: var(--gold);
}

.product-price-old{
  font-size: 15px;
  color: var(--text-muted);
  text-decoration: line-through;
}

.product-discount{
  padding: 4px 10px;
  background: var(--success);
  color: white;
  border-radius: 12px;
  font-size: 12px;
  font-weight: 700;
  margin-left: auto;
}

.product-rating{
  display: flex;
  align-items: center;
  gap: 6px;
  font-size: 13px;
  color: var(--gold);
  margin-bottom: 16px;
}

.product-actions{
  display: flex;
  gap: 10px;
}

.product-actions .btn{
  flex: 1;
  padding: 12px;
  font-size: 14px;
}

.stock-status{
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 4px 12px;
  border-radius: 12px;
  font-size: 12px;
  font-weight: 600;
  margin-top: 8px;
}

.stock-status.in-stock{
  background: rgba(16, 185, 129, 0.1);
  color: var(--success);
}

.stock-status.out-of-stock{
  background: rgba(239, 68, 68, 0.1);
  color: var(--danger);
}

/* ================= MODAL ================= */
.modal{
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.85);
  backdrop-filter: blur(8px);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 2000;
  padding: 20px;
}

.modal.show{display:flex}

.modal-content{
  background: var(--bg-secondary);
  border: 1px solid rgba(212, 175, 55, 0.2);
  border-radius: 24px;
  max-width: 600px;
  width:100%;
  max-height:90vh;
  overflow-y: auto;
  box-shadow: 0 25px 80px rgba(0, 0, 0, 0.5);
  animation: modalSlideIn 0.3s ease-out;
}

@keyframes modalSlideIn{
  from{
    opacity: 0;
    transform: translateY(-20px);
  }
  to{
    opacity: 1;
    transform: translateY(0);
  }
}

.modal-header{
  padding: 24px;
  border-bottom: 1px solid rgba(212, 175, 55, 0.1);
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.modal-header h2{
  font-family: 'Playfair Display', serif;
  font-size: 24px;
  color: var(--text-primary);
}

.modal-close{
  background: none;
  border: none;
  font-size: 24px;
  color: var(--text-muted);
  cursor: pointer;
  padding: 8px;
  transition: var(--transition);
}

.modal-close:hover{
  color: var(--gold);
  transform: rotate(90deg);
}

.modal-body{
  padding: 24px;
}

.form-group{
  margin-bottom: 20px;
}

.form-group label{
  display: block;
  font-size: 14px;
  font-weight: 600;
  color: var(--text-secondary);
  margin-bottom: 8px;
}

.form-group input,
.form-group textarea{
  width: 100%;
  padding: 12px 16px;
  background: var(--bg-tertiary);
  border: 2px solid rgba(212, 175, 55, 0.1);
  border-radius: var(--border-radius);
  color: var(--text-primary);
  font-size: 15px;
  transition: var(--transition);
}

.form-group input:focus,
.form-group textarea:focus{
  outline: none;
  border-color: var(--gold);
  box-shadow: 0 0 0 3px rgba(212, 175, 55, 0.1);
}

.form-group textarea{
  min-height: 100px;
  resize: vertical;
}

.modal-footer{
  padding: 24px;
  border-top: 1px solid rgba(212, 175, 55, 0.1);
  display: flex;
  gap: 12px;
  justify-content: flex-end;
}

/* ================= TOAST ================= */
.toast{
  position: fixed;
  bottom: 24px;
  right: 24px;
  padding: 16px 24px;
  background: var(--bg-secondary);
  border: 1px solid var(--gold);
  border-radius: var(--border-radius);
  color: var(--text-primary);
  font-weight: 600;
  box-shadow: var(--shadow-xl);
  z-index: 3000;
  animation: toastSlideIn 0.3s ease-out;
  display: none;
}

.toast.show{
  display: block;
}

@keyframes toastSlideIn{
  from{
    opacity: 0;
    transform: translateX(100%);
  }
  to{
    opacity: 1;
    transform: translateX(0);
  }
}

/* ================= FOOTER ================= */
footer{
  margin-top: 80px;
  padding: 40px 0;
  background: var(--bg-secondary);
  border-top: 1px solid rgba(212, 175, 55, 0.1);
  text-align: center;
  color: var(--text-muted);
  font-size: 14px;
}

footer p{
  margin: 8px 0;
}

footer a{
  color: var(--gold);
  text-decoration: none;
  transition: var(--transition);
}

footer a:hover{
  color: var(--gold-light);
}

/* ================= RESPONSIVE ================= */
@media (max-width: 768px){
  .header-content{
    flex-direction: column;
    align-items: stretch;
  }
  
  .search-wrapper{
    max-width: 100%;
  }
  
  .hero h2{
    font-size: 28px;
  }
  
  .product-grid{
    grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
    gap: 16px;
  }
}

/* ================= LOADING STATE ================= */
.loading{
  display: inline-block;
  width: 20px;
  height: 20px;
  border: 3px solid rgba(212, 175, 55, 0.2);
  border-radius: 50%;
  border-top-color: var(--gold);
  animation: spin 0.8s linear infinite;
}

@keyframes spin{
  to{
    transform: rotate(360deg);
  }
}

/* ================= ACCESSIBILITY ================= */
.sr-only{
  position: absolute;
  width: 1px;
  height: 1px;
  padding: 0;
  margin: -1px;
  overflow: hidden;
  clip: rect(0,0,0,0);
  white-space: nowrap;
  border: 0;
}

:focus-visible{
  outline: 2px solid var(--gold);
  outline-offset: 2px;
}

</style>

</head>
<body>
  <!-- Header -->
  <header>
    <div class="container">
      <div class="header-content">
        <div class="brand">
          <div class="logo">
            <img src="hamsasareeslogo.jpg" alt="Hamsa Sarees Logo" onerror="this.parentElement.innerHTML='HS'">
          </div>
          <div class="brand-info">
            <h1>Hamsa Sarees</h1>
            <p>Jalakandapuram - 636501</p>
          </div>
        </div>

        <div class="search-wrapper">
          <div class="search" role="search">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
              <circle cx="11" cy="11" r="8" stroke="currentColor" stroke-width="2"/>
              <path d="M21 21l-4.35-4.35" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            </svg>
            <input 
              id="searchBox" 
              type="search"
              placeholder="Search sarees, cotton, silk..." 
              aria-label="Search products"
            />
          </div>
        </div>

        <div style="display: flex; gap: 12px; align-items: center;">
          <button id="loginBtn" class="btn btn-primary">Sign In</button>
          <div id="userBadge" style="display: none;"></div>
          <button id="logoutBtn" class="btn btn-secondary" style="display: none;">Sign Out</button>
          <a href="yourorders.html" id="ordersLink" class="btn btn-secondary" style="display: none; text-decoration: none;">My Orders</a>
          <button id="adminBtn" class="btn btn-secondary" style="display: none;">Admin</button>
        </div>
      </div>
    </div>
  </header>

  <main class="container">
    <!-- Hero Section -->
    <section class="hero">
      <h2>Welcome to Hamsa Sarees</h2>
      <p>
        Manufactured and Sold by Hamsa Sarees<br>
        Address: 22/3, Tharamangalam Main Road, Jalakandapuram, Salem 636501
      </p>
      <a 
        href="https://www.google.com/search?q=Hamsa+Sarees+Jalakandapuram" 
        target="_blank" 
        rel="noopener noreferrer" 
        class="btn btn-primary"
      >
        Find Us on Google
      </a>
    </section>

    <!-- Filters Section -->
    <section class="filters">
      <div class="filters-header">
        <h3>Refine Your Search</h3>
        <button id="clearFilters" class="btn btn-secondary" style="padding: 8px 16px; font-size: 13px;">
          Clear Filters
        </button>
      </div>

      <div id="filtersContainer">
        <!-- Filters will be dynamically generated -->
        <!-- Static Color Filters will be injected here by JS -->
        <!-- Dynamic Filter Groups will be injected here -->
        <div id="materialFilterGroup"></div>
        <div id="styleFilterGroup"></div>
        <div id="designFilterGroup"></div>
        <div id="blouseFilterGroup"></div>
        <div id="availabilityFilterGroup"></div>


      </div>
    </section>

    <!-- Products Section -->
    <section class="products-section">
      <div class="section-header">
        <h2>Our Collection</h2>
        <p style="color: var(--text-muted); font-size: 14px;">Sign in to place orders</p>
      </div>

      <div id="productGrid" class="product-grid">
        <!-- Products will be dynamically loaded -->
        <div style="grid-column: 1/-1; text-align: center; padding: 60px 20px; color: var(--text-muted);">
          <div class="loading"></div>
          <p style="margin-top: 16px;">Loading products...</p>
        </div>
      </div>
    </section>
  </main>

  <!-- Footer -->
  <footer>
    <div class="container">
      <p>&copy; 2025 Hamsa Sarees. All rights reserved.</p>
      <p>Website designed & developed by Terminal Joint</p>
    </div>
  </footer>

  <!-- Login Modal -->
  <div id="loginModal" class="modal" aria-hidden="true">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Sign In</h2>
        <button class="modal-close" aria-label="Close">&times;</button>
      </div>
      <div class="modal-body">
        <p style="color: var(--text-secondary); margin-bottom: 24px;">
          Sign in with your Google account to place orders and track your purchases.
        </p>
        <button id="googleSignIn" class="btn btn-primary" style="width: 100%;">
          <span>Sign in with Google</span>
        </button>
        <p id="loginError" style="color: var(--danger); margin-top: 16px; display: none;"></p>
      </div>
    </div>
  </div>

  <!-- Toast Notification -->
  <div id="toast" class="toast"></div>

  <!-- Admin Modal -->
  <div class="modal" id="adminModal" aria-hidden="true">
    <div class="modal-content" style="max-width: 800px;">
      <div class="modal-header">
        <h2>Admin Panel</h2>
        <button class="modal-close" id="closeAdmin" title="Close">×</button>
      </div>
      <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
        <!-- ADD/EDIT PRODUCT FORM -->
        <div style="background: var(--bg-tertiary); padding: 20px; border-radius: var(--border-radius); margin-bottom: 24px;">
          <h3 id="adminFormTitle" style="margin-top:0; color: var(--text-primary);">Add Product</h3>
          <p style="font-size: 14px; color: var(--text-muted); margin-bottom: 16px;">Manage the product catalog. Fields with * are required.</p>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
            <div class="form-group"><label for="admin_pTitle">Title *</label><input id="admin_pTitle" placeholder="Product title"></div>
            <div class="form-group"><label for="admin_pTag">Tag</label><input id="admin_pTag" placeholder="e.g., New Arrival, Best Seller"></div>
            <div class="form-group"><label for="admin_pPrice">Selling Price (₹) *</label><input id="admin_pPrice" type="number" placeholder="1499"></div>
            <div class="form-group"><label for="admin_pMrp">MRP (₹)</label><input id="admin_pMrp" type="number" placeholder="1999"></div>
            <div class="form-group"><label for="admin_pColors">Colors (comma-separated) *</label><input id="admin_pColors" placeholder="red, gold, blue"></div>
            <div class="form-group"><label for="admin_pMaterial">Material</label><input id="admin_pMaterial" placeholder="e.g., Cotton, Silk"></div>
            <div class="form-group"><label for="admin_pStyle">Style</label><input id="admin_pStyle" placeholder="e.g., Kanjivaram"></div>
            <div class="form-group"><label for="admin_pDesign">Design</label><input id="admin_pDesign" placeholder="e.g., Floral, Paisley"></div>
            <div class="form-group"><label for="admin_pBlouse">Blouse Included</label><input id="admin_pBlouse" placeholder="e.g., Yes, No"></div>
            <div class="form-group"><label for="admin_pStock">Number in Stock</label><input id="admin_pStock" type="number" placeholder="10"></div>
          </div>
          <div class="form-group">
            <label>Image URLs *</label>
            <div id="imageUrlsContainer">
              <input class="imageUrlInput form-group" placeholder="Image URL 1" style="margin-bottom:8px; width: 100%;">
            </div>
            <button id="addImageUrl" type="button" class="btn btn-secondary" style="margin-top:8px">Add another image</button>
          </div>
          <div class="modal-footer" style="padding: 0; margin-top: 20px; border-top: none;">
            <button id="adminCancelEdit" class="btn btn-secondary" style="display:none">Cancel Edit</button>
            <button id="adminSave" class="btn btn-primary">Add Product</button>
          </div>
        </div>

        <!-- PRODUCT LIST -->
        <div>
          <h3 style="color: var(--text-primary);">All Products</h3>
          <div id="adminProductsList" style="border:1px solid var(--bg-tertiary); border-radius:var(--border-radius); max-height:400px; overflow-y:auto; background:var(--bg-tertiary);">
            <div style="padding:12px; text-align:center; color:var(--text-muted);">Loading products...</div>
          </div>
        </div>
      </div>
    </div>
  </div>


<script type="module">
(async function(){
  // if(document.readyState === 'loading') await new Promise(r=>document.addEventListener('DOMContentLoaded', r));
  const $ = id => document.getElementById(id);
  let currentEditingId = null; // To track which product is being edited
  let allProducts = []; // Master list of all products from Firestore
  function openModal(modal){ if(!modal) return; modal.classList.add('show'); modal.removeAttribute('aria-hidden'); document.body.style.overflow = 'hidden'; }
  function closeModal(modal){
  if(!modal) return;

  if(document.activeElement instanceof HTMLElement){
    // document.activeElement.blur();
  }

  modal.classList.remove('show');
  modal.setAttribute('aria-hidden','true');
  document.body.style.overflow = '';
}

  let currentProductId = null;
let selectedRating = 0;

  // ---- CONFIG ----
  const ADMIN_UID = 'EenXHJIvZpavhkGTCI8EZyFAfH93'; // UI-only sentinel; enforce admin in Firestore rules / backend
  const firebaseConfig = {
    apiKey: "AIzaSyBozW19Rjc9nj0YabOIE3DlW0qVHtU5XLA",
    authDomain: "hamsasarees-24738.firebaseapp.com",
    projectId: "hamsasarees-24738",
    storageBucket: "hamsasarees-24738.firebasestorage.app",
    messagingSenderId: "16303342424",
    appId: "1:16303342424:web:d68d26160d45472713db2d",
    measurementId: "G-1G1HQGJ5XS"
  };

  // ---- FILTER CONFIG ----
  const FILTERS_CONFIG = {
    colors: {
      red: '#ff4757', blue: '#3742fa', green: '#2ed573', yellow: '#ffc048',
      black: '#2f3542', white: '#ffffff', pink: '#f78fb3', purple: '#8e44ad',
      orange: '#ffa502', brown: '#834822', gold: '#e6b566', silver: '#bdc3c7',
      multicolor: 'linear-gradient(45deg, red, yellow, green, blue)'
    },
    colorGroups: {
      light: ['white', 'cream', 'beige', 'pastel pink', 'pastel blue', 'light yellow'],
      dark: ['black', 'maroon', 'navy blue', 'dark green', 'dark red']
    }
  };
  
  // ---- State for active filters ----
  let activeFilters = {
    colors: new Set(),
    material: new Set(),
    style: new Set(),
    design: new Set(),
    blouse: new Set(),
    stock: new Set()
  };
  // ---- helper: escape text for safe insertion ----
  function escapeHtml(s){ return String(s===undefined||s===null?'':s).replace(/[&<>\"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

  // ---- Firebase imports (modular) ----
  try{
    const { initializeApp } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js');
    const authMod = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js');
    const fsMod = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
    const storageMod = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js');

    const { getAuth, GoogleAuthProvider, signInWithPopup, signInWithRedirect, getRedirectResult, signOut, onAuthStateChanged } = authMod;
    const { getFirestore, collection, addDoc, setDoc, doc, deleteDoc, serverTimestamp, query, orderBy, getDocs, onSnapshot } = fsMod;
    const { getStorage, ref, uploadBytes, getDownloadURL } = storageMod;

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app); //getAuth(app);
    const db = getFirestore(app); //getFirestore(app);
    const storage = getStorage(app);
    const googleProvider = new GoogleAuthProvider();
    function loadProductReviews(pid){
  const pdRating = $('pdRating');
  const reviewsList = $('reviewsList');
  if(!pdRating || !reviewsList) return;

  pdRating.innerText = 'Loading reviews...';
  reviewsList.innerHTML = 'Loading comments...';

  const reviewsRef = collection(db, 'products', pid, 'reviews');

  onSnapshot(reviewsRef, snap => {
    let sum = 0;
    let count = 0;

    reviewsList.innerHTML = '';

    if (snap.empty) {
      pdRating.innerText = 'No reviews yet';
      reviewsList.innerHTML = '<div class="small">No comments yet.</div>';
      return;
    }

    snap.forEach(d => {
      const r = d.data();
      if(typeof r.rating === 'number'){
        sum += r.rating;
        count++;
      }

      // render comment
      const div = document.createElement('div');
      div.className = 'review-item';

      const stars = '★'.repeat(r.rating || 0);
const date = r.createdAt?.toDate
  ? r.createdAt.toDate().toLocaleDateString('en-IN', {
      day: '2-digit',
      month: 'short',
      year: 'numeric'
    })
  : '';

div.innerHTML = `
  <div style="display:flex;justify-content:space-between;align-items:center">
    <strong>${escapeHtml(r.userName || 'User')}</strong>
    <span style="font-size:12px;color:var(--muted)">${date}</span>
  </div>
  <div class="stars">${stars}</div>
  ${r.text ? `<div class="text">${escapeHtml(r.text)}</div>` : ''}
`;


      reviewsList.appendChild(div);
    });

    pdRating.innerText = `★ ${(sum/count).toFixed(1)} (${count} reviews)`;
  });
}

    // ---- DOM refs ----
    
    const loginModal = $('loginModal');
    const loginErr = $('loginError'), userBadge = $('userBadge'), signOutBtn = $('logoutBtn'), loginShowBtn = $('loginBtn'), googleBtnLarge = $('googleSignIn');
    const myOrdersBtn = $('ordersLink');
    const adminBtn = $('adminBtn');

    function toast(msg){ if(!toastEl) return; toastEl.innerText = msg; toastEl.classList.add('show'); setTimeout(()=>toastEl.classList.remove('show'), 3000); }
    function showLoginError(msg){ if(!loginErr) return; loginErr.innerText = msg; loginErr.style.display = msg ? 'block' : 'none'; }

    const toastEl = $('toast');

    // backdrop click and Esc
   // ================= REVIEW SYSTEM (FIXED) =================


document.addEventListener('click', e => {
  const star = e.target.closest('#reviewStars span');
  if (!star) return;

  selectedRating = Number(star.dataset.val);
  document.querySelectorAll('#reviewStars span').forEach(s => {
    s.classList.toggle('active', Number(s.dataset.val) <= selectedRating);
  });
});

$('submitReview')?.addEventListener('click', async () => {
  if (!auth.currentUser) {
    alert('Sign in to write a review');
    return;
  }
  if (!currentProductId) {
    alert('Product not selected');
    return;
  }
  if (!selectedRating) {
    alert('Select rating');
    return;
  }

  try {
    await setDoc(
  doc(db, 'products', currentProductId, 'reviews', auth.currentUser.uid),
  {
    rating: selectedRating,
    text: $('reviewText').value.trim(),
    userName: auth.currentUser.displayName || 'Anonymous',
    createdAt: serverTimestamp()
  }
);

    toast('Review submitted');
    $('reviewText').value = '';
    selectedRating = 0;
    document.querySelectorAll('#reviewStars span').forEach(s => s.classList.remove('active'));
  } catch (err) {
    console.error('Review save failed', err);
    alert('Failed to submit review');
  }
});

    try {
  const rr = await getRedirectResult(auth);
  if (rr && rr.user) {
    console.log('redirect sign-in OK', rr.user.uid);
  }
} catch (e) {
  console.warn('redirect result', e && e.code);
}

    async function signInPopup(){
      showLoginError('');
      try{ await signInWithPopup(auth, googleProvider); toast('Signed in'); }catch(e){
        console.error('sign-in error', e && e.code, e && e.message);
        const popupErrors = ['auth/popup-blocked','auth/popup-closed-by-user','auth/cancelled-popup-request'];
        if(e && popupErrors.includes(e.code)){
          try{ await signInWithRedirect(auth, googleProvider); return; }catch(err){ showLoginError('Popup blocked and redirect failed. Allow popups or try another browser.'); return; }
        }
        if(e && e.code === 'auth/unauthorized-domain'){
          showLoginError('Domain not authorized. Add your hosting domain in Firebase console → Authentication → Authorized domains.');
        } else showLoginError(e && e.message ? e.message : 'Sign-in failed');
      }
    }
    googleBtnLarge && googleBtnLarge.addEventListener('click', ()=>signInPopup());
    loginShowBtn && loginShowBtn.addEventListener('click', ()=>{ openModal(loginModal); console.log("open"); });

    signOutBtn && signOutBtn.addEventListener('click', async () => { try{ await signOut(auth); toast('Signed out'); }catch(e){ console.error('signout failed', e); } });

    // ---- PRODUCTS: load from Firestore (live) ----
    const productGrid = $('productGrid');
    // ================= PRODUCT DETAIL → ORDER NOW =================
const pdOrderBtn = $('pdOrderBtn');
pdOrderBtn?.addEventListener('click', () => {
  if (!currentProductId) {
    alert('Product not selected');
    return;
  }
  if (!auth.currentUser) {
    closeModal(document.getElementById('productDetailModal'));
    openModal(loginModal);
    showLoginError('Please sign in to place orders');
    return;
  }
  // Get product info directly from the detail modal's state
  const title = $('pdTitle').innerText || '';
  const priceText = $('pdPrice').innerText || '';
  const price = priceText.replace(/[^\d.]/g, ''); // Keep decimal point
  const mainImg = $('pdMainImg').src || '';
  // Directly create order object and redirect to payment
  const tempOrder = {
    product: title,
    price: price,
    image: mainImg,
    // Pre-fill user details if available, otherwise payment page will ask
    name: auth.currentUser.displayName || '',
    phone: '', // Phone and address must be entered on payment page
    address: '',
    createdAt: Date.now()
  };
  try {
    sessionStorage.setItem('pendingOrder', JSON.stringify(tempOrder));
    window.location.href = 'payment.html';
  } catch (e) {
    console.error("Failed to save order to sessionStorage:", e);
    alert("Could not proceed to payment. Please try again.");
  }
});

    // ================= PRODUCT CARD CLICK → DETAIL MODAL =================
productGrid.addEventListener('click', e => {
  const card = e.target.closest('.product-card');
  if (!card) return; //card
  if (!card.dataset.pid) return;

  // If Order button clicked, ignore (already handled elsewhere)
  if (e.target.closest('.orderBtn')) return;

  currentProductId = card.dataset.pid;

  // Load images
  const imgWrap = card.querySelector('.product-image');
  const images = JSON.parse(imgWrap?.dataset.images || '[]');

  if (images.length) {
    $('pdMainImg').src = images[0];
    const thumbs = $('pdThumbs');
    thumbs.innerHTML = '';

    images.forEach((src, i) => {
      const t = document.createElement('img');
      t.src = src;
      if (i === 0) t.classList.add('active');

      t.onclick = () => {
        thumbs.querySelectorAll('img').forEach(x => x.classList.remove('active'));
        t.classList.add('active');
        $('pdMainImg').src = src;
      };

      thumbs.appendChild(t);
    });
  }

  // Title & price
  $('pdTitle').innerText = card.querySelector('.product-title')?.innerText || '';
  $('pdPrice').innerText = card.querySelector('.product-price')?.innerText || '';

  // ---- FIXED: Safely parse and populate additional details ----
  let data = {};
  try {
    // Use the data stored in the dataset, which is now guaranteed to be safe
    data = JSON.parse(card.dataset.productData || '{}');
  } catch (e) {
    console.error('Failed to parse productData from dataset:', e);
    // data remains an empty object, so the modal still opens
  }

  const detailsContainer = $('pdDetails');
  detailsContainer.innerHTML = ''; // Clear previous details

  const addDetailToModal = (label, value) => {
    if (!value || (Array.isArray(value) && value.length === 0)) return; // Don't render empty details
    const detailEl = document.createElement('div');
    const formattedValue = Array.isArray(value) ? value.map(v => v.charAt(0).toUpperCase() + v.slice(1)).join(', ') : value;
    detailEl.innerHTML = `<span style="font-weight:600; color: var(--text-main);">${label}: </span><span>${formattedValue}</span>`;
    detailsContainer.appendChild(detailEl);
  };

  addDetailToModal('Material', data.material);
  addDetailToModal('Style', data.style);
  addDetailToModal('Design', data.design);
  addDetailToModal('Colors', data.colors);
  addDetailToModal('Blouse', data.blouse);

  // Stock Status for Modal
  const stock = Number(data.stock || 0); // Normalize stock as per requirements
  const isInStock = stock > 0;

  const stockStatusText = isInStock ? 'In Stock' : 'Out of Stock';
  const stockColor = isInStock ? 'var(--success)' : 'var(--danger)';
  const stockEl = document.createElement('div');
  stockEl.innerHTML = `<span style="font-weight:600; color: var(--text-main);">Availability: </span><span style="color: ${stockColor};">${stockStatusText}</span>`;
  detailsContainer.appendChild(stockEl);
  
  // --- REQUIRED: Update the order button based on normalized stock ---
  const pdOrderBtn = $('pdOrderBtn');
  if (isInStock) {
    pdOrderBtn.disabled = false;
    pdOrderBtn.textContent = 'Order Now';
    pdOrderBtn.style.opacity = '';
    pdOrderBtn.style.cursor = 'pointer';
  } else {
    pdOrderBtn.disabled = true;
    pdOrderBtn.textContent = 'Out of Stock';
    pdOrderBtn.style.opacity = '0.6';
    pdOrderBtn.style.cursor = 'not-allowed';
  }

  // Load reviews
  loadProductReviews(currentProductId);

  // OPEN MODAL
  openModal(document.getElementById('productDetailModal'));
});

    // ---- Helper function to add detail rows to a container ----
    function addDetailToCard(container, label, value) {
      if (!value || (Array.isArray(value) && value.length === 0)) return;
      const detailEl = document.createElement('div');
      // This function now expects value to be a pre-formatted string (or HTML)
      const formattedValue = Array.isArray(value) ? value.map(v => v.charAt(0).toUpperCase() + v.slice(1)).join(', ') : value;
      detailEl.innerHTML = `<span style="font-weight:600; color: var(--text-main);">${label}: </span><span>${formattedValue}</span>`;
      container.appendChild(detailEl);
    }

    const productsColRef = collection(db, 'products');

    function renderProductCard(docSnap){
      const id = docSnap.id;
      const data = docSnap.data() || {};
      const title = data.title || 'Untitled';
      const tag = data.tag || '';      
      // Use the 'images' array if it exists, otherwise fall back to 'img'.
      const images = data.images && data.images.length > 0 ? data.images : [data.img];
      const primaryImage = images[0] || 'https://images.unsplash.com/photo-1520975918016-4d0b5b0b2f3d?q=80&w=1200&auto=format&fit=crop&ixlib=rb-4.0.3&s=placeholder';
      const price = data.price || '0';
      const stock = data.stock;
      const avg = data._avg ? Number(data._avg).toFixed(1) : null;
      const avgDisplay = avg ? `★ ${avg} (${data._count||0})` : 'No ratings';

      const card = document.createElement('div');
      card.className = 'product-card';
      card.dataset.pid = id;
      // Store product data on the element for filtering
      const safeDataForDataset = {
        material: data.material || '',
        style: data.style || '',
        design: data.design || '',
        blouse: data.blouse || '',
        stock: data.stock === undefined ? 0 : data.stock, // Default to 0 if undefined
        colors: Array.isArray(data.colors) ? data.colors : []
      };
      card.dataset.productData = JSON.stringify(safeDataForDataset);

      // build DOM safely (no raw innerHTML from user content)
      let tagEl = null;
if(tag){
  tagEl = document.createElement('div'); //div
  tagEl.className = 'product-tag';
  tagEl.textContent = tag;
}

      const imgWrap = document.createElement('div');
imgWrap.className = 'product-image';
      if(tagEl){
  imgWrap.appendChild(tagEl); // ✅ CORRECT PLACE
}
imgWrap.dataset.images = JSON.stringify(images); // ⭐ STORE ALL IMAGES

const imgEl = document.createElement('img');
imgEl.loading = 'lazy'; //lazy
imgEl.src = primaryImage;
imgEl.alt = title;
imgWrap.appendChild(imgEl);
 
      card.appendChild(imgWrap);

      const infoWrap = document.createElement('div');
      infoWrap.className = 'product-info';

      const h3 = document.createElement('div'); h3.className = 'product-title'; h3.textContent = title; infoWrap.appendChild(h3);

      const priceWrap = document.createElement('div'); //div
priceWrap.className = 'product-pricing';

const oldPrice = document.createElement('span');
oldPrice.className = 'product-price-old';
const mrp = data.mrp || price;
oldPrice.textContent = `₹${mrp}`;


const newPrice = document.createElement('span');
newPrice.className = 'product-price';
newPrice.textContent = `₹${price}`;

if (mrp > price) {
  priceWrap.appendChild(oldPrice);
}
priceWrap.appendChild(newPrice);
infoWrap.appendChild(priceWrap);

// OPTIONAL discount badge
let discount = 0;
if (mrp > price) {
  discount = Math.round(((mrp - price) / mrp) * 100);
}
if (discount > 0) {
  const badge = document.createElement('span');
  badge.className = 'product-discount';
  badge.textContent = `${discount}% OFF`;
  priceWrap.appendChild(badge);
}



      const ratingWrap = document.createElement('div'); ratingWrap.style.display='flex'; ratingWrap.style.alignItems='center';
      const rEl = document.createElement('div'); rEl.className = 'product-rating'; rEl.dataset.pid = id; rEl.textContent = avgDisplay;
      ratingWrap.appendChild(rEl);
      infoWrap.appendChild(ratingWrap);

      // --- Product Details Block (Restored) ---
      const detailsContainer = document.createElement('div');
      detailsContainer.className = 'product-details';

      addDetailToCard(detailsContainer, 'Material', data.material);
      addDetailToCard(detailsContainer, 'Style', data.style);
      addDetailToCard(detailsContainer, 'Design', data.design);
      addDetailToCard(detailsContainer, 'Blouse', data.blouse);
      infoWrap.appendChild(detailsContainer);

      // Add stock status directly to the details container for correct HTML
      const stockStatusText = (stock !== undefined && stock > 0) ? 'In Stock' : 'Out of Stock';
      const stockColor = (stock !== undefined && stock > 0) ? 'var(--success)' : 'var(--danger)';
      const stockEl = document.createElement('div');
      stockEl.className = `stock-status ${(stock !== undefined && stock > 0) ? 'in-stock' : 'out-of-stock'}`;
      stockEl.textContent = stockStatusText;
      infoWrap.appendChild(stockEl);

      const orderWrap = document.createElement('div'); orderWrap.className = 'product-actions';
      const orderBtn = document.createElement('button'); orderBtn.className='orderBtn btn btn-primary'; orderBtn.type='button'; orderBtn.dataset.product = title; orderBtn.dataset.price = price;orderBtn.dataset.image = primaryImage; orderBtn.textContent='Order Now'; orderWrap.appendChild(orderBtn);
      infoWrap.appendChild(orderWrap);
      card.appendChild(infoWrap);
      
      // Mute card if out of stock
      if (stock === undefined || stock <= 0) {
        card.style.opacity = '0.6';
        card.style.pointerEvents = 'auto'; // Keep card clickable for detail view
        orderBtn.disabled = true;
        orderBtn.textContent = 'Out of Stock'; //Out of Stock
        orderBtn.style.background = 'var(--bg-tertiary)';
        orderBtn.style.cursor = 'not-allowed';
        orderBtn.style.boxShadow = 'none';
      }
      return card;
    }

    function renderProducts(productsToRender, productGrid) {
      const productGrid = $('productGrid');
      productGrid.innerHTML = '';

      if (productsToRender.length === 0) {
        const fallback = document.createElement('div');
        fallback.className = 'card';
        fallback.style.cssText = 'grid-column:1/-1;text-align:center;color:var(--muted);padding:32px;background:transparent;box-shadow:none;';
        fallback.innerHTML = '<strong style="color:#eaf6ff">No products match your filters.</strong><div class="small" style="margin-top:8px">Try clearing the filters to see all products.</div>';
        productGrid.appendChild(fallback);
        return;
      }

      productsToRender.forEach(productData => {
        // We need a mock docSnap structure for renderProductCard
        const mockDocSnap = {
          id: productData.id,
          data: () => productData
        };
        const card = renderProductCard(mockDocSnap);
        productGrid.appendChild(card);
      });
      attachRatingListenersToGrid();
    }

    let productsUnsub = null;
    try{
      productsUnsub = onSnapshot(productsColRef, snap=>{
        allProducts = []; // Clear and repopulate the master list
        if(snap.empty){
          productGrid.innerHTML = `<div class="product-card" style="grid-column:1/-1;text-align:center;color:var(--muted);padding:32px;background:transparent">
            <strong style="color:#eaf6ff">No products yet</strong>
            <div class="small" style="margin-top:8px">As admin, open Admin → Add Product to upload items. The product grid updates live for users.</div>
            <div style="margin-top:12px"><button id="openAdminFromEmptyInner" class="btn btn-secondary">Open Admin</button></div>
          </div>`;
          $('openAdminFromEmptyInner')?.addEventListener('click', ()=>{ 
            if(!auth.currentUser){ openModal(loginModal); showLoginError('Sign in as admin to add products'); return; } 
            if(auth.currentUser.uid !== ADMIN_UID){ alert('You are not admin'); return; } 
            openModal(adminModal); 
          });
          return;
        }

        snap.forEach(d => {
          allProducts.push({ id: d.id, ...d.data() });
        });

        // Initial render with all products
        applyFiltersAndRender();

        // Update product counts in filters
        updateColorFilterCounts();

        // Re-initialize all dynamic filters based on the full product list
        initializeDynamicFilters();

      }, err => { console.error('products snapshot error', err); });
    }catch(e){ console.warn('products onSnapshot not available', e); }

    // delegate order button via productGrid click
productGrid.addEventListener('click', ev=>{
  const btn = ev.target.closest('.orderBtn');
  if(!btn) return;

  if(!auth.currentUser){
    openModal(loginModal);
    showLoginError('Please sign in with Google to place orders');
    return;
  }

  // --- UNIFIED ORDER LOGIC ---
  // This now behaves exactly like the button in the detail modal.
  const tempOrder = {
    product: btn.dataset.product || '',
    price: btn.dataset.price || '0',
    image: btn.dataset.image || '',
    name: auth.currentUser.displayName || '',
    phone: '',
    address: '',
    createdAt: Date.now()
  };

  sessionStorage.setItem('pendingOrder', JSON.stringify(tempOrder));
  window.location.href = 'payment.html';
});

    // ---- Rating listeners and live averages per product ----
    // ---- Rating listeners and live averages (FIXED) ----
function attachRatingListenersToGrid(){ //_
  document.querySelectorAll('#productGrid .card').forEach(card=>{
    const pid = card.dataset.pid;
    if(!pid) return;

    // ⭐ RATE BUTTON CLICK
    card.querySelectorAll('.rateBtn').forEach(btn=>{
      if(btn._bound) return;
      btn._bound = true;

      btn.addEventListener('click', async (ev)=>{
        if(!auth.currentUser){
          alert('Sign in to rate products');
          return;
        }

        const rating = Number(ev.currentTarget.dataset.rating);
        const uid = auth.currentUser.uid;

        try{
          await setDoc(
            doc(db, 'products', pid, 'reviews', uid),
            {
              rating: rating,
              createdAt: serverTimestamp()
            }
          );
          toast('Thanks for rating!');
        }catch(err){
          console.error('rating save failed', err);
          alert('Thanks for Your Review !');
        }
      });
    });

    // ⭐ LIVE AVERAGE RATING
    if(card._reviewsUnsub) return;

    try{
      const reviewsRef = collection(db, 'products', pid, 'reviews');
      card._reviewsUnsub = onSnapshot(reviewsRef, snap=>{
        let sum = 0;
        let count = 0;

        snap.forEach(docSnap=>{
          const d = docSnap.data();
          if(typeof d.rating === 'number'){
            sum += d.rating;
            count++;
          }
        });

        const avg = count ? (sum / count).toFixed(1) : null;
        const ratingEl = card.querySelector('.product-rating');

        if(ratingEl){
          ratingEl.innerText = avg
            ? `★ ${avg} (${count})`
            : 'No ratings';
        }
      });
    }catch(e){
      console.warn('ratings listener failed', e);
    }
  });
}

      

    attachRatingListenersToGrid();

    // Load user orders (persistent) and allow delete + view
    // Moved to yourorders.html as a separate page


    // ---- Admin UI: persist product to Firestore (must be guarded by rules) ----
    adminBtn && adminBtn.addEventListener('click', ()=>{
      if(!auth.currentUser){ alert('Sign in as admin'); return; }
      if(auth.currentUser.uid !== ADMIN_UID){ alert('You are not admin'); return; }
      loadAdminProductsList();
      openModal(adminModal);
    });
    
    // Handle Cancel Edit button
    $('adminCancelEdit')?.addEventListener('click', () => {
      currentEditingId = null;
      $('adminFormTitle').innerText = 'Add Product';
      $('adminSave').innerText = 'Add Product';
      $('adminCancelEdit').style.display = 'none';
      // Reset form fields
      $('admin_pTitle').value = '';
      $('admin_pPrice').value = '';
      $('admin_pMrp').value = '';
      $('admin_pTag').value = '';
      $('admin_pColors').value = '';
      $('admin_pMaterial').value = '';
      $('admin_pStyle').value = '';
      $('admin_pDesign').value = '';
      $('admin_pBlouse').value = '';
      $('admin_pStock').value = '';
      const imageUrlsContainer = $('imageUrlsContainer');
      imageUrlsContainer.innerHTML = '<input class="imageUrlInput" placeholder="Image URL 1" style="margin-bottom:8px">';
      $('admin_pTitle').focus();
    });

    // Load and render products list for admin
    async function loadAdminProductsList(){
      const listContainer = $('adminProductsList');
      if(!listContainer) return;
      listContainer.innerHTML = '<div class="small" style="padding:12px;text-align:center;color:var(--muted)">Loading products...</div>';
      
      try{
        const snap = await getDocs(productsColRef);
        if(snap.empty){
          listContainer.innerHTML = '<div class="small" style="padding:12px;text-align:center;color:var(--muted)">No products to remove</div>';
          return;
        }
        listContainer.innerHTML = '';
        snap.forEach(docSnap=>{
          const id = docSnap.id;
          const data = docSnap.data() || {};
          const title = data.title || 'Untitled';
          const price = data.price || '0';
          
          const row = document.createElement('div');
          row.style.cssText = 'display:flex;justify-content:space-between;align-items:center;padding:12px;border-bottom:1px solid rgba(255,255,255,0.03)';
          row.innerHTML = `
            <div style="flex:1">
              <strong style="color:var(--text-primary)">${escapeHtml(title)}</strong>
              <div class="small" style="color:var(--muted)">₹${escapeHtml(price)}</div>
            </div>
            <div style="display:flex; gap:8px;">
              <button class="editProductBtn btn-secondary" data-id="${id}" type="button">Edit</button>
              <button class="deleteProductBtn btn" data-id="${id}" style="background:linear-gradient(90deg,#ff3b3b,#ff5252);white-space:nowrap" type="button">Delete</button>
            </div>
          `;
          listContainer.appendChild(row);
        });
        
        // Attach edit handlers
        listContainer.querySelectorAll('.editProductBtn').forEach(btn => {
          btn.addEventListener('click', async (ev) => {
            const id = ev.currentTarget.getAttribute('data-id');
            if (!id) return;
            try {
              const docRef = doc(db, 'products', id);
              const docSnap = await fsMod.getDoc(docRef);
              if (docSnap.exists()) {
                populateAdminFormForEdit(id, docSnap.data());
              }
            } catch (err) { console.error("Failed to fetch product for edit:", err); alert("Could not load product data."); }
          });
        });

        
        // Attach delete handlers
        listContainer.querySelectorAll('.deleteProductBtn').forEach(btn=>{
          btn.addEventListener('click', async (ev)=>{
            const id = ev.currentTarget.getAttribute('data-id');
            if(!id) return;
            const ok = confirm('Are you sure you want to delete this product? This cannot be undone.');
            if(!ok) return;
            try{
              await deleteDoc(doc(db, 'products', id));
              toast('Product deleted');
              await loadAdminProductsList();
            }catch(err){
              console.error('delete product failed', err);
              alert('Failed to delete product. See console.');
            }
          });
        });
      }catch(err){
        console.error('load admin products failed', err);
        listContainer.innerHTML = '<div class="small" style="padding:12px;color:#ffb4b4">Failed to load products</div>';
      }
    }

    function populateAdminFormForEdit(id, data) {
      currentEditingId = id;
      $('admin_pTitle').value = data.title || '';
      $('admin_pPrice').value = data.price || '';
      $('admin_pMrp').value = data.mrp || '';
      $('admin_pTag').value = data.tag || '';
      $('admin_pColors').value = (data.colors || []).join(', ');
      $('admin_pMaterial').value = data.material || '';
      $('admin_pStyle').value = data.style || '';
      $('admin_pDesign').value = data.design || '';
      $('admin_pBlouse').value = data.blouse || '';
      $('admin_pStock').value = data.stock || '';

      const imageUrlsContainer = $('imageUrlsContainer');
      imageUrlsContainer.innerHTML = ''; // Clear existing inputs
      const images = data.images || [data.img] || [];
      if (images.length > 0) {
        images.forEach(url => {
          const newInput = document.createElement('input');
          newInput.className = 'imageUrlInput';
          newInput.value = url;
          newInput.style.marginBottom = '8px';
          imageUrlsContainer.appendChild(newInput);
        });
      }

      $('adminFormTitle').innerText = 'Edit Product';
      $('adminSave').innerText = 'Save Changes';
      $('adminCancelEdit').style.display = 'inline-block';
      window.scrollTo(0, 0);
    }
    // Logic for adding multiple image URLs
    const addImageUrlBtn = $('addImageUrl');
    if (addImageUrlBtn) {
      addImageUrlBtn.addEventListener('click', () => {
        const imageUrlsContainer = $('imageUrlsContainer');
        const inputCount = imageUrlsContainer.querySelectorAll('.imageUrlInput').length;
        const newInput = document.createElement('input');
        newInput.type = 'text';
        newInput.className = 'imageUrlInput';
        newInput.placeholder = `Image URL ${inputCount + 1}`;
        newInput.style.marginBottom = '8px';
        imageUrlsContainer.appendChild(newInput);
      });
    }

    $('adminSave').addEventListener('click', async ()=>{
      const title = $('admin_pTitle').value.trim();
      const price = Number($('admin_pPrice').value.trim());
      const tag = $('admin_pTag').value.trim();
      const mrp = Number($('admin_pMrp').value.trim()) || price;
      const colors = $('admin_pColors').value.trim().toLowerCase().split(',')
        .map(c => c.trim())
        .filter(c => c);
      const material = $('admin_pMaterial').value.trim();
      const pStyle = $('admin_pStyle').value.trim();
      const design = $('admin_pDesign').value.trim();
      const blouse = $('admin_pBlouse').value.trim();
      const stock = Number($('admin_pStock').value.trim());

      const imageUrls = [...document.querySelectorAll('#imageUrlsContainer .imageUrlInput')]
        .map(input => input.value.trim())
        .filter(url => url);

      if (!title || !price) { alert('Title and Selling Price are required.'); return; }
      if (colors.length === 0) { alert('Please enter at least one color.'); return; }
      if (imageUrls.length === 0) { alert('Please enter at least one image URL'); return; }
      if (!auth.currentUser || auth.currentUser.uid !== ADMIN_UID) { alert('Only admin can add products'); return; }

      try {
        const btn = $('adminSave'); btn.disabled = true; btn.innerText = 'Saving...';

        const payload = {
          title,
          price,
          mrp,
          tag,
          img: imageUrls[0],
          material,
          colors,
          style: pStyle,
          design,
          blouse,
          stock,
          images: imageUrls,
        };

        if (currentEditingId) {
          // Update existing document
          await setDoc(doc(db, 'products', currentEditingId), payload, { merge: true });
          toast('Product updated');
        } else {
          // Add new document
          payload.createdAt = serverTimestamp();
          await addDoc(collection(db, 'products'), payload);
          toast('Product added');
        }

        // Reset fields
        $('adminCancelEdit').click(); // Use cancel logic to reset the form
        $('admin_pTitle').value = '';
        $('admin_pPrice').value = '';
        $('admin_pTag').value = '';
        $('admin_pMrp').value = '';
        $('admin_pColors').value = '';
        $('admin_pMaterial').value = '';
        $('admin_pStyle').value = '';
        $('admin_pDesign').value = '';
        $('admin_pBlouse').value = '';
        $('admin_pStock').value = '';

        const imageUrlsContainer = $('imageUrlsContainer');
        imageUrlsContainer.innerHTML = '<input class="imageUrlInput" placeholder="Image URL 1" style="margin-bottom: 8px;">';

        btn.disabled = false; btn.innerText = 'Add Product';
        await loadAdminProductsList();
      } catch (err) {
        console.error('add product failed', err);
        alert('Failed to add product: ' + (err.message || ''));
        $('adminSave').disabled = false;
        $('adminSave').innerText = 'Add Product';
      }
    });

    // ---- Generic modal close (fix for all X buttons) ----
    document.querySelectorAll('.modal-close').forEach(btn=>{ btn.addEventListener('click', ()=>{ const modal = btn.closest('.modal'); closeModal(modal); }); });

    // ---- Auth state changes: UI toggle ----
    onAuthStateChanged(auth, user=>{
      if(user){
        closeModal(loginModal);
        if(userBadge){ userBadge.style.display='inline-block'; userBadge.innerText = user.displayName || user.email; }
        if(signOutBtn) signOutBtn.style.display='inline-block';
        if(myOrdersBtn) myOrdersBtn.style.display='inline-block';
        if(loginShowBtn) loginShowBtn.style.display='none';
        if(adminBtn) adminBtn.style.display = (user.uid === ADMIN_UID) ? 'inline-block' : 'none';
      }else{
        closeModal(loginModal);
        if(userBadge) userBadge.style.display='none';
        if(signOutBtn) signOutBtn.style.display='none';
        if(myOrdersBtn) myOrdersBtn.style.display='none';
        if(loginShowBtn) loginShowBtn.style.display='inline-block';
        if(adminBtn) adminBtn.style.display='none';
      }
    });

    // ---- Search and shopNow (debounced) ----
    const searchBox = $('searchBox');
    if(searchBox){
      // The search input is now handled by the initializeFilters function
    }
    const shopNow = $('shopNow'); if(shopNow) shopNow.addEventListener('click', ()=>{ const grid=document.getElementById('productGrid'); if(grid) grid.scrollIntoView({behavior:'smooth'}); });

    // ---- FILTERING LOGIC ----
    function applyFiltersAndRender() {
      const productGrid = $('productGrid');
      const searchTerm = $('searchBox').value.toLowerCase();
      
      let filteredProducts = allProducts.filter(product => {
        // 1. Search term filter
        const title = (product.title || '').toLowerCase();
        const tag = (product.tag || '').toLowerCase();
        const material = (product.material || '').toLowerCase();
        const searchMatch = !searchTerm || title.includes(searchTerm) || tag.includes(searchTerm) || material.includes(searchTerm);
        if (!searchMatch) return false;

        // 2. Color filter
        const selectedColors = activeFilters.colors;
        if (selectedColors.size > 0) {
          const productColors = product.colors || [];
          const colorMatch = productColors.some(pc => selectedColors.has(pc));
          if (!colorMatch) return false;
        }

        // 3. Material filter (AND logic)
        const materialFilters = activeFilters.material; // This is a Set of selected materials
        if (materialFilters.size > 0) {
            if (!materialFilters.has(product.material?.toLowerCase() || '')) return false;
        }

        // 4. Style filter (AND logic)
        const styleFilters = activeFilters.style;
        if (styleFilters.size > 0) {
            if (!styleFilters.has(product.style?.toLowerCase() || '')) return false;
        }

        // 5. Design filter (AND logic)
        const designFilters = activeFilters.design;
        if (designFilters.size > 0) {
            if (!designFilters.has(product.design?.toLowerCase() || '')) return false;
        }

        // 6. Blouse filter (AND logic)
        const blouseFilters = activeFilters.blouse;
        if (blouseFilters.size > 0) {
            if (!blouseFilters.has(product.blouse?.toLowerCase() || '')) return false;
        }

        // 7. Stock filter (AND logic)
        if (activeFilters.stock.size > 0) {
            const isInStock = (product.stock || 0) > 0;
            const selection = activeFilters.stock.has('in stock');
            // Show if user wants "In Stock" and it is, or user wants "Out of Stock" and it is not.
            if (selection !== isInStock) return false;
        }

        // If all filters pass, include the product
        return true;
      });

      renderProducts(filteredProducts, productGrid);
    }

    function updateColorFilterCounts() {
      const colorCounts = {};
      Object.keys(FILTERS_CONFIG.colors).forEach(c => colorCounts[c] = 0);

      allProducts.forEach(p => {
        (p.colors || []).forEach(color => {
          if (colorCounts.hasOwnProperty(color)) {
            colorCounts[color]++;
          }
        });
      });

      document.querySelectorAll('.color-filter-item').forEach(item => {
        const color = item.dataset.color;
        const countEl = item.querySelector('.color-count');
        if (countEl && colorCounts[color] > 0) {
          countEl.textContent = `(${colorCounts[color]})`;
        } else if (countEl) {
          countEl.textContent = '(0)';
        }
      });
    }

    // ---- Initialize Filters UI ----
    function initializeFilters() {
      const container = $('filtersContainer');
      if (container) container.innerHTML = '';
      for (const color in FILTERS_CONFIG.colors) {
        const item = document.createElement('div');
        item.className = 'filter-item';
        item.dataset.color = color;
        item.innerHTML = `
          <div class="color-swatch" style="background:${FILTERS_CONFIG.colors[color]}"></div>
          <span>${color.charAt(0).toUpperCase() + color.slice(1)}</span>
          <span class="color-count" style="margin-left:4px; color:var(--text-muted);"></span>
        `;
        item.addEventListener('click', () => {
          item.classList.toggle('active');
          // item.style.outline = activeFilters.colors.has(color) ? 'none' : '2px solid var(--gold)';
          activeFilters.colors.has(color) ? activeFilters.colors.delete(color) : activeFilters.colors.add(color);
          applyFiltersAndRender();
        });
        container.appendChild(item);
      }
      

      // This now clears ALL filters
      $('clearFilters').addEventListener('click', () => {
        for (const key in activeFilters) {
            activeFilters[key].clear();
        }
        document.querySelectorAll('.filter-item.active').forEach(item => item.classList.remove('active'));
        $('searchBox').value = '';
        applyFiltersAndRender();
      });

      // Integrate search box with the new filtering system
      const searchBox = $('searchBox');
      if(searchBox){ let searchTimer = null;
        searchBox.addEventListener('input', () => {
          clearTimeout(searchTimer);
          searchTimer = setTimeout(applyFiltersAndRender, 180); // Debounced call
        });
      }
    }
    initializeFilters();

    function initializeDynamicFilters() {
        const fieldsToFilter = {
            material: { label: 'By Material', container: 'materialFilterGroup' },
            style: { label: 'By Style', container: 'styleFilterGroup' },
            design: { label: 'By Design', container: 'designFilterGroup' },
            blouse: { label: 'Blouse', container: 'blouseFilterGroup' }
        };

        // --- Generate dynamic filters from product data (Material, Style, Design) ---
        for (const field in fieldsToFilter) {
            const uniqueValues = [...new Set(allProducts.map(p => p[field]?.trim().toLowerCase()).filter(Boolean))];
            uniqueValues.sort();
            const config = fieldsToFilter[field];
            const container = $(config.container);
            if (!container) continue;

            let html = `<h4 style="margin: 0 0 10px 0; font-size: 14px;">${config.label}</h4><div class="color-filter-grid">`;
            uniqueValues.forEach(value => {
                const count = allProducts.filter(p => p[field]?.trim().toLowerCase() === value).length;
                html += `<div class="filter-item" data-filter-group="${field}" data-filter-value="${value}">
                    ${value.charAt(0).toUpperCase() + value.slice(1)} <span style="margin-left:4px; color:var(--text-muted);">(${count})</span>
                </div>`;
            });
            html += `</div>`;
            container.innerHTML = html;
        }

        // --- Generate static filters (Availability) ---
        const availabilityContainer = $('availabilityFilterGroup');
        if (availabilityContainer) {
            availabilityContainer.innerHTML = `<h4 style="margin: 0 0 10px 0; font-size: 14px;">By Availability</h4><div class="color-filter-grid">
                <div class="filter-item" data-filter-group="stock" data-filter-value="in stock">In Stock</div>
                <div class="filter-item" data-filter-group="stock" data-filter-value="out of stock">Out of Stock</div>
            </div>`;
        }

        // --- Attach a single, delegated event listener for all new filters ---
        const filterGroupsContainer = $('filtersContainer');
        if (filterGroupsContainer && !filterGroupsContainer._bound) {
            filterGroupsContainer._bound = true; // Prevent multiple bindings
            filterGroupsContainer.addEventListener('click', (e) => {
                const item = e.target.closest('.filter-item');
                if (!item) return;
                const group = item.dataset.filterGroup;
                const value = item.dataset.filterValue;
                if (!group || !value) return;

                item.classList.toggle('active');
                
                activeFilters[group].has(value) ? activeFilters[group].delete(value) : activeFilters[group].add(value);
                applyFiltersAndRender();
            });
        }
    }

    // initial UI ready
    $('openAdminFromEmpty')?.addEventListener('click', ()=>{
      if(!auth.currentUser){ openModal(loginModal); showLoginError('Sign in as admin to add products'); return; }
      if(auth.currentUser.uid !== ADMIN_UID){ alert('You are not admin'); return; }
      openModal(adminModal);
    });

    console.log('Hamsa Sarees SPA ready — fixed');
  }catch(err){
    console.error('Init error', err);
    alert('Initialization failed — check console.');
  }
})();

</script>

  <!-- Image zoom modal (added) -->
  <div class="modal zoom-modal" id="zoomModal" aria-hidden="true">
    <div class="modal-content" role="dialog" aria-modal="true">
      <button class="modal-close" id="closeZoom" title="Close">✕</button>
      <img id="zoomImg" src="" alt="Zoomed-in product image" />
    </div>
  </div>


  <!-- Product Detail Modal -->
  <div class="modal" id="productDetailModal" aria-hidden="true">
    <div class="modal-content" style="max-width: 900px;">
      <div class="modal-header">
        <h2 id="pdTitle">Product Details</h2>
        <button class="modal-close" id="closeProductDetail">✕</button>
      </div>
      <div class="modal-body">
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 24px;">
          <!-- Images -->
          <div>
            <img id="pdMainImg" style="width:100%; border-radius: 12px;" src="" alt="Main product image">
            <div id="pdThumbs" style="display:flex; gap:8px; margin-top:10px;"></div>
          </div>
  
          <!-- Info -->
          <div>
            <div id="pdPrice" class="product-price" style="margin-bottom: 16px;"></div>
            <div id="pdDetails" style="margin: 16px 0; font-size: 14px; color: var(--text-secondary); display: grid; gap: 8px;"></div>
            <button id="pdOrderBtn" class="btn btn-primary">Order Now</button>
            <hr style="margin: 20px 0; border-color: rgba(212, 175, 55, 0.1);">
            <h3>User Reviews</h3>
            <div id="pdRating" class="product-rating" style="margin-bottom: 10px;"></div>
            <div id="reviewsList" style="display:flex; flex-direction:column; gap:10px; margin-top:10px;"></div>
            <hr style="margin: 20px 0; border-color: rgba(212, 175, 55, 0.1);">
            <div>
              <h3>Write a Review</h3>
              <div id="reviewStars">
                <span data-val="1">★</span><span data-val="2">★</span><span data-val="3">★</span><span data-val="4">★</span><span data-val="5">★</span>
              </div>
              <textarea id="reviewText" class="form-group" style="width:100%; margin-top:8px;" placeholder="Share your experience (optional)"></textarea>
              <button id="submitReview" class="btn btn-secondary">Submit Review</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  </body>
</html>
