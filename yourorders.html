<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>My Orders — Hamsa Sarees</title>

<meta http-equiv="Content-Security-Policy" content="
  default-src 'self';
  script-src 'self' https://www.gstatic.com/firebasejs/ https://apis.google.com;
  style-src 'self' 'unsafe-inline' https://fonts.googleapis.com;
  font-src 'self' https://fonts.gstatic.com;
  connect-src 'self' https://*.firebaseio.com wss://*.firebaseio.com https://www.googleapis.com https://securetoken.googleapis.com;
  img-src 'self' https: data:;
  object-src 'none';">

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">
<link rel="stylesheet" href="style.css">
</head>

<body>

<div class="container">

  <header>
    <div class="brand">
      <div class="logo">HS</div>
      <div>
        <div class="title">Hamsa Sarees</div>
        <div class="small">My Orders</div>
      </div>
    </div>

    <div class="actions">
      <div id="userBadge" class="user-badge"></div>
      <button id="signOutBtn" class="btn-ghost">Sign out</button>
      <a href="index.html" class="btn-ghost">Back to Shop</a>
    </div>
  </header>

  <main>
    <h1>Order History</h1>
    <p class="small">Your confirmed orders. These cannot be edited or deleted.</p>

    <div id="orders" class="orders-list">
      <div class="text-muted text-center p-16">Loading orders…</div>
    </div>
  </main>

</div>

<!-- Order Detail Modal -->
<div class="modal" id="detailModal">
  <div class="modal-box modal-scrollable">
    <button class="close-x" id="closeModal">✕</button>
    <h2>Order Details</h2>
    <pre id="detailContent" class="white-space-preline mt-12"></pre>
  </div>
</div>

<div id="toast" class="toast">Saved</div>

<script type="module">
(async () => {

  /* ===============================
     FIREBASE SETUP
     =============================== */

  const firebaseConfig = {
    apiKey: "AIzaSyBozW19Rjc9nj0YabOIE3DlW0qVHtU5XLA",
    authDomain: "hamsasarees-24738.firebaseapp.com",
    projectId: "hamsasarees-24738",
    storageBucket: "hamsasarees-24738.firebasestorage.app",
    messagingSenderId: "16303342424",
    appId: "1:16303342424:web:d68d26160d45472713db2d"
  };

  const { initializeApp } =
    await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js');
  const { getAuth, onAuthStateChanged, signOut } =
    await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js');
  const { getFirestore, collection, query, where, orderBy, getDocs } =
    await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  const $ = id => document.getElementById(id);

  /* ===============================
     AUTH REQUIRED
     =============================== */

  let currentUser = null;

  await new Promise(resolve => {
    onAuthStateChanged(auth, user => {
      if (!user) {
        alert('Please sign in to view your orders.');
        location.href = 'index.html';
      } else {
        currentUser = user;
        $('userBadge').style.display = 'block';
        $('userBadge').textContent = user.displayName || user.email;
        resolve();
      }
    });
  });

  $('signOutBtn').addEventListener('click', async () => {
    await signOut(auth);
    location.href = 'index.html';
  });

  /* ===============================
     LOAD ORDERS (AUTHORITATIVE)
     =============================== */

  const ordersEl = $('orders');

  const q = query(
    collection(db, 'orders'),
    where('userId', '==', currentUser.uid),
    orderBy('createdAt', 'desc')
  );

  const snap = await getDocs(q);

  if (snap.empty) {
    ordersEl.innerHTML =
      '<div class="text-muted text-center p-16">No orders yet.</div>';
    return;
  }

  ordersEl.innerHTML = '';

  snap.forEach(doc => {
    const o = doc.data();
    const id = doc.id;

    const card = document.createElement('div');
    card.className = 'card order-card';

    card.innerHTML = `
      <div class="order-card-header">
        <div class="order-info">
          <strong>${o.productSnapshot.title}</strong>
          <div class="small">₹${o.productSnapshot.price}</div>
          <div class="small text-muted">
            ${o.createdAt?.toDate().toLocaleString() || ''}
          </div>
        </div>
        <div class="order-actions">
          <button class="btn-ghost viewBtn" data-id="${id}">View</button>
        </div>
      </div>
    `;

    ordersEl.appendChild(card);

    card.querySelector('.viewBtn').addEventListener('click', () => {
      $('detailContent').textContent =
`Order ID: ${id}

Product: ${o.productSnapshot.title}
Price: ₹${o.productSnapshot.price}

Buyer:
${o.buyer.name}
${o.buyer.phone}
${o.buyer.address}

Payment:
Provider: ${o.payment.provider}
Status: ${o.payment.status}
Payment ID: ${o.payment.paymentId || '—'}

Ordered at:
${o.createdAt?.toDate().toLocaleString() || ''}`;

      openModal();
    });
  });

  /* ===============================
     MODAL HELPERS
     =============================== */

  const modal = $('detailModal');

  function openModal() {
    modal.classList.add('show');
    document.body.style.overflow = 'hidden';
  }

  function closeModal() {
    modal.classList.remove('show');
    document.body.style.overflow = '';
  }

  $('closeModal').addEventListener('click', closeModal);
  modal.addEventListener('click', e => {
    if (e.target === modal) closeModal();
  });

})();
</script>

</body>
</html>
