<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Hamsa Sarees — Single Page (Fixed + Admin Orders Table)</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">
<style>
  :root{ --bg1:#001f3f; --bg2:#00306b; --accent:#00aaff; --accent2:#4dd0e1; --muted:#9fb8d9; --success:#10b981; --card:#071522; --glass:rgba(255,255,255,0.03); }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;font-family:Inter,system-ui,Arial,sans-serif;background:linear-gradient(180deg,var(--bg1),var(--bg2));color:#eaf6ff;-webkit-font-smoothing:antialiased}
  a{color:inherit}
  .container{max-width:1100px;margin:20px auto;padding:0 16px}
  header{display:flex;align-items:center;justify-content:space-between;gap:12px;padding:12px}
  .brand{display:flex;gap:12px;align-items:center}
  .logo{width:44px;height:44px;border-radius:10px;background:linear-gradient(135deg,var(--accent),var(--accent2));display:flex;align-items:center;justify-content:center;font-weight:800;color:#032033;box-shadow:0 12px 40px rgba(0,170,255,0.12)}
  .title{font-weight:800}
  .search{display:flex;align-items:center;background:var(--glass);padding:8px;border-radius:10px;gap:8px;border:1px solid rgba(255,255,255,0.02)}
  .search input{background:transparent;border:none;color:#eaf6ff;outline:none;width:220px}
  .actions{display:flex;gap:8px;align-items:center}
  .btn{cursor:pointer;border-radius:10px;padding:9px 14px;border:none;font-weight:700;background:linear-gradient(90deg,var(--accent),#ff5aa3);color:#fff;box-shadow:0 8px 24px rgba(0,170,255,0.12);transition:transform .15s,filter .15s}
  .btn:active{transform:translateY(1px)}
  .btn-ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);color:#fff;padding:8px 12px;border-radius:10px}
  .hero{display:flex;gap:16px;align-items:flex-start;margin-top:8px}
  .hero-card{flex:1;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));padding:18px;border-radius:12px;backdrop-filter: blur(6px)}
  .promo{width:260px;padding:12px;border-radius:10px;background:linear-gradient(135deg,#061526,#072234);box-shadow:0 10px 40px rgba(0,0,0,0.4)}
  .grid{display:grid;grid-template-columns:repeat(3,1fr);gap:14px;margin-top:16px}
  .card{background:linear-gradient(180deg,#071522,#06121a);padding:12px;border-radius:12px;transition:transform .2s,box-shadow .2s;overflow:hidden;position:relative}
  .card:hover{transform:translateY(-8px);box-shadow:0 24px 60px rgba(2,6,23,0.6)}
  .imgwrap{height:180px;border-radius:10px;background:#081522;display:flex;align-items:center;justify-content:center;overflow:hidden}
  .imgwrap img{width:100%;height:100%;object-fit:cover;display:block}
  h3{margin:10px 0 6px;color:#eaf6ff}
  .price{color:#7ee0b2;font-weight:800}
  .tag{position:absolute;top:10px;left:10px;background:rgba(0,0,0,0.4);padding:6px 8px;border-radius:8px;font-size:12px}
  .product-rating{font-weight:700;margin-left:8px}
  .rating-ui{display:flex;gap:6px;margin-top:6px}
  .rating-ui .rateBtn{width:34px;height:34px;padding:0;border-radius:8px}
  .orders-list{max-height:60vh;overflow:auto;border-radius:10px;padding:8px;background:linear-gradient(180deg,#06131a,#071722)}
  .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:linear-gradient(180deg,rgba(3,8,20,0.6),rgba(2,8,18,0.85));z-index:1200;padding:12px}
  .modal.show{display:flex}
  .modal-box{max-width:920px;width:100%;background:linear-gradient(180deg,#071522,#06121a);border-radius:12px;padding:16px;color:#eaf6ff;position:relative;box-shadow:0 30px 80px rgba(2,6,23,0.6)}
  .close-x{position:absolute;top:12px;right:12px;background:transparent;border:none;color:#ff3b3b;font-weight:800;font-size:18px;cursor:pointer}
  .field{display:flex;flex-direction:column;margin-top:10px}
  .field input,.field textarea,select{padding:12px;border-radius:10px;border:none;background:#08121a;color:#dbeafe}
  .small{color:var(--muted)}
  table{width:100%;border-collapse:collapse;margin-top:12px}
  th,td{padding:10px;border-bottom:1px solid rgba(255,255,255,0.04);text-align:left}
  th{color:var(--muted);font-weight:700}
  tr:hover td{background:rgba(255,255,255,0.01)}
  .status-select{padding:8px;border-radius:8px;border:none;background:#08121a;color:#dbeafe}
  @media (max-width:1000px){ .grid{grid-template-columns:repeat(2,1fr)} .promo{display:none} .search input{width:140px} .modal-box{max-width:680px} }
  @media (max-width:640px){ header{flex-direction:column;align-items:stretch;padding:12px 16px} .search{width:100%;margin-top:8px} .grid{grid-template-columns:1fr} .imgwrap{height:200px} .modal-box{width:100%;height:100%;border-radius:12px 12px 0 0;max-width:none;display:flex;flex-direction:column;overflow:auto;padding:14px} }
  .toast{position:fixed;right:16px;bottom:16px;background:#0b1220;padding:10px 14px;border-radius:10px;color:#d1fae5;border-left:4px solid var(--success);box-shadow:0 8px 30px rgba(2,6,23,0.6);display:none}
</style>
</head>
<body>
  <div class="container">
    <header>
      <div class="brand">
        <div class="logo" aria-hidden="true">HS</div>
        <div>
          <div class="title">Hamsa Sarees</div>
          <div class="small">Handpicked • Ethnic • Quality</div>
        </div>
      </div>

      <div style="flex:1;display:flex;justify-content:center">
        <div class="search" role="search" aria-label="Search products">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M21 21l-4.35-4.35" stroke="#9fb6c9" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
          <input id="searchBox" placeholder="Search sarees, cotton, silk..." aria-label="Search products" />
        </div>
      </div>

      <div class="actions">
        <button id="adminBtn" class="btn-ghost" style="display:none" aria-hidden="true">Admin</button>
        <button id="adminOrdersBtn" class="btn-ghost" style="display:none">All Orders</button>
        <div id="userBadge" style="display:none;background:rgba(255,255,255,0.03);padding:8px 10px;border-radius:10px;color:#fff;font-weight:700"></div>
        <button id="myOrdersBtn" class="btn-ghost" style="display:none">My Orders</button>
        <button id="signOutBtn" class="btn-ghost" style="display:none">Sign out</button>
        <button id="loginShowBtn" class="btn">Sign in</button>
      </div>
    </header>

    <main>
      <section class="hero" style="gap:16px">
        <div class="hero-card">
          <h1>Real sarees. Real people. Real style.</h1>
          <p class="small">Curated collection, saved orders for your account, and a smooth checkout. Mobile-first.</p>
          <div style="margin-top:14px;display:flex;gap:10px">
            <button id="shopNow" class="btn">Shop Now</button>
            <button id="exploreBtn" class="btn-ghost">Collections</button>
          </div>
        </div>

        <aside class="promo" aria-hidden="true">
          <strong>Limited Offer</strong>
          <div class="small" style="margin-top:8px">Free shipping on orders above ₹3000</div>
          <div style="margin-top:12px;font-weight:800;color:#7ee0b2">Best Seller: Elegant Cotton — ₹1499</div>
        </aside>
      </section>

      <section style="margin-top:12px">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <h2 style="margin:0">Products</h2>
          <div class="small">Sign in to place orders; orders saved to your account</div>
        </div>
        <div class="grid" id="productGrid" aria-live="polite">
          <div class="card" style="grid-column:1/-1;text-align:center;color:var(--muted);padding:32px;background:transparent">
            <strong style="color:#eaf6ff">No products yet</strong>
            <div class="small" style="margin-top:8px">As admin, open Admin → Add Product to upload items. The product grid updates live for users.</div>
            <div style="margin-top:12px"><button id="openAdminFromEmpty" class="btn-ghost">Open Admin</button></div>
          </div>
        </div>
      </section>
    </main>
  </div>

  <!-- Modals (Order, Login, Payment, My Orders, Admin, Detail, Admin Orders) -->
  <div class="modal" id="orderModal" aria-hidden="true">
    <div class="modal-box" role="dialog" aria-modal="true">
      <button class="close-x" id="closeOrderModal" title="Close">✕</button>
      <h2 id="orderModalTitle">Confirm Your Order</h2>
      <p class="small" id="selectedProduct"></p>
      <form id="orderForm" method="POST" target="hiddenFrame" action="https://docs.google.com/forms/d/e/1FAIpQLSfREKvTld9R59UADJQK6jxQIbM64tt1iP0M-XiPq4ykOOwe5w/formResponse">
        <div class="field"><label class="sr-only" for="custName">Your name</label><input id="custName" name="entry.1128392407" placeholder="Your Name" required></div>
        <div class="field"><label class="sr-only" for="custAddress">Address</label><textarea id="custAddress" name="entry.654904844" placeholder="Address" required></textarea></div>
        <div class="field"><label class="sr-only" for="custPhone">Mobile number</label><input id="custPhone" name="entry.1644126654" placeholder="Mobile Number" required></div>
        <div class="field"><input id="productField" name="entry.1866699911" readonly aria-readonly="true"></div>
        <div class="modal-footer" style="margin-top:12px;display:flex;gap:8px;justify-content:flex-end">
          <button class="btn" id="placeOrder">Place Order</button>
          <button type="button" class="btn-ghost" id="cancelOrder">Cancel</button>
        </div>
      </form>
      <div id="orderStatus" class="small" style="margin-top:10px;color:var(--success);display:none">Order placed. Thank you!</div>
    </div>
  </div>

  <div class="modal" id="loginModal" aria-hidden="true">
    <div class="modal-box" role="dialog" aria-modal="true">
      <button class="close-x" id="closeLogin" title="Close">✕</button>
      <h2>Sign in with Google</h2>
      <p class="small">No typing required — uses Google auth.</p>
      <div style="display:flex;justify-content:center;margin-top:12px">
        <button id="googleBtnLarge" class="btn">Sign in with Google</button>
      </div>
      <p id="loginErr" class="small" style="margin-top:12px;color:#ffb4b4;display:none"></p>
    </div>
  </div>

  <div class="modal" id="paymentModal" aria-hidden="true">
    <div class="modal-box" role="dialog" aria-modal="true">
      <button class="close-x" id="closePayment" title="Close">✕</button>
      <h2>Payment</h2>
      <p class="small" id="paymentSummary" style="white-space:pre-line"></p>
      <div style="margin-top:12px;display:flex;gap:10px;flex-direction:column">
        <label class="small">Select Payment Method</label>
        <select id="paymentMethod" style="padding:12px;border-radius:10px;border:none;background:#08121a;color:#dbeafe">
          <option value="card">Card (Test)</option>
          <option value="upi">UPI (Test)</option>
          <option value="cod">Cash on Delivery</option>
        </select>
        <button class="btn" id="payNow">Pay Now</button>
      </div>
      <div id="paymentMsg" class="small" style="margin-top:10px;color:var(--success);display:none">Payment successful. Finalizing order...</div>
    </div>
  </div>

  <div class="modal" id="myOrdersModal" aria-hidden="true">
    <div class="modal-box" role="dialog" aria-modal="true">
      <button class="close-x" id="closeMyOrdersX" title="Close">✕</button>
      <h2>My Orders</h2>
      <div class="orders-list" id="ordersList"></div>
      <div style="display:flex;gap:10px;margin-top:12px"><button id="closeOrders" class="btn-ghost">Close</button></div>
    </div>
  </div>

  <div class="modal" id="orderDetailModal" aria-hidden="true">
    <div class="modal-box" role="dialog" aria-modal="true">
      <button class="close-x" id="closeOrderDetail" title="Close">✕</button>
      <h2>Order Details</h2>
      <div id="orderDetailContent" class="small" style="white-space:pre-line;margin-top:8px"></div>
      <div style="display:flex;gap:10px;margin-top:12px;justify-content:flex-end"><button id="closeDetailBtn" class="btn-ghost">Close</button></div>
    </div>
  </div>

  <div class="modal" id="adminModal" aria-hidden="true">
    <div class="modal-box" role="dialog" aria-modal="true">
      <button class="close-x" id="closeAdmin" title="Close">✕</button>
      <h2>Admin — Add Product</h2>
      <p class="small">Products added here are saved to Firestore (admin-only).</p>
      <div class="field"><label class="small">Title</label><input id="admin_pTitle" placeholder="Product title"></div>
      <div class="field"><label class="small">Price (₹)</label><input id="admin_pPrice" type="number" placeholder="1499"></div>
      <div class="field"><label class="small">Tag</label><input id="admin_pTag" placeholder="e.g. New, Best"></div>
      <div class="field"><label class="small">Image URL</label><input id="admin_pImg" placeholder="https://..."></div>
      <div style="margin-top:12px;display:flex;gap:8px;justify-content:flex-end">
        <button id="adminSave" class="btn">Add Product</button>
        <button id="adminCancel" class="btn-ghost">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Admin Orders Modal: Table View -->
  <div class="modal" id="adminOrdersModal" aria-hidden="true">
    <div class="modal-box" role="dialog" aria-modal="true">
      <button class="close-x" id="closeAdminOrders" title="Close">✕</button>
      <h2>All Customer Orders</h2>
      <p class="small">Visible to admin only. Use this table to update status or delete orders.</p>
      <div id="adminOrdersContainer">
        <table id="adminOrdersTable">
          <thead>
            <tr><th>Order ID</th><th>Product</th><th>Name</th><th>Phone</th><th>Address</th><th>Date</th><th>Status</th><th>Actions</th></tr>
          </thead>
          <tbody id="adminOrdersTbody"></tbody>
        </table>
      </div>
      <div style="display:flex;gap:10px;margin-top:12px;justify-content:flex-end"><button id="refreshAdminOrders" class="btn-ghost">Refresh</button><button id="closeAdminOrdersBtn" class="btn-ghost">Close</button></div>
    </div>
  </div>

  <iframe name="hiddenFrame" style="display:none"></iframe>
  <div id="toast" class="toast" role="status" aria-live="polite">Saved.</div>

<script type="module">
(async function(){
  if(document.readyState === 'loading') await new Promise(r=>document.addEventListener('DOMContentLoaded', r));

  // UI-only admin UID sentinel — DO NOT rely on this for security. Add Firestore rules + custom claims.
  const ADMIN_UID = 'EenXHJIvZpavhkGTCI8EZyFAfH93';
  const firebaseConfig = {
    apiKey: "AIzaSyBozW19Rjc9nj0YabOIE3DlW0qVHtU5XLA",
    authDomain: "hamsasarees-24738.firebaseapp.com",
    projectId: "hamsasarees-24738",
    storageBucket: "hamsasarees-24738.firebasestorage.app",
    messagingSenderId: "16303342424",
    appId: "1:16303342424:web:d68d26160d45472713db2d",
    measurementId: "G-1G1HQGJ5XS"
  };

  function escapeHtml(s){ return String(s===undefined||s===null?'':s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

  try{
    const { initializeApp } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js');
    const authMod = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js');
    const fsMod = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');

    const { getAuth, GoogleAuthProvider, signInWithPopup, signInWithRedirect, getRedirectResult, signOut, onAuthStateChanged } = authMod;
    const { getFirestore, collection, addDoc, setDoc, doc, deleteDoc, serverTimestamp, query, orderBy, getDocs, onSnapshot, updateDoc } = fsMod;

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const googleProvider = new GoogleAuthProvider();

    const $ = id => document.getElementById(id);
    const loginModal = $('loginModal'), orderModal = $('orderModal'), paymentModal = $('paymentModal'), myOrdersModal = $('myOrdersModal'), adminModal = $('adminModal');
    const loginErr = $('loginErr'), userBadge = $('userBadge'), signOutBtn = $('signOutBtn'), loginShowBtn = $('loginShowBtn'), googleBtnLarge = $('googleBtnLarge');
    const myOrdersBtn = $('myOrdersBtn'), ordersList = $('ordersList'), toastEl = $('toast');
    const adminBtn = $('adminBtn'), adminOrdersBtn = $('adminOrdersBtn');

    function toast(msg){ if(!toastEl) return; toastEl.innerText = msg; toastEl.style.display = 'block'; setTimeout(()=>toastEl.style.display = 'none', 2200); }
    function showLoginError(msg){ if(!loginErr) return; loginErr.innerText = msg; loginErr.style.display = msg ? 'block' : 'none'; }

    function openModal(modal){ if(!modal) return; modal.classList.add('show'); modal.removeAttribute('aria-hidden'); document.body.style.overflow = 'hidden'; }
    function closeModal(modal){ if(!modal) return; modal.classList.remove('show'); modal.setAttribute('aria-hidden','true'); document.body.style.overflow = ''; }

    // backdrop & Esc
    document.addEventListener('click', (ev)=>{ const m = ev.target.closest('.modal'); if(m && !ev.target.closest('.modal-box')){ closeModal(m); } });
    document.addEventListener('keydown', (ev)=>{ if(ev.key === 'Escape'){ document.querySelectorAll('.modal.show').forEach(m=>closeModal(m)); } });

    try{ const rr = await getRedirectResult(auth); if(rr && rr.user) console.log('redirect sign-in OK', rr.user.uid); }catch(e){ console.warn('redirect result', e && e.code); }

    async function signInPopup(){ showLoginError(''); try{ await signInWithPopup(auth, googleProvider); toast('Signed in'); }catch(e){ console.error('sign-in error', e && e.code, e && e.message); const popupErrors = ['auth/popup-blocked','auth/popup-closed-by-user','auth/cancelled-popup-request']; if(e && popupErrors.includes(e.code)){ try{ await signInWithRedirect(auth, googleProvider); return; }catch(err){ showLoginError('Popup blocked and redirect failed. Allow popups or try another browser.'); return; } } if(e && e.code === 'auth/unauthorized-domain'){ showLoginError('Domain not authorized. Add your hosting domain in Firebase console → Authentication → Authorized domains.'); } else showLoginError(e && e.message ? e.message : 'Sign-in failed'); } }
    googleBtnLarge && googleBtnLarge.addEventListener('click', ()=>signInPopup());
    loginShowBtn && loginShowBtn.addEventListener('click', ()=>{ openModal(loginModal); });

    signOutBtn && signOutBtn.addEventListener('click', async () => { try{ await signOut(auth); toast('Signed out'); }catch(e){ console.error('signout failed', e); } });

    // PRODUCTS rendering
    const productGrid = $('productGrid');
    const productsColRef = collection(db, 'products');

    function renderProductCard(docSnap){
      const id = docSnap.id; const data = docSnap.data() || {};
      const title = data.title || 'Untitled'; const tag = data.tag || ''; const img = data.img || '';
      const price = data.price || '0'; const avg = data._avg ? Number(data._avg).toFixed(1) : null; const avgDisplay = avg ? `★ ${avg} (${data._count||0})` : 'No ratings';
      const card = document.createElement('div'); card.className = 'card'; card.dataset.pid = id;
      if(tag){ const tagEl = document.createElement('div'); tagEl.className = 'tag'; tagEl.textContent = tag; card.appendChild(tagEl); }
      const imgWrap = document.createElement('div'); imgWrap.className = 'imgwrap'; const imgEl = document.createElement('img'); imgEl.loading='lazy'; imgEl.src = img; imgEl.alt = title; imgWrap.appendChild(imgEl); card.appendChild(imgWrap);
      const h3 = document.createElement('h3'); h3.textContent = title; card.appendChild(h3);
      const row = document.createElement('div'); row.style.display='flex'; row.style.justifyContent='space-between'; row.style.alignItems='center';
      const priceEl = document.createElement('div'); priceEl.className='price'; priceEl.textContent = `₹${price}`;
      const ratingWrap = document.createElement('div'); ratingWrap.style.display='flex'; ratingWrap.style.alignItems='center';
      const rEl = document.createElement('div'); rEl.className='product-rating small'; rEl.dataset.pid = id; rEl.textContent = avgDisplay; ratingWrap.appendChild(rEl);
      row.appendChild(priceEl); row.appendChild(ratingWrap); card.appendChild(row);
      const ratingUI = document.createElement('div'); ratingUI.className='rating-ui'; ratingUI.style.marginTop='8px'; for(let i=1;i<=5;i++){ const b=document.createElement('button'); b.className='rateBtn btn-ghost'; b.dataset.rating=String(i); b.type='button'; b.textContent=String(i); ratingUI.appendChild(b); }
      card.appendChild(ratingUI);
      const orderWrap=document.createElement('div'); orderWrap.style.marginTop='8px'; const orderBtn=document.createElement('button'); orderBtn.className='orderBtn btn'; orderBtn.type='button'; orderBtn.dataset.product=title; orderBtn.textContent='Order Now'; orderWrap.appendChild(orderBtn); card.appendChild(orderWrap);
      return card;
    }

    let productsUnsub = null;
    try{
      productsUnsub = onSnapshot(productsColRef, snap=>{
        productGrid.innerHTML=''; 
        if(snap.empty){
          const fallback = document.createElement('div'); fallback.className='card'; fallback.style.gridColumn='1/-1'; fallback.style.textAlign='center'; fallback.style.color='var(--muted)'; fallback.style.padding='32px';
          fallback.innerHTML = '<strong style="color:#eaf6ff">No products yet</strong><div class="small" style="margin-top:8px">As admin, open Admin → Add Product to upload items. The product grid updates live for users.</div><div style="margin-top:12px"><button id="openAdminFromEmptyInner" class="btn-ghost">Open Admin</button></div>';
          productGrid.appendChild(fallback);
          setTimeout(()=>{ document.getElementById('openAdminFromEmptyInner')?.addEventListener('click', ()=>{ if(!auth.currentUser){ openModal(loginModal); showLoginError('Sign in as admin to add products'); return; } if(auth.currentUser.uid !== ADMIN_UID){ alert('You are not admin'); return; } openModal(adminModal); }); },50);
          return;
        }
        snap.forEach(d=>{ const card=renderProductCard(d); productGrid.appendChild(card); });
        attachRatingListenersToGrid();
      }, err=>{ console.error('products snapshot error', err); });
    }catch(e){ console.warn('products onSnapshot not available', e); }

    // order click delegation
    productGrid.addEventListener('click', ev=>{ const btn = ev.target.closest('.orderBtn'); if(!btn) return; const prod = btn.getAttribute('data-product') || ''; if(!auth.currentUser){ openModal(loginModal); showLoginError('Please sign in with Google to place orders'); return; } const sel = $('selectedProduct'); if(sel) sel.innerText = prod; const pf = $('productField'); if(pf) pf.value = prod; openModal(orderModal); });

    // ratings
    function attachRatingListenersToGrid(){ 
      document.querySelectorAll('#productGrid .card').forEach(card=>{
        const pid = card.dataset.pid; if(!pid) return;
        card.querySelectorAll('.rateBtn').forEach(btn=>{
          if(btn._bound) return; btn._bound = true;
          btn.addEventListener('click', async (ev)=>{
            if(!auth.currentUser){ alert('Sign in to rate products'); return; }
            const uid = auth.currentUser.uid; const rating = Number(ev.currentTarget.dataset.rating);
            try{
              const ratingRef = doc(db, 'products', pid, 'ratings', uid);
              await setDoc(ratingRef, { rating: rating, createdAt: serverTimestamp() });
              toast('Thanks for rating');
            }catch(err){ console.error('rating save failed', err); alert('Failed to save rating'); }
          });
        });

        if(card._ratingsUnsub) return;
        try{
          const ratingsColRef = collection(db, 'products', pid, 'ratings');
          card._ratingsUnsub = onSnapshot(ratingsColRef, snap=>{
            let sum=0,cnt=0;
            snap.forEach(s=>{ const d=s.data(); if(d && typeof d.rating==='number'){ sum+=d.rating; cnt++; } });
            const avg = cnt ? (sum/cnt) : null;
            const rEl = card.querySelector(`.product-rating[data-pid="${pid}"]`);
            if(rEl) rEl.innerText = avg ? `★ ${avg.toFixed(1)} (${cnt})` : 'No ratings';
          }, err=>{ console.error('ratings snapshot failed', err); });
        }catch(e){ console.warn('ratings onSnapshot error', e); }
      });
    }

    // ORDERS flow
    $('placeOrder').addEventListener('click', ev=>{
      ev.preventDefault();
      const name=$('custName').value.trim(), address=$('custAddress').value.trim(), phone=$('custPhone').value.trim();
      const product=$('productField').value||'';
      if(!name||!address||!phone){ alert('Fill all fields'); return; }
      if(!/^[6-9]\d{9}$/.test(phone)){ alert('Enter a valid 10-digit Indian mobile number'); return; }
      window.pendingOrder={product,name,address,phone};
      closeModal(orderModal);
      const ps=$('paymentSummary'); if(ps) ps.innerText=`${product}\nName: ${name}\nPhone: ${phone}`;
      openModal(paymentModal);
    });

    $('payNow').addEventListener('click', async ()=>{
      const payNowBtn=$('payNow'); const paymentMsg=$('paymentMsg');
      if(paymentMsg) paymentMsg.style.display='block';
      if(payNowBtn) payNowBtn.disabled=true;
      try{
        try{ document.getElementById('orderForm').submit(); }catch(e){ console.warn('form.submit failed', e); }
        await new Promise(res=>setTimeout(res,800));
        const uid = auth.currentUser ? auth.currentUser.uid : null;
        const orderData = { ...(window.pendingOrder||{}), user: uid, userEmail: auth.currentUser ? auth.currentUser.email : null, status: 'Pending', createdAt: serverTimestamp() };
        if(uid){
          const userOrderRef = await addDoc(collection(db, 'users', uid, 'orders'), orderData);
          await addDoc(collection(db, 'orders'), { ...orderData, userRef: userOrderRef.id });
          window.lastOrderId = userOrderRef.id;
        } else {
          const globalOrderRef = await addDoc(collection(db, 'orders'), orderData);
          window.lastOrderId = globalOrderRef.id;
        }
        if(paymentMsg) paymentMsg.style.display='none';
        const os=$('orderStatus'); if(os){ os.innerText='Order placed and payment received. Thank you!'; os.style.display='block'; }
        toast('Order successful');
        setTimeout(()=>{
          closeModal(paymentModal);
          if(os) os.style.display='none';
          if(document.getElementById('orderForm')) document.getElementById('orderForm').reset();
          window.pendingOrder=null;
          if(payNowBtn) payNowBtn.disabled=false;
        },1200);
      }catch(err){
        console.error('save after payment failed', err);
        showLoginError('Payment succeeded but saving order failed. See console.');
        if(payNowBtn) payNowBtn.disabled=false;
        if(paymentMsg) paymentMsg.style.display='none';
      }
    });

    // User orders
    async function loadUserOrders(){
      if(!auth.currentUser){ ordersList.innerHTML = '<div class="small">Please sign in</div>'; return; }
      ordersList.innerHTML = '<div class="small">Loading...</div>';
      try{
        const uid = auth.currentUser.uid;
        const q = query(collection(db, 'users', uid, 'orders'), orderBy('createdAt','desc'));
        const snap = await getDocs(q);
        if(snap.empty){ ordersList.innerHTML = '<div class="small">No orders yet</div>'; return; }
        ordersList.innerHTML = '';
        snap.forEach(docSnap=>{
          const o=docSnap.data(); const id=docSnap.id;
          const el=document.createElement('div'); el.style.padding='10px'; el.style.borderBottom='1px solid rgba(255,255,255,0.03)';
          const dt=(o.createdAt && o.createdAt.toDate)?o.createdAt.toDate().toLocaleString():'';
          el.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center"><div><strong style="color:#fff">${escapeHtml(o.product||'')}</strong><div class="small">${escapeHtml(o.name||'')} • ${escapeHtml(o.phone||'')}</div><div class="small" style="color:var(--muted)">${escapeHtml(dt)}</div></div><div style="display:flex;flex-direction:column;gap:6px;align-items:flex-end"><button class="btn-ghost viewOrderBtn" data-id="${id}" type="button">View</button><button class="btn deleteOrderBtn" data-id="${id}" type="button">Delete</button></div></div>`;
          el.querySelector('.viewOrderBtn').dataset.product=o.product||'';
          el.querySelector('.viewOrderBtn').dataset.name=o.name||'';
          el.querySelector('.viewOrderBtn').dataset.phone=o.phone||'';
          el.querySelector('.viewOrderBtn').dataset.address=o.address||'';
          ordersList.appendChild(el);
        });
        ordersList.querySelectorAll('.deleteOrderBtn').forEach(b=>{
          b.addEventListener('click', async ev=>{
            const id = ev.currentTarget.getAttribute('data-id'); if(!id) return;
            const ok = confirm('Delete this order permanently from your account? This cannot be undone.');
            if(!ok) return;
            try{
              const uid = auth.currentUser.uid;
              await deleteDoc(doc(db, 'users', uid, 'orders', id));
              toast('Order deleted');
              await loadUserOrders();
            }catch(err){ console.error('delete failed', err); alert('Failed to delete order. See console.'); }
          });
        });
        ordersList.querySelectorAll('.viewOrderBtn').forEach(b=>{
          b.addEventListener('click', ev=>{
            const btn = ev.currentTarget;
            const p = btn.dataset.product || '';
            const n = btn.dataset.name || '';
            const ph = btn.dataset.phone || '';
            const a = btn.dataset.address || '';
            orderDetailContent.innerText = `Product: ${p}\nName: ${n}\nPhone: ${ph}\nAddress: ${a}`;
            openModal(orderDetailModal);
          });
        });
      }catch(e){ console.error('fetch orders failed', e); ordersList.innerHTML = '<div class="small">Failed to load orders</div>'; }
    }

    myOrdersBtn && myOrdersBtn.addEventListener('click', async ()=>{ if(!auth.currentUser){ openModal(loginModal); showLoginError('Please sign in to view your orders'); return; } await loadUserOrders(); openModal(myOrdersModal); });

    // Admin: add product
    adminBtn && adminBtn.addEventListener('click', ()=>{ if(!auth.currentUser){ alert('Sign in as admin'); return; } if(auth.currentUser.uid !== ADMIN_UID){ alert('You are not admin'); return; } openModal(adminModal); });
    $('adminCancel').addEventListener('click', ()=>{ closeModal(adminModal); });
    $('adminSave').addEventListener('click', async ()=>{ const title=$('admin_pTitle').value.trim(); const price=Number($('admin_pPrice').value.trim()); const tag=$('admin_pTag').value.trim(); const img=$('admin_pImg').value.trim(); if(!title||!price){ alert('Title and price required'); return; } if(!auth.currentUser || auth.currentUser.uid !== ADMIN_UID){ alert('Only admin can add products'); return; } try{ const payload={ title, price, tag, img, createdAt: serverTimestamp() }; await addDoc(collection(db, 'products'), payload); toast('Product added (Firestore)'); closeModal(adminModal); $('admin_pTitle').value=''; $('admin_pPrice').value=''; $('admin_pTag').value=''; $('admin_pImg').value=''; }catch(err){ console.error('add product failed', err); alert('Failed to add product'); } });

    // ADMIN ORDERS — table view handlers
    const adminOrdersTbody = $('adminOrdersTbody');
    async function loadAdminOrders(){
      adminOrdersTbody.innerHTML = '<tr><td colspan="8" class="small">Loading...</td></tr>';
      try{
        const snap = await getDocs(collection(db, 'orders'));
        if(snap.empty){ adminOrdersTbody.innerHTML = '<tr><td colspan="8" class="small">No orders yet</td></tr>'; return; }
        adminOrdersTbody.innerHTML = '';
        snap.forEach(docSnap=>{
          const o = docSnap.data(); const id = docSnap.id;
          const dt = (o.createdAt && o.createdAt.toDate) ? o.createdAt.toDate().toLocaleString() : '';
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td style="max-width:120px;word-break:break-all">${escapeHtml(id)}</td>
            <td>${escapeHtml(o.product||'')}</td>
            <td>${escapeHtml(o.name||'')}</td>
            <td>${escapeHtml(o.phone||'')}</td>
            <td style="max-width:240px;word-break:break-word">${escapeHtml(o.address||'')}</td>
            <td>${escapeHtml(dt)}</td>
            <td>
              <select class="status-select" data-id="${id}">
                <option value="Pending" ${o.status==='Pending'?'selected':''}>Pending</option>
                <option value="Packed" ${o.status==='Packed'?'selected':''}>Packed</option>
                <option value="Shipped" ${o.status==='Shipped'?'selected':''}>Shipped</option>
                <option value="Delivered" ${o.status==='Delivered'?'selected':''}>Delivered</option>
              </select>
            </td>
            <td>
              <button class="btn-ghost viewAdminOrder" data-id="${id}">View</button>
              <button class="btn deleteAdminOrder" data-id="${id}">Delete</button>
            </td>`;
          adminOrdersTbody.appendChild(tr);
        });

        // attach handlers
        adminOrdersTbody.querySelectorAll('.status-select').forEach(sel=>{
          sel.addEventListener('change', async (ev)=>{
            const id = ev.currentTarget.dataset.id; const val = ev.currentTarget.value;
            const ok = confirm(`Change status of order ${id} to ${val}?`);
            if(!ok) return;
            try{ await updateDoc(doc(db, 'orders', id), { status: val }); toast('Status updated'); }
            catch(err){ console.error('status update failed', err); alert('Failed to update status'); }
          });
        });

        adminOrdersTbody.querySelectorAll('.viewAdminOrder').forEach(b=>{
          b.addEventListener('click', async ev=>{
            const id = ev.currentTarget.dataset.id;
            // quick view — in production fetch single doc and show full details
            alert('Order ID: ' + id);
          });
        });

        adminOrdersTbody.querySelectorAll('.deleteAdminOrder').forEach(b=>{
          b.addEventListener('click', async ev=>{
            const id = ev.currentTarget.dataset.id; const ok = confirm('Delete this order permanently?');
            if(!ok) return;
            try{ await deleteDoc(doc(db, 'orders', id)); toast('Order deleted'); await loadAdminOrders(); }
            catch(err){ console.error('delete order failed', err); alert('Failed to delete order'); }
          });
        });

      }catch(err){ console.error('loadAdminOrders failed', err); adminOrdersTbody.innerHTML = '<tr><td colspan="8" class="small">Failed to load orders</td></tr>'; }
    }

    adminOrdersBtn?.addEventListener('click', async ()=>{
      if(!auth.currentUser){ openModal(loginModal); showLoginError('Sign in as admin to view orders'); return; }
      if(auth.currentUser.uid !== ADMIN_UID){ alert('You are not admin'); return; }
      await loadAdminOrders();
      openModal($('adminOrdersModal'));
    });
    $('refreshAdminOrders')?.addEventListener('click', ()=>loadAdminOrders());
    $('closeAdminOrdersBtn')?.addEventListener('click', ()=>{ closeModal($('adminOrdersModal')); });

    // generic close handlers
    document.querySelectorAll('.close-x').forEach(btn=>{ btn.addEventListener('click', ()=>{ const modal = btn.closest('.modal'); closeModal(modal); }); });
    $('cancelOrder')?.addEventListener('click', ()=>{ closeModal(orderModal); });
    $('closeOrders')?.addEventListener('click', ()=>{ closeModal(myOrdersModal); });
    $('closePayment')?.addEventListener('click', ()=>{ closeModal(paymentModal); });
    $('closeOrderDetail')?.addEventListener('click', ()=>{ closeModal(orderDetailModal); });
    $('closeDetailBtn')?.addEventListener('click', ()=>{ closeModal(orderDetailModal); });

    // auth state UI
    onAuthStateChanged(auth, user=>{
      if(user){
        closeModal(loginModal);
        if(userBadge){ userBadge.style.display='inline-block'; userBadge.innerText = user.displayName || user.email; }
        if(signOutBtn) signOutBtn.style.display='inline-block';
        if(myOrdersBtn) myOrdersBtn.style.display='inline-block';
        if(loginShowBtn) loginShowBtn.style.display='none';
        if(adminBtn) adminBtn.style.display = (user.uid === ADMIN_UID) ? 'inline-block' : 'none';
        if(adminOrdersBtn) adminOrdersBtn.style.display = (user.uid === ADMIN_UID) ? 'inline-block' : 'none';
      }else{
        closeModal(loginModal);
        if(userBadge) userBadge.style.display='none';
        if(signOutBtn) signOutBtn.style.display='none';
        if(myOrdersBtn) myOrdersBtn.style.display='none';
        if(loginShowBtn) loginShowBtn.style.display='inline-block';
        if(adminBtn) adminBtn.style.display='none';
        if(adminOrdersBtn) adminOrdersBtn.style.display='none';
      }
    });

    // search debounce
    const searchBox = $('searchBox'); if(searchBox){ let searchTimer=null; searchBox.addEventListener('input', e=>{ clearTimeout(searchTimer); searchTimer = setTimeout(()=>{ const v = e.target.value.toLowerCase(); document.querySelectorAll('#productGrid .card').forEach(card=>{ const t=(card.querySelector('h3')||{innerText:''}).innerText.toLowerCase(); const tag=(card.querySelector('.tag')||{innerText:''}).innerText.toLowerCase(); const show = !v || t.includes(v) || tag.includes(v); card.style.display = show ? '' : 'none'; }); },180); }); }
    const shopNow = $('shopNow'); if(shopNow) shopNow.addEventListener('click', ()=>{ const grid=document.getElementById('productGrid'); if(grid) grid.scrollIntoView({behavior:'smooth'}); });

    document.getElementById('openAdminFromEmpty')?.addEventListener('click', ()=>{ if(!auth.currentUser){ openModal(loginModal); showLoginError('Sign in as admin to add products'); return; } if(auth.currentUser.uid !== ADMIN_UID){ alert('You are not admin'); return; } openModal(adminModal); });
    console.log('Hamsa Sarees SPA ready — admin orders added');
  }catch(err){
    console.error('Init error', err);
    alert('Initialization failed — check console.');
  }
})();
</script>

<!-- Image zoom modal -->
<div class="modal zoom-modal" id="zoomModal" aria-hidden="true">
  <div class="modal-box" role="dialog" aria-modal="true">
    <button class="close-x" id="closeZoom" title="Close">✕</button>
    <img id="zoomImg" src="" alt="Product zoom" />
  </div>
</div>

<script>
  document.addEventListener('click', function(ev){
    try{
      var target = ev.target;
      var imgEl = (target && target.closest) ? target.closest('.imgwrap img') : null;
      if(imgEl){
        var src = imgEl.getAttribute('src');
        if(!src) return;
        var zoomImg = document.getElementById('zoomImg');
        if(zoomImg) zoomImg.src = src;
        var modal = document.getElementById('zoomModal');
        if(modal) modal.classList.add('show'), modal.removeAttribute('aria-hidden'), document.body.style.overflow = 'hidden';
      }
    }catch(e){ console.error('zoom click handler failed', e); }
  });

  var closeZoomBtn = document.getElementById && document.getElementById('closeZoom');
  if(closeZoomBtn){
    closeZoomBtn.addEventListener('click', function(){
      var zoomImg = document.getElementById('zoomImg'); if(zoomImg) zoomImg.src = '';
      var modal = document.getElementById('zoomModal'); if(modal) modal.classList.remove('show'), modal.setAttribute('aria-hidden','true'), document.body.style.overflow = '';
    });
  }

  document.addEventListener('keydown', function(e){
    if(e.key === 'Escape'){
      var modal = document.getElementById('zoomModal');
      if(modal && modal.classList.contains('show')){
        modal.classList.remove('show');
        modal.setAttribute('aria-hidden','true');
        document.body.style.overflow = '';
        var zoomImg = document.getElementById('zoomImg'); if(zoomImg) zoomImg.src = '';
      }
    }
  });
</script>

</body>
</html>
