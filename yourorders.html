<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>My Orders — Hamsa Sarees</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">
<link rel="icon" href="hamsasareeslogo.jpg" type="image/jpeg">

<style>
/* ================= ROOT THEME ================= */
:root{
  --bg-main:#0a0e1a;
  --bg-panel:#11172c;
  --bg-soft:#161e3d;
  --border:rgba(255,255,255,0.08);
  --gold:#e6b566;
  --gold-dark:#cfa34e;
  --text-main:#eef2ff;
  --text-muted:#9fb0d1;
  --success:#3ddc97;
  --danger:#ff6b6b;
}

/* ================= RESET ================= */
*{box-sizing:border-box}
html,body{
  margin:0;
  font-family:Inter,system-ui,Arial,sans-serif;
  background:
    radial-gradient(900px 400px at 20% -10%, rgba(230,181,102,.12), transparent 60%),
    linear-gradient(180deg,#080c18,#0a0e1a);
  color:var(--text-main);
}
/* ================= SCROLLBAR ================= */
::-webkit-scrollbar { width: 8px; height: 8px; }
::-webkit-scrollbar-track { background: var(--bg-main); }
::-webkit-scrollbar-thumb { background: var(--border); border-radius: 4px; }
::-webkit-scrollbar-thumb:hover { background: var(--text-muted); }
/* ================= SELECTION ================= */
::selection { background: var(--gold); color: #0a0e1a; }
::-moz-selection { background: var(--gold); color: #0a0e1a; }
::placeholder { color: var(--text-muted); opacity: 0.6; }
.bg-noise { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 0; opacity: 0.04; background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)'/%3E%3C/svg%3E"); }
.container{position: relative; z-index: 1; max-width:1200px;margin:auto;padding:20px 16px}
header{
  display:flex;
  align-items:center;
  gap:18px;
  padding:16px 18px;
  border-radius:16px;
  background: rgba(255, 255, 255, 0.03);
  backdrop-filter: blur(12px);
  border:1px solid rgba(255,255,255,0.05);
  box-shadow:0 20px 50px rgba(0,0,0,0.3);
}
@media(max-width:768px){
  header{flex-direction:column; gap: 16px;}
}
.brand{ display:flex; gap:14px; align-items:center; }
.logo{ width:52px; height:52px; border-radius:14px; overflow:hidden; border: 1px solid rgba(255,255,255,0.1); box-shadow: 0 4px 10px rgba(0,0,0,0.2); flex-shrink: 0; }
.logo img { width: 100%; height: 100%; object-fit: cover; }
.title{ font-weight:800; font-size:18px; letter-spacing: -0.01em; line-height: 1.2; }
.small{ font-size:13px; color:var(--text-muted); }
.actions{display:flex;gap:8px;align-items:center}
.btn{
  font-family:inherit;
  background:linear-gradient(90deg,var(--gold),#f3d48c);
  color:#3b2b08;
  border:none;
  padding:10px 18px;
  border-radius:14px;
  font-weight:800;
  cursor:pointer;
  box-shadow:0 10px 30px rgba(230,181,102,.35);
  text-decoration: none;
  transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
}
.btn:active {
  transform: scale(0.96);
}
.btn-ghost{
  font-family:inherit;
  background:#0f1738;
  border:1px solid var(--border);
  color:var(--text-main);
  padding:9px 16px;
  border-radius:14px;
  cursor:pointer;
  text-decoration: none;
  transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
}
.btn-ghost:active {
  transform: scale(0.96);
}
.order-card{
  background: rgba(255, 255, 255, 0.02);
  backdrop-filter: blur(10px);
  border:1px solid rgba(255,255,255,0.05);
  border-radius:18px;
  padding:20px;
  margin-bottom:16px;
  display: grid;
  grid-template-columns: 80px 1fr minmax(100px, auto);
  gap: 20px;
  align-items: center;
  animation: fadeIn 0.5s cubic-bezier(0.25, 0.8, 0.25, 1) backwards;
  transition: transform 0.2s ease, box-shadow 0.2s ease, border-color 0.2s ease;
}
.order-card:hover {
  transform: translateY(-4px);
  box-shadow: 0 15px 30px rgba(0,0,0,0.25);
  border-color: rgba(230, 181, 102, 0.4);
}
.order-card img { border-radius: 10px; width: 80px; height: 100px; object-fit: cover; }
.order-info strong{display:block;font-size:16px;margin-bottom:6px}
.order-status { text-align: right; }
.modal{
  position:fixed;inset:0;display:none;
  background:rgba(5,8,15,.9);
  backdrop-filter: blur(8px);
  -webkit-backdrop-filter: blur(8px);
  align-items:center;justify-content:center
}
.modal.show{display:flex}
@keyframes fadeIn { from { opacity:0; transform:translateY(10px); } to { opacity:1; transform:translateY(0); } }
.modal-box{
  background: rgba(22, 32, 81, 0.95);
  backdrop-filter: blur(16px);
  border:1px solid var(--border);
  border-radius:20px;
  padding:24px;
  max-width:700px;
  width:100%;
  box-shadow:0 40px 120px rgba(0,0,0,.7);
  animation: modalPop 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
}
@keyframes modalPop { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
.modal-box h2 { margin-top: 0; }
.detail-grid { display: grid; grid-template-columns: 120px 1fr; gap: 8px 16px; font-size: 14px; }
.detail-grid dt { font-weight: 600; color: var(--text-muted); }
.detail-grid dd { margin: 0; color: var(--text-main); }
.detail-grid .payment-id { word-break: break-all; }

/* A simple toast notification */
#toast {
  visibility: hidden; opacity: 0;
  position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%) translateY(20px);
  background: linear-gradient(90deg,var(--success),#59e4ab); color: #0a0e1a;
  padding: 12px 24px; border-radius: 50px; font-weight: 800;
  z-index: 9999; box-shadow: 0 10px 30px rgba(0,0,0,0.3);
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
  transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
}
#toast.show { visibility: visible; opacity: 1; transform: translateX(-50%) translateY(0); }

.spinner {
  width: 32px;
  height: 32px;
  border: 3px solid rgba(230,181,102,0.3);
  border-radius: 50%;
  border-top-color: var(--gold);
  animation: spin 1s linear infinite;
  margin: 20px auto;
}
@keyframes spin { to { transform: rotate(360deg); } }
</style>
</head>

<body>
<div class="bg-noise"></div>
<div class="container">
  <header>
    <div class="brand">
      <div class="logo" aria-hidden="true"><img src="hamsasareeslogo.jpg" alt="Hamsa Sarees Logo"></div>
      <div>
        <div class="title">Hamsa Sarees</div>
        <div class="small">My Orders</div>
      </div>
    </div>
    <div style="flex:1"></div>
    <div class="actions">
      <span id="userBadge" class="small" style="display:none"></span>
      <button id="loginBtn" class="btn">Sign in</button>
      <button id="logoutBtn" class="btn-ghost" style="display:none">Sign out</button>
      <a href="index.html" class="btn-ghost">Back</a>
    </div>
  </header>

  <main>
    <div style="background:var(--bg-soft); border:1px solid var(--border); border-radius:16px; padding:16px; margin: 22px 0; display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:12px;">
      <h3 style="margin:0;">For order cancellations, please contact us on WhatsApp.</h3>
      <a href="https://whatsapp.com/channel/0029Vb7MNNbDZ4LcXUZoSz2y" target="_blank" rel="noopener noreferrer" class="btn">
        Contact Support
      </a>
    </div>
    
    <div id="ordersContainer" class="small" style="text-align:center;padding:40px; border:1px solid var(--border); border-radius:16px; margin-top:22px; background:var(--bg-panel);">
      Please sign in to view your orders
    </div>
  </main>
</div>

<!-- MODAL -->
<div class="modal" id="orderModal">
  <div class="modal-box">
    <button id="closeModal" class="btn-ghost" style="float:right; font-size:12px; padding:6px 12px;">Close</button>
    <h2>Order Details</h2>
    <div id="orderDetails" class="small"></div>
  </div>
</div>

<div id="toast"></div>

<footer style="text-align:center;padding:18px;color:#9fb8d9;font-size:13px;line-height:1.6;">
  ©2025 Hamsa Sarees, unauthorized use is strictly prohibited.<br>
  Website designed, created & published by Terminal Joint.
</footer>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import { getFirestore, collection, query, orderBy, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyBozW19Rjc9nj0YabOIE3DlW0qVHtU5XLA",
  authDomain: "hamsasarees-24738.firebaseapp.com",
  projectId: "hamsasarees-24738"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const provider = new GoogleAuthProvider();

const ordersContainer = document.getElementById('ordersContainer');
const userBadge = document.getElementById('userBadge');
const loginBtn = document.getElementById('loginBtn');
const logoutBtn = document.getElementById('logoutBtn');
const modal = document.getElementById('orderModal');
const orderDetails = document.getElementById('orderDetails');
const toastEl = document.getElementById('toast');

function toast(msg){ 
  if(!toastEl) return; 
  toastEl.innerText = msg; 
  toastEl.classList.add('show'); 
  setTimeout(()=> toastEl.classList.remove('show'), 3000); 
}

async function loadOrders(){
  if(!auth.currentUser) return;

  ordersContainer.innerHTML = '<div class="spinner"></div><div style="text-align:center;font-size:13px;color:var(--text-muted)">Loading orders...</div>';

  const q = query(
    collection(db, `users/${auth.currentUser.uid}/orders`),
    orderBy('createdAt','desc')
  );
  const snap = await getDocs(q);

  if(snap.empty){
    ordersContainer.innerHTML = 'No orders yet';
    return;
  }

  ordersContainer.innerHTML = '';

  const fragment = document.createDocumentFragment();
  snap.forEach(d=>{
    const o = d.data();
    const orderId = d.id;
    const orderDate = o.createdAt?.toDate ? o.createdAt.toDate().toLocaleDateString('en-IN', { day: 'numeric', month: 'long', year: 'numeric' }) : 'N/A';

    const card = document.createElement('div');
    card.className = 'order-card';

    // Store all data needed for the modal directly on the button
    const fullOrderData = { ...o, id: orderId, formattedDate: orderDate };

    card.innerHTML = `
      ${o.image ? `<img src="${o.image}" alt="${o.product}">` : '<div></div>'}
      <div class="order-info">
        <strong>${o.product}</strong>
        <div class="small">Order Date: ${orderDate}</div>
        <div class="small">Amount: ₹${o.price}</div>
      </div>
      <div class="order-status">
        <div class="small" style="color: var(--success); font-weight: 600;">${o.status || 'Processing'}</div>
        <button class="btn-ghost viewBtn" data-order="${encodeURIComponent(JSON.stringify(fullOrderData))}" style="font-size:12px; padding:6px 12px; margin-top: 8px;">View Details</button>
      </div>
    `;
    fragment.appendChild(card);
  });
  ordersContainer.appendChild(fragment);
}

ordersContainer.addEventListener('click', e => {
  const view = e.target.closest('.viewBtn');
  if(!view) return;

  // ✅ PERFECTION: No more Firestore reads. Data is already on the button.
  const o = JSON.parse(decodeURIComponent(view.dataset.order));

  orderDetails.innerHTML = `
    <dl class="detail-grid">
      <dt>Order ID</dt>
      <dd>${o.id}</dd>
      <dt>Order Date</dt>
      <dd>${o.formattedDate}</dd>
      <dt>Product</dt>
      <dd>${o.product}</dd>
      <dt>Amount</dt>
      <dd>₹${o.price}</dd>
      <dt>Status</dt>
      <dd style="color: var(--success); font-weight: 600;">${o.status || 'Processing'}</dd>
      <dt>Payment ID</dt>
      <dd class="payment-id">${o.paymentId}</dd>
    </dl>
  `;
  modal.classList.add('show');
});

document.getElementById('closeModal').onclick=()=>modal.classList.remove('show');
loginBtn.onclick=()=>signInWithPopup(auth,provider);
logoutBtn.onclick=()=>signOut(auth);

onAuthStateChanged(auth,user=>{
  if(user){
    userBadge.style.display='inline';
    userBadge.textContent=user.email;
    loginBtn.style.display='none';
    logoutBtn.style.display='inline';
    loadOrders();
  }else{
    ordersContainer.innerHTML='Please sign in to view your orders';
    userBadge.style.display='none';
    loginBtn.style.display='inline';
    logoutBtn.style.display='none';
  }
});

// ✅ PERFECTION: Check for success status from payment page
const urlParams = new URLSearchParams(window.location.search);
if (urlParams.get('status') === 'success') {
  toast('Payment successful! Your order has been placed.');
  history.replaceState(null, '', location.pathname); // Clean URL
}
</script>

</body>
</html>
