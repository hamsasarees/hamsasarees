<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Hamsa Sarees — Admin + Firestore</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">
<style>
  :root{ --bg1:#001f3f; --bg2:#00306b; --accent:#00aaff; --accent2:#4dd0e1; --muted:#9fb8d9; --success:#10b981; --card:#071522; --glass:rgba(255,255,255,0.03); }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;font-family:Inter,system-ui,Arial,sans-serif;background:linear-gradient(180deg,var(--bg1),var(--bg2));color:#eaf6ff;-webkit-font-smoothing:antialiased}
  .container{max-width:1100px;margin:20px auto;padding:0 16px}
  header{display:flex;align-items:center;justify-content:space-between;padding:12px;gap:12px}
  .brand{display:flex;gap:12px;align-items:center}
  .logo{width:44px;height:44px;border-radius:10px;background:linear-gradient(135deg,var(--accent),var(--accent2));display:flex;align-items:center;justify-content:center;font-weight:800;color:#032033}
  .title{font-weight:800}
  .search{display:flex;align-items:center;background:var(--glass);padding:8px;border-radius:10px;gap:8px;border:1px solid rgba(255,255,255,0.02)}
  .search input{background:transparent;border:none;color:#eaf6ff;outline:none;width:220px}
  .actions{display:flex;gap:8px;align-items:center}
  .btn{cursor:pointer;border-radius:10px;padding:9px 14px;border:none;font-weight:700;background:linear-gradient(90deg,var(--accent),#ff5aa3);color:#fff}
  .btn-ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);color:#fff;padding:8px 12px;border-radius:10px}
  .grid{display:grid;grid-template-columns:repeat(3,1fr);gap:14px;margin-top:16px}
  .card{background:linear-gradient(180deg,#071522,#06121a);padding:12px;border-radius:12px;position:relative}
  .imgwrap{height:180px;border-radius:10px;background:#081522;display:flex;align-items:center;justify-content:center;overflow:hidden}
  img{width:100%;height:100%;object-fit:cover;display:block}
  .small{color:var(--muted)}
  .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:linear-gradient(180deg,rgba(3,8,20,0.6),rgba(2,8,18,0.85));z-index:1200;padding:12px}
  .modal-box{max-width:720px;width:100%;background:linear-gradient(180deg,#071522,#06121a);border-radius:12px;padding:16px;color:#eaf6ff;position:relative}
  .field{display:flex;flex-direction:column;margin-top:10px}
  .field input, .field textarea, select{padding:10px;border-radius:8px;border:none;background:#08121a;color:#dbeafe}
  .orders-list{max-height:60vh;overflow:auto;padding:8px;background:linear-gradient(180deg,#06131a,#071722)}
  .admin-badge{background:rgba(255,255,255,0.03);padding:6px 10px;border-radius:8px;font-weight:700}
  @media (max-width:900px){ .grid{grid-template-columns:repeat(2,1fr)} .search input{width:140px} }
  @media (max-width:600px){ .grid{grid-template-columns:1fr} .imgwrap{height:200px} }
  button:focus,input:focus,select:focus{outline:3px solid rgba(0,170,255,0.12);outline-offset:3px}
</style>
</head>
<body>
  <div class="container">
    <header>
      <div class="brand">
        <div class="logo">HS</div>
        <div>
          <div class="title">Hamsa Sarees</div>
          <div class="small">Handpicked • Ethnic • Quality</div>
        </div>
      </div>

      <div style="flex:1;display:flex;justify-content:center">
        <div class="search" role="search"><input id="searchBox" placeholder="Search sarees..."></div>
      </div>

      <div class="actions">
        <div id="userBadge" style="display:none" class="admin-badge"></div>
        <button id="adminBtn" class="btn-ghost" style="display:none">Admin</button>
        <button id="myOrdersBtn" class="btn-ghost" style="display:none">My Orders</button>
        <button id="signOutBtn" class="btn-ghost" style="display:none">Sign out</button>
        <button id="loginShowBtn" class="btn">Sign in</button>
      </div>
    </header>

    <main>
      <section style="margin-top:12px">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <h2 style="margin:0">Products</h2>
          <div class="small">Products served from Firestore · Admin can add/edit/delete</div>
        </div>

        <div id="productGrid" class="grid">
          <!-- products will be rendered here from Firestore -->
        </div>
      </section>
    </main>
  </div>

  <!-- Admin Modal: Add / Edit Product -->
  <div class="modal" id="adminModal" aria-hidden="true">
    <div class="modal-box">
      <button id="closeAdmin" style="position:absolute;right:12px;top:12px">✕</button>
      <h3 id="adminTitle">Admin — Add product</h3>
      <div class="field"><label class="small">Title</label><input id="pTitle"></div>
      <div class="field"><label class="small">Price (₹)</label><input id="pPrice" type="number"></div>
      <div class="field"><label class="small">Rating (e.g. ★★★★☆)</label><input id="pRating"></div>
      <div class="field"><label class="small">Tag (e.g. New, Best)</label><input id="pTag"></div>
      <div class="field"><label class="small">Image URL (use CDN/unsplash)</label><input id="pImg"></div>
      <div style="margin-top:12px;display:flex;gap:8px;justify-content:flex-end">
        <button id="saveProduct" class="btn">Save</button>
        <button id="cancelAdmin" class="btn-ghost">Cancel</button>
      </div>
    </div>
  </div>

  <!-- My Orders modal (simple) -->
  <div class="modal" id="myOrdersModal" aria-hidden="true">
    <div class="modal-box">
      <button id="closeMyOrders" style="position:absolute;right:12px;top:12px">✕</button>
      <h3>My Orders</h3>
      <div class="orders-list" id="ordersList"></div>
    </div>
  </div>

  <iframe name="hiddenFrame" style="display:none"></iframe>
  <div id="toast" style="position:fixed;right:16px;bottom:16px;background:#0b1220;padding:10px 14px;border-radius:10px;color:#d1fae5;display:none">Saved.</div>

<script type="module">
(async function(){
  if(document.readyState === 'loading') await new Promise(r=>document.addEventListener('DOMContentLoaded', r));

  // *** ADMIN UID already set for you (hamsasarees@gmail.com) ***
  const ADMIN_UID = 'EenXHJIvZpavhkGTCI8EZyFAfH93';

  // Firebase imports
  const { initializeApp } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js');
  const authMod = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js');
  const fsMod = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');

  const { getAuth, GoogleAuthProvider, signInWithPopup, signInWithRedirect, getRedirectResult, signOut, onAuthStateChanged } = authMod;
  const { getFirestore, collection, addDoc, setDoc, doc, deleteDoc, serverTimestamp, query, orderBy, getDocs, onSnapshot, getDoc } = fsMod;

  // Your firebaseConfig (same as before)
  const firebaseConfig = {
    apiKey: "AIzaSyBozW19Rjc9nj0YabOIE3DlW0qVHtU5XLA",
    authDomain: "hamsasarees-24738.firebaseapp.com",
    projectId: "hamsasarees-24738",
    storageBucket: "hamsasarees-24738.firebasestorage.app",
    messagingSenderId: "16303342424",
    appId: "1:16303342424:web:d68d26160d45472713db2d",
    measurementId: "G-1G1HQGJ5XS"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);
  const googleProvider = new GoogleAuthProvider();

  // DOM refs
  const $ = id => document.getElementById(id);
  const productGrid = $('productGrid'), adminBtn = $('adminBtn'), adminModal = $('adminModal'), closeAdmin = $('closeAdmin');
  const saveProduct = $('saveProduct'), cancelAdmin = $('cancelAdmin'), adminTitle = $('adminTitle');
  const pTitle = $('pTitle'), pPrice = $('pPrice'), pRating = $('pRating'), pTag = $('pTag'), pImg = $('pImg');
  const loginShowBtn = $('loginShowBtn'), signOutBtn = $('signOutBtn'), userBadge = $('userBadge');
  const myOrdersBtn = $('myOrdersBtn'), myOrdersModal = $('myOrdersModal'), closeMyOrders = $('closeMyOrders'), ordersList = $('ordersList');
  const toastEl = $('toast'), searchBox = $('searchBox');

  function toast(msg){ if(!toastEl) return; toastEl.innerText = msg; toastEl.style.display='block'; setTimeout(()=>toastEl.style.display='none',1800); }
  function showError(msg){ alert(msg); }

  // auth helpers
  async function signInPopup(){ try{ await signInWithPopup(auth, googleProvider); toast('Signed in'); }catch(e){ console.error(e); try{ await signInWithRedirect(auth, googleProvider); }catch(err){ showError('Sign-in failed: '+(err.message||err.code)); } } }
  loginShowBtn && loginShowBtn.addEventListener('click', signInPopup);

  // show admin only when UID matches ADMIN_UID
  function updateAdminUI(user){
    if(user && user.uid === ADMIN_UID){
      adminBtn.style.display = 'inline-block';
      userBadge.style.display = 'inline-block';
      userBadge.innerText = user.displayName || user.email || user.uid;
    } else {
      adminBtn.style.display = 'none';
      if(user){ userBadge.style.display='inline-block'; userBadge.innerText = user.displayName || user.email; } else { userBadge.style.display='none'; }
    }
    myOrdersBtn.style.display = user ? 'inline-block' : 'none';
    signOutBtn.style.display = user ? 'inline-block' : 'none';
    loginShowBtn.style.display = user ? 'none' : 'inline-block';
  }

  // Admin modal open
  let editingId = null;
  adminBtn && adminBtn.addEventListener('click', ()=>{
    editingId = null;
    adminTitle.innerText = 'Admin — Add product';
    pTitle.value=''; pPrice.value=''; pRating.value=''; pTag.value=''; pImg.value='';
    adminModal.style.display='flex'; adminModal.removeAttribute('aria-hidden');
  });
  closeAdmin && closeAdmin.addEventListener('click', ()=>{ adminModal.style.display='none'; adminModal.setAttribute('aria-hidden','true'); });
  cancelAdmin && cancelAdmin.addEventListener('click', ()=>{ adminModal.style.display='none'; adminModal.setAttribute('aria-hidden','true'); });

  // Save product (create or update)
  saveProduct.addEventListener('click', async ()=>{
    const title = pTitle.value.trim(); const price = Number(pPrice.value); const rating = pRating.value.trim(); const tag = pTag.value.trim(); const img = pImg.value.trim();
    if(!title || !price || !img){ alert('Title, price and image URL required'); return; }
    try{
      const payload = { title, price, rating, tag, img, updatedAt: serverTimestamp() };
      if(editingId){
        await setDoc(doc(db, 'products', editingId), payload, { merge: true });
        toast('Product updated');
      } else {
        await addDoc(collection(db, 'products'), { ...payload, createdAt: serverTimestamp() });
        toast('Product added');
      }
      adminModal.style.display='none'; adminModal.setAttribute('aria-hidden','true');
    }catch(err){ console.error('save product failed', err); alert('Failed to save product. Check console.'); }
  });

  // Render product card
  function renderProductCard(id, data){
    const el = document.createElement('div'); el.className='card';
    el.innerHTML = `
      ${data.tag ? `<div class="small" style="position:absolute;left:10px;top:10px;background:rgba(0,0,0,0.4);padding:6px 8px;border-radius:8px">${data.tag}</div>` : ''}
      <div class="imgwrap"><img src="${data.img}" loading="lazy" alt="${data.title}"></div>
      <h3>${data.title}</h3>
      <div style="display:flex;justify-content:space-between;align-items:center"><div class="price">₹${data.price}</div><div class="small">${data.rating||''}</div></div>
      <div style="margin-top:8px;display:flex;gap:8px;justify-content:space-between">
        <div><button class="orderBtn btn" data-product="${data.title}">Order Now</button></div>
        <div class="admin-controls" style="display:none">
          <button class="editBtn btn-ghost" data-id="${id}">Edit</button>
          <button class="delBtn btn-ghost" data-id="${id}">Delete</button>
        </div>
      </div>`;
    return el;
  }

  // live listener for products (realtime)
  const productsCol = collection(db, 'products');
  onSnapshot(productsCol, (snap)=>{
    productGrid.innerHTML='';
    snap.forEach(docSnap=>{
      const data = docSnap.data(); const id = docSnap.id;
      const card = renderProductCard(id, data);
      productGrid.appendChild(card);
    });
    attachProductHandlers(); // attach after render
  }, (err)=>{ console.error('products snapshot failed', err); });

  // attach click handlers: orderBtn (delegate), edit, delete
  function attachProductHandlers(){
    // Order buttons
    productGrid.querySelectorAll('.orderBtn').forEach(b=>{
      b.addEventListener('click', ev=>{
        const prod = ev.currentTarget.getAttribute('data-product') || '';
        if(!auth.currentUser){ alert('Sign in to place orders'); return; }
        // simple prompt flow to keep single-file app minimal
        const name = prompt('Your name'); if(!name) return;
        const phone = prompt('Phone number (10 digits)'); if(!phone) return;
        const address = prompt('Address'); if(!address) return;
        (async ()=>{
          try{
            const uid = auth.currentUser.uid;
            const order = { product: prod, name, phone, address, createdAt: serverTimestamp(), user: uid, userEmail: auth.currentUser.email || null };
            await addDoc(collection(db, `users/${uid}/orders`), order);
            toast('Order saved');
          }catch(e){ console.error('order save failed', e); alert('Failed to save order'); }
        })();
      });
    });

    // Admin controls visible if current user is admin
    const user = auth.currentUser;
    if(user && user.uid === ADMIN_UID){
      productGrid.querySelectorAll('.admin-controls').forEach(ctrl=> ctrl.style.display='flex');
      // edit handlers
      productGrid.querySelectorAll('.editBtn').forEach(b=>{
        b.addEventListener('click', async ev=>{
          const id = ev.currentTarget.getAttribute('data-id');
          if(!id) return;
          try{
            const docSnap = await getDoc(doc(db, 'products', id));
            const d = docSnap.data() || {};
            editingId = id;
            adminTitle.innerText = 'Admin — Edit product';
            pTitle.value = d.title || ''; pPrice.value = d.price || ''; pRating.value = d.rating || ''; pTag.value = d.tag || ''; pImg.value = d.img || '';
            adminModal.style.display='flex'; adminModal.removeAttribute('aria-hidden');
          }catch(err){ console.error('load product failed', err); alert('Failed to load product'); }
        });
      });
      // delete handlers
      productGrid.querySelectorAll('.delBtn').forEach(b=>{
        b.addEventListener('click', async ev=>{
          const id = ev.currentTarget.getAttribute('data-id');
          if(!id) return;
          if(!confirm('Delete product permanently?')) return;
          try{ await deleteDoc(doc(db, 'products', id)); toast('Deleted'); }catch(err){ console.error('delete failed', err); alert('Failed to delete'); }
        });
      });
    } else {
      productGrid.querySelectorAll('.admin-controls').forEach(ctrl=> ctrl.style.display='none');
    }
  }

  // my orders modal
  myOrdersBtn && myOrdersBtn.addEventListener('click', async ()=>{
    if(!auth.currentUser){ alert('Sign in to view orders'); return; }
    myOrdersModal.style.display='flex'; myOrdersModal.removeAttribute('aria-hidden');
    ordersList.innerHTML='<div class="small">Loading...</div>';
    try{
      const uid = auth.currentUser.uid;
      const q = query(collection(db, `users/${uid}/orders`), orderBy('createdAt','desc'));
      const snap = await getDocs(q);
      if(snap.empty){ ordersList.innerHTML='<div class="small">No orders yet</div>'; return; }
      ordersList.innerHTML='';
      snap.forEach(docSnap=>{
        const o = docSnap.data(); const id = docSnap.id;
        const dt = (o.createdAt && o.createdAt.toDate) ? o.createdAt.toDate().toLocaleString() : '';
        const el = document.createElement('div'); el.style.padding='10px'; el.style.borderBottom='1px solid rgba(255,255,255,0.03)';
        el.innerHTML = `<strong>${o.product||''}</strong><div class="small">${o.name||''} • ${o.phone||''}</div><div class="small" style="color:var(--muted)">${dt}</div><div style="margin-top:6px"><button class="btn-ghost" data-id="${id}" data-action="delOrder">Delete</button></div>`;
        ordersList.appendChild(el);
      });
      ordersList.querySelectorAll('button[data-action="delOrder"]').forEach(b=>{
        b.addEventListener('click', async ev=>{
          const id = ev.currentTarget.getAttribute('data-id');
          if(!id) return;
          if(!confirm('Delete this order?')) return;
          try{ await deleteDoc(doc(db, `users/${auth.currentUser.uid}/orders/${id}`)); toast('Order deleted'); await myOrdersBtn.click(); }catch(err){ console.error(err); alert('Delete failed'); }
        });
      });
    }catch(err){ console.error(err); ordersList.innerHTML='<div class="small">Failed to load</div>'; }
  });
  closeMyOrders && closeMyOrders.addEventListener('click', ()=>{ myOrdersModal.style.display='none'; myOrdersModal.setAttribute('aria-hidden','true'); });

  // sign out
  signOutBtn && signOutBtn.addEventListener('click', async ()=>{ try{ await signOut(auth); toast('Signed out'); }catch(e){ console.error(e); } });

  // auth state changes
  onAuthStateChanged(auth, user=>{
    updateAdminUI(user);
    if(user && ADMIN_UID === 'EenXHJIvZpavhkGTCI8EZyFAfH93'){
      // fine — admin UID matches
    }
    setTimeout(()=> attachProductHandlers(), 400);
    // show UID in console for debugging
    if(user) console.log('Signed in UID:', user.uid);
  });

  // search helper
  if(searchBox) searchBox.addEventListener('input', e=>{
    const v = e.target.value.toLowerCase();
    document.querySelectorAll('#productGrid .card').forEach(card=>{
      const t = (card.querySelector('h3')||{innerText:''}).innerText.toLowerCase();
      card.style.display = t.includes(v) ? 'block' : 'none';
    });
  });

  console.log('App ready. If you need image uploads or payment integration next, tell me which one.');
})();
</script>
</body>
</html>
