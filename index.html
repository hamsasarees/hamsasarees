<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Hamsa Sarees — Premium Ethnic Store</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600;700&family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">
<link rel="stylesheet" href="style.css">
</head>
<body>
<header>
  <div class="container nav">
    <a href="index.html" class="brand">
      <div class="logo">HS</div>
      <div>
        <div class="title">Hamsa Sarees</div>
        <div class="small">Premium Ethnic Wear</div>
      </div>
    </a>
    <a href="index.html" class="btn-ghost">Shop</a>
    <a href="yourorders.html" class="btn-ghost">My Orders</a>
    <div class="spacer"></div>
    <div class="search"><input id="searchBox" placeholder="Search cotton, silk, bridal..."></div>
    <div class="actions">
      <button id="auth-btn" class="btn">Sign in</button>
      <div id="user-info" class="avatar" style="display:none;cursor:pointer"></div>
    </div>
  </div>
</header>

<main class="container">
  <section class="hero">
    <div class="hero-card">
      <h1>Grace you can feel.</h1>
      <p class="small">Handpicked sarees. Account‑saved orders. Simple checkout.</p>
      <div style="margin-top:12px;display:flex;gap:10px">
        <button class="btn" onclick="document.getElementById('products-container').scrollIntoView({behavior:'smooth'})">Shop now</button>
        <button class="btn-ghost">Collections</button>
      </div>
    </div>
    <div class="promo">
      <strong>Limited Offer</strong>
      <p class="small">Free shipping above ₹3000</p>
      <div style="margin-top:10px;font-weight:800;color:#7ee0b2">Best Seller ₹1499</div>
    </div>
  </section>

  <h2 style="margin-top:26px">Products</h2>
  <div id="products-container" class="grid"></div>
</main>

<!-- User Profile Modal -->
<div class="modal" id="profileModal">
  <div class="modal-box">
    <button class="close-x" onclick="toggleProfile(false)">✕</button>
    <h2>Your Profile</h2>
    <div class="field"><label class="small">Name</label><div id="pName"></div></div>
    <div class="field"><label class="small">Email</label><div id="pEmail"></div></div>
    <div style="margin-top:14px;display:flex;gap:8px;justify-content:flex-end">
      <button class="btn-ghost" onclick="toggleProfile(false)">Close</button>
      <button class="btn" id="signOutBtn">Sign out</button>
    </div>
  </div>
</div>

<div id="product-modal" class="modal" aria-hidden="true">
    <div class="modal-box">
        <button id="close-modal-btn" class="close-x">&times;</button>
        <h2 id="modal-title">Product Details</h2>
        <div id="modal-body" class="modal-body">
            <!-- Product details will be shown here -->
        </div>
    </div>
</div>

<div class="toast" id="toast">Done</div>

<script src="firebase-config.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js"></script>
<script>
    (async function() {
        if (document.readyState === 'loading') {
            await new Promise(r => document.addEventListener('DOMContentLoaded', r));
        }

        function escapeHtml(s) {
            return String(s === undefined || s === null ? '' : s).replace(/[&<>'"`]/g, c => ({ 
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#39;'
            } [c]));
        }

        try {
            const { initializeApp } = firebase.app;
            const { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } = firebase.auth;
            const { getFirestore, collection, getDocs } = firebase.firestore;

            const app = initializeApp(window.firebaseConfig);
            const auth = getAuth(app);
            const db = getFirestore(app);
            const googleProvider = new GoogleAuthProvider();

            const $ = id => document.getElementById(id);
            const userInfo = $('user-info');
            const authBtn = $('auth-btn');
            const productsContainer = $('products-container');
            const toastEl = $('toast');
            const productModal = $('product-modal');
            const modalTitle = $('modal-title');
            const modalBody = $('modal-body');
            const closeModalBtn = $('close-modal-btn');
            const profileModal = $('profileModal');
            const pName = $('pName');
            const pEmail = $('pEmail');
            const signOutBtn = $('signOutBtn');


            window.toggleProfile = (v) => {
                profileModal.classList.toggle('show', v);
            };

            function showToast(msg, isError = false) {
                toastEl.textContent = msg;
                toastEl.className = `toast show ${isError ? 'error' : ''}`;
                setTimeout(() => {
                    toastEl.className = 'toast';
                }, 3000);
            }

            function showModal() {
                productModal.classList.add('show');
                productModal.setAttribute('aria-hidden', 'false');
            }

            function closeModal() {
                productModal.classList.remove('show');
                productModal.setAttribute('aria-hidden', 'true');
            }

            closeModalBtn.addEventListener('click', closeModal);
            productModal.addEventListener('click', (e) => {
                if (e.target === productModal) {
                    closeModal();
                }
            });

            authBtn.addEventListener('click', () => {
                if (!auth.currentUser) {
                    signInWithPopup(auth, googleProvider).catch(e => showToast(`Sign-in failed: ${e.message}`, true));
                }
            });

            signOutBtn.addEventListener('click', () => {
                signOut(auth).then(() => {
                    toggleProfile(false);
                }).catch(e => showToast(`Sign-out failed: ${e.message}`, true))
            });

            userInfo.addEventListener('click', () => toggleProfile(true));

            onAuthStateChanged(auth, user => {
                if (user) {
                    // User is signed in
                    authBtn.style.display = 'none';
                    userInfo.style.display = 'block';
                    userInfo.textContent = user.displayName ? user.displayName.charAt(0) : 'A';
                    pName.textContent = user.displayName;
                    pEmail.textContent = user.email;
                } else {
                    // User is signed out
                    authBtn.style.display = 'block';
                    userInfo.style.display = 'none';
                    pName.textContent = '';
                    pEmail.textContent = '';
                }
            });


            let allProducts = [];

            function renderProducts(products) {
                productsContainer.innerHTML = '';
                if (products.length === 0) {
                    productsContainer.innerHTML = '<p class="placeholder-text">No products found.</p>';
                    return;
                }
                products.forEach(product => {
                    const card = document.createElement('div');
                    card.className = 'card';
                    card.innerHTML = `
                        <div class="imgwrap">
                            <img src="${escapeHtml(product.image)}" alt="${escapeHtml(product.name)}">
                        </div>
                        <div>${escapeHtml(product.name)}</div>
                        <div class="price">₹${escapeHtml(product.price)}</div>
                        <button class="btn view-details-btn" data-id="${product.id}">View Details</button>
                    `;
                    productsContainer.appendChild(card);
                });

                document.querySelectorAll('.view-details-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const productId = btn.dataset.id;
                        const productData = allProducts.find(p => p.id === productId);
                        if (productData) {
                            modalTitle.textContent = productData.name;
                            modalBody.innerHTML = `
                                <img src="${escapeHtml(productData.image)}" alt="${escapeHtml(productData.name)}" style="width:100%; border-radius: 16px; margin-bottom: 1rem;">
                                <p><strong>Price:</strong> ₹${escapeHtml(productData.price)}</p>
                                <p>${escapeHtml(productData.description)}</p>
                                <a href="payment.html?product=${encodeURIComponent(productData.name)}&price=${encodeURIComponent(productData.price)}" class="btn" style="margin-top: 1rem; display:inline-block;">Buy Now</a>
                            `;
                            showModal();
                        }
                    });
                });
            }

            $('searchBox').addEventListener('input', e => {
                const query = e.target.value.toLowerCase().trim();
                const filteredProducts = allProducts.filter(p => 
                    p.name.toLowerCase().includes(query) || 
                    (p.description && p.description.toLowerCase().includes(query))
                );
                renderProducts(filteredProducts);
            });

            async function loadProducts() {
                productsContainer.innerHTML = '<div class="loader"></div>';
                try {
                    const snap = await getDocs(collection(db, 'products'));
                    allProducts = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    renderProducts(allProducts);
                } catch (e) {
                    productsContainer.innerHTML = '<p class="placeholder-text error">Failed to load products. Please try again.</p>';
                    showToast(`Error: ${e.message}`, true);
                }
            }

            loadProducts();

        } catch (err) {
            console.error('Initialization error', err);
            let errorMsg = '<p>Could not load necessary components. Please check your internet connection and try again.</p>';
            if (typeof firebase === 'undefined') {
                errorMsg = '<p>Failed to load the Firebase library. Please ensure you are connected to the internet and that nothing is blocking gstatic.com.</p>';
            } else if (typeof window.firebaseConfig === 'undefined') {
                errorMsg = '<p>Firebase configuration is missing. Please ensure <code>firebase-config.js</code> is present and correct.</p>';
            }
            document.body.innerHTML = 
`<div style="text-align: center; padding: 50px; font-family: sans-serif; color: #d9534f;"><h1>Initialization Failed</h1>${errorMsg}</div>
`;
        }
    })();
</script>

<footer>©2025 Hamsa Sarees • Built by Terminal Joint</footer>
</body>
</html>
