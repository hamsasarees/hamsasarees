<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Hamsa Sarees</title>

<!-- ✅ FIXED CSP FOR GOOGLE AUTH -->
<meta http-equiv="Content-Security-Policy" content="
  default-src 'self';
  script-src
    'self'
    'unsafe-inline'
    https://www.gstatic.com/firebasejs/
    https://apis.google.com
    https://accounts.google.com;
  style-src 'self' 'unsafe-inline' https://fonts.googleapis.com;
  font-src 'self' https://fonts.gstatic.com;
  connect-src
    'self'
    https://www.googleapis.com
    https://securetoken.googleapis.com
    https://identitytoolkit.googleapis.com
    https://*.firebaseio.com
    wss://*.firebaseio.com;
  frame-src
    https://accounts.google.com
    https://*.firebaseapp.com;
  img-src 'self' https: data:;
  object-src 'none';
">

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">
<link rel="stylesheet" href="style.css">
</head>

<body>

<div class="container">

  <header>
    <div class="brand">
      <div class="logo">HS</div>
      <div>
        <div class="title">Hamsa Sarees</div>
        <div class="small">Handpicked • Ethnic • Quality</div>
      </div>
    </div>

    <div class="actions">
      <div id="userBadge" class="user-badge"></div>
      <button id="loginBtn" class="btn-ghost">Sign in</button>
      <a href="yourorders.html" class="btn-ghost">My Orders</a>
    </div>
  </header>

  <main>
    <h1>Products</h1>
    <div id="productGrid" class="grid"></div>
  </main>

</div>

<!-- LOGIN MODAL -->
<div class="modal" id="loginModal">
  <div class="modal-box modal-sm">
    <button class="close-x" id="closeLogin">✕</button>
    <h2>Sign in</h2>
    <p class="small">Sign in to continue.</p>
    <div class="mt-16">
      <button id="googleLoginBtn" class="btn btn-full">
        Sign in with Google
      </button>
    </div>
    <p id="loginError" class="small text-danger mt-12" style="display:none"></p>
  </div>
</div>

<script type="module">
(async () => {

  const firebaseConfig = {
    apiKey: "AIzaSyBozW19Rjc9nj0YabOIE3DlW0qVHtU5XLA",
    authDomain: "hamsasarees-24738.firebaseapp.com",
    projectId: "hamsasarees-24738",
    storageBucket: "hamsasarees-24738.firebasestorage.app",
    messagingSenderId: "16303342424",
    appId: "1:16303342424:web:d68d26160d45472713db2d"
  };

  const { initializeApp } =
    await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js');
  const {
    getAuth,
    GoogleAuthProvider,
    signInWithPopup,
    signInWithRedirect,
    getRedirectResult,
    onAuthStateChanged
  } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js');
  const {
    getFirestore,
    collection,
    getDocs
  } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);
  const provider = new GoogleAuthProvider();

  const $ = id => document.getElementById(id);

  // Handle redirect result (popup blocked case)
  try { await getRedirectResult(auth); } catch(e){}

  onAuthStateChanged(auth, user => {
    if (user) {
      $('userBadge').style.display = 'block';
      $('userBadge').textContent = user.displayName || user.email;
      $('loginBtn').style.display = 'none';
      $('loginModal').classList.remove('show');
    } else {
      $('userBadge').style.display = 'none';
      $('loginBtn').style.display = 'inline-block';
    }
  });

  $('loginBtn').onclick = () =>
    $('loginModal').classList.add('show');

  $('closeLogin').onclick = () =>
    $('loginModal').classList.remove('show');

  $('googleLoginBtn').onclick = async () => {
    $('loginError').style.display = 'none';
    try {
      await signInWithPopup(auth, provider);
    } catch (e) {
      if (e.code === 'auth/popup-blocked') {
        await signInWithRedirect(auth, provider);
      } else {
        $('loginError').textContent = e.message;
        $('loginError').style.display = 'block';
      }
    }
  };

  // Load products
  const grid = $('productGrid');
  const snap = await getDocs(collection(db, 'products'));
  grid.innerHTML = snap.empty
    ? '<div class="text-muted p-16">No products</div>'
    : '';

  snap.forEach(d => {
    const p = d.data();
    const img = p.images?.[0] || '';
    const card = document.createElement('div');
    card.className = 'card';
    card.innerHTML = `
      <div class="imgwrap"><img src="${img}"></div>
      <div class="p-12">
        <strong>${p.title}</strong>
        <div class="price mt-8">₹${p.price}</div>
        <button class="btn btn-full mt-12">Buy Now</button>
      </div>`;
    card.querySelector('button').onclick = () => {
      if (!auth.currentUser) {
        alert('Please sign in first');
        $('loginModal').classList.add('show');
        return;
      }
      location.href = 'payment.html?pid=' + d.id;
    };
    grid.appendChild(card);
  });

})();
</script>

</body>
</html>
