<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta http-equiv="Content-Security-Policy" content="
  default-src 'self';
  script-src 'self' https://www.gstatic.com/firebasejs/ https://apis.google.com https://checkout.razorpay.com;
  style-src 'self' 'unsafe-inline' https://fonts.googleapis.com;
  font-src 'self' https://fonts.gstatic.com;
  connect-src 'self' https://*.firebaseio.com wss://*.firebaseio.com https://www.googleapis.com https://lumberjack-cx.razorpay.com;
  frame-src 'self' https://api.razorpay.com;
  img-src 'self' https: data:;
  object-src 'none';">
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Payment — Hamsa Sarees</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">
<style>
  :root{
    --bg1: #0d1117;
    --bg2: #010409;
    --accent: #238636;
    --accent-glow: rgba(35, 134, 54, 0.6);
    --accent-hover: #2ea043;
    --text-primary: #e6edf3;
    --text-secondary: #7d8590;
    --border-color: rgba(255, 255, 255, 0.1);
    --card-bg: #161b22;
    --input-bg: #0d1117;
    --error: #f85149;
    --error-bg: rgba(248, 81, 73, 0.1);
  }
  *{box-sizing:border-box}
  html,body{
    height:100%; margin:0; font-family:Inter,system-ui,Arial,sans-serif;
    background:var(--bg2); color:var(--text-primary); -webkit-font-smoothing:antialiased;
  }
  a{color:inherit;text-decoration:none}
  .container{max-width:540px;margin:20px auto;padding:0 16px}
  header{display:flex;align-items:center;justify-content:space-between;gap:12px;padding:12px 0;margin-bottom:24px;}
  .brand{display:flex;gap:14px;align-items:center}
  .logo{width:48px;height:48px;border-radius:50%;background:linear-gradient(135deg, #f9ce34, #ee2a7b, #6228d7);display:flex;align-items:center;justify-content:center;font-weight:800;color:#fff;font-size:20px;box-shadow:0 8px 30px rgba(0,0,0,0.3);}
  .title{font-weight:700;font-size:20px}
  .small{color:var(--text-secondary);font-size:14px}
  .btn{
    cursor:pointer; border-radius:8px; padding:12px 18px; border:1px solid var(--accent); font-weight:700;
    background:var(--accent); color:#fff; box-shadow:0 1px 0 rgba(255,255,255,0.1) inset, 0 4px 12px rgba(0,0,0,0.4);
    transition: all .2s ease; width:100%; display:flex; align-items:center; justify-content:center; gap: 8px;
  }
  .btn:hover:not(:disabled){background:var(--accent-hover); border-color:var(--accent-hover);}
  .btn:active:not(:disabled){transform:translateY(1px); box-shadow:0 1px 0 rgba(255,255,255,0.1) inset, 0 2px 6px rgba(0,0,0,0.4);}
  .btn:disabled{opacity:0.7;cursor:not-allowed}
  .btn-ghost{
    background:transparent; border:1px solid var(--border-color); color:var(--text-secondary);
    box-shadow:none; font-weight:600;
  }
  .btn-ghost:hover{background:var(--card-bg); color:var(--text-primary); border-color:var(--text-secondary);}
  .payment-card{
    background:var(--card-bg); padding:24px; border-radius:12px; margin-bottom:16px;
    border:1px solid var(--border-color); box-shadow: 0 10px 40px rgba(0,0,0,0.3);
  }
  .payment-card h1{margin-top:0;font-size:28px;margin-bottom:24px; letter-spacing:-0.5px;}
  .payment-summary{
    background:var(--input-bg); padding:16px; border-radius:8px; margin-bottom:24px;
    border:1px solid var(--border-color); font-size:14px;
  }
  .summary-list{list-style:none; padding:0; margin:0; line-height:1.8;}
  .summary-list li{display:flex; justify-content:space-between; color:var(--text-secondary);}
  .summary-list li strong{color:var(--text-primary); font-weight:600;}
  .field{display:flex;flex-direction:column;margin-bottom:16px}
  .field label{font-weight:600;margin-bottom:8px;color:var(--text-secondary);font-size:13px}
  .field input,.field select{
    padding:12px; border-radius:8px; border:1px solid var(--border-color);
    background:var(--input-bg); color:var(--text-primary); font-size:15px;
    transition:all .2s;
  }
  .field input:focus,.field select:focus{
    outline:none; border-color:var(--accent);
    box-shadow:0 0 0 3px var(--accent-glow);
  }
  .status-message{padding:12px 16px;border-radius:8px;margin-bottom:16px;display:none;font-weight:600;border:1px solid transparent;font-size:14px}
  .status-success{background:rgba(35,134,54,0.15);color:#3fb950;border-color:rgba(35,134,54,0.3);display:block}
  .status-error{background:var(--error-bg);color:var(--error);border-color:rgba(248,81,73,0.3);display:block}
  .button-group{display:flex;gap:12px;margin-top:24px}
  .button-group button{flex:1}
  .sr-only{position:absolute!important;height:1px;width:1px;overflow:hidden;clip:rect(1px,1px,1px,1px);white-space:nowrap}
  button:focus-visible, a:focus-visible{outline:3px solid var(--accent-glow); outline-offset:2px; border-radius: 8px;}
  .toast{
    position:fixed; right:16px; bottom:16px; background:#1f2937; padding:12px 18px;
    border-radius:8px; color:var(--text-primary); border-left:4px solid var(--accent);
    box-shadow:0 10px 40px rgba(0,0,0,0.5); display:none; z-index:2000; font-weight:600;
    animation:toast-in .3s ease;
  }
  @keyframes toast-in { from { transform: translateY(20px); opacity: 0; } }
  footer{text-align:center;padding:24px;color:var(--text-secondary);font-size:12px;margin-top:20px;border-top:1px solid var(--border-color)}
  @media (max-width:640px){
    .container{margin-top:0;}
    header{padding:16px 0; margin-bottom:16px;}
    .button-group{flex-direction:column}
    .payment-card{padding:20px; border-radius:0; border-left:0; border-right:0;}
  }
  .loader {
    width: 16px; height: 16px; border: 2px solid #FFF;
    border-bottom-color: transparent; border-radius: 50%;
    display: inline-block; box-sizing: border-box;
    animation: rotation 1s linear infinite;
  }
  @keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
</style>
</head>
<body>
  <div class="container">
    <header>
      <div class="brand">
        <div class="logo" aria-hidden="true">HS</div>
        <div>
          <div class="title">Hamsa Sarees</div>
          <div class="small">Payment</div>
        </div>
      </div>
    </header>

    <main>
      <section class="payment-card">
        <h1>Secure Checkout</h1>
        <div id="paymentSummary" class="payment-summary">Loading order summary...</div>

        <div id="paymentStatus" class="status-message"></div>
        <!-- Razorpay checkout will be used; no external intent flows -->

        <form id="paymentForm">
          <div class="field">
            <label for="buyerName">Name</label>
            <input id="buyerName" type="text" placeholder="Full name" required />
          </div>

          <div class="field">
            <label for="buyerPhone">Mobile number</label>
            <input id="buyerPhone" type="tel" placeholder="10-digit mobile number" required />
          </div>

          <div class="field">
            <label for="buyerAddress">Address</label>
            <input id="buyerAddress" type="text" placeholder="Delivery address" required />
          </div>

          <div class="field">
            <label for="paymentMethod">Select Payment Method</label>
            <select id="paymentMethod" required>
              <option value="">Choose a payment method</option>
              <option value="razorpay">Pay with Razorpay (Card/UPI)</option>
            </select>
          </div>

          <div class="button-group">
            <button type="submit" id="payNow" class="btn">Pay Now</button>
            <a href="index.html" class="btn btn-ghost">Cancel</a>
          </div>
        </form>
      </section>

      <div style="text-align:center;margin-top:20px">
        <p class="small">Your payment is secure and encrypted. Data is not stored.</p>
      </div>

      <!-- Desktop UPI helper removed (Razorpay integrated) -->

    </main>
  </div>
  <footer style="line-height:1.8;">
    <div class="policy-links" style="margin-bottom: 16px; display: flex; justify-content: center; gap: 8px 16px; flex-wrap: wrap;">
      <a href="https://merchant.razorpay.com/policy/RqTr3sOZEqSD8V/privacy" target="_blank" style="color: var(--text-secondary); text-decoration: underline;">Privacy Policy</a>
      <a href="https://merchant.razorpay.com/policy/RqTr3sOZEqSD8V/terms" target="_blank" style="color: var(--text-secondary); text-decoration: underline;">Terms & Conditions</a>
      <a href="https://merchant.razorpay.com/policy/RqTr3sOZEqSD8V/shipping" target="_blank" style="color: var(--text-secondary); text-decoration: underline;">Shipping</a>
      <a href="https://merchant.razorpay.com/policy/RqTr3sOZEqSD8V/refund" target="_blank" style="color: var(--text-secondary); text-decoration: underline;">Cancellation & Refunds</a>
      <a href="https://merchant.razorpay.com/policy/RqTr3sOZEqSD8V/contact_us" target="_blank" style="color: var(--text-secondary); text-decoration: underline;">Contact Us</a>
    </div>
    ©2025 Hamsa Sarees, unauthorized use is strictly prohibited.<br>
    Website designed, created & published by Terminal Joint.
  </footer>

  <div id="toast" class="toast" role="status" aria-live="polite">Saved.</div>

<script type="module" id="main-script">
(async function(){
  if(document.readyState === 'loading') await new Promise(r=>document.addEventListener('DOMContentLoaded', r));

  // ---- CONFIG ----
  // Google Pay Configuration:
  // 1. Card/UPI payments redirect to Google Pay
  // 2. Mobile number: 9994051579
  // 3. User will be redirected to UPI app on mobile or Google Pay
  // 4. After payment completion, order will be saved to Firestore
  // 5. Payments processed via Razorpay checkout
  
  const firebaseConfig = {
    apiKey: "AIzaSyBozW19Rjc9nj0YabOIE3DlW0qVHtU5XLA",
    authDomain: "hamsasarees-24738.firebaseapp.com",
    projectId: "hamsasarees-24738",
    storageBucket: "hamsasarees-24738.firebasestorage.app",
    messagingSenderId: "16303342424",
    appId: "1:16303342424:web:d68d26160d45472713db2d",
    measurementId: "G-1G1HQGJ5XS"
  };

  // ---- Firebase imports ----
  try{
    const { initializeApp } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js');
    const authMod = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js');
    const fsMod = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');

    const { getAuth, onAuthStateChanged } = authMod;
    const { getFirestore, collection, addDoc, serverTimestamp, doc, getDoc, setDoc } = fsMod;

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // ---- DOM refs ----
    const $ = id => document.getElementById(id);
    const paymentSummary = $('paymentSummary');
    const paymentStatus = $('paymentStatus');
    const paymentForm = $('paymentForm');
    const payNowBtn = $('payNow');
    const paymentMethod = $('paymentMethod');
    const toastEl = $('toast');
    const buyerName = $('buyerName');
    const buyerPhone = $('buyerPhone');
    const buyerAddress = $('buyerAddress');

    function toast(msg){ if(!toastEl) return; toastEl.innerText = msg; toastEl.style.display = 'block'; setTimeout(()=>toastEl.style.display = 'none', 2200); }

    function showStatus(msg, isError = false){
      paymentStatus.textContent = msg;
      paymentStatus.className = 'status-message ' + (isError ? 'status-error' : 'status-success');
    }

    function hideStatus(){
      paymentStatus.className = 'status-message';
    }

    // ---- Get order data from URL params ----
    const params = new URLSearchParams(window.location.search);
    const orderData = {
      product: params.get('product') || '',
      name: params.get('name') || '',
      phone: params.get('phone') || '',
      address: params.get('address') || '',
      price: parseFloat(params.get('price')) || 0
    };

    // Display order summary with fixed price
    if(paymentSummary && (orderData.product || orderData.name)){
      paymentSummary.innerHTML = `
        <ul class="summary-list">
          <li><span>Product</span> <strong>${orderData.product}</strong></li>
          <li><span>Name</span> <strong>${orderData.name}</strong></li>
          <li><span>Phone</span> <strong>${orderData.phone}</strong></li>
          <li><span>Price</span> <strong>₹${orderData.price}</strong></li>
        </ul>
      `;
    } else if(paymentSummary){
      paymentSummary.innerHTML = '<div class="small" style="color:var(--error)">No order data found. <a href="index.html" style="color:var(--accent-hover)">Return to shop</a></div>';
    }

    // Payment method change handler (no COD option)
    paymentMethod.addEventListener('change', (e) => {
      // Placeholder for future payment UI toggles
    });

    // Auto-select Razorpay by default
    try{ paymentMethod.value = 'razorpay'; }catch(e){}

    // Prefill buyer inputs from URL params
    try{
      if(buyerName && orderData.name) buyerName.value = orderData.name;
      if(buyerPhone && orderData.phone) buyerPhone.value = orderData.phone;
      if(buyerAddress && orderData.address) buyerAddress.value = orderData.address;
    }catch(e){/* ignore */}

    // ---- Save order to Firestore ONLY after successful payment ----
    async function saveOrderAfterPayment(paymentId, paymentMethod) {
      try {
        const uid = auth.currentUser ? auth.currentUser.uid : null;
        const finalOrderData = { 
          ...orderData, 
          paymentMethod: paymentMethod,
          paymentId: paymentId,
          paymentStatus: 'completed',
          user: uid, 
          userEmail: auth.currentUser ? auth.currentUser.email : null, 
          createdAt: serverTimestamp() 
        };

        if(uid){
          await addDoc(collection(db, `users/${uid}/orders`), finalOrderData);
        }
        await addDoc(collection(db, 'orders'), finalOrderData);
        
        return true;
      } catch(err) {
        console.error('Failed to save order to database', err);
      }
    }

    // ---- Send order to Google Sheets (only after payment success) ----
    async function sendOrderToGoogleSheets(orderData, paymentId) {
      try {
        // This is the URL of the Google Form you are submitting to.
        const formUrl = 'https://docs.google.com/forms/d/e/1FAIpQLSfREKvTld9R59UADJQK6jxQIbM64tt1iP0M-XiPq4ykOOwe5w/formResponse';
        
        // These entry IDs must match the fields in your Google Form.
        const formData = new FormData();
        formData.append('entry.1128392407', orderData.name || '');      // Name
        formData.append('entry.654904844', orderData.address || '');   // Address
        formData.append('entry.1644126654', orderData.phone || '');     // Phone
        formData.append('entry.1866699911', orderData.product || '');   // Product
        // You can add more fields to your Google Form and map them here.
        // For example, to add price and payment ID, you would need their 'entry' IDs.
        
        // We send the data using 'no-cors' mode. This means the code sends the data
        // but doesn't wait to see if it was successful. This prevents browser errors
        // and ensures the user experience is not interrupted, even if the Google Sheet part fails.
        await fetch(formUrl, {
          method: 'POST',
          body: formData,
          mode: 'no-cors'
        });
        
        console.log('Order data sent to Google Sheets.');
      } catch(err) {
        console.warn('Failed to send order to Google Sheets. The order is still saved in Firebase.', err);
      }
    }

    // ---- Payment form handler with Razorpay integration ----
    paymentForm.addEventListener('submit', async (ev) => {
      ev.preventDefault();
      
      if(!paymentMethod.value){
        showStatus('Please select a payment method', true);
        return;
      }

      hideStatus();
      payNowBtn.disabled = true;
      // Add loader to button
      const originalButtonText = payNowBtn.innerHTML;
      payNowBtn.innerHTML = `<span class="loader"></span> Processing...`;

      // showStatus('Processing payment...', false); // This is now handled by the button state

      try{
        const method = paymentMethod.value;

        // Update orderData from editable fields
        try{
          if(buyerName) orderData.name = buyerName.value.trim();
          if(buyerPhone) orderData.phone = buyerPhone.value.trim();
          if(buyerAddress) orderData.address = buyerAddress.value.trim();
        }catch(e){/*ignore*/}

        // If logged in, persist profile for future orders
        try{
          const user = auth.currentUser;
          if(user){
            const profileRef = doc(db, 'users', user.uid, 'profile');
            await setDoc(profileRef, { name: orderData.name || '', phone: orderData.phone || '', address: orderData.address || '' }, { merge: true });
          }
        }catch(e){ console.warn('Failed to save profile', e); }

        // Use Razorpay checkout for payments
        if(method === 'razorpay'){
          await startRazorpay(orderData);
          // Razorpay handler will handle saving the order and redirecting on success
        } else {
          showStatus('Unsupported payment method selected', true);
          payNowBtn.innerHTML = originalButtonText;
          payNowBtn.disabled = false;
        }

      }catch(err){
        console.error('Payment processing failed', err);
        showStatus('Payment processing failed. Please try again.', true);
        payNowBtn.innerHTML = originalButtonText;
        payNowBtn.disabled = false;
      }
    });

    // ---- COD removed: WhatsApp integration removed ----

    // ---- Razorpay integration ----
    function loadScript(src){
      return new Promise((resolve)=>{
        const s = document.createElement('script'); s.src = src; s.onload = ()=>resolve(true); s.onerror = ()=>resolve(false); document.body.appendChild(s);
      });
    }

    async function startRazorpay(orderData){
      const ok = await loadScript('https://checkout.razorpay.com/v1/checkout.js');
      if(!ok){
        showStatus('Failed to load payment gateway. Try again later.', true);
        payNowBtn.innerHTML = 'Pay Now'; // Restore button text
        payNowBtn.disabled=false;
        return;
      }

      const amountPaise = Math.round((orderData.price || 0) * 100);
      const options = {
        key: 'rzp_live_Rqulhc8rZRz8Iw', // Your Live Razorpay Key ID
        amount: amountPaise,
        currency: 'INR',
        name: 'Hamsa Sarees',
        description: orderData.product || 'Order',
        handler: async function(response){
          try{
            // Save order only after successful payment
            const paymentId = response.razorpay_payment_id;
            await saveOrderAfterPayment(paymentId, 'razorpay');

            // Now, send the confirmed order details to Google Sheets
            await sendOrderToGoogleSheets(orderData, paymentId);

            showStatus('✓ Payment successful! Order confirmed and saved.', false);
            payNowBtn.innerHTML = '✓ Success';
            toast('Order placed successfully');
            setTimeout(()=> window.location.href = 'index.html', 1800);
          }catch(err){
            console.error('Saving after payment failed', err);
            showStatus('Payment succeeded but saving failed. Contact support with payment ID.', true);
            payNowBtn.innerHTML = 'Pay Now'; // Restore button text
            payNowBtn.disabled = false; // Allow retry
          }
        },
        prefill: { name: orderData.name || '', contact: orderData.phone || '' },
        theme: { color: '#2ea043' }
      };

      const originalButtonText = payNowBtn.innerHTML;
      const rzp = new Razorpay(options);
      rzp.on('payment.failed', function(resp){
        console.error('Payment failed', resp);
        showStatus('Payment failed. Please try another method or retry.', true);
        payNowBtn.innerHTML = 'Pay Now';
        payNowBtn.disabled = false;
      });

      // Restore button if user closes Razorpay modal
      rzp.on('modal.close', function(){
          if(!payNowBtn.innerText.includes('Success')) payNowBtn.innerHTML = 'Pay Now';
      });

      rzp.open();
    }

    // ---- Auth state check ----
    onAuthStateChanged(auth, async (user)=>{
      try{
        if(!user){
          // Allow guest checkout or prompt login if required
          return;
        }

        const uid = user.uid;
        const profileRef = doc(db, 'users', uid, 'profile');
        const snap = await getDoc(profileRef);
        if(snap && snap.exists()){
          const profile = snap.data();
          if(buyerName && profile.name) buyerName.value = profile.name;
          if(buyerPhone && profile.phone) buyerPhone.value = profile.phone;
          if(buyerAddress && profile.address) buyerAddress.value = profile.address;

          // Ensure orderData uses saved profile where URL params were absent
          if(!orderData.name && profile.name) orderData.name = profile.name;
          if(!orderData.phone && profile.phone) orderData.phone = profile.phone;
          if(!orderData.address && profile.address) orderData.address = profile.address;
        } else {
          // First-time login: if we have order data from URL, save it as initial profile
          if(orderData.name || orderData.phone || orderData.address){
            try{
              await setDoc(profileRef, { name: orderData.name || '', phone: orderData.phone || '', address: orderData.address || '' }, { merge: true });
            }catch(e){ console.warn('Failed to save initial profile', e); }
          }
        }
      }catch(e){ console.warn('Profile load failed', e); }

      // No external pending-payments logic required for Razorpay flow
    });

    // ---- COD removed: no saveCODOrderAfterWhatsApp ----

    // ---- (Razorpay) Order saving is handled in the Razorpay success handler ----

    // Finish panel helpers removed — Razorpay checkout handles payment lifecycle

    // Desktop UPI helper removed (Razorpay is used)

    console.log('Hamsa Sarees Payment page ready');
  }catch(err){
    console.error('Init error', err);
    alert('Initialization failed — check console.');
  }
})();
</script>

</body>
</html>
