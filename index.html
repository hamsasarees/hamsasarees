<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Hamsa Sarees — Single Page (Fixed)</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">
  

<style>
:root{
  /* BACKGROUND */
  --bg1:#070b14;
  --bg2:#0b1426;

  /* SURFACES */
  --card:#0e1b2f;
  --glass:rgba(255,255,255,0.06);

  /* BRAND */
  --accent:#e6b566;     /* silk gold */
  --accent2:#7aa2ff;    /* royal indigo */

  --text:#eef3ff;
  --muted:#9fb0c8;

  --success:#3ddc97;
  --danger:#ff5c5c;
}

*{box-sizing:border-box}

html,body{
  height:100%;
  margin:0;
  font-family:Inter,system-ui,Arial,sans-serif;
  background:
    radial-gradient(1200px 600px at 20% -10%, rgba(122,162,255,.15), transparent 60%),
    linear-gradient(180deg,var(--bg1),var(--bg2));
  color:var(--text);
}

.container{
  max-width:1200px;
  margin:28px auto;
  padding:0 18px;
}

/* ================= HEADER ================= */
header{
  display:flex;
  gap:18px;
  align-items:center;
  justify-content:space-between;
  padding:18px 20px;
  border-radius:22px;
  background:
    linear-gradient(180deg,rgba(255,255,255,.06),rgba(255,255,255,.02));
  backdrop-filter: blur(14px);
  box-shadow:0 20px 60px rgba(0,0,0,.35);
}

.brand{
  display:flex;
  gap:14px;
  align-items:center;
}

.logo{
  width:52px;
  height:52px;
  border-radius:16px;
  background:
    linear-gradient(135deg,var(--accent),#f3d48c);
  display:flex;
  align-items:center;
  justify-content:center;
  font-weight:900;
  color:#3b2b08;
}

.title{
  font-weight:800;
  font-size:18px;
  letter-spacing:.2px;
}

.small{
  font-size:13px;
  color:var(--muted);
}

/* ================= SEARCH ================= */
.search{
  flex:1;
  max-width:460px;
  display:flex;
  align-items:center;
  gap:10px;
  padding:12px 16px;
  border-radius:18px;
  background:rgba(255,255,255,.07);
  border:1px solid rgba(255,255,255,.12);
}

.search input{
  flex:1;
  background:none;
  border:none;
  outline:none;
  color:var(--text);
  font-size:14px;
}

/* ================= BUTTONS ================= */
.btn{
  border:none;
  padding:12px 20px;
  border-radius:18px;
  font-weight:800;
  cursor:pointer;
  background:
    linear-gradient(90deg,var(--accent),#f3d48c);
  color:#3b2b08;
  box-shadow:0 10px 30px rgba(230,181,102,.35);
}

.btn-ghost{
  background:transparent;
  border:1px solid rgba(255,255,255,.18);
  padding:11px 18px;
  border-radius:18px;
  color:var(--text);
  cursor:pointer;
}

/* ================= HERO ================= */
.hero{
  display:grid;
  grid-template-columns:1.4fr .6fr;
  gap:22px;
  margin-top:26px;
}

.hero-card{
  padding:36px;
  border-radius:28px;
  background:
    linear-gradient(180deg,#12233e,#0a162a);
  box-shadow:0 30px 80px rgba(0,0,0,.45);
}

.hero-card h1{
  font-size:34px;
  margin:0 0 14px 0;
  line-height:1.2;
}

.promo{
  border-radius:28px;
  padding:26px;
  background:
    linear-gradient(180deg,rgba(230,181,102,.25),rgba(122,162,255,.08));
  border:1px solid rgba(230,181,102,.4);
  text-align:center;
  box-shadow:0 20px 60px rgba(0,0,0,.35);
}

/* ================= PRODUCT GRID ================= */
.grid{
  display:grid;
  grid-template-columns:repeat(auto-fill,minmax(230px,1fr));
  gap:22px;
  margin-top:26px;
}

.card{
  background:
    linear-gradient(180deg,#132644,#0b182d);
  border-radius:26px;
  padding-bottom:16px;
  transition:.35s ease;
  box-shadow:0 18px 50px rgba(0,0,0,.45);
}

.card:hover{
  transform:translateY(-10px);
}

/* IMAGE */
.imgwrap{
  position:relative;
  padding-bottom:125%;
  border-radius:26px 26px 0 0;
  overflow:hidden;
}

.imgwrap img{
  position:absolute;
  inset:0;
  width:100%;
  height:100%;
  object-fit:cover;
  transition:transform .5s ease;
}

.card:hover .imgwrap img{
  transform:scale(1.06);
}

/* TAG */
.tag{
  position:absolute;
  top:14px;
  left:14px;
  padding:6px 14px;
  font-size:12px;
  border-radius:999px;
  background:
    linear-gradient(90deg,var(--accent),#f3d48c);
  color:#3b2b08;
  font-weight:800;
}

/* PRODUCT TEXT */
.card h3{
  margin:16px;
  font-size:16px;
  font-weight:700;
}

.price{
  font-weight:900;
  color:var(--accent);
}

.product-rating{
  font-size:13px;
  color:var(--success);
}

/* ================= MODALS ================= */
.modal{
  position:fixed;
  inset:0;
  display:none;
  align-items:center;
  justify-content:center;
  background:rgba(3,6,12,.85);
  z-index:2000;
}

.modal.show{display:flex}

.modal-box{
  width:100%;
  max-width:760px;
  max-height:90vh;
  overflow:auto;
  background:
    linear-gradient(180deg,#132644,#0b182d);
  border-radius:28px;
  padding:28px;
  box-shadow:0 40px 120px rgba(0,0,0,.6);
}

/* ================= PRODUCT DETAIL ================= */
.product-detail-box{
  max-width:960px;
}

.pd-layout{
  display:grid;
  grid-template-columns:1.05fr .95fr;
  gap:28px;
}

.pd-main-img{
  width:100%;
  border-radius:22px;
  aspect-ratio:3/4;
  object-fit:cover;
  box-shadow:0 20px 60px rgba(0,0,0,.5);
}

.pd-thumbs img{
  width:64px;
  height:86px;
  border-radius:14px;
  cursor:pointer;
  opacity:.6;
  border:2px solid transparent;
}

.pd-thumbs img.active{
  opacity:1;
  border-color:var(--accent);
}

.review-stars span{
  font-size:24px;
  cursor:pointer;
  color:#666;
}

.review-stars span.active{
  color:var(--accent);
}

/* ================= MOBILE ================= */
@media(max-width:768px){
  header{
    flex-direction:column;
    align-items:stretch;
  }
  .hero{
    grid-template-columns:1fr;
  }
  .pd-layout{
    grid-template-columns:1fr;
  }
}
</style>

</head>
<body>
  <div class="container">
    <header>
      <div class="brand">
        <div class="logo" aria-hidden="true">HS</div>
        <div>
          <div class="title">Hamsa Sarees<br> ! This Site Is Under Construction !</div>
          <div class="small">Handpicked • Ethnic • Quality</div>
        </div>
      </div>

      <div style="flex:1;display:flex;justify-content:center">
        <div class="search" role="search" aria-label="Search products">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M21 21l-4.35-4.35" stroke="#9fb6c9" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
          <input id="searchBox" placeholder="Search sarees, cotton, silk..." aria-label="Search products" />
        </div>
      </div>

      <div class="actions">
        <button id="adminBtn" class="btn-ghost" style="display:none" aria-hidden="true">Admin</button>
        <div id="userBadge" style="display:none;background:rgba(255,255,255,0.03);padding:8px 10px;border-radius:10px;color:#fff;font-weight:700"></div>
        <a id="myOrdersBtn" href="yourorders.html" class="btn-ghost" style="display:none">My Orders</a>
        <button id="signOutBtn" class="btn-ghost" style="display:none">Sign out</button>
        <button id="loginShowBtn" class="btn">Sign in</button>
      </div>
    </header>

    <main>
      <section class="hero" style="gap:16px">
        <div class="hero-card">
          <h1>Real sarees. Real people. Real style.</h1>
          <p class="small">Curated collection, saved orders for your account, and a smooth checkout. Mobile-first.</p>
          <div style="margin-top:14px;display:flex;gap:10px">
            <button id="shopNow" class="btn">Shop Now</button>
            <button id="exploreBtn" class="btn-ghost">Collections</button>
          </div>
        </div>

        <aside class="promo" aria-hidden="true">
          <strong>Limited Offer</strong>
          <div class="small" style="margin-top:8px">Free shipping on orders above ₹3000</div>
          <div style="margin-top:12px;font-weight:800;color:#7ee0b2">Best Seller: Elegant Cotton — ₹1499</div>
        </aside>
      </section>

      <section style="margin-top:12px">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <h2 style="margin:0">Products</h2>
          <div class="small">Sign in to place orders; orders saved to your account</div>
        </div>
        <div class="grid" id="productGrid" aria-live="polite">
          <div class="card" style="grid-column:1/-1;text-align:center;color:var(--muted);padding:32px;background:transparent">
            <strong style="color:#eaf6ff">No products yet</strong>
            <div class="small" style="margin-top:8px">As admin, open Admin → Add Product to upload items. The product grid updates live for users.</div>
            <div style="margin-top:12px"><button id="openAdminFromEmpty" class="btn-ghost">Open Admin</button></div>
          </div>
        </div>
      </section>
    </main>
  </div>

  <!-- Modals (Order, Login, Payment, My Orders, Admin, Detail) -->
  <div class="modal" id="orderModal" aria-hidden="true">
    <div class="modal-box" role="dialog" aria-modal="true">
      <button class="close-x" id="closeOrderModal" title="Close">✕</button>
      <h2 id="orderModalTitle">Confirm Your Order</h2>
      <p class="small" id="selectedProduct"></p>
      <form id="orderForm" method="POST" target="hiddenFrame" action="https://docs.google.com/forms/d/e/1FAIpQLSfREKvTld9R59UADJQK6jxQIbM64tt1iP0M-XiPq4ykOOwe5w/formResponse">
        <div class="field"><label class="sr-only" for="custName">Your name</label><input id="custName" name="entry.1128392407" placeholder="Your Name" required></div>
        <div class="field"><label class="sr-only" for="custAddress">Address</label><textarea id="custAddress" name="entry.654904844" placeholder="Address" required></textarea></div>
        <div class="field"><label class="sr-only" for="custPhone">Mobile number</label><input id="custPhone" name="entry.1644126654" placeholder="Mobile Number" required></div>
        <div class="field"><input id="productField" name="entry.1866699911" readonly aria-readonly="true"></div>
        <div class="modal-footer" style="margin-top:12px;display:flex;gap:8px;justify-content:flex-end">
          <button class="btn" id="placeOrder">Place Order</button>
          <button type="button" class="btn-ghost" id="cancelOrder">Cancel</button>
        </div>
      </form>
      <div id="orderStatus" class="small" style="margin-top:10px;color:var(--success);display:none">Order placed. Thank you!</div>
    </div>
  </div>

  <div class="modal" id="loginModal" aria-hidden="true">
    <div class="modal-box" role="dialog" aria-modal="true">
      <button class="close-x" id="closeLogin" title="Close">✕</button>
      <h2>Sign in with Google</h2>
      <p class="small">No typing required — uses Google auth.</p>
      <div style="display:flex;justify-content:center;margin-top:12px">
        <button id="googleBtnLarge" class="btn">Sign in with Google</button>
      </div>
      <p id="loginErr" class="small" style="margin-top:12px;color:#ffb4b4;display:none"></p>
    </div>
  </div>

  <div class="modal" id="orderDetailModal" aria-hidden="true">
    <div class="modal-box" role="dialog" aria-modal="true">
      <button class="close-x" id="closeOrderDetail" title="Close">✕</button>
      <h2>Order Details</h2>
      <div id="orderDetailContent" class="small" style="white-space:pre-line;margin-top:8px"></div>
      <div style="display:flex;gap:10px;margin-top:12px;justify-content:flex-end"><button id="closeDetailBtn" class="btn-ghost">Close</button></div>
    </div>
  </div>

  <div class="modal" id="adminModal" aria-hidden="true">
    <div class="modal-box" role="dialog" aria-modal="true" style="max-height:90vh;overflow-y:auto">
      <button class="close-x" id="closeAdmin" title="Close">✕</button>
      <h2>Admin Panel</h2>
      
      <!-- Add Product Section -->
      <div style="border-bottom:1px solid rgba(255,255,255,0.06);padding-bottom:16px;margin-bottom:16px;background:rgba(255,255,255,0.01);padding:16px;border-radius:10px">
        <h3 style="margin-top:0;color:#eaf6ff">Add Product</h3>
        <p class="small">Products added here are saved to Firestore (admin-only).</p>
        <div class="field"><label class="small" style="font-weight:600">Title *</label><input id="admin_pTitle" placeholder="Product title" required></div>
        <div class="field"><label class="small" style="font-weight:600">Price (₹) *</label><input id="admin_pPrice" type="number" placeholder="1499" required></div>
        <div class="field"><label class="small" style="font-weight:600">Tag</label><input id="admin_pTag" placeholder="e.g. New, Best"></div>
        <div class="field">
          <label class="small" style="font-weight:600">Image URLs</label>
          <div id="imageUrlsContainer">
            <input class="imageUrlInput" type="text" placeholder="Image URL 1" style="margin-bottom: 8px;">
          </div>
          <button id="addImageUrl" type="button" class="btn-ghost" style="margin-top:8px;">Add another image</button>
        </div>
        <div style="margin-top:12px;display:flex;gap:8px;justify-content:flex-end">
          <button id="adminSave" class="btn">Add Product</button>
        </div>
      </div>

      <!-- Remove Product Section -->
      <div>
        <h3 style="margin-top:0;color:#eaf6ff">Remove Product</h3>
        <p class="small">Click the delete button next to a product to remove it.</p>
        <div id="adminProductsList" style="border:1px solid rgba(255,255,255,0.06);border-radius:10px;max-height:400px;overflow-y:auto;background:rgba(255,255,255,0.01)">
          <div class="small" style="padding:12px;text-align:center;color:var(--muted)">Loading products...</div>
        </div>
      </div>

      <div style="margin-top:16px;display:flex;gap:8px;justify-content:flex-end">
        <button id="adminCancel" class="btn-ghost">Close</button>
      </div>
    </div>
  </div>

  <iframe name="hiddenFrame" style="display:none"></iframe>
  <div id="toast" class="toast" role="status" aria-live="polite">Saved.</div>

<script type="module">
(async function(){
  if(document.readyState === 'loading') await new Promise(r=>document.addEventListener('DOMContentLoaded', r));
  let currentProductId = null;
let selectedRating = 0;
// ================= PRODUCT DETAIL OPEN =================
document.addEventListener('click', e => {
  const card = e.target.closest('.card');
  if (!card || !card.dataset.pid) return;


  const imgWrap = card.querySelector('.imgwrap');
  if (!imgWrap) return;

  currentProductId = card.dataset.pid;
const $ = id => document.getElementById(id);
  // ================= PRODUCT DETAIL OPEN =================
document.addEventListener('click', e => {
  const card = e.target.closest('.card');
  if (!card || !card.dataset.pid) return;

  const imgWrap = card.querySelector('.imgwrap');
  if (!imgWrap) return;

  currentProductId = card.dataset.pid;

  $('pdTitle').innerText = card.querySelector('h3')?.innerText || '';
  $('pdPrice').innerText = card.querySelector('.price')?.innerText || '';

  const images = JSON.parse(imgWrap.dataset.images || '[]');
  const thumbs = $('pdThumbs');
  thumbs.innerHTML = '';

  if (images.length) {
    $('pdMainImg').src = images[0];

    images.forEach((src, i) => {
      const t = document.createElement('img');
      t.src = src;
      if (i === 0) t.classList.add('active');

      t.onclick = () => {
        thumbs.querySelectorAll('img').forEach(x => x.classList.remove('active'));
        t.classList.add('active');
        $('pdMainImg').src = src;
      };

      thumbs.appendChild(t);
    });
  }

  openModal($('productDetailModal'));
});
$('closeProductDetail')?.addEventListener('click', () => {
  closeModal($('productDetailModal'));
});

  $('pdTitle').innerText = card.querySelector('h3')?.innerText || '';
  $('pdPrice').innerText = card.querySelector('.price')?.innerText || '';

  const images = JSON.parse(imgWrap.dataset.images || '[]');
  const thumbs = $('pdThumbs');
  thumbs.innerHTML = '';

  if (images.length) {
    $('pdMainImg').src = images[0];

    images.forEach((src, i) => {
      const t = document.createElement('img');
      t.src = src;
      if (i === 0) t.classList.add('active');

      t.onclick = () => {
        thumbs.querySelectorAll('img').forEach(x => x.classList.remove('active'));
        t.classList.add('active');
        $('pdMainImg').src = src;
      };
      thumbs.appendChild(t);
    });
    openModal($('productDetailModal'));

  }

  

  // ---- CONFIG ----
  const ADMIN_UID = 'EenXHJIvZpavhkGTCI8EZyFAfH93'; // UI-only sentinel; enforce admin in Firestore rules / backend
  const firebaseConfig = {
    apiKey: "AIzaSyBozW19Rjc9nj0YabOIE3DlW0qVHtU5XLA",
    authDomain: "hamsasarees-24738.firebaseapp.com",
    projectId: "hamsasarees-24738",
    storageBucket: "hamsasarees-24738.firebasestorage.app",
    messagingSenderId: "16303342424",
    appId: "1:16303342424:web:d68d26160d45472713db2d",
    measurementId: "G-1G1HQGJ5XS"
  };

  // ---- helper: escape text for safe insertion ----
  function escapeHtml(s){ return String(s===undefined||s===null?'':s).replace(/[&<>\"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

  // ---- Firebase imports (modular) ----
  try{
    const { initializeApp } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js');
    const authMod = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js');
    const fsMod = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
    const storageMod = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js');

    const { getAuth, GoogleAuthProvider, signInWithPopup, signInWithRedirect, getRedirectResult, signOut, onAuthStateChanged } = authMod;
    const { getFirestore, collection, addDoc, setDoc, doc, deleteDoc, serverTimestamp, query, orderBy, getDocs, onSnapshot } = fsMod;
    const { getStorage, ref, uploadBytes, getDownloadURL } = storageMod;

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const storage = getStorage(app);
    const googleProvider = new GoogleAuthProvider();

    // ---- DOM refs ----
    
    const loginModal = $('loginModal'), orderModal = $('orderModal'), adminModal = $('adminModal');
    const loginErr = $('loginErr'), userBadge = $('userBadge'), signOutBtn = $('signOutBtn'), loginShowBtn = $('loginShowBtn'), googleBtnLarge = $('googleBtnLarge');
    const myOrdersBtn = $('myOrdersBtn');
    const adminBtn = $('adminBtn');

    function toast(msg){ if(!toastEl) return; toastEl.innerText = msg; toastEl.style.display = 'block'; setTimeout(()=>toastEl.style.display = 'none', 2200); }
    function showLoginError(msg){ if(!loginErr) return; loginErr.innerText = msg; loginErr.style.display = msg ? 'block' : 'none'; }

    function openModal(modal){ if(!modal) return; modal.classList.add('show'); modal.removeAttribute('aria-hidden'); document.body.style.overflow = 'hidden'; }
    function closeModal(modal){ if(!modal) return; modal.classList.remove('show'); modal.setAttribute('aria-hidden','true'); document.body.style.overflow = ''; }
const toastEl = document.getElementById('toast');

    // backdrop click and Esc
   // ================= REVIEW SYSTEM (FIXED) =================


document.addEventListener('click', e => {
  const star = e.target.closest('#reviewStars span');
  if (!star) return;

  selectedRating = Number(star.dataset.val);
  document.querySelectorAll('#reviewStars span').forEach(s => {
    s.classList.toggle('active', Number(s.dataset.val) <= selectedRating);
  });
});

$('submitReview')?.addEventListener('click', async () => {
  if (!auth.currentUser) {
    alert('Sign in to write a review');
    return;
  }
  if (!currentProductId) {
    alert('Product not selected');
    return;
  }
  if (!selectedRating) {
    alert('Select rating');
    return;
  }

  try {
    await setDoc(
      doc(db, 'products', currentProductId, 'reviews', auth.currentUser.uid),
      {
        rating: selectedRating,
        text: $('reviewText').value.trim(),
        createdAt: serverTimestamp()
      }
    );
    toast('Review submitted');
    $('reviewText').value = '';
    selectedRating = 0;
    document.querySelectorAll('#reviewStars span').forEach(s => s.classList.remove('active'));
  } catch (err) {
    console.error('Review save failed', err);
    alert('Failed to submit review');
  }
});

    try {
  const rr = await getRedirectResult(auth);
  if (rr && rr.user) {
    console.log('redirect sign-in OK', rr.user.uid);
  }
} catch (e) {
  console.warn('redirect result', e && e.code);
}

    async function signInPopup(){
      showLoginError('');
      try{ await signInWithPopup(auth, googleProvider); toast('Signed in'); }catch(e){
        console.error('sign-in error', e && e.code, e && e.message);
        const popupErrors = ['auth/popup-blocked','auth/popup-closed-by-user','auth/cancelled-popup-request'];
        if(e && popupErrors.includes(e.code)){
          try{ await signInWithRedirect(auth, googleProvider); return; }catch(err){ showLoginError('Popup blocked and redirect failed. Allow popups or try another browser.'); return; }
        }
        if(e && e.code === 'auth/unauthorized-domain'){
          showLoginError('Domain not authorized. Add your hosting domain in Firebase console → Authentication → Authorized domains.');
        } else showLoginError(e && e.message ? e.message : 'Sign-in failed');
      }
    }
    googleBtnLarge && googleBtnLarge.addEventListener('click', ()=>signInPopup());
    loginShowBtn && loginShowBtn.addEventListener('click', ()=>{ openModal(loginModal); });

    signOutBtn && signOutBtn.addEventListener('click', async () => { try{ await signOut(auth); toast('Signed out'); }catch(e){ console.error('signout failed', e); } });

    // ---- PRODUCTS: load from Firestore (live) ----
    const productGrid = $('productGrid');
    const productsColRef = collection(db, 'products');

    function renderProductCard(docSnap){
      const id = docSnap.id;
      const data = docSnap.data() || {};
      const title = data.title || 'Untitled';
      const tag = data.tag || '';
      // Use the 'images' array if it exists, otherwise fall back to 'img'.
      const images = data.images && data.images.length > 0 ? data.images : [data.img];
      const primaryImage = images[0] || 'https://images.unsplash.com/photo-1520975918016-4d0b5b0b2f3d?q=80&w=1200&auto=format&fit=crop&ixlib=rb-4.0.3&s=placeholder';
      const price = data.price || '0';
      const avg = data._avg ? Number(data._avg).toFixed(1) : null;
      const avgDisplay = avg ? `★ ${avg} (${data._count||0})` : 'No ratings';

      const card = document.createElement('div'); card.className = 'card'; card.dataset.pid = id;

      // build DOM safely (no raw innerHTML from user content)
      if(tag){ const tagEl = document.createElement('div'); tagEl.className = 'tag'; tagEl.textContent = tag; card.appendChild(tagEl); }
      
      const imgWrap = document.createElement('div');
imgWrap.className = 'imgwrap';
imgWrap.dataset.images = JSON.stringify(images); // ⭐ STORE ALL IMAGES

const imgEl = document.createElement('img');
imgEl.loading = 'lazy';
imgEl.src = primaryImage;
imgEl.alt = title;
imgWrap.appendChild(imgEl);
 
      
      // Add a multi-image indicator if there's more than one image
      if (images.length > 1) {
        const multiImgIndicator = document.createElement('div');
        multiImgIndicator.textContent = '1/' + images.length;
        multiImgIndicator.style.cssText = 'position:absolute; bottom:8px; right:8px; background:rgba(0,0,0,0.6); color:white; padding:2px 8px; border-radius:10px; font-size:12px; font-weight:500;';
        imgWrap.appendChild(multiImgIndicator);
      }
      
      card.appendChild(imgWrap);

      const h3 = document.createElement('h3'); h3.textContent = title; card.appendChild(h3);

      const row = document.createElement('div'); row.style.display = 'flex'; row.style.justifyContent = 'space-between'; row.style.alignItems = 'center';
      const priceEl = document.createElement('div'); priceEl.className = 'price'; priceEl.textContent = `₹${price}`;
      const ratingWrap = document.createElement('div'); ratingWrap.style.display='flex'; ratingWrap.style.alignItems='center';
      const rEl = document.createElement('div'); rEl.className = 'product-rating small'; rEl.dataset.pid = id; rEl.textContent = avgDisplay;
      ratingWrap.appendChild(rEl);
      row.appendChild(priceEl); row.appendChild(ratingWrap);
      card.appendChild(row);

      const ratingUI = document.createElement('div'); ratingUI.className = 'rating-ui'; ratingUI.style.marginTop='8px';
      for(let i=1;i<=5;i++){ const b = document.createElement('button'); b.className='rateBtn btn-ghost'; b.dataset.rating = String(i); b.type='button'; b.textContent = String(i); ratingUI.appendChild(b); }
      card.appendChild(ratingUI);

      const orderWrap = document.createElement('div'); orderWrap.style.marginTop='8px';
      const orderBtn = document.createElement('button'); orderBtn.className='orderBtn btn'; orderBtn.type='button'; orderBtn.dataset.product = title; orderBtn.dataset.price = price; orderBtn.textContent='Order Now'; orderWrap.appendChild(orderBtn);
      card.appendChild(orderWrap);

      return card;
    }

    let productsUnsub = null;
    try{
      productsUnsub = onSnapshot(productsColRef, snap=>{
        // render from DB
        productGrid.innerHTML = '';
        if(snap.empty){
          const fallback = document.createElement('div'); fallback.className='card'; fallback.style.gridColumn='1/-1'; fallback.style.textAlign='center'; fallback.style.color='var(--muted)'; fallback.style.padding='32px';
          fallback.innerHTML = '<strong style="color:#eaf6ff">No products yet</strong><div class="small" style="margin-top:8px">As admin, open Admin → Add Product to upload items. The product grid updates live for users.</div><div style="margin-top:12px"><button id="openAdminFromEmptyInner" class="btn-ghost">Open Admin</button></div>';
          productGrid.appendChild(fallback);
          // attach handler to that button
          setTimeout(()=>{ document.getElementById('openAdminFromEmptyInner')?.addEventListener('click', ()=>{ if(!auth.currentUser){ openModal(loginModal); showLoginError('Sign in as admin to add products'); return; } if(auth.currentUser.uid !== ADMIN_UID){ alert('You are not admin'); return; } openModal(adminModal); }); },50);
          return;
        }

        snap.forEach(d => {
          const card = renderProductCard(d);
          productGrid.appendChild(card);
        });
        attachRatingListenersToGrid();
      }, err => { console.error('products snapshot error', err); });
    }catch(e){ console.warn('products onSnapshot not available', e); }

    // delegate order button via productGrid click
    productGrid.addEventListener('click', ev=>{
      const btn = ev.target.closest('.orderBtn');
      if(!btn) return;
      ev.stopPropagation();
      const prod = btn.getAttribute('data-product') || '';
      const price = btn.getAttribute('data-price') || '0';
      if(!auth.currentUser){ openModal(loginModal); showLoginError('Please sign in with Google to place orders'); return; }
      const sel = $('selectedProduct'); if(sel) sel.innerText = `${prod} (₹${price})`;
      const pf = $('productField'); if(pf) {
        pf.value = prod;
        pf.dataset.price = price;
      }
      openModal(orderModal);
    });

    // ---- Rating listeners and live averages per product ----
    // ---- Rating listeners and live averages (FIXED) ----
function attachRatingListenersToGrid(){
  document.querySelectorAll('#productGrid .card').forEach(card=>{
    const pid = card.dataset.pid;
    if(!pid) return;

    // ⭐ RATE BUTTON CLICK
    card.querySelectorAll('.rateBtn').forEach(btn=>{
      if(btn._bound) return;
      btn._bound = true;

      btn.addEventListener('click', async (ev)=>{
        if(!auth.currentUser){
          alert('Sign in to rate products');
          return;
        }

        const rating = Number(ev.currentTarget.dataset.rating);
        const uid = auth.currentUser.uid;

        try{
          await setDoc(
            doc(db, 'products', pid, 'reviews', uid),
            {
              rating: rating,
              createdAt: serverTimestamp()
            }
          );
          toast('Thanks for rating!');
        }catch(err){
          console.error('rating save failed', err);
          alert('Thanks for Your Review !');
        }
      });
    });

    // ⭐ LIVE AVERAGE RATING
    if(card._reviewsUnsub) return;

    try{
      const reviewsRef = collection(db, 'products', pid, 'reviews');
      card._reviewsUnsub = onSnapshot(reviewsRef, snap=>{
        let sum = 0;
        let count = 0;

        snap.forEach(docSnap=>{
          const d = docSnap.data();
          if(typeof d.rating === 'number'){
            sum += d.rating;
            count++;
          }
        });

        const avg = count ? (sum / count).toFixed(1) : null;
        const ratingEl = card.querySelector('.product-rating');

        if(ratingEl){
          ratingEl.innerText = avg
            ? `★ ${avg} (${count})`
            : 'No ratings';
        }
      });
    }catch(e){
      console.warn('ratings listener failed', e);
    }
  });
}

      

    attachRatingListenersToGrid();

    // ---- Orders: place & redirect to payment page ----
    $('placeOrder').addEventListener('click', ev=>{
      ev.preventDefault();
      const name = $('custName').value.trim(), address = $('custAddress').value.trim(), phone = $('custPhone').value.trim();
      const product = $('productField').value || '';
      const price = $('productField').dataset.price || '0';
      if(!name || !address || !phone){ alert('Fill all fields'); return; }
      if(!/^[6-9]\d{9}$/.test(phone)){ alert('Enter a valid 10-digit Indian mobile number'); return; }
      closeModal(orderModal);
      // Redirect to payment page with order details as URL parameters
    const tempOrder = {
  product,
  name,
  address,
  phone,
  price,
  createdAt: Date.now()
};

sessionStorage.setItem('pendingOrder', JSON.stringify(tempOrder));
window.location.href = 'payment.html';});



    // Load user orders (persistent) and allow delete + view
    // Moved to yourorders.html as a separate page


    // ---- Admin UI: persist product to Firestore (must be guarded by rules) ----
    adminBtn && adminBtn.addEventListener('click', ()=>{
      if(!auth.currentUser){ alert('Sign in as admin'); return; }
      if(auth.currentUser.uid !== ADMIN_UID){ alert('You are not admin'); return; }
      loadAdminProductsList();
      openModal(adminModal);
    });
    $('adminCancel').addEventListener('click', ()=>{ closeModal(adminModal); });

    // Load and render products list for admin
    async function loadAdminProductsList(){
      const listContainer = $('adminProductsList');
      if(!listContainer) return;
      listContainer.innerHTML = '<div class="small" style="padding:12px;text-align:center;color:var(--muted)">Loading products...</div>';
      
      try{
        const snap = await getDocs(productsColRef);
        if(snap.empty){
          listContainer.innerHTML = '<div class="small" style="padding:12px;text-align:center;color:var(--muted)">No products to remove</div>';
          return;
        }
        listContainer.innerHTML = '';
        snap.forEach(docSnap=>{
          const id = docSnap.id;
          const data = docSnap.data() || {};
          const title = data.title || 'Untitled';
          const price = data.price || '0';
          
          const row = document.createElement('div');
          row.style.cssText = 'display:flex;justify-content:space-between;align-items:center;padding:12px;border-bottom:1px solid rgba(255,255,255,0.03)';
          row.innerHTML = `
            <div style="flex:1">
              <strong style="color:#eaf6ff">${escapeHtml(title)}</strong>
              <div class="small" style="color:var(--muted)">₹${escapeHtml(price)}</div>
            </div>
            <button class="deleteProductBtn btn" data-id="${id}" style="background:linear-gradient(90deg,#ff3b3b,#ff5252);white-space:nowrap" type="button">Delete</button>
          `;
          listContainer.appendChild(row);
        });
        
        // Attach delete handlers
        listContainer.querySelectorAll('.deleteProductBtn').forEach(btn=>{
          btn.addEventListener('click', async (ev)=>{
            const id = ev.currentTarget.getAttribute('data-id');
            if(!id) return;
            const ok = confirm('Are you sure you want to delete this product? This cannot be undone.');
            if(!ok) return;
            try{
              await deleteDoc(doc(db, 'products', id));
              toast('Product deleted');
              await loadAdminProductsList();
            }catch(err){
              console.error('delete product failed', err);
              alert('Failed to delete product. See console.');
            }
          });
        });
      }catch(err){
        console.error('load admin products failed', err);
        listContainer.innerHTML = '<div class="small" style="padding:12px;color:#ffb4b4">Failed to load products</div>';
      }
    }

    // Logic for adding multiple image URLs
    const addImageUrlBtn = $('addImageUrl');
    if (addImageUrlBtn) {
      addImageUrlBtn.addEventListener('click', () => {
        const imageUrlsContainer = $('imageUrlsContainer');
        const inputCount = imageUrlsContainer.querySelectorAll('.imageUrlInput').length;
        const newInput = document.createElement('input');
        newInput.type = 'text';
        newInput.className = 'imageUrlInput';
        newInput.placeholder = `Image URL ${inputCount + 1}`;
        newInput.style.marginBottom = '8px';
        imageUrlsContainer.appendChild(newInput);
      });
    }

    $('adminSave').addEventListener('click', async ()=>{
      const title = $('admin_pTitle').value.trim();
      const price = Number($('admin_pPrice').value.trim());
      const tag = $('admin_pTag').value.trim();
      const imageUrls = [...document.querySelectorAll('#imageUrlsContainer .imageUrlInput')]
        .map(input => input.value.trim())
        .filter(url => url);

      if (!title || !price) { alert('Title and price required'); return; }
      if (imageUrls.length === 0) { alert('Please enter at least one image URL'); return; }
      if (!auth.currentUser || auth.currentUser.uid !== ADMIN_UID) { alert('Only admin can add products'); return; }

      try {
        const btn = $('adminSave'); btn.disabled = true; btn.innerText = 'Saving...';
        
        const payload = {
          title,
          price,
          tag,
          img: imageUrls[0], // For thumbnail/main image
          images: imageUrls, // Array of all image URLs
          createdAt: serverTimestamp()
        };

        await addDoc(collection(db, 'products'), payload);
        toast('Product added');

        // Reset fields
        $('admin_pTitle').value = '';
        $('admin_pPrice').value = '';
        $('admin_pTag').value = '';
        const imageUrlsContainer = $('imageUrlsContainer');
        imageUrlsContainer.innerHTML = '<input class="imageUrlInput" type="text" placeholder="Image URL 1" style="margin-bottom: 8px;">';

        btn.disabled = false; btn.innerText = 'Add Product';
        await loadAdminProductsList();
      } catch (err) {
        console.error('add product failed', err);
        alert('Failed to add product: ' + (err.message || ''));
        $('adminSave').disabled = false;
        $('adminSave').innerText = 'Add Product';
      }
    });

    // ---- Generic modal close (fix for all X buttons) ----
    document.querySelectorAll('.close-x').forEach(btn=>{ btn.addEventListener('click', ()=>{ const modal = btn.closest('.modal'); closeModal(modal); }); });
    $('cancelOrder')?.addEventListener('click', ()=>{ closeModal(orderModal); });
    $('closeOrderDetail')?.addEventListener('click', ()=>{ closeModal(orderDetailModal); });
    $('closeDetailBtn')?.addEventListener('click', ()=>{ closeModal(orderDetailModal); });

    // ---- Auth state changes: UI toggle ----
    onAuthStateChanged(auth, user=>{
      if(user){
        closeModal(loginModal);
        if(userBadge){ userBadge.style.display='inline-block'; userBadge.innerText = user.displayName || user.email; }
        if(signOutBtn) signOutBtn.style.display='inline-block';
        if(myOrdersBtn) myOrdersBtn.style.display='inline-block';
        if(loginShowBtn) loginShowBtn.style.display='none';
        if(adminBtn) adminBtn.style.display = (user.uid === ADMIN_UID) ? 'inline-block' : 'none';
      }else{
        closeModal(loginModal);
        if(userBadge) userBadge.style.display='none';
        if(signOutBtn) signOutBtn.style.display='none';
        if(myOrdersBtn) myOrdersBtn.style.display='none';
        if(loginShowBtn) loginShowBtn.style.display='inline-block';
        if(adminBtn) adminBtn.style.display='none';
      }
    });

    // ---- Search and shopNow (debounced) ----
    const searchBox = $('searchBox');
    if(searchBox){
      let searchTimer = null;
      searchBox.addEventListener('input', e=>{
        clearTimeout(searchTimer);
        searchTimer = setTimeout(()=>{
          const v = e.target.value.toLowerCase();
          document.querySelectorAll('#productGrid .card').forEach(card=>{
            const t = (card.querySelector('h3')||{innerText:''}).innerText.toLowerCase();
            const tag = (card.querySelector('.tag')||{innerText:''}).innerText.toLowerCase();
            const show = !v || t.includes(v) || tag.includes(v);
            card.style.display = show ? '' : 'none';
          });
        }, 180);
      });
    }
    const shopNow = $('shopNow'); if(shopNow) shopNow.addEventListener('click', ()=>{ const grid=document.getElementById('productGrid'); if(grid) grid.scrollIntoView({behavior:'smooth'}); });

    // initial UI ready
    document.getElementById('openAdminFromEmpty')?.addEventListener('click', ()=>{
      if(!auth.currentUser){ openModal(loginModal); showLoginError('Sign in as admin to add products'); return; }
      if(auth.currentUser.uid !== ADMIN_UID){ alert('You are not admin'); return; }
      openModal(adminModal);
    });
    console.log('Hamsa Sarees SPA ready — fixed');
  }catch(err){
    console.error('Init error', err);
    alert('Initialization failed — check console.');
  }
})();
</script>

  <!-- Image zoom modal (added) -->
  <div class="modal zoom-modal" id="zoomModal" aria-hidden="true">
    <div class="modal-box" role="dialog" aria-modal="true">
      <button class="close-x" id="closeZoom" title="Close">✕</button>
      <img id="zoomImg" src="" alt="Product zoom" />
    </div>
  </div>


  <!-- Product Detail Modal -->
<div class="modal" id="productDetailModal" aria-hidden="true">
  <div class="modal-box product-detail-box">
    <button class="close-x" id="closeProductDetail">✕</button>

    <div class="pd-layout">
      <!-- Images -->
      <div class="pd-images">
        <img id="pdMainImg" class="pd-main-img" src="" alt="">
        <div id="pdThumbs" class="pd-thumbs"></div>
      </div>

      <!-- Info -->
      <div class="pd-info">
        <h2 id="pdTitle"></h2>
        <div id="pdPrice" class="pd-price"></div>
        <div id="pdRating" class="pd-rating"></div>

        <button id="pdOrderBtn" class="btn">Order Now</button>

        <hr>

        <!-- Write Review -->
        <h3>Write a Review</h3>
        <div class="review-write">
          <div class="review-stars" id="reviewStars">
            <span data-val="1">★</span>
            <span data-val="2">★</span>
            <span data-val="3">★</span>
            <span data-val="4">★</span>
            <span data-val="5">★</span>
          </div>
          <textarea id="reviewText" placeholder="Share your experience (optional)"></textarea>
          <button id="submitReview" class="btn-ghost">Submit Review</button>
        </div>
      </div>
    </div>
  </div>
</div>

  <footer style="text-align:center;padding:18px;color:#9fb8d9;font-size:13px;line-height:1.6;">
    ©2025 Hamsa Sarees, unauthorized use is strictly prohibited.<br>
    Website designed, created & published by Terminal Joint.
  </footer>

  </body>
  </html>
