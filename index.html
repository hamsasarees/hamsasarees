<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Hamsa Sarees — Single Page (Admin + Ratings + Persistent Orders)</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">
<style>
  :root{
    --bg1:#001f3f; --bg2:#00306b; --accent:#00aaff; --accent2:#4dd0e1; --muted:#9fb8d9; --success:#10b981;
    --card:#071522; --glass:rgba(255,255,255,0.03);
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;font-family:Inter,system-ui,Arial,sans-serif;background:linear-gradient(180deg,var(--bg1),var(--bg2));color:#eaf6ff;-webkit-font-smoothing:antialiased}
  a{color:inherit}
  .container{max-width:1100px;margin:20px auto;padding:0 16px}
  header{display:flex;align-items:center;justify-content:space-between;gap:12px;padding:12px}
  .brand{display:flex;gap:12px;align-items:center}
  .logo{width:44px;height:44px;border-radius:10px;background:linear-gradient(135deg,var(--accent),var(--accent2));display:flex;align-items:center;justify-content:center;font-weight:800;color:#032033;box-shadow:0 12px 40px rgba(0,170,255,0.12)}
  .title{font-weight:800}
  .search{display:flex;align-items:center;background:var(--glass);padding:8px;border-radius:10px;gap:8px;border:1px solid rgba(255,255,255,0.02)}
  .search input{background:transparent;border:none;color:#eaf6ff;outline:none;width:220px}
  .actions{display:flex;gap:8px;align-items:center}
  .btn{cursor:pointer;border-radius:10px;padding:9px 14px;border:none;font-weight:700;background:linear-gradient(90deg,var(--accent),#ff5aa3);color:#fff;box-shadow:0 8px 24px rgba(0,170,255,0.12);transition:transform .15s,filter .15s}
  .btn:active{transform:translateY(1px)}
  .btn-ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);color:#fff;padding:8px 12px;border-radius:10px}
  .hero{display:flex;gap:16px;align-items:flex-start;margin-top:8px}
  .hero-card{flex:1;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));padding:18px;border-radius:12px;backdrop-filter: blur(6px)}
  .promo{width:260px;padding:12px;border-radius:10px;background:linear-gradient(135deg,#061526,#072234);box-shadow:0 10px 40px rgba(0,0,0,0.4)}
  .grid{display:grid;grid-template-columns:repeat(3,1fr);gap:14px;margin-top:16px}
  .card{background:linear-gradient(180deg,#071522,#06121a);padding:12px;border-radius:12px;transition:transform .2s,box-shadow .2s;overflow:hidden;position:relative}
  .card:hover{transform:translateY(-8px);box-shadow:0 24px 60px rgba(2,6,23,0.6)}
  .imgwrap{height:180px;border-radius:10px;background:#081522;display:flex;align-items:center;justify-content:center;overflow:hidden}
  .imgwrap img{width:100%;height:100%;object-fit:cover;display:block}
  h3{margin:10px 0 6px;color:#eaf6ff}
  .price{color:#7ee0b2;font-weight:800}
  .tag{position:absolute;top:10px;left:10px;background:rgba(0,0,0,0.4);padding:6px 8px;border-radius:8px;font-size:12px}
  .product-rating{font-weight:700;margin-left:8px}
  .rating-ui{display:flex;gap:6px;margin-top:6px}
  .rating-ui .rateBtn{width:34px;height:34px;padding:0;border-radius:8px}
  .orders-list{max-height:60vh;overflow:auto;border-radius:10px;padding:8px;background:linear-gradient(180deg,#06131a,#071722)}
  .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:linear-gradient(180deg,rgba(3,8,20,0.6),rgba(2,8,18,0.85));z-index:1200;padding:12px}
  .modal.show{display:flex}
  .modal-box{max-width:720px;width:100%;background:linear-gradient(180deg,#071522,#06121a);border-radius:12px;padding:16px;color:#eaf6ff;position:relative;box-shadow:0 30px 80px rgba(2,6,23,0.6)}
  .close-x{position:absolute;top:12px;right:12px;background:transparent;border:none;color:#ff3b3b;font-weight:800;font-size:18px;cursor:pointer}
  .field{display:flex;flex-direction:column;margin-top:10px}
  .field input,.field textarea,select{padding:12px;border-radius:10px;border:none;background:#08121a;color:#dbeafe}
  .small{color:var(--muted)}
  @media (max-width:1000px){ .grid{grid-template-columns:repeat(2,1fr)} .promo{display:none} .search input{width:140px} }
  @media (max-width:640px){
    header{flex-direction:column;align-items:stretch;padding:12px 16px}
    .search{width:100%;margin-top:8px}
    .grid{grid-template-columns:1fr}
    .imgwrap{height:200px}
    .modal-box{width:100%;height:100%;border-radius:12px 12px 0 0;max-width:none;display:flex;flex-direction:column;overflow:auto;padding:14px}
  }
  @keyframes floaty{0%{transform:translateY(0)}50%{transform:translateY(-6px)}100%{transform:translateY(0)}}
  .imgwrap img{animation:floaty 6s ease-in-out infinite}
  button:focus,input:focus,select:focus{outline:3px solid rgba(0,170,255,0.12);outline-offset:3px}
  .toast{position:fixed;right:16px;bottom:16px;background:#0b1220;padding:10px 14px;border-radius:10px;color:#d1fae5;border-left:4px solid var(--success);box-shadow:0 8px 30px rgba(2,6,23,0.6);display:none}
  .sr-only{position:absolute!important;height:1px;width:1px;overflow:hidden;clip:rect(1px,1px,1px,1px);white-space:nowrap}
</style>
</head>
<body>
  <div class="container">
    <header>
      <div class="brand">
        <div class="logo" aria-hidden="true">HS</div>
        <div>
          <div class="title">Hamsa Sarees</div>
          <div class="small">Handpicked • Ethnic • Quality</div>
        </div>
      </div>

      <div style="flex:1;display:flex;justify-content:center">
        <div class="search" role="search" aria-label="Search products">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M21 21l-4.35-4.35" stroke="#9fb6c9" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
          <input id="searchBox" placeholder="Search sarees, cotton, silk..." aria-label="Search products" />
        </div>
      </div>

      <div class="actions">
        <button id="adminBtn" class="btn-ghost" style="display:none" aria-hidden="true">Admin</button>
        <div id="userBadge" style="display:none;background:rgba(255,255,255,0.03);padding:8px 10px;border-radius:10px;color:#fff;font-weight:700"></div>
        <button id="myOrdersBtn" class="btn-ghost" style="display:none">My Orders</button>
        <button id="signOutBtn" class="btn-ghost" style="display:none">Sign out</button>
        <button id="loginShowBtn" class="btn">Sign in</button>
      </div>
    </header>

    <main>
      <section class="hero" style="gap:16px">
        <div class="hero-card">
          <h1>Real sarees. Real people. Real style.</h1>
          <p class="small">Curated collection, saved orders for your account, and a smooth checkout. Mobile-first.</p>
          <div style="margin-top:14px;display:flex;gap:10px">
            <button id="shopNow" class="btn">Shop Now</button>
            <button id="exploreBtn" class="btn-ghost">Collections</button>
          </div>
        </div>

        <aside class="promo" aria-hidden="true">
          <strong>Limited Offer</strong>
          <div class="small" style="margin-top:8px">Free shipping on orders above ₹3000</div>
          <div style="margin-top:12px;font-weight:800;color:#7ee0b2">Best Seller: Elegant Cotton — ₹1499</div>
        </aside>
      </section>

      <section style="margin-top:12px">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <h2 style="margin:0">Products</h2>
          <div class="small">Sign in to place orders; orders saved to your account</div>
        </div>
        <div class="grid" id="productGrid" aria-live="polite">
          <!-- No products included in the canvas. Admin will add products via Admin modal. -->
          <div class="card" style="grid-column:1/-1;text-align:center;color:var(--muted);padding:32px;background:transparent">
            <strong style="color:#eaf6ff">No products yet</strong>
            <div class="small" style="margin-top:8px">As admin, open Admin → Add Product to upload items. The product grid updates live for users.</div>
            <div style="margin-top:12px"><button id="openAdminFromEmpty" class="btn-ghost">Open Admin</button></div>
          </div>
        </div>
      </section>
    </main>
  </div>

  <!-- Modals (Order, Login, Payment, My Orders, Admin, Detail) -->
  <div class="modal" id="orderModal" aria-hidden="true">
    <div class="modal-box" role="dialog" aria-modal="true">
      <button class="close-x" id="closeOrderModal" title="Close">✕</button>
      <h2 id="orderModalTitle">Confirm Your Order</h2>
      <p class="small" id="selectedProduct"></p>
      <form id="orderForm" method="POST" target="hiddenFrame" action="https://docs.google.com/forms/d/e/1FAIpQLSfREKvTld9R59UADJQK6jxQIbM64tt1iP0M-XiPq4ykOOwe5w/formResponse">
        <div class="field"><label class="sr-only" for="custName">Your name</label><input id="custName" name="entry.1128392407" placeholder="Your Name" required></div>
        <div class="field"><label class="sr-only" for="custAddress">Address</label><textarea id="custAddress" name="entry.654904844" placeholder="Address" required></textarea></div>
        <div class="field"><label class="sr-only" for="custPhone">Mobile number</label><input id="custPhone" name="entry.1644126654" placeholder="Mobile Number" required></div>
        <div class="field"><input id="productField" name="entry.1866699911" readonly aria-readonly="true"></div>
        <div class="modal-footer" style="margin-top:12px;display:flex;gap:8px;justify-content:flex-end">
          <button class="btn" id="placeOrder">Place Order</button>
          <button type="button" class="btn-ghost" id="cancelOrder">Cancel</button>
        </div>
      </form>
      <div id="orderStatus" class="small" style="margin-top:10px;color:var(--success);display:none">Order placed. Thank you!</div>
    </div>
  </div>

  <div class="modal" id="loginModal" aria-hidden="true">
    <div class="modal-box" role="dialog" aria-modal="true">
      <button class="close-x" id="closeLogin" title="Close">✕</button>
      <h2>Sign in with Google</h2>
      <p class="small">No typing required — uses Google auth.</p>
      <div style="display:flex;justify-content:center;margin-top:12px">
        <button id="googleBtnLarge" class="btn">Sign in with Google</button>
      </div>
      <p id="loginErr" class="small" style="margin-top:12px;color:#ffb4b4;display:none"></p>
    </div>
  </div>

  <div class="modal" id="paymentModal" aria-hidden="true">
    <div class="modal-box" role="dialog" aria-modal="true">
      <button class="close-x" id="closePayment" title="Close">✕</button>
      <h2>Payment</h2>
      <p class="small" id="paymentSummary" style="white-space:pre-line"></p>
      <div style="margin-top:12px;display:flex;gap:10px;flex-direction:column">
        <label class="small">Select Payment Method</label>
        <select id="paymentMethod" style="padding:12px;border-radius:10px;border:none;background:#08121a;color:#dbeafe">
          <option value="card">Card (Test)</option>
          <option value="upi">UPI (Test)</option>
          <option value="cod">Cash on Delivery</option>
        </select>
        <button class="btn" id="payNow">Pay Now</button>
      </div>
      <div id="paymentMsg" class="small" style="margin-top:10px;color:var(--success);display:none">Payment successful. Finalizing order...</div>
    </div>
  </div>

  <div class="modal" id="myOrdersModal" aria-hidden="true">
    <div class="modal-box" role="dialog" aria-modal="true">
      <button class="close-x" id="closeMyOrdersX" title="Close">✕</button>
      <h2>My Orders</h2>
      <div class="orders-list" id="ordersList"></div>
      <div style="display:flex;gap:10px;margin-top:12px"><button id="closeOrders" class="btn-ghost">Close</button></div>
    </div>
  </div>

  <!-- Order detail modal (replaces alert) -->
  <div class="modal" id="orderDetailModal" aria-hidden="true">
    <div class="modal-box" role="dialog" aria-modal="true">
      <button class="close-x" id="closeOrderDetail" title="Close">✕</button>
      <h2>Order Details</h2>
      <div id="orderDetailContent" class="small" style="white-space:pre-line;margin-top:8px"></div>
      <div style="display:flex;gap:10px;margin-top:12px;justify-content:flex-end"><button id="closeDetailBtn" class="btn-ghost">Close</button></div>
    </div>
  </div>

  <!-- Admin modal -->
  <div class="modal" id="adminModal" aria-hidden="true">
    <div class="modal-box" role="dialog" aria-modal="true">
      <button class="close-x" id="closeAdmin" title="Close">✕</button>
      <h2>Admin — Add Product</h2>
      <p class="small">Products added here are saved to Firestore (admin-only).</p>
      <div class="field"><label class="small">Title</label><input id="admin_pTitle" placeholder="Product title"></div>
      <div class="field"><label class="small">Price (₹)</label><input id="admin_pPrice" type="number" placeholder="1499"></div>
      <div class="field"><label class="small">Tag</label><input id="admin_pTag" placeholder="e.g. New, Best"></div>
      <div class="field"><label class="small">Image URL</label><input id="admin_pImg" placeholder="https://..."></div>
      <div style="margin-top:12px;display:flex;gap:8px;justify-content:flex-end">
        <button id="adminSave" class="btn">Add Product</button>
        <button id="adminCancel" class="btn-ghost">Cancel</button>
      </div>
    </div>
  </div>

  <iframe name="hiddenFrame" style="display:none"></iframe>
  <div id="toast" class="toast" role="status" aria-live="polite">Saved.</div>

<script type="module">
(async function(){
  if(document.readyState === 'loading') await new Promise(r=>document.addEventListener('DOMContentLoaded', r));

  // ---- CONFIG ----
  const ADMIN_UID = 'EenXHJIvZpavhkGTCI8EZyFAfH93'; // your admin UID (already provided)
  const firebaseConfig = {
    apiKey: "AIzaSyBozW19Rjc9nj0YabOIE3DlW0qVHtU5XLA",
    authDomain: "hamsasarees-24738.firebaseapp.com",
    projectId: "hamsasarees-24738",
    storageBucket: "hamsasarees-24738.firebasestorage.app",
    messagingSenderId: "16303342424",
    appId: "1:16303342424:web:d68d26160d45472713db2d",
    measurementId: "G-1G1HQGJ5XS"
  };

  // ---- Firebase imports ----
  try{
    const { initializeApp } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js');
    const authMod = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js');
    const fsMod = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');

    const { getAuth, GoogleAuthProvider, signInWithPopup, signInWithRedirect, getRedirectResult, signOut, onAuthStateChanged } = authMod;
    const { getFirestore, collection, addDoc, setDoc, doc, deleteDoc, serverTimestamp, query, orderBy, getDocs, onSnapshot } = fsMod;

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const googleProvider = new GoogleAuthProvider();

    // ---- DOM refs ----
    const $ = id => document.getElementById(id);
    const loginModal = $('loginModal'), orderModal = $('orderModal'), paymentModal = $('paymentModal'), myOrdersModal = $('myOrdersModal'), adminModal = $('adminModal');
    const loginErr = $('loginErr'), userBadge = $('userBadge'), signOutBtn = $('signOutBtn'), loginShowBtn = $('loginShowBtn'), googleBtnLarge = $('googleBtnLarge');
    const myOrdersBtn = $('myOrdersBtn'), ordersList = $('ordersList'), toastEl = $('toast');
    const adminBtn = $('adminBtn');
    const orderDetailModal = $('orderDetailModal'), orderDetailContent = $('orderDetailContent');

    function toast(msg){ if(!toastEl) return; toastEl.innerText = msg; toastEl.style.display = 'block'; setTimeout(()=>toastEl.style.display = 'none', 1800); }
    function showLoginError(msg){ if(!loginErr) return; loginErr.innerText = msg; loginErr.style.display = msg ? 'block' : 'none'; }

    // small utility: open/close modal with focus trap basic handling (non-perfect but good)
    function openModal(modal){ if(!modal) return; modal.classList.add('show'); modal.removeAttribute('aria-hidden'); document.body.style.overflow = 'hidden'; }
    function closeModal(modal){ if(!modal) return; modal.classList.remove('show'); modal.setAttribute('aria-hidden','true'); document.body.style.overflow = ''; }

    // close on backdrop click and Esc
    document.addEventListener('click', (ev)=>{
      // if click on modal backdrop (element with class 'modal' but not inside modal-box)
      const m = ev.target.closest('.modal');
      if(m && !ev.target.closest('.modal-box')){
        closeModal(m);
      }
    });
    document.addEventListener('keydown', (ev)=>{ if(ev.key === 'Escape'){ document.querySelectorAll('.modal.show').forEach(m=>closeModal(m)); } });

    // handle redirect sign-in fallback
    try{ const rr = await getRedirectResult(auth); if(rr && rr.user) console.log('redirect sign-in OK', rr.user.uid); }catch(e){ console.warn('redirect result', e && e.code); }

    // sign-in
    async function signInPopup(){
      showLoginError('');
      try{
        await signInWithPopup(auth, googleProvider);
        toast('Signed in');
      }catch(e){
        console.error('sign-in error', e && e.code, e && e.message);
        const popupErrors = ['auth/popup-blocked','auth/popup-closed-by-user','auth/cancelled-popup-request'];
        if(e && popupErrors.includes(e.code)){
          try{ await signInWithRedirect(auth, googleProvider); return; }catch(err){ showLoginError('Popup blocked and redirect failed. Allow popups or try another browser.'); return; }
        }
        if(e && e.code === 'auth/unauthorized-domain'){
          showLoginError('Domain not authorized. Add your hosting domain in Firebase console → Authentication → Authorized domains.');
        } else showLoginError(e && e.message ? e.message : 'Sign-in failed');
      }
    }
    googleBtnLarge && googleBtnLarge.addEventListener('click', ()=>signInPopup());
    loginShowBtn && loginShowBtn.addEventListener('click', ()=>{ openModal(loginModal); });

    signOutBtn && signOutBtn.addEventListener('click', async () => { try{ await signOut(auth); toast('Signed out'); }catch(e){ console.error('signout failed', e); } });

    // ---- PRODUCTS: load from Firestore (live) ----
    const productGrid = $('productGrid');
    const productsColRef = collection(db, 'products');

    // render helper
    function renderProductCard(id, data){
      const title = data.title || 'Untitled';
      const pid = id || (title.toLowerCase().replace(/\s+/g,'-').replace(/[^a-z0-9\-]/g,''));
      const tagHtml = data.tag ? `<div class="tag">${data.tag}</div>` : '';
      const img = data.img || 'https://images.unsplash.com/photo-1520975918016-4d0b5b0b2f3d?q=80&w=1200&auto=format&fit=crop&ixlib=rb-4.0.3&s=placeholder';
      const price = data.price || '0';
      const avgDisplay = data._avg ? `★ ${Number(data._avg).toFixed(1)} (${data._count||0})` : 'No ratings';
      const card = document.createElement('div'); card.className = 'card'; card.dataset.pid = pid;
      card.innerHTML = `
        ${tagHtml}
        <div class="imgwrap"><img src="${img}" alt="${title}"></div>
        <h3>${title}</h3>
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div class="price">₹${price}</div>
          <div style="display:flex;align-items:center"><div class="product-rating small" data-pid="${pid}">${avgDisplay}</div></div>
        </div>
        <div class="rating-ui" style="margin-top:8px">
          <button class="rateBtn btn-ghost" data-rating="1">1</button>
          <button class="rateBtn btn-ghost" data-rating="2">2</button>
          <button class="rateBtn btn-ghost" data-rating="3">3</button>
          <button class="rateBtn btn-ghost" data-rating="4">4</button>
          <button class="rateBtn btn-ghost" data-rating="5">5</button>
        </div>
        <div style="margin-top:8px"><button class="orderBtn btn" data-product="${title}">Order Now</button></div>
      `;
      return card;
    }

    // live listener: show products from Firestore; if empty, keep fallback static ones
    let productsUnsub = null;
    try{
      productsUnsub = onSnapshot(productsColRef, snap=>{
        if(snap.empty){
          // keep static fallback — but still attach rating listeners later
          attachRatingListenersToGrid();
          return;
        }
        // clear grid and render from DB
        productGrid.innerHTML = '';
        snap.forEach(d => {
          const id = d.id; const data = d.data();
          const card = renderProductCard(id, data);
          productGrid.appendChild(card);
        });
        attachRatingListenersToGrid();
      }, err => {
        console.error('products snapshot error', err);
        attachRatingListenersToGrid();
      });
    }catch(e){
      console.warn('products onSnapshot not available (maybe offline)', e);
      attachRatingListenersToGrid();
    }

    // attach order button delegation (works for dynamic cards)
    productGrid.addEventListener('click', ev=>{
      const btn = ev.target.closest('.orderBtn');
      if(!btn) return;
      const prod = btn.getAttribute('data-product') || '';
      if(!auth.currentUser){ openModal(loginModal); showLoginError('Please sign in with Google to place orders'); return; }
      const sel = $('selectedProduct'); if(sel) sel.innerText = prod;
      const pf = $('productField'); if(pf) pf.value = prod;
      openModal(orderModal);
    });

    // ---- Rating listeners and live averages per product ----
    function attachRatingListenersToGrid(){
      document.querySelectorAll('#productGrid .card').forEach(card=>{
        const pid = card.dataset.pid || (card.querySelector('h3') && card.querySelector('h3').innerText.toLowerCase().replace(/\s+/g,'-').replace(/[^a-z0-9\-]/g,'')) ;
        if(!pid) return;
        card.querySelectorAll('.rateBtn').forEach(btn=>{
          if(btn._bound) return; btn._bound = true;
          btn.addEventListener('click', async (ev)=>{
            if(!auth.currentUser){ alert('Sign in to rate products'); return; }
            const uid = auth.currentUser.uid; const rating = Number(ev.currentTarget.dataset.rating);
            try{
              const ratingRef = doc(db, `products/${pid}/ratings/${uid}`);
              await setDoc(ratingRef, { rating: rating, createdAt: serverTimestamp() });
              toast('Thanks for rating');
            }catch(err){ console.error('rating save failed', err); alert('Failed to save rating'); }
          });
        });

        if(card._ratingsUnsub) return;
        try{
          const ratingsColRef = collection(db, `products/${pid}/ratings`);
          card._ratingsUnsub = onSnapshot(ratingsColRef, snap=>{
            let sum = 0, cnt = 0;
            snap.forEach(s => { const d = s.data(); if(d && typeof d.rating === 'number'){ sum += d.rating; cnt++; }});
            const avg = cnt ? (sum / cnt) : null;
            const rEl = card.querySelector(`.product-rating[data-pid="${pid}"]`);
            if(rEl) rEl.innerText = avg ? `★ ${avg.toFixed(1)} (${cnt})` : 'No ratings';
          }, err => { console.error('ratings snapshot failed', err); });
        }catch(e){ console.warn('ratings onSnapshot error', e); }
      });
    }
    attachRatingListenersToGrid();

    // ---- Orders: place & persist in users/{uid}/orders ----
    $('placeOrder').addEventListener('click', ev=>{
      ev.preventDefault();
      const name = $('custName').value.trim(), address = $('custAddress').value.trim(), phone = $('custPhone').value.trim();
      const product = $('productField').value || '';
      if(!name || !address || !phone){ alert('Fill all fields'); return; }
      if(!/^[6-9]\d{9}$/.test(phone)){ alert('Enter a valid 10-digit Indian mobile number'); return; }
      window.pendingOrder = { product, name, address, phone };
      closeModal(orderModal);
      const ps = $('paymentSummary'); if(ps) ps.innerText = `${product}\nName: ${name}\nPhone: ${phone}`;
      openModal(paymentModal);
    });

    $('payNow').addEventListener('click', async ()=>{
      const payNowBtn = $('payNow'); const paymentMsg = $('paymentMsg');
      if(paymentMsg) paymentMsg.style.display = 'block';
      if(payNowBtn) payNowBtn.disabled = true;
      try{
        try{ document.getElementById('orderForm').submit(); }catch(e){ console.warn('form.submit failed', e); }
        await new Promise(res => setTimeout(res, 800));
        const uid = auth.currentUser ? auth.currentUser.uid : null;
        const orderData = { ...(window.pendingOrder || {}), user: uid, userEmail: auth.currentUser ? auth.currentUser.email : null, createdAt: serverTimestamp() };
        if(uid){
          const userOrderRef = await addDoc(collection(db, `users/${uid}/orders`), orderData);
          await addDoc(collection(db, 'orders'), { ...orderData, userRef: userOrderRef.id });
          window.lastOrderId = userOrderRef.id;
        } else {
          const globalOrderRef = await addDoc(collection(db, 'orders'), orderData);
          window.lastOrderId = globalOrderRef.id;
        }
        if(paymentMsg) paymentMsg.style.display = 'none';
        const os = $('orderStatus'); if(os){ os.innerText = 'Order placed and payment received. Thank you!'; os.style.display='block'; }
        toast('Order successful');
        setTimeout(()=>{
          closeModal(paymentModal);
          if(os) os.style.display='none';
          if(document.getElementById('orderForm')) document.getElementById('orderForm').reset();
          window.pendingOrder = null;
          if(payNowBtn) payNowBtn.disabled = false;
        }, 1200);
      }catch(err){
        console.error('save after payment failed', err);
        showLoginError('Payment succeeded but saving order failed. See console.');
        if(payNowBtn) payNowBtn.disabled = false;
        if(paymentMsg) paymentMsg.style.display = 'none';
      }
    });

    // Load user orders (persistent) and allow delete + view
    async function loadUserOrders(){
      if(!auth.currentUser){ ordersList.innerHTML = '<div class="small">Please sign in</div>'; return; }
      ordersList.innerHTML = '<div class="small">Loading...</div>';
      try{
        const uid = auth.currentUser.uid;
        const q = query(collection(db, `users/${uid}/orders`), orderBy('createdAt','desc'));
        const snap = await getDocs(q);
        if(snap.empty){ ordersList.innerHTML = '<div class="small">No orders yet</div>'; return; }
        ordersList.innerHTML = '';
        snap.forEach(docSnap=>{
          const o = docSnap.data(); const id = docSnap.id;
          const el = document.createElement('div'); el.style.padding='10px'; el.style.borderBottom='1px solid rgba(255,255,255,0.03)';
          const dt = (o.createdAt && o.createdAt.toDate) ? o.createdAt.toDate().toLocaleString() : '';
          el.innerHTML = `
            <div style="display:flex;justify-content:space-between;align-items:center">
              <div>
                <strong style="color:#fff">${o.product||''}</strong>
                <div class="small">${o.name||''} • ${o.phone||''}</div>
                <div class="small" style="color:var(--muted)">${dt}</div>
              </div>
              <div style="display:flex;flex-direction:column;gap:6px;align-items:flex-end">
                <button class="btn-ghost viewOrderBtn" data-id="${id}" type="button">View</button>
                <button class="btn deleteOrderBtn" data-id="${id}" type="button">Delete</button>
              </div>
            </div>`;
          // store order data for quick view without extra read
          el.querySelector('.viewOrderBtn').dataset.product = o.product || '';
          el.querySelector('.viewOrderBtn').dataset.name = o.name || '';
          el.querySelector('.viewOrderBtn').dataset.phone = o.phone || '';
          el.querySelector('.viewOrderBtn').dataset.address = o.address || '';
          ordersList.appendChild(el);
        });
        // attach delete handlers and view handlers
        ordersList.querySelectorAll('.deleteOrderBtn').forEach(b=>{
          b.addEventListener('click', async ev=>{
            const id = ev.currentTarget.getAttribute('data-id'); if(!id) return;
            const ok = confirm('Delete this order permanently from your account? This cannot be undone.');
            if(!ok) return;
            try{
              const uid = auth.currentUser.uid;
              await deleteDoc(doc(db, `users/${uid}/orders/${id}`));
              toast('Order deleted');
              await loadUserOrders();
            }catch(err){ console.error('delete failed', err); alert('Failed to delete order. See console.'); }
          });
        });

        ordersList.querySelectorAll('.viewOrderBtn').forEach(b=>{
          b.addEventListener('click', ev=>{
            const btn = ev.currentTarget;
            const p = btn.dataset.product || '';
            const n = btn.dataset.name || '';
            const ph = btn.dataset.phone || '';
            const a = btn.dataset.address || '';
            orderDetailContent.innerText = `Product: ${p}\nName: ${n}\nPhone: ${ph}\nAddress: ${a}`;
            openModal(orderDetailModal);
          });
        });

      }catch(e){ console.error('fetch orders failed', e); ordersList.innerHTML = '<div class="small">Failed to load orders</div>'; }
    }

    myOrdersBtn && myOrdersBtn.addEventListener('click', async ()=>{
      if(!auth.currentUser){ openModal(loginModal); showLoginError('Please sign in to view your orders'); return; }
      await loadUserOrders();
      openModal(myOrdersModal);
    });

    // ---- Admin UI: open modal only if user is admin, and persist product to Firestore ----
    adminBtn && adminBtn.addEventListener('click', ()=>{
      if(!auth.currentUser){ alert('Sign in as admin'); return; }
      if(auth.currentUser.uid !== ADMIN_UID){ alert('You are not admin'); return; }
      openModal(adminModal);
    });
    $('adminCancel').addEventListener('click', ()=>{ closeModal(adminModal); });

    $('adminSave').addEventListener('click', async ()=>{
      const title = $('admin_pTitle').value.trim(); const price = Number($('admin_pPrice').value.trim()); const tag = $('admin_pTag').value.trim(); const img = $('admin_pImg').value.trim();
      if(!title || !price){ alert('Title and price required'); return; }
      if(!auth.currentUser || auth.currentUser.uid !== ADMIN_UID){ alert('Only admin can add products'); return; }
      try{
        const payload = { title, price, tag, img, createdAt: serverTimestamp() };
        await addDoc(collection(db, 'products'), payload);
        toast('Product added (Firestore)');
        closeModal(adminModal);
        $('admin_pTitle').value=''; $('admin_pPrice').value=''; $('admin_pTag').value=''; $('admin_pImg').value='';
      }catch(err){ console.error('add product failed', err); alert('Failed to add product'); }
    });

    // ---- Generic modal close (fix for all X buttons) ----
    document.querySelectorAll('.close-x').forEach(btn=>{ btn.addEventListener('click', ()=>{ const modal = btn.closest('.modal'); closeModal(modal); }); });
    $('cancelOrder')?.addEventListener('click', ()=>{ closeModal(orderModal); });
    $('closeOrders')?.addEventListener('click', ()=>{ closeModal(myOrdersModal); });
    $('closePayment')?.addEventListener('click', ()=>{ closeModal(paymentModal); });
    $('closeOrderDetail')?.addEventListener('click', ()=>{ closeModal(orderDetailModal); });
    $('closeDetailBtn')?.addEventListener('click', ()=>{ closeModal(orderDetailModal); });

    // ---- Auth state changes: UI toggle ----
    onAuthStateChanged(auth, user=>{
      if(user){
        closeModal(loginModal);
        if(userBadge){ userBadge.style.display='inline-block'; userBadge.innerText = user.displayName || user.email; }
        if(signOutBtn) signOutBtn.style.display='inline-block';
        if(myOrdersBtn) myOrdersBtn.style.display='inline-block';
        if(loginShowBtn) loginShowBtn.style.display='none';
        if(adminBtn) adminBtn.style.display = (user.uid === ADMIN_UID) ? 'inline-block' : 'none';
      }else{
        closeModal(loginModal);
        if(userBadge) userBadge.style.display='none';
        if(signOutBtn) signOutBtn.style.display='none';
        if(myOrdersBtn) myOrdersBtn.style.display='none';
        if(loginShowBtn) loginShowBtn.style.display='inline-block';
        if(adminBtn) adminBtn.style.display='none';
      }
    });

    // ---- Search and shopNow ----
    const searchBox = $('searchBox');
    if(searchBox) searchBox.addEventListener('input', e=>{
      const v = e.target.value.toLowerCase();
      document.querySelectorAll('#productGrid .card').forEach(card=>{
        const t = (card.querySelector('h3')||{innerText:''}).innerText.toLowerCase();
        const tag = (card.querySelector('.tag')||{innerText:''}).innerText.toLowerCase();
        card.style.display = (t.includes(v) || tag.includes(v)) ? 'block' : 'none';
      });
    });
    const shopNow = $('shopNow'); if(shopNow) shopNow.addEventListener('click', ()=>{ const grid=document.getElementById('productGrid'); if(grid) grid.scrollIntoView({behavior:'smooth'}); });

    // initial UI ready
    // quick-open admin from empty state
    document.getElementById('openAdminFromEmpty')?.addEventListener('click', ()=>{
      if(!auth.currentUser){ openModal(loginModal); showLoginError('Sign in as admin to add products'); return; }
      if(auth.currentUser.uid !== ADMIN_UID){ alert('You are not admin'); return; }
      openModal(adminModal);
    });
    console.log('Hamsa Sarees SPA ready — polished canvas');
  }catch(err){
    console.error('Init error', err);
    alert('Initialization failed — check console.');
  }
})();
</script>


  <!-- Image zoom modal (added) -->
  <div class="modal zoom-modal" id="zoomModal" aria-hidden="true">
    <div class="modal-box" role="dialog" aria-modal="true">
      <button class="close-x" id="closeZoom" title="Close">✕</button>
      <img id="zoomImg" src="" alt="Product zoom" />
    </div>
  </div>

  <script>
    // Lightweight zoom handlers (no dependencies)
    document.addEventListener('click', function(ev){
      try{
        var target = ev.target;
        // support closest if available
        var imgEl = (target && target.closest) ? target.closest('.imgwrap img') : null;
        if(imgEl){
          var src = imgEl.getAttribute('src');
          if(!src) return;
          var zoomImg = document.getElementById('zoomImg');
          if(zoomImg) zoomImg.src = src;
          var modal = document.getElementById('zoomModal');
          if(modal) modal.classList.add('show'), modal.removeAttribute('aria-hidden'), document.body.style.overflow = 'hidden';
        }
      }catch(e){ console.error('zoom click handler failed', e); }
    });

    var closeZoomBtn = document.getElementById && document.getElementById('closeZoom');
    if(closeZoomBtn){
      closeZoomBtn.addEventListener('click', function(){
        var zoomImg = document.getElementById('zoomImg'); if(zoomImg) zoomImg.src = '';
        var modal = document.getElementById('zoomModal'); if(modal) modal.classList.remove('show'), modal.setAttribute('aria-hidden','true'), document.body.style.overflow = '';
      });
    }

    document.addEventListener('keydown', function(e){
      if(e.key === 'Escape'){
        var modal = document.getElementById('zoomModal');
        if(modal && modal.classList.contains('show')){
          modal.classList.remove('show');
          modal.setAttribute('aria-hidden','true');
          document.body.style.overflow = '';
          var zoomImg = document.getElementById('zoomImg'); if(zoomImg) zoomImg.src = '';
        }
      }
    });
  </script>

</body>
</html>
