<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Secure Payment</title>

  <!-- FIXED CSP: Razorpay checkout was blocked earlier -->
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' https://checkout.razorpay.com https://*.razorpay.com; connect-src 'self' https://api.razorpay.com https://*.razorpay.com https://docs.google.com; img-src 'self' data: https://*.razorpay.com; style-src 'self' 'unsafe-inline'; frame-src https://checkout.razorpay.com https://*.razorpay.com;" />

  <style>
    body{font-family:system-ui,Arial,sans-serif;background:#0b1220;color:#eaf1ff;display:flex;align-items:center;justify-content:center;height:100vh;margin:0}
    .card{background:#121a2b;border-radius:14px;padding:24px;max-width:420px;width:100%;box-shadow:0 10px 30px rgba(0,0,0,.35)}
    h1{margin:0 0 12px;font-size:22px}
    p{color:#9fb2ff;margin:0 0 18px}
    label{display:block;margin:12px 0 6px}
    input{width:100%;padding:10px 12px;border-radius:10px;border:1px solid #243055;background:#0b1220;color:#fff}
    input:read-only{background:#0d1117;opacity:.7;cursor:not-allowed}
    button{margin-top:18px;width:100%;padding:12px 14px;border-radius:12px;border:0;background:#3b82f6;color:#fff;font-weight:600;cursor:pointer}
    button:disabled{opacity:.6;cursor:not-allowed}
    .small{font-size:12px;color:#8aa0ff;margin-top:10px}
  </style>
</head>
<body>
  <div class="card">
    <h1>Secure Checkout</h1>
    <p>Payments powered by Razorpay</p>

    <label>Amount (INR)</label>
    <input id="amount" type="number" readonly />

    <label>Name</label>
    <input id="name" type="text" placeholder="Customer name" />

    <label>Email</label>
    <input id="email" type="email" placeholder="email@example.com" />

    <label>Phone</label>
    <input id="contact" type="tel" placeholder="10-digit number" />

    <button id="payBtn">Pay Now</button>
    <div class="small">Do not refresh during payment</div>
  </div>

  <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
  <script>
    const payBtn = document.getElementById('payBtn');
    const amountInput = document.getElementById('amount');
    const nameInput = document.getElementById('name');
    const contactInput = document.getElementById('contact');
    const emailInput = document.getElementById('email');

    // -------- STRICT PRICE SYNC FROM MAIN PAGE --------
    const params = new URLSearchParams(window.location.search);

    // Expecting price in RUPEES from main page
    const priceFromMain = Number(params.get('price'));

    if (isNaN(priceFromMain) || priceFromMain <= 0) {
      alert('Invalid or missing price. Please go back and retry.');
      payBtn.disabled = true;
    } else {
      amountInput.value = priceFromMain; // exact same value as main page
    }

    const orderData = {
      product: params.get('product') || '',
      name: params.get('name') || '',
      phone: params.get('phone') || '',
      address: params.get('address') || '',
      price: priceFromMain
    };

    if (orderData.name) nameInput.value = orderData.name;
    if (orderData.phone) contactInput.value = orderData.phone;

    // -------- SEND TO GOOGLE FORMS AFTER PAYMENT --------
    async function sendOrderToGoogleSheets(data, paymentId) {
      const formUrl = 'https://docs.google.com/forms/d/e/1FAIpQLSfREKvTld9R59UADJQK6jxQIbM64tt1iP0M-XiPq4ykOOwe5w/formResponse';
      const formData = new FormData();

      formData.append('entry.1128392407', data.name || '');
      formData.append('entry.654904844', data.address || '');
      formData.append('entry.1644126654', data.phone || '');
      formData.append('entry.1866699911', data.product || '');

      await fetch(formUrl, { method:'POST', body:formData, mode:'no-cors' });
    }

    payBtn.onclick = function () {
      payBtn.disabled = true;

      const amountPaise = Math.round(Number(amountInput.value) * 100); // Razorpay needs paise

      if (!amountPaise || amountPaise < 100) {
        alert('Invalid amount');
        payBtn.disabled = false;
        return;
      }

      const options = {
        key: 'rzp_live_Rqulhc8rZRz8Iw',
        amount: amountPaise,
        currency: 'INR',
        name: 'Hamsa Sarees',
        description: orderData.product || 'Order Payment',
        handler: async function (response) {
          alert('Payment successful: ' + response.razorpay_payment_id);
          await sendOrderToGoogleSheets(orderData, response.razorpay_payment_id);
        },
        prefill: {
          name: nameInput.value.trim(),
          email: emailInput.value.trim(),
          contact: contactInput.value.trim()
        },
        notes: {
          product: orderData.product,
          source: 'payment.html'
        },
        theme: { color: '#3b82f6' }
      };

      const rzp = new Razorpay(options);

      rzp.on('payment.failed', function (response) {
        alert('Payment failed: ' + response.error.description);
        payBtn.disabled = false;
      });

      rzp.open();
    };
  </script>
</body>
</html>
