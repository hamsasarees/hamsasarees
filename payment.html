<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Hamsa Sarees — Payment</title>

<meta http-equiv="Content-Security-Policy" content="
  default-src 'self' https: data: blob:;
  script-src 'self' 'unsafe-inline' https://checkout.razorpay.com https://www.gstatic.com;
  style-src 'self' 'unsafe-inline' https://fonts.googleapis.com;
  font-src https://fonts.gstatic.com data:;
  frame-src https://checkout.razorpay.com https://api.razorpay.com;
  connect-src https://api.razorpay.com https://checkout.razorpay.com
               https://firestore.googleapis.com
               https://identitytoolkit.googleapis.com
               https://www.gstatic.com;
  img-src 'self' data: https: http:;
" />

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">

<style>
body{
  margin:0;
  font-family:Inter,system-ui,Arial,sans-serif;
  background:linear-gradient(180deg,#001f3f,#00306b);
  color:#eaf6ff;
  display:flex;
  align-items:center;
  justify-content:center;
  min-height:100vh
}
.card{
  background:linear-gradient(180deg,#071522,#06121a);
  border-radius:14px;
  padding:24px;
  max-width:420px;
  width:100%;
  box-shadow:0 20px 60px rgba(0,0,0,.45);
}
.row{margin-bottom:12px}
label{display:block;font-size:13px;color:#9fb8d9;margin-bottom:6px}
input,textarea{
  width:100%;
  padding:12px;
  border-radius:10px;
  border:1px solid rgba(255,255,255,0.08);
  background:#0b1220;
  color:#fff;
}
textarea{min-height:90px}
.price{font-size:20px;font-weight:800;color:#4dd0e1}
button{
  width:100%;
  padding:14px;
  border-radius:12px;
  border:none;
  background:linear-gradient(90deg,#00aaff,#ff5aa3);
  color:#fff;
  font-weight:800;
  cursor:pointer
}
button:disabled{opacity:.6}
img{display:none;max-width:100%;border-radius:12px;margin-bottom:12px}
</style>
</head>

<body>

<div class="card">
  <h1>Confirm & Pay</h1>

  <div class="row">
    <label>Product</label>
    <input id="product" readonly />
  </div>

  <img id="productImg">

  <div class="row">
    <label>Amount</label>
    <div class="price" id="priceText">₹0</div>
  </div>

  <div class="row">
    <label>Your Name</label>
    <input id="name" />
  </div>

  <div class="row">
    <label>Phone</label>
    <input id="phone" />
  </div>

  <div class="row">
    <label>Delivery Address</label>
    <textarea id="address"></textarea>
  </div>

  <button id="payBtn" disabled>Pay Securely</button>
</div>

<script src="https://checkout.razorpay.com/v1/checkout.js"></script>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import { getFirestore, doc, setDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

/* ---------- SESSION DATA ---------- */
const raw = sessionStorage.getItem('pendingOrder');
if(!raw){ alert('Invalid access'); location.href='index.html'; }
const order = JSON.parse(raw);

/* ---------- DOM ---------- */
const productEl = document.getElementById('product');
const priceText = document.getElementById('priceText');
const nameEl = document.getElementById('name');
const phoneEl = document.getElementById('phone');
const addressEl = document.getElementById('address');
const imgEl = document.getElementById('productImg');
const payBtn = document.getElementById('payBtn');

/* ---------- INIT UI ---------- */
productEl.value = order.product || '';
priceText.textContent = `₹${order.price}`;
if(order.image){
  imgEl.src = order.image;
  imgEl.style.display='block';
}

/* ---------- FIREBASE ---------- */
const app = initializeApp({
  apiKey: "AIzaSyBozW19Rjc9nj0YabOIE3DlW0qVHtU5XLA",
  authDomain: "hamsasarees-24738.firebaseapp.com",
  projectId: "hamsasarees-24738"
});

const auth = getAuth(app);
const db = getFirestore(app);
let currentUser = null;

onAuthStateChanged(auth,user=>{
  if(!user){
    alert('Please sign in');
    location.href='index.html';
  }else{
    currentUser = user;
    payBtn.disabled=false;
  }
});

/* ---------- PAYMENT ---------- */
payBtn.addEventListener('click',()=>{
  const name = nameEl.value.trim();
  const phone = phoneEl.value.trim();
  const address = addressEl.value.trim();

  if(!name || !/^[6-9]\d{9}$/.test(phone) || address.length<10){
    alert('Fill details properly');
    return;
  }

  payBtn.disabled=true;
  payBtn.textContent='Processing...';

  const rzp = new Razorpay({
    key:'rzp_live_Rqulhc8rZRz8Iw',
    amount:Math.round(order.price*100),
    currency:'INR',
    name:'Hamsa Sarees',

    handler: async res=>{
      await setDoc(
        doc(db,'users',currentUser.uid,'orders',crypto.randomUUID()),
        {
          product:order.product,
          price:order.price,
          image:order.image||'',
          name, phone, address,
          email:currentUser.email,
          paymentId:res.razorpay_payment_id,
          status:'PAID',
          createdAt:serverTimestamp()
        }
      );

      sessionStorage.removeItem('pendingOrder');
      alert('Payment successful');
      location.href='yourorders.html';
    }
  });

  rzp.open();
});
</script>

</body>
</html>

