<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Hamsa Sarees — Premium Quality</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">

<style>
/* ================= ROOT THEME ================= */
:root{
  --bg-main:#0a0e1a;
  --bg-panel:#11172c;
  --bg-soft:#161e3d;
  --border:rgba(255,255,255,0.08);
  --gold:#e6b566;
  --gold-dark:#cfa34e;
  --text-main:#eef2ff;
  --text-muted:#9fb0d1;
  --success:#3ddc97;
  --danger:#ff6b6b;
}

/* ================= RESET ================= */
*{box-sizing:border-box;margin:0;padding:0}

html,body{
  font-family:Inter,system-ui,Arial,sans-serif;
  background:radial-gradient(900px 400px at 20% -10%, rgba(230,181,102,.12), transparent 60%),
    linear-gradient(180deg,#080c18,#0a0e1a);
  color:var(--text-main);
  min-height:100vh;
}

/* ================= UTILITIES ================= */
.sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);border:0}

/* ================= LOADING SPINNER ================= */
.spinner{
  border:3px solid rgba(255,255,255,0.1);
  border-top:3px solid var(--gold);
  border-radius:50%;
  width:24px;
  height:24px;
  animation:spin 0.8s linear infinite;
  display:inline-block;
  margin:0 auto;
}

@keyframes spin{
  0%{transform:rotate(0deg)}
  100%{transform:rotate(360deg)}
}

.loading-overlay{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,0.7);
  display:flex;
  align-items:center;
  justify-content:center;
  z-index:9999;
  display:none;
}

.loading-overlay.show{display:flex}

/* ================= TOAST ================= */
.toast{
  position:fixed;
  bottom:24px;
  right:24px;
  background:linear-gradient(135deg,#1a2447,#141c3f);
  border:1px solid var(--border);
  padding:14px 20px;
  border-radius:12px;
  box-shadow:0 20px 50px rgba(0,0,0,0.6);
  color:var(--text-main);
  font-size:14px;
  font-weight:600;
  display:none;
  z-index:10000;
  min-width:250px;
}

.toast.show{display:block;animation:slideIn 0.3s ease}
.toast.success{border-left:4px solid var(--success)}
.toast.error{border-left:4px solid var(--danger)}

@keyframes slideIn{
  from{transform:translateX(400px);opacity:0}
  to{transform:translateX(0);opacity:1}
}

/* ================= LAYOUT ================= */
.container{
  max-width:1200px;
  margin:auto;
  padding:20px 16px;
}

/* ================= HEADER ================= */
header{
  display:flex;
  align-items:center;
  gap:18px;
  padding:16px 18px;
  border-radius:16px;
  background:linear-gradient(180deg,#12183a,#0f152e);
  border:1px solid var(--border);
  box-shadow:0 20px 50px rgba(0,0,0,.45);
  flex-wrap:wrap;
}

.brand{
  display:flex;
  gap:12px;
  align-items:center;
}

.logo{
  width:48px;
  height:48px;
  border-radius:12px;
  background:linear-gradient(135deg,var(--gold),#f3d48c);
  color:#3b2b08;
  font-weight:900;
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:20px;
}

.title{
  font-weight:800;
  font-size:16px;
  line-height:1.3;
}

.small{
  font-size:13px;
  color:var(--text-muted);
  line-height:1.4;
}

/* ================= SEARCH ================= */
.search{
  display:flex;
  align-items:center;
  gap:10px;
  background:#0f1738;
  border:1px solid var(--border);
  padding:10px 14px;
  border-radius:14px;
  max-width:420px;
  width:100%;
}

.search input{
  flex:1;
  background:none;
  border:none;
  outline:none;
  color:var(--text-main);
  font-size:14px;
}

.search input::placeholder{color:var(--text-muted)}

/* ================= BUTTONS ================= */
button,a{font-family:inherit}

.btn{
  background:linear-gradient(90deg,var(--gold),#f3d48c);
  color:#3b2b08;
  border:none;
  padding:10px 18px;
  border-radius:14px;
  font-weight:800;
  cursor:pointer;
  box-shadow:0 10px 30px rgba(230,181,102,.35);
  transition:transform 0.2s ease;
  font-size:14px;
}

.btn:hover:not(:disabled){transform:translateY(-1px)}
.btn:disabled{opacity:0.5;cursor:not-allowed}

.btn-ghost{
  background:#0f1738;
  border:1px solid var(--border);
  color:var(--text-main);
  padding:9px 16px;
  border-radius:14px;
  cursor:pointer;
  transition:background 0.2s ease;
  font-size:14px;
}

.btn-ghost:hover:not(:disabled){background:#18225a}
.btn-ghost:disabled{opacity:0.5;cursor:not-allowed}

.btn-danger{
  background:linear-gradient(90deg,#ff3b3b,#ff5252);
  color:#fff;
}

/* ================= HERO ================= */
.hero{
  display:grid;
  grid-template-columns:1.4fr .6fr;
  gap:18px;
  margin-top:22px;
}

.hero-card,
.promo{
  background:linear-gradient(180deg,#141c3f,#0f1533);
  border:1px solid var(--border);
  border-radius:20px;
  padding:24px;
  box-shadow:0 30px 70px rgba(0,0,0,.45);
}

.hero-card h1{
  margin:0 0 10px;
  font-size:30px;
  line-height:1.25;
}

.promo{text-align:center}

/* ================= PRODUCT GRID ================= */
.grid{
  display:grid;
  grid-template-columns:repeat(auto-fill,minmax(220px,1fr));
  gap:18px;
  margin-top:18px;
}

/* ================= PRODUCT CARD ================= */
.card{
  background:linear-gradient(180deg,#18245a,#111a3d);
  border:1px solid var(--border);
  border-radius:18px;
  padding:12px;
  cursor:pointer;
  transition:transform 0.25s ease;
  box-shadow:0 18px 45px rgba(0,0,0,.5);
}

.card:hover{transform:translateY(-6px)}

.imgwrap{
  width:100%;
  aspect-ratio:3/4;
  border-radius:14px;
  overflow:hidden;
  background:#080c1f;
  position:relative;
}

.imgwrap img{
  width:100%;
  height:100%;
  object-fit:cover;
  transition:transform .4s ease;
}

.card:hover .imgwrap img{transform:scale(1.05)}

.tag{
  position:absolute;
  top:10px;
  left:10px;
  z-index:5;
  padding:4px 12px;
  background:linear-gradient(90deg,var(--gold),#f3d48c);
  color:#3b2b08;
  font-size:12px;
  font-weight:800;
  border-radius:999px;
  pointer-events:none;
  transform:translateZ(0);
}

.card h3{
  margin:12px 0 6px;
  font-size:15px;
  font-weight:700;
}

/* ================= PRICE ================= */
.price-wrap{
  display:flex;
  align-items:baseline;
  gap:8px;
  flex-wrap:wrap;
}

.price-old{
  font-size:13px;
  color:var(--text-muted);
  text-decoration:line-through;
}

.price-new{
  font-size:17px;
  font-weight:900;
  color:var(--gold);
}

.discount-badge{
  font-size:12px;
  font-weight:800;
  background:#7ee0b2;
  color:#0a0e1a;
  padding:4px 10px;
  border-radius:999px;
  margin-left:auto;
}

/* ================= RATING ================= */
.product-rating{
  font-size:13px;
  color:var(--success);
}

/* ================= MODALS ================= */
.modal{
  position:fixed;
  inset:0;
  background:rgba(5,8,15,.9);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:1000;
  padding:20px;
  overflow-y:auto;
}

.modal.show{display:flex}

.modal-box{
  background:linear-gradient(180deg,#162051,#0f1533);
  border:1px solid var(--border);
  border-radius:20px;
  padding:24px;
  max-width:900px;
  width:100%;
  max-height:90vh;
  overflow-y:auto;
  box-shadow:0 40px 120px rgba(0,0,0,.7);
  position:relative;
}

.close-x{
  position:absolute;
  top:16px;
  right:16px;
  background:none;
  border:none;
  color:var(--text-muted);
  font-size:24px;
  cursor:pointer;
  width:32px;
  height:32px;
  display:flex;
  align-items:center;
  justify-content:center;
  border-radius:8px;
  transition:background 0.2s ease;
}

.close-x:hover{background:rgba(255,255,255,0.05)}

/* ================= PRODUCT DETAIL ================= */
.pd-layout{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:20px;
  margin-top:20px;
}

.pd-main-img{
  width:100%;
  border-radius:16px;
  cursor:zoom-in;
}

.pd-thumbs{
  display:flex;
  gap:8px;
  margin-top:10px;
  flex-wrap:wrap;
}

.pd-thumbs img{
  width:64px;
  height:86px;
  object-fit:cover;
  border-radius:10px;
  opacity:.6;
  cursor:pointer;
  transition:opacity 0.2s ease;
}

.pd-thumbs img:hover{opacity:0.8}
.pd-thumbs img.active{opacity:1;outline:2px solid var(--gold)}

.pd-price{
  font-size:22px;
  font-weight:900;
  color:var(--gold);
  margin:10px 0;
}

/* ================= REVIEWS ================= */
.review-stars{
  display:flex;
  gap:4px;
  font-size:24px;
  margin:10px 0;
}

.review-stars span{
  cursor:pointer;
  color:#555;
  transition:color 0.2s ease;
}

.review-stars span:hover,
.review-stars span.active{color:var(--gold)}

.reviews-list{
  display:flex;
  flex-direction:column;
  gap:10px;
  margin-top:10px;
  max-height:300px;
  overflow-y:auto;
}

.review-item{
  background:#0f1738;
  border:1px solid var(--border);
  border-radius:12px;
  padding:12px;
}

/* ================= FORMS ================= */
.field{
  margin-bottom:12px;
}

.field label{
  display:block;
  margin-bottom:6px;
  font-weight:600;
  font-size:13px;
}

.field input,
.field textarea{
  width:100%;
  background:#0f1738;
  border:1px solid var(--border);
  border-radius:12px;
  padding:10px;
  color:var(--text-main);
  font-size:14px;
  font-family:inherit;
}

.field input:focus,
.field textarea:focus{
  outline:none;
  border-color:var(--gold);
}

.field textarea{
  min-height:80px;
  resize:vertical;
}

.field input::placeholder,
.field textarea::placeholder{color:var(--text-muted)}

.error-text{
  color:var(--danger);
  font-size:12px;
  margin-top:4px;
  display:none;
}

.error-text.show{display:block}

/* ================= ADMIN ================= */
.admin-section{
  border-bottom:1px solid rgba(255,255,255,0.06);
  padding:16px;
  margin-bottom:16px;
  background:rgba(255,255,255,0.01);
  border-radius:10px;
}

.admin-products-list{
  border:1px solid rgba(255,255,255,0.06);
  border-radius:10px;
  max-height:400px;
  overflow-y:auto;
  background:rgba(255,255,255,0.01);
}

.admin-product-row{
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:12px;
  border-bottom:1px solid rgba(255,255,255,0.03);
}

.admin-product-row:last-child{border-bottom:none}

/* ================= MOBILE RESPONSIVE ================= */
@media(max-width:768px){
  header{flex-direction:column;align-items:stretch}
  .hero{grid-template-columns:1fr}
  .pd-layout{grid-template-columns:1fr}
  .grid{grid-template-columns:repeat(auto-fill,minmax(160px,1fr))}
  .toast{right:16px;bottom:16px;min-width:200px}
}

/* ================= EMPTY STATE ================= */
.empty-state{
  grid-column:1/-1;
  text-align:center;
  padding:48px 32px;
  background:rgba(255,255,255,0.02);
  border-radius:16px;
  border:1px dashed var(--border);
}

.empty-state h3{
  color:#eaf6ff;
  margin-bottom:8px;
}
</style>

</head>
<body>
  <!-- Loading Overlay -->
  <div class="loading-overlay" id="loadingOverlay">
    <div class="spinner"></div>
  </div>

  <!-- Toast Notification -->
  <div class="toast" id="toast"></div>

  <div class="container">
    <header>
      <div class="brand">
        <div class="logo" aria-hidden="true">HS</div>
        <div>
          <div class="title">Hamsa Sarees</div>
          <div class="small">Handpicked • Ethnic • Quality</div>
        </div>
      </div>

      <div style="flex:1;display:flex;justify-content:center;min-width:200px">
        <div class="search" role="search" aria-label="Search products">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <circle cx="11" cy="11" r="8" stroke="#9fb6c9" stroke-width="1.5"/>
            <path d="M21 21l-4.35-4.35" stroke="#9fb6c9" stroke-width="1.5" stroke-linecap="round"/>
          </svg>
          <input id="searchBox" placeholder="Search sarees..." aria-label="Search products" />
        </div>
      </div>

      <div class="actions" style="display:flex;gap:10px;flex-wrap:wrap">
        <button id="adminBtn" class="btn-ghost" style="display:none">Admin</button>
        <div id="userBadge" style="display:none;background:rgba(255,255,255,0.03);padding:8px 12px;border-radius:10px;color:#fff;font-weight:700;font-size:13px"></div>
        <button id="signOutBtn" class="btn-ghost" style="display:none">Sign Out</button>
        <button id="loginShowBtn" class="btn">Sign In</button>
      </div>
    </header>

    <main>
      <section class="hero">
        <div class="hero-card">
          <h1>Real sarees. Real people. Real style.</h1>
          <p class="small">Curated collection with secure checkout. Your orders are saved to your account.</p>
          <div style="margin-top:14px;display:flex;gap:10px;flex-wrap:wrap">
            <button id="shopNow" class="btn">Shop Now</button>
            <button id="exploreBtn" class="btn-ghost">Explore</button>
          </div>
        </div>

        <aside class="promo" aria-label="Current promotion">
          <strong style="font-size:16px">Limited Offer</strong>
          <div class="small" style="margin-top:8px">Free shipping on orders above ₹3000</div>
          <div style="margin-top:12px;font-weight:800;color:#7ee0b2">Best Seller: Elegant Cotton — ₹1499</div>
        </aside>
      </section>

      <section style="margin-top:24px">
        <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:10px">
          <h2 style="margin:0">Products</h2>
          <div class="small">Sign in to place orders</div>
        </div>
        <div class="grid" id="productGrid" aria-live="polite">
          <div class="empty-state">
            <h3>No Products Available</h3>
            <div class="small" style="margin-top:8px">Products will appear here once added by admin.</div>
          </div>
        </div>
      </section>
    </main>
  </div>

  <!-- Login Modal -->
  <div class="modal" id="loginModal" aria-hidden="true">
    <div class="modal-box" role="dialog" aria-modal="true" style="max-width:400px">
      <button class="close-x" id="closeLogin" aria-label="Close">✕</button>
      <h2>Sign In</h2>
      <p class="small">Sign in with your Google account to place orders and write reviews.</p>
      <div style="display:flex;justify-content:center;margin-top:20px">
        <button id="googleSignInBtn" class="btn" style="width:100%">
          <span>Continue with Google</span>
        </button>
      </div>
      <div id="loginError" class="error-text" style="margin-top:12px;text-align:center"></div>
    </div>
  </div>

  <!-- Product Detail Modal -->
  <div class="modal" id="productDetailModal" aria-hidden="true">
    <div class="modal-box" style="max-width:1000px">
      <button class="close-x" id="closeProductDetail" aria-label="Close">✕</button>
      
      <div class="pd-layout">
        <div class="pd-images">
          <img id="pdMainImg" class="pd-main-img" src="" alt="Product image">
          <div id="pdThumbs" class="pd-thumbs"></div>
        </div>

        <div class="pd-info">
          <h2 id="pdTitle" style="margin-top:0"></h2>
          <div id="pdPrice" class="pd-price"></div>
          <div id="pdRating" class="product-rating" style="margin-bottom:16px"></div>
          
          <button id="pdOrderBtn" class="btn" style="width:100%;margin-bottom:20px">Order Now</button>
          
          <hr style="border:none;border-top:1px solid var(--border);margin:20px 0">
          
          <h3 style="margin-bottom:10px">Write a Review</h3>
          <div class="review-stars" id="reviewStars">
            <span data-val="1">★</span>
            <span data-val="2">★</span>
            <span data-val="3">★</span>
            <span data-val="4">★</span>
            <span data-val="5">★</span>
          </div>
          <textarea id="reviewText" placeholder="Share your experience (optional)" style="width:100%;background:#0f1738;border:1px solid var(--border);border-radius:12px;padding:10px;color:var(--text-main);margin-bottom:10px"></textarea>
          <button id="submitReview" class="btn-ghost">Submit Review</button>
          
          <hr style="border:none;border-top:1px solid var(--border);margin:20px 0">
          
          <h3 style="margin-bottom:10px">Customer Reviews</h3>
          <div id="reviewsList" class="reviews-list"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Order Modal -->
  <div class="modal" id="orderModal" aria-hidden="true">
    <div class="modal-box" role="dialog" aria-modal="true" style="max-width:500px">
      <button class="close-x" id="closeOrderModal" aria-label="Close">✕</button>
      <h2>Confirm Your Order</h2>
      <p class="small" id="selectedProduct" style="margin:10px 0;color:var(--gold)"></p>
      
      <form id="orderForm">
        <div class="field">
          <label for="custName">Full Name *</label>
          <input id="custName" name="name" placeholder="Enter your full name" required>
          <div class="error-text" id="nameError"></div>
        </div>
        
        <div class="field">
          <label for="custPhone">Mobile Number *</label>
          <input id="custPhone" name="phone" type="tel" placeholder="10-digit mobile number" required>
          <div class="error-text" id="phoneError"></div>
        </div>
        
        <div class="field">
          <label for="custAddress">Delivery Address *</label>
          <textarea id="custAddress" name="address" placeholder="Enter complete address with pincode" required></textarea>
          <div class="error-text" id="addressError"></div>
        </div>

        <div style="margin-top:20px;display:flex;gap:10px;justify-content:flex-end">
          <button type="button" class="btn-ghost" id="cancelOrder">Cancel</button>
          <button type="submit" class="btn" id="placeOrderBtn">Place Order</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Admin Modal -->
  <div class="modal" id="adminModal" aria-hidden="true">
    <div class="modal-box" role="dialog" aria-modal="true" style="max-width:800px">
      <button class="close-x" id="closeAdmin" aria-label="Close">✕</button>
      <h2>Admin Panel</h2>

      <div class="admin-section">
        <h3 style="margin-top:0;color:#eaf6ff">Add Product</h3>
        
        <form id="adminProductForm">
          <div class="field">
            <label for="adminTitle">Product Title *</label>
            <input id="adminTitle" placeholder="e.g., Elegant Cotton Saree" required>
          </div>

          <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
            <div class="field">
              <label for="adminPrice">Selling Price (₹) *</label>
              <input id="adminPrice" type="number" min="0" placeholder="1499" required>
            </div>

            <div class="field">
              <label for="adminMrp">MRP (₹)</label>
              <input id="adminMrp" type="number" min="0" placeholder="1999">
            </div>
          </div>

          <div class="field">
            <label for="adminTag">Tag (Optional)</label>
            <input id="adminTag" placeholder="e.g., New Arrival, Best Seller">
          </div>

          <div class="field">
            <label>Image URLs *</label>
            <div id="imageUrlsContainer">
              <input class="imageUrlInput" placeholder="Image URL 1" style="margin-bottom:8px;width:100%;background:#0f1738;border:1px solid var(--border);border-radius:12px;padding:10px;color:var(--text-main)" required>
            </div>
            <button type="button" id="addImageUrl" class="btn-ghost" style="margin-top:8px">+ Add Another Image</button>
          </div>

          <div style="margin-top:16px;display:flex;gap:10px;justify-content:flex-end">
            <button type="submit" class="btn" id="adminSaveBtn">Add Product</button>
          </div>
        </form>
      </div>

      <div>
        <h3 style="margin:0 0 12px 0;color:#eaf6ff">Manage Products</h3>
        <div id="adminProductsList" class="admin-products-list">
          <div class="small" style="padding:20px;text-align:center;color:var(--muted)">Loading products...</div>
        </div>
      </div>

      <div style="margin-top:16px;display:flex;justify-content:flex-end">
        <button id="adminCloseBtn" class="btn-ghost">Close</button>
      </div>
    </div>
  </div>

  <footer style="text-align:center;padding:24px;color:#9fb8d9;font-size:13px;line-height:1.6;margin-top:40px;border-top:1px solid var(--border)">
    © 2025 Hamsa Sarees. All rights reserved.<br>
    Website designed & developed by Terminal Joint
  </footer>

<script type="module">
// ==================== INITIALIZATION ====================
(async function() {
  // Wait for DOM
  if (document.readyState === 'loading') {
    await new Promise(r => document.addEventListener('DOMContentLoaded', r));
  }

  // Utility function for DOM selection
  const $ = id => document.getElementById(id);
  
  // Error boundary
  window.addEventListener('error', (e) => {
    console.error('Global error:', e.error);
    showToast('An error occurred. Please refresh the page.', 'error');
  });

  // ==================== FIREBASE CONFIG ====================
  const firebaseConfig = {
    apiKey: "AIzaSyBozW19Rjc9nj0YabOIE3DlW0qVHtU5XLA",
    authDomain: "hamsasarees-24738.firebaseapp.com",
    projectId: "hamsasarees-24738",
    storageBucket: "hamsasarees-24738.firebasestorage.app",
    messagingSenderId: "16303342424",
    appId: "1:16303342424:web:d68d26160d45472713db2d"
  };

  // ==================== FIREBASE IMPORTS ====================
  let auth, db, firebaseLoaded = false;
  
  try {
    const { initializeApp } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js');
    const authModule = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js');
    const firestoreModule = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');

    const app = initializeApp(firebaseConfig);
    auth = authModule.getAuth(app);
    db = firestoreModule.getFirestore(app);
    
    // Export for global access
    window.firebaseAuth = authModule;
    window.firebaseFirestore = firestoreModule;
    window.auth = auth;
    window.db = db;
    
    firebaseLoaded = true;
    console.log('Firebase initialized successfully');
  } catch (error) {
    console.error('Firebase initialization failed:', error);
    showToast('Failed to initialize app. Please refresh.', 'error');
    return;
  }

  // ==================== UTILITY FUNCTIONS ====================
  function escapeHtml(text) {
    const map = {
      '&': '&amp;',
      '<': '&lt;',
      '>': '&gt;',
      '"': '&quot;',
      "'": '&#039;'
    };
    return String(text || '').replace(/[&<>"']/g, m => map[m]);
  }

  function showLoading(show = true) {
    const overlay = $('loadingOverlay');
    if (overlay) {
      overlay.classList.toggle('show', show);
    }
  }

  function showToast(message, type = 'success') {
    const toast = $('toast');
    if (!toast) return;
    
    toast.textContent = message;
    toast.className = `toast ${type} show`;
    
    setTimeout(() => {
      toast.classList.remove('show');
    }, 3000);
  }

  function openModal(modal) {
    if (!modal) return;
    modal.classList.add('show');
    modal.removeAttribute('aria-hidden');
    document.body.style.overflow = 'hidden';
  }

  function closeModal(modal) {
    if (!modal) return;
    modal.classList.remove('show');
    modal.setAttribute('aria-hidden', 'true');
    document.body.style.overflow = '';
    
    // Clear form if exists
    const form = modal.querySelector('form');
    if (form) form.reset();
  }

  function validatePhone(phone) {
    return /^[6-9]\d{9}$/.test(phone);
  }

  function formatDate(timestamp) {
    if (!timestamp) return '';
    const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
    return date.toLocaleDateString('en-IN', {
      day: '2-digit',
      month: 'short',
      year: 'numeric'
    });
  }

  // ==================== STATE MANAGEMENT ====================
  let currentUser = null;
  let currentProductId = null;
  let selectedRating = 0;
  let productsUnsubscribe = null;

  // ==================== AUTH FUNCTIONS ====================
  async function signInWithGoogle() {
    const { GoogleAuthProvider, signInWithPopup, signInWithRedirect, getRedirectResult } = window.firebaseAuth;
    const provider = new GoogleAuthProvider();
    
    showLoading();
    
    try {
      await signInWithPopup(auth, provider);
      showToast('Signed in successfully!');
      closeModal($('loginModal'));
    } catch (error) {
      console.error('Sign-in error:', error);
      
      // Handle popup blocked
      if (error.code === 'auth/popup-blocked' || 
          error.code === 'auth/popup-closed-by-user' ||
          error.code === 'auth/cancelled-popup-request') {
        try {
          await signInWithRedirect(auth, provider);
        } catch (redirectError) {
          showToast('Sign-in failed. Please allow popups.', 'error');
        }
      } else if (error.code === 'auth/unauthorized-domain') {
        showToast('Domain not authorized. Contact administrator.', 'error');
      } else {
        showToast('Sign-in failed. Please try again.', 'error');
      }
    } finally {
      showLoading(false);
    }
  }

  async function signOutUser() {
    const { signOut } = window.firebaseAuth;
    
    try {
      await signOut(auth);
      showToast('Signed out successfully');
    } catch (error) {
      console.error('Sign-out error:', error);
      showToast('Sign-out failed', 'error');
    }
  }

  // Check for redirect result on page load
  (async () => {
    const { getRedirectResult } = window.firebaseAuth;
    try {
      const result = await getRedirectResult(auth);
      if (result && result.user) {
        showToast('Signed in successfully!');
      }
    } catch (error) {
      console.warn('Redirect result error:', error);
    }
  })();

  // ==================== PRODUCT FUNCTIONS ====================
  function renderProductCard(docSnap) {
    const { collection, doc: firestoreDoc, onSnapshot } = window.firebaseFirestore;
    
    const id = docSnap.id;
    const data = docSnap.data() || {};
    const title = data.title || 'Untitled';
    const tag = data.tag || '';
    const images = data.images && data.images.length > 0 ? data.images : [data.img || ''];
    const primaryImage = images[0] || 'https://images.unsplash.com/photo-1610030469983-98e550d6193c?w=400';
    const price = data.price || 0;
    const mrp = data.mrp || price;
    
    const card = document.createElement('div');
    card.className = 'card';
    card.dataset.pid = id;
    
    // Image wrapper
    const imgWrap = document.createElement('div');
    imgWrap.className = 'imgwrap';
    imgWrap.dataset.images = JSON.stringify(images);
    
    // Tag
    if (tag) {
      const tagEl = document.createElement('div');
      tagEl.className = 'tag';
      tagEl.textContent = tag;
      imgWrap.appendChild(tagEl);
    }
    
    // Main image
    const imgEl = document.createElement('img');
    imgEl.loading = 'lazy';
    imgEl.src = primaryImage;
    imgEl.alt = title;
    imgWrap.appendChild(imgEl);
    
    // Multi-image indicator
    if (images.length > 1) {
      const indicator = document.createElement('div');
      indicator.textContent = `1/${images.length}`;
      indicator.style.cssText = 'position:absolute;bottom:8px;right:8px;background:rgba(0,0,0,0.7);color:white;padding:3px 8px;border-radius:10px;font-size:11px;font-weight:600';
      imgWrap.appendChild(indicator);
    }
    
    card.appendChild(imgWrap);
    
    // Title
    const h3 = document.createElement('h3');
    h3.textContent = title;
    card.appendChild(h3);
    
    // Price row
    const row = document.createElement('div');
    row.style.display = 'flex';
    row.style.justifyContent = 'space-between';
    row.style.alignItems = 'center';
    row.style.marginBottom = '8px';
    
    const priceWrap = document.createElement('div');
    priceWrap.className = 'price-wrap';
    
    // MRP (if different from price)
    if (mrp > price) {
      const oldPrice = document.createElement('span');
      oldPrice.className = 'price-old';
      oldPrice.textContent = `₹${mrp}`;
      priceWrap.appendChild(oldPrice);
    }
    
    // Selling price
    const newPrice = document.createElement('span');
    newPrice.className = 'price-new';
    newPrice.textContent = `₹${price}`;
    priceWrap.appendChild(newPrice);
    
    // Discount badge
    if (mrp > price) {
      const discount = Math.round(((mrp - price) / mrp) * 100);
      if (discount > 0) {
        const badge = document.createElement('span');
        badge.className = 'discount-badge';
        badge.textContent = `${discount}% OFF`;
        priceWrap.appendChild(badge);
      }
    }
    
    row.appendChild(priceWrap);
    
    // Rating
    const ratingEl = document.createElement('div');
    ratingEl.className = 'product-rating';
    ratingEl.textContent = 'Loading...';
    row.appendChild(ratingEl);
    
    card.appendChild(row);
    
    // Order button
    const orderBtn = document.createElement('button');
    orderBtn.className = 'btn';
    orderBtn.type = 'button';
    orderBtn.textContent = 'Order Now';
    orderBtn.style.width = '100%';
    orderBtn.dataset.product = title;
    orderBtn.dataset.price = price;
    orderBtn.dataset.image = primaryImage;
    card.appendChild(orderBtn);
    
    // Listen to reviews for live rating
    try {
      const reviewsRef = collection(db, 'products', id, 'reviews');
      onSnapshot(reviewsRef, (snap) => {
        let sum = 0;
        let count = 0;
        
        snap.forEach(docSnap => {
          const review = docSnap.data();
          if (typeof review.rating === 'number') {
            sum += review.rating;
            count++;
          }
        });
        
        if (count > 0) {
          const avg = (sum / count).toFixed(1);
          ratingEl.textContent = `★ ${avg} (${count})`;
        } else {
          ratingEl.textContent = 'No ratings';
        }
      });
    } catch (error) {
      console.warn('Could not attach rating listener:', error);
      ratingEl.textContent = 'No ratings';
    }
    
    return card;
  }

  function loadProducts() {
    const { collection, onSnapshot } = window.firebaseFirestore;
    const productGrid = $('productGrid');
    
    if (!productGrid) return;
    
    try {
      const productsRef = collection(db, 'products');
      
      productsUnsubscribe = onSnapshot(productsRef, (snapshot) => {
        productGrid.innerHTML = '';
        
        if (snapshot.empty) {
          const emptyState = document.createElement('div');
          emptyState.className = 'empty-state';
          emptyState.innerHTML = `
            <h3>No Products Available</h3>
            <div class="small" style="margin-top:8px">Products will appear here once added by admin.</div>
          `;
          productGrid.appendChild(emptyState);
          return;
        }
        
        snapshot.forEach(docSnap => {
          const card = renderProductCard(docSnap);
          productGrid.appendChild(card);
        });
      }, (error) => {
        console.error('Products snapshot error:', error);
        showToast('Failed to load products', 'error');
      });
    } catch (error) {
      console.error('Load products error:', error);
      showToast('Failed to load products', 'error');
    }
  }

  // ==================== PRODUCT DETAIL FUNCTIONS ====================
  function loadProductReviews(productId) {
    const { collection, onSnapshot } = window.firebaseFirestore;
    
    const pdRating = $('pdRating');
    const reviewsList = $('reviewsList');
    
    if (!pdRating || !reviewsList) return;
    
    pdRating.textContent = 'Loading reviews...';
    reviewsList.innerHTML = '<div class="small" style="padding:10px;text-align:center">Loading...</div>';
    
    try {
      const reviewsRef = collection(db, 'products', productId, 'reviews');
      
      onSnapshot(reviewsRef, (snapshot) => {
        let sum = 0;
        let count = 0;
        
        reviewsList.innerHTML = '';
        
        if (snapshot.empty) {
          pdRating.textContent = 'No reviews yet';
          reviewsList.innerHTML = '<div class="small" style="padding:10px;text-align:center;color:var(--muted)">No reviews yet. Be the first!</div>';
          return;
        }
        
        snapshot.forEach(docSnap => {
          const review = docSnap.data();
          
          if (typeof review.rating === 'number') {
            sum += review.rating;
            count++;
          }
          
          const reviewItem = document.createElement('div');
          reviewItem.className = 'review-item';
          
          const stars = '★'.repeat(review.rating || 0);
          const date = formatDate(review.createdAt);
          
          reviewItem.innerHTML = `
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">
              <strong>${escapeHtml(review.userName || 'Anonymous')}</strong>
              <span style="font-size:11px;color:var(--muted)">${date}</span>
            </div>
            <div style="color:var(--gold);margin-bottom:4px">${stars}</div>
            ${review.text ? `<div class="small">${escapeHtml(review.text)}</div>` : ''}
          `;
          
          reviewsList.appendChild(reviewItem);
        });
        
        if (count > 0) {
          const avg = (sum / count).toFixed(1);
          pdRating.textContent = `★ ${avg} (${count} reviews)`;
        }
      });
    } catch (error) {
      console.error('Load reviews error:', error);
      pdRating.textContent = 'Error loading reviews';
      reviewsList.innerHTML = '<div class="small" style="padding:10px;color:var(--danger)">Failed to load reviews</div>';
    }
  }

  // ==================== ORDER FUNCTIONS ====================
  async function placeOrder(orderData) {
    const { collection, addDoc, serverTimestamp } = window.firebaseFirestore;
    
    if (!currentUser) {
      showToast('Please sign in to place orders', 'error');
      return false;
    }
    
    try {
      showLoading();
      
      const ordersRef = collection(db, 'users', currentUser.uid, 'orders');
      
      await addDoc(ordersRef, {
        ...orderData,
        status: 'pending',
        createdAt: serverTimestamp()
      });
      
      showToast('Order placed successfully!');
      closeModal($('orderModal'));
      
      return true;
    } catch (error) {
      console.error('Place order error:', error);
      showToast('Failed to place order. Please try again.', 'error');
      return false;
    } finally {
      showLoading(false);
    }
  }

  // ==================== ADMIN FUNCTIONS ====================
  async function checkAdminStatus(user) {
    if (!user) return false;
    
    const { doc: firestoreDoc, getDoc } = window.firebaseFirestore;
    
    try {
      const adminDoc = await getDoc(firestoreDoc(db, 'admins', user.uid));
      return adminDoc.exists();
    } catch (error) {
      console.error('Check admin status error:', error);
      return false;
    }
  }

  async function loadAdminProducts() {
    const { collection, getDocs, deleteDoc, doc: firestoreDoc } = window.firebaseFirestore;
    
    const listContainer = $('adminProductsList');
    if (!listContainer) return;
    
    listContainer.innerHTML = '<div class="small" style="padding:20px;text-align:center;color:var(--muted)">Loading...</div>';
    
    try {
      const productsRef = collection(db, 'products');
      const snapshot = await getDocs(productsRef);
      
      if (snapshot.empty) {
        listContainer.innerHTML = '<div class="small" style="padding:20px;text-align:center;color:var(--muted)">No products yet</div>';
        return;
      }
      
      listContainer.innerHTML = '';
      
      snapshot.forEach(docSnap => {
        const id = docSnap.id;
        const data = docSnap.data() || {};
        
        const row = document.createElement('div');
        row.className = 'admin-product-row';
        
        row.innerHTML = `
          <div style="flex:1">
            <strong style="color:#eaf6ff">${escapeHtml(data.title || 'Untitled')}</strong>
            <div class="small" style="color:var(--muted)">₹${data.price || 0}</div>
          </div>
          <button class="btn btn-danger deleteProductBtn" data-id="${id}" type="button" style="white-space:nowrap">Delete</button>
        `;
        
        listContainer.appendChild(row);
        
        // Attach delete handler
        const deleteBtn = row.querySelector('.deleteProductBtn');
        deleteBtn.addEventListener('click', async () => {
          if (!confirm('Delete this product? This cannot be undone.')) return;
          
          try {
            showLoading();
            await deleteDoc(firestoreDoc(db, 'products', id));
            showToast('Product deleted');
            await loadAdminProducts();
          } catch (error) {
            console.error('Delete product error:', error);
            showToast('Failed to delete product', 'error');
          } finally {
            showLoading(false);
          }
        });
      });
    } catch (error) {
      console.error('Load admin products error:', error);
      listContainer.innerHTML = '<div class="small" style="padding:20px;color:var(--danger)">Failed to load</div>';
    }
  }

  async function addProduct(productData) {
    const { collection, addDoc, serverTimestamp } = window.firebaseFirestore;
    
    try {
      showLoading();
      
      const productsRef = collection(db, 'products');
      
      await addDoc(productsRef, {
        ...productData,
        createdAt: serverTimestamp()
      });
      
      showToast('Product added successfully!');
      
      // Reset form
      $('adminProductForm').reset();
      
      // Reset image inputs to default
      const container = $('imageUrlsContainer');
      container.innerHTML = '<input class="imageUrlInput" placeholder="Image URL 1" style="margin-bottom:8px;width:100%;background:#0f1738;border:1px solid var(--border);border-radius:12px;padding:10px;color:var(--text-main)" required>';
      
      await loadAdminProducts();
      
      return true;
    } catch (error) {
      console.error('Add product error:', error);
      showToast('Failed to add product', 'error');
      return false;
    } finally {
      showLoading(false);
    }
  }

  // ==================== EVENT LISTENERS ====================
  
  // Auth buttons
  $('googleSignInBtn')?.addEventListener('click', signInWithGoogle);
  $('loginShowBtn')?.addEventListener('click', () => openModal($('loginModal')));
  $('signOutBtn')?.addEventListener('click', signOutUser);
  
  // Modal close buttons
  document.querySelectorAll('.close-x').forEach(btn => {
    btn.addEventListener('click', () => {
      const modal = btn.closest('.modal');
      closeModal(modal);
    });
  });
  
  $('cancelOrder')?.addEventListener('click', () => closeModal($('orderModal')));
  $('adminCloseBtn')?.addEventListener('click', () => closeModal($('adminModal')));
  
  // Click outside modal to close
  document.querySelectorAll('.modal').forEach(modal => {
    modal.addEventListener('click', (e) => {
      if (e.target === modal) {
        closeModal(modal);
      }
    });
  });
  
  // ESC key to close modals
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
      document.querySelectorAll('.modal.show').forEach(modal => closeModal(modal));
    }
  });
  
  // Search functionality
  let searchTimeout;
  $('searchBox')?.addEventListener('input', (e) => {
    clearTimeout(searchTimeout);
    searchTimeout = setTimeout(() => {
      const query = e.target.value.toLowerCase().trim();
      
      document.querySelectorAll('#productGrid .card').forEach(card => {
        const title = card.querySelector('h3')?.textContent.toLowerCase() || '';
        const tag = card.querySelector('.tag')?.textContent.toLowerCase() || '';
        const matches = !query || title.includes(query) || tag.includes(query);
        card.style.display = matches ? '' : 'none';
      });
    }, 300);
  });
  
  // Shop now - scroll to products
  $('shopNow')?.addEventListener('click', () => {
    $('productGrid')?.scrollIntoView({ behavior: 'smooth', block: 'start' });
  });
  
  // Product grid - delegate clicks
  $('productGrid')?.addEventListener('click', (e) => {
    // Check if order button clicked
    const orderBtn = e.target.closest('.btn');
    if (orderBtn && orderBtn.dataset.product) {
      e.stopPropagation();
      
      if (!currentUser) {
        openModal($('loginModal'));
        showToast('Please sign in to place orders', 'error');
        return;
      }
      
      const product = orderBtn.dataset.product;
      const price = orderBtn.dataset.price;
      const image = orderBtn.dataset.image;
      
      $('selectedProduct').textContent = `${product} - ₹${price}`;
      $('orderForm').dataset.product = product;
      $('orderForm').dataset.price = price;
      $('orderForm').dataset.image = image;
      
      openModal($('orderModal'));
      return;
    }
    
    // Check if card clicked (for detail view)
    const card = e.target.closest('.card');
    if (card && card.dataset.pid) {
      currentProductId = card.dataset.pid;
      
      const imgWrap = card.querySelector('.imgwrap');
      const images = JSON.parse(imgWrap?.dataset.images || '[]');
      
      if (images.length > 0) {
        $('pdMainImg').src = images[0];
        
        const thumbsContainer = $('pdThumbs');
        thumbsContainer.innerHTML = '';
        
        images.forEach((src, i) => {
          const thumb = document.createElement('img');
          thumb.src = src;
          thumb.alt = `Thumbnail ${i + 1}`;
          if (i === 0) thumb.classList.add('active');
          
          thumb.addEventListener('click', () => {
            thumbsContainer.querySelectorAll('img').forEach(img => img.classList.remove('active'));
            thumb.classList.add('active');
            $('pdMainImg').src = src;
          });
          
          thumbsContainer.appendChild(thumb);
        });
      }
      
      $('pdTitle').textContent = card.querySelector('h3')?.textContent || '';
      $('pdPrice').textContent = card.querySelector('.price-new')?.textContent || '';
      
      loadProductReviews(currentProductId);
      
      openModal($('productDetailModal'));
    }
  });
  
  // Product detail - order button
  $('pdOrderBtn')?.addEventListener('click', () => {
    if (!currentUser) {
      closeModal($('productDetailModal'));
      openModal($('loginModal'));
      showToast('Please sign in to place orders', 'error');
      return;
    }
    
    const title = $('pdTitle').textContent;
    const priceText = $('pdPrice').textContent;
    const price = priceText.replace(/[^\d]/g, '');
    const image = $('pdMainImg').src;
    
    $('selectedProduct').textContent = `${title} - ₹${price}`;
    $('orderForm').dataset.product = title;
    $('orderForm').dataset.price = price;
    $('orderForm').dataset.image = image;
    
    closeModal($('productDetailModal'));
    openModal($('orderModal'));
  });
  
  // Review stars
  $('reviewStars')?.addEventListener('click', (e) => {
    const star = e.target.closest('span');
    if (!star) return;
    
    selectedRating = Number(star.dataset.val);
    
    $('reviewStars').querySelectorAll('span').forEach(s => {
      s.classList.toggle('active', Number(s.dataset.val) <= selectedRating);
    });
  });
  
  // Submit review
  $('submitReview')?.addEventListener('click', async () => {
    const { doc: firestoreDoc, setDoc, serverTimestamp } = window.firebaseFirestore;
    
    if (!currentUser) {
      showToast('Please sign in to write reviews', 'error');
      return;
    }
    
    if (!currentProductId) {
      showToast('Product not selected', 'error');
      return;
    }
    
    if (!selectedRating) {
      showToast('Please select a rating', 'error');
      return;
    }
    
    const reviewText = $('reviewText').value.trim();
    
    try {
      showLoading();
      
      const reviewRef = firestoreDoc(db, 'products', currentProductId, 'reviews', currentUser.uid);
      
      await setDoc(reviewRef, {
        rating: selectedRating,
        text: reviewText,
        userName: currentUser.displayName || 'Anonymous',
        createdAt: serverTimestamp()
      });
      
      showToast('Review submitted successfully!');
      
      // Reset
      $('reviewText').value = '';
      selectedRating = 0;
      $('reviewStars').querySelectorAll('span').forEach(s => s.classList.remove('active'));
      
    } catch (error) {
      console.error('Submit review error:', error);
      showToast('Failed to submit review', 'error');
    } finally {
      showLoading(false);
    }
  });
  
  // Order form submission
  $('orderForm')?.addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const name = $('custName').value.trim();
    const phone = $('custPhone').value.trim();
    const address = $('custAddress').value.trim();
    
    // Clear previous errors
    document.querySelectorAll('.error-text').forEach(el => el.classList.remove('show'));
    
    let hasError = false;
    
    if (!name) {
      $('nameError').textContent = 'Name is required';
      $('nameError').classList.add('show');
      hasError = true;
    }
    
    if (!phone) {
      $('phoneError').textContent = 'Phone number is required';
      $('phoneError').classList.add('show');
      hasError = true;
    } else if (!validatePhone(phone)) {
      $('phoneError').textContent = 'Enter valid 10-digit mobile number';
      $('phoneError').classList.add('show');
      hasError = true;
    }
    
    if (!address) {
      $('addressError').textContent = 'Address is required';
      $('addressError').classList.add('show');
      hasError = true;
    }
    
    if (hasError) return;
    
    const orderData = {
      product: $('orderForm').dataset.product,
      price: Number($('orderForm').dataset.price),
      image: $('orderForm').dataset.image,
      customerName: name,
      phone: phone,
      address: address,
      userId: currentUser.uid,
      userEmail: currentUser.email
    };
    
    await placeOrder(orderData);
  });
  
  // Admin button
  $('adminBtn')?.addEventListener('click', async () => {
    if (!currentUser) {
      showToast('Please sign in', 'error');
      return;
    }
    
    const isAdmin = await checkAdminStatus(currentUser);
    if (!isAdmin) {
      showToast('Admin access required', 'error');
      return;
    }
    
    await loadAdminProducts();
    openModal($('adminModal'));
  });
  
  // Add image URL input
  $('addImageUrl')?.addEventListener('click', () => {
    const container = $('imageUrlsContainer');
    const count = container.querySelectorAll('.imageUrlInput').length;
    
    const input = document.createElement('input');
    input.type = 'text';
    input.className = 'imageUrlInput';
    input.placeholder = `Image URL ${count + 1}`;
    input.style.cssText = 'margin-bottom:8px;width:100%;background:#0f1738;border:1px solid var(--border);border-radius:12px;padding:10px;color:var(--text-main)';
    
    container.appendChild(input);
  });
  
  // Admin product form
  $('adminProductForm')?.addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const title = $('adminTitle').value.trim();
    const price = Number($('adminPrice').value);
    const mrp = Number($('adminMrp').value) || price;
    const tag = $('adminTag').value.trim();
    
    const imageInputs = document.querySelectorAll('.imageUrlInput');
    const images = Array.from(imageInputs)
      .map(input => input.value.trim())
      .filter(url => url);
    
    if (!title || !price) {
      showToast('Title and price are required', 'error');
      return;
    }
    
    if (images.length === 0) {
      showToast('At least one image URL is required', 'error');
      return;
    }
    
    const productData = {
      title,
      price,
      mrp,
      tag,
      img: images[0],
      images
    };
    
    await addProduct(productData);
  });
  
  // ==================== AUTH STATE OBSERVER ====================
  const { onAuthStateChanged } = window.firebaseAuth;
  
  onAuthStateChanged(auth, async (user) => {
    currentUser = user;
    
    if (user) {
      // User signed in
      $('userBadge').textContent = user.displayName || user.email;
      $('userBadge').style.display = 'inline-block';
      $('signOutBtn').style.display = 'inline-block';
      $('loginShowBtn').style.display = 'none';
      
      // Check admin status
      const isAdmin = await checkAdminStatus(user);
      $('adminBtn').style.display = isAdmin ? 'inline-block' : 'none';
      
      closeModal($('loginModal'));
    } else {
      // User signed out
      $('userBadge').style.display = 'none';
      $('signOutBtn').style.display = 'none';
      $('loginShowBtn').style.display = 'inline-block';
      $('adminBtn').style.display = 'none';
    }
  });
  
  // ==================== INITIALIZE ====================
  loadProducts();
  
  console.log('✅ Hamsa Sarees initialized successfully');
  
})().catch(error => {
  console.error('Fatal initialization error:', error);
  alert('Failed to initialize application. Please refresh the page.');
});
</script>

</body>
</html>
