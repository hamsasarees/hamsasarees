<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Hamsa Sarees — Premium Handpicked Sarees</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">

<style>
:root{
  --bg-main:#0a0e1a;
  --bg-panel:#11172c;
  --bg-soft:#161e3d;
  --border:rgba(255,255,255,0.08);
  --gold:#e6b566;
  --gold-dark:#cfa34e;
  --text-main:#eef2ff;
  --text-muted:#9fb0d1;
  --success:#3ddc97;
  --danger:#ff6b6b;
}

*{box-sizing:border-box;margin:0;padding:0}

html,body{
  font-family:Inter,system-ui,Arial,sans-serif;
  background:radial-gradient(900px 400px at 20% -10%, rgba(230,181,102,.12), transparent 60%),
    linear-gradient(180deg,#080c18,#0a0e1a);
  color:var(--text-main);
  min-height:100vh;
}

.sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);border:0}

.spinner{
  border:3px solid rgba(255,255,255,0.1);
  border-top:3px solid var(--gold);
  border-radius:50%;
  width:24px;
  height:24px;
  animation:spin 0.8s linear infinite;
  display:inline-block;
}

@keyframes spin{
  0%{transform:rotate(0deg)}
  100%{transform:rotate(360deg)}
}

.loading-overlay{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,0.7);
  display:flex;
  align-items:center;
  justify-content:center;
  z-index:9999;
  display:none;
}

.loading-overlay.show{display:flex}

.toast{
  position:fixed;
  bottom:24px;
  right:24px;
  background:linear-gradient(135deg,#1a2447,#141c3f);
  border:1px solid var(--border);
  padding:14px 20px;
  border-radius:12px;
  box-shadow:0 20px 50px rgba(0,0,0,0.6);
  color:var(--text-main);
  font-size:14px;
  font-weight:600;
  display:none;
  z-index:10000;
  min-width:250px;
}

.toast.show{display:block;animation:slideIn 0.3s ease}
.toast.success{border-left:4px solid var(--success)}
.toast.error{border-left:4px solid var(--danger)}

@keyframes slideIn{
  from{transform:translateX(400px);opacity:0}
  to{transform:translateX(0);opacity:1}
}

.container{
  max-width:1200px;
  margin:auto;
  padding:20px 16px;
}

header{
  display:flex;
  align-items:center;
  gap:18px;
  padding:16px 18px;
  border-radius:16px;
  background:linear-gradient(180deg,#12183a,#0f152e);
  border:1px solid var(--border);
  box-shadow:0 20px 50px rgba(0,0,0,.45);
  flex-wrap:wrap;
}

.brand{
  display:flex;
  gap:12px;
  align-items:center;
}

.logo{
  width:48px;
  height:48px;
  border-radius:12px;
  background:linear-gradient(135deg,var(--gold),#f3d48c);
  color:#3b2b08;
  font-weight:900;
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:20px;
}

.title{
  font-weight:800;
  font-size:16px;
  line-height:1.3;
}

.small{
  font-size:13px;
  color:var(--text-muted);
  line-height:1.4;
}

.search{
  display:flex;
  align-items:center;
  gap:10px;
  background:#0f1738;
  border:1px solid var(--border);
  padding:10px 14px;
  border-radius:14px;
  max-width:420px;
  width:100%;
}

.search input{
  flex:1;
  background:none;
  border:none;
  outline:none;
  color:var(--text-main);
  font-size:14px;
}

.search input::placeholder{color:var(--text-muted)}

button,a{font-family:inherit}

.btn{
  background:linear-gradient(90deg,var(--gold),#f3d48c);
  color:#3b2b08;
  border:none;
  padding:10px 18px;
  border-radius:14px;
  font-weight:800;
  cursor:pointer;
  box-shadow:0 10px 30px rgba(230,181,102,.35);
  transition:transform 0.2s ease;
  font-size:14px;
}

.btn:hover:not(:disabled){transform:translateY(-1px)}
.btn:disabled{opacity:0.5;cursor:not-allowed}

.btn-ghost{
  background:#0f1738;
  border:1px solid var(--border);
  color:var(--text-main);
  padding:9px 16px;
  border-radius:14px;
  cursor:pointer;
  transition:background 0.2s ease;
  font-size:14px;
  text-decoration:none;
  display:inline-block;
}

.btn-ghost:hover:not(:disabled){background:#18225a}
.btn-ghost:disabled{opacity:0.5;cursor:not-allowed}

.btn-danger{
  background:linear-gradient(90deg,#ff3b3b,#ff5252);
  color:#fff;
}

.hero{
  display:grid;
  grid-template-columns:1.4fr .6fr;
  gap:18px;
  margin-top:22px;
}

.hero-card,
.promo{
  background:linear-gradient(180deg,#141c3f,#0f1533);
  border:1px solid var(--border);
  border-radius:20px;
  padding:24px;
  box-shadow:0 30px 70px rgba(0,0,0,.45);
}

.hero-card h1{
  margin:0 0 10px;
  font-size:30px;
  line-height:1.25;
}

.promo{text-align:center}

.grid{
  display:grid;
  grid-template-columns:repeat(auto-fill,minmax(220px,1fr));
  gap:18px;
  margin-top:18px;
}

.card{
  background:linear-gradient(180deg,#18245a,#111a3d);
  border:1px solid var(--border);
  border-radius:18px;
  padding:12px;
  cursor:pointer;
  transition:transform 0.25s ease;
  box-shadow:0 18px 45px rgba(0,0,0,.5);
}

.card:hover{transform:translateY(-6px)}

.imgwrap{
  width:100%;
  aspect-ratio:3/4;
  border-radius:14px;
  overflow:hidden;
  background:#080c1f;
  position:relative;
}

.imgwrap img{
  width:100%;
  height:100%;
  object-fit:cover;
  transition:transform .4s ease;
}

.card:hover .imgwrap img{transform:scale(1.05)}

.tag{
  position:absolute;
  top:10px;
  left:10px;
  z-index:5;
  padding:4px 12px;
  background:linear-gradient(90deg,var(--gold),#f3d48c);
  color:#3b2b08;
  font-size:12px;
  font-weight:800;
  border-radius:999px;
  pointer-events:none;
  transform:translateZ(0);
}

.card h3{
  margin:12px 0 6px;
  font-size:15px;
  font-weight:700;
}

.price-wrap{
  display:flex;
  align-items:baseline;
  gap:8px;
  flex-wrap:wrap;
}

.price-old{
  font-size:13px;
  color:var(--text-muted);
  text-decoration:line-through;
}

.price-new{
  font-size:17px;
  font-weight:900;
  color:var(--gold);
}

.discount-badge{
  font-size:12px;
  font-weight:800;
  background:#7ee0b2;
  color:#0a0e1a;
  padding:4px 10px;
  border-radius:999px;
  margin-left:auto;
}

.product-rating{
  font-size:13px;
  color:var(--success);
}

.modal{
  position:fixed;
  inset:0;
  background:rgba(5,8,15,.9);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:1000;
  padding:20px;
  overflow-y:auto;
}

.modal.show{display:flex}

.modal-box{
  background:linear-gradient(180deg,#162051,#0f1533);
  border:1px solid var(--border);
  border-radius:20px;
  padding:24px;
  max-width:900px;
  width:100%;
  max-height:90vh;
  overflow-y:auto;
  box-shadow:0 40px 120px rgba(0,0,0,.7);
  position:relative;
}

.close-x{
  position:absolute;
  top:16px;
  right:16px;
  background:none;
  border:none;
  color:var(--text-muted);
  font-size:24px;
  cursor:pointer;
  width:32px;
  height:32px;
  display:flex;
  align-items:center;
  justify-content:center;
  border-radius:8px;
  transition:background 0.2s ease;
}

.close-x:hover{background:rgba(255,255,255,0.05)}

.pd-layout{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:20px;
  margin-top:20px;
}

.pd-main-img{
  width:100%;
  border-radius:16px;
  cursor:zoom-in;
}

.pd-thumbs{
  display:flex;
  gap:8px;
  margin-top:10px;
  flex-wrap:wrap;
}

.pd-thumbs img{
  width:64px;
  height:86px;
  object-fit:cover;
  border-radius:10px;
  opacity:.6;
  cursor:pointer;
  transition:opacity 0.2s ease;
}

.pd-thumbs img:hover{opacity:0.8}
.pd-thumbs img.active{opacity:1;outline:2px solid var(--gold)}

.pd-price{
  font-size:22px;
  font-weight:900;
  color:var(--gold);
  margin:10px 0;
}

.review-stars{
  display:flex;
  gap:4px;
  font-size:24px;
  margin:10px 0;
}

.review-stars span{
  cursor:pointer;
  color:#555;
  transition:color 0.2s ease;
}

.review-stars span:hover,
.review-stars span.active{color:var(--gold)}

.reviews-list{
  display:flex;
  flex-direction:column;
  gap:10px;
  margin-top:10px;
  max-height:300px;
  overflow-y:auto;
}

.review-item{
  background:#0f1738;
  border:1px solid var(--border);
  border-radius:12px;
  padding:12px;
}

.field{
  margin-bottom:12px;
}

.field label{
  display:block;
  margin-bottom:6px;
  font-weight:600;
  font-size:13px;
}

.field input,
.field textarea{
  width:100%;
  background:#0f1738;
  border:1px solid var(--border);
  border-radius:12px;
  padding:10px;
  color:var(--text-main);
  font-size:14px;
  font-family:inherit;
}

.field input:focus,
.field textarea:focus{
  outline:none;
  border-color:var(--gold);
}

.field textarea{
  min-height:80px;
  resize:vertical;
}

.field input::placeholder,
.field textarea::placeholder{color:var(--text-muted)}

.error-text{
  color:var(--danger);
  font-size:12px;
  margin-top:4px;
  display:none;
}

.error-text.show{display:block}

.admin-section{
  border-bottom:1px solid rgba(255,255,255,0.06);
  padding:16px;
  margin-bottom:16px;
  background:rgba(255,255,255,0.01);
  border-radius:10px;
}

.admin-products-list{
  border:1px solid rgba(255,255,255,0.06);
  border-radius:10px;
  max-height:400px;
  overflow-y:auto;
  background:rgba(255,255,255,0.01);
}

.admin-product-row{
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:12px;
  border-bottom:1px solid rgba(255,255,255,0.03);
}

.admin-product-row:last-child{border-bottom:none}

@media(max-width:768px){
  header{flex-direction:column;align-items:stretch}
  .hero{grid-template-columns:1fr}
  .pd-layout{grid-template-columns:1fr}
  .grid{grid-template-columns:repeat(auto-fill,minmax(160px,1fr))}
  .toast{right:16px;bottom:16px;min-width:200px}
}

.empty-state{
  grid-column:1/-1;
  text-align:center;
  padding:48px 32px;
  background:rgba(255,255,255,0.02);
  border-radius:16px;
  border:1px dashed var(--border);
}

.empty-state h3{
  color:#eaf6ff;
  margin-bottom:8px;
}
</style>

</head>
<body>
  <div class="loading-overlay" id="loadingOverlay">
    <div class="spinner"></div>
  </div>

  <div class="toast" id="toast"></div>

  <div class="container">
    <header>
      <div class="brand">
        <div class="logo" aria-hidden="true">HS</div>
        <div>
          <div class="title">Hamsa Sarees</div>
          <div class="small">Handpicked • Ethnic • Quality</div>
        </div>
      </div>

      <div style="flex:1;display:flex;justify-content:center;min-width:200px">
        <div class="search" role="search" aria-label="Search products">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <circle cx="11" cy="11" r="8" stroke="#9fb6c9" stroke-width="1.5"/>
            <path d="M21 21l-4.35-4.35" stroke="#9fb6c9" stroke-width="1.5" stroke-linecap="round"/>
          </svg>
          <input id="searchBox" placeholder="Search sarees..." aria-label="Search products" />
        </div>
      </div>

      <div class="actions" style="display:flex;gap:10px;flex-wrap:wrap">
        <button id="adminBtn" class="btn-ghost" style="display:none">Admin</button>
        <div id="userBadge" style="display:none;background:rgba(255,255,255,0.03);padding:8px 12px;border-radius:10px;color:#fff;font-weight:700;font-size:13px"></div>
        <a href="yourorders.html" id="myOrdersBtn" class="btn-ghost" style="display:none">My Orders</a>
        <button id="signOutBtn" class="btn-ghost" style="display:none">Sign Out</button>
        <button id="loginShowBtn" class="btn">Sign In</button>
      </div>
    </header>

    <main>
      <section class="hero">
        <div class="hero-card">
          <h1>Real sarees. Real people. Real style.</h1>
          <p class="small">Curated collection with secure checkout. Your orders are saved to your account.</p>
          <div style="margin-top:14px;display:flex;gap:10px;flex-wrap:wrap">
            <button id="shopNow" class="btn">Shop Now</button>
            <button id="exploreBtn" class="btn-ghost">Explore</button>
          </div>
        </div>

        <aside class="promo" aria-label="Current promotion">
          <strong style="font-size:16px">Limited Offer</strong>
          <div class="small" style="margin-top:8px">Free shipping on orders above ₹3000</div>
          <div style="margin-top:12px;font-weight:800;color:#7ee0b2">Best Seller: Elegant Cotton — ₹1499</div>
        </aside>
      </section>

      <section style="margin-top:24px">
        <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:10px">
          <h2 style="margin:0">Products</h2>
          <div class="small">Sign in to place orders</div>
        </div>
        <div class="grid" id="productGrid" aria-live="polite">
          <div class="empty-state">
            <h3>No Products Available</h3>
            <div class="small" style="margin-top:8px">Products will appear here once added by admin.</div>
          </div>
        </div>
      </section>
    </main>
  </div>

  <!-- Login Modal -->
  <div class="modal" id="loginModal" aria-hidden="true">
    <div class="modal-box" role="dialog" aria-modal="true" style="max-width:400px">
      <button class="close-x" id="closeLogin" aria-label="Close">✕</button>
      <h2>Sign In</h2>
      <p class="small">Sign in with your Google account to place orders and write reviews.</p>
      <div style="display:flex;justify-content:center;margin-top:20px">
        <button id="googleSignInBtn" class="btn" style="width:100%">
          <span>Continue with Google</span>
        </button>
      </div>
      <div id="loginError" class="error-text" style="margin-top:12px;text-align:center"></div>
    </div>
  </div>

  <!-- Product Detail Modal -->
  <div class="modal" id="productDetailModal" aria-hidden="true">
    <div class="modal-box" style="max-width:1000px">
      <button class="close-x" id="closeProductDetail" aria-label="Close">✕</button>
      
      <div class="pd-layout">
        <div class="pd-images">
          <img id="pdMainImg" class="pd-main-img" src="" alt="Product image">
          <div id="pdThumbs" class="pd-thumbs"></div>
        </div>

        <div class="pd-info">
          <h2 id="pdTitle" style="margin-top:0"></h2>
          <div id="pdPrice" class="pd-price"></div>
          <div id="pdRating" class="product-rating" style="margin-bottom:16px"></div>
          
          <button id="pdOrderBtn" class="btn" style="width:100%;margin-bottom:20px">Order Now</button>
          
          <hr style="border:none;border-top:1px solid var(--border);margin:20px 0">
          
          <h3 style="margin-bottom:10px">Write a Review</h3>
          <div class="review-stars" id="reviewStars">
            <span data-val="1">★</span>
            <span data-val="2">★</span>
            <span data-val="3">★</span>
            <span data-val="4">★</span>
            <span data-val="5">★</span>
          </div>
          <textarea id="reviewText" placeholder="Share your experience (optional)" style="width:100%;background:#0f1738;border:1px solid var(--border);border-radius:12px;padding:10px;color:var(--text-main);margin-bottom:10px"></textarea>
          <button id="submitReview" class="btn-ghost">Submit Review</button>
          
          <hr style="border:none;border-top:1px solid var(--border);margin:20px 0">
          
          <h3 style="margin-bottom:10px">Customer Reviews</h3>
          <div id="reviewsList" class="reviews-list"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Order Modal -->
  <div class="modal" id="orderModal" aria-hidden="true">
    <div class="modal-box" role="dialog" aria-modal="true" style="max-width:500px">
      <button class="close-x" id="closeOrderModal" aria-label="Close">✕</button>
      <h2>Confirm Your Order</h2>
      <p class="small" id="selectedProduct" style="margin:10px 0;color:var(--gold)"></p>
      
      <form id="orderForm">
        <div class="field">
          <label for="custName">Full Name *</label>
          <input id="custName" name="name" placeholder="Enter your full name" required>
          <div class="error-text" id="nameError"></div>
        </div>
        
        <div class="field">
          <label for="custPhone">Mobile Number *</label>
          <input id="custPhone" name="phone" type="tel" placeholder="10-digit mobile number" required>
          <div class="error-text" id="phoneError"></div>
        </div>
        
        <div class="field">
          <label for="custAddress">Delivery Address *</label>
          <textarea id="custAddress" name="address" placeholder="Enter complete address with pincode" required></textarea>
          <div class="error-text" id="addressError"></div>
        </div>

        <div style="margin-top:20px;display:flex;gap:10px;justify-content:flex-end">
          <button type="button" class="btn-ghost" id="cancelOrder">Cancel</button>
          <button type="submit" class="btn" id="placeOrderBtn">Place Order</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Admin Modal -->
  <div class="modal" id="adminModal" aria-hidden="true">
    <div class="modal-box" role="dialog" aria-modal="true" style="max-width:800px">
      <button class="close-x" id="closeAdmin" aria-label="Close">✕</button>
      <h2>Admin Panel</h2>

      <div class="admin-section">
        <h3 style="margin-top:0;color:#eaf6ff">Add Product</h3>
        
        <form id="adminProductForm">
          <div class="field">
            <label for="adminTitle">Product Title *</label>
            <input id="adminTitle" placeholder="e.g., Elegant Cotton Saree" required>
          </div>

          <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
            <div class="field">
              <label for="adminPrice">Selling Price (₹) *</label>
              <input id="adminPrice" type="number" min="0" placeholder="1499" required>
            </div>

            <div class="field">
              <label for="adminMrp">MRP (₹)</label>
              <input id="adminMrp" type="number" min="0" placeholder="1999">
            </div>
          </div>

          <div class="field">
            <label for="adminTag">Tag (Optional)</label>
            <input id="adminTag" placeholder="e.g., New Arrival, Best Seller">
          </div>

          <div class="field">
            <label>Image URLs *</label>
            <div id="imageUrlsContainer">
              <input class="imageUrlInput" placeholder="Image URL 1" style="margin-bottom:8px;width:100%;background:#0f1738;border:1px solid var(--border);border-radius:12px;padding:10px;color:var(--text-main)" required>
            </div>
            <button type="button" id="addImageUrl" class="btn-ghost" style="margin-top:8px">+ Add Another Image</button>
          </div>

          <div style="margin-top:16px;display:flex;gap:10px;justify-content:flex-end">
            <button type="submit" class="btn" id="adminSaveBtn">Add Product</button>
          </div>
        </form>
      </div>

      <div>
        <h3 style="margin:0 0 12px 0;color:#eaf6ff">Manage Products</h3>
        <div id="adminProductsList" class="admin-products-list">
          <div class="small" style="padding:20px;text-align:center;color:var(--muted)">Loading products...</div>
        </div>
      </div>

      <div style="margin-top:16px;display:flex;justify-content:flex-end">
        <button id="adminCloseBtn" class="btn-ghost">Close</button>
      </div>
    </div>
  </div>

  <footer style="text-align:center;padding:24px;color:#9fb8d9;font-size:13px;line-height:1.6;margin-top:40px;border-top:1px solid var(--border)">
    © 2025 Hamsa Sarees. All rights reserved.<br>
    Website designed & developed by Terminal Joint
  </footer>

<script type="module">
(async function() {
  if (document.readyState === 'loading') {
    await new Promise(r => document.addEventListener('DOMContentLoaded', r));
  }

  const $ = id => document.getElementById(id);
  
  window.addEventListener('error', (e) => {
    console.error('Global error:', e.error);
    showToast('An error occurred. Please refresh the page.', 'error');
  });

  const firebaseConfig = {
    apiKey: "AIzaSyBozW19Rjc9nj0YabOIE3DlW0qVHtU5XLA",
    authDomain: "hamsasarees-24738.firebaseapp.com",
    projectId: "hamsasarees-24738",
    storageBucket: "hamsasarees-24738.firebasestorage.app",
    messagingSenderId: "16303342424",
    appId: "1:16303342424:web:d68d26160d45472713db2d"
  };

  let auth, db, firebaseLoaded = false;
  
  try {
    const { initializeApp } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js');
    const authModule = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js');
    const firestoreModule = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');

    const app = initializeApp(firebaseConfig);
    auth = authModule.getAuth(app);
    db = firestoreModule.getFirestore(app);
    
    window.firebaseAuth = authModule;
    window.firebaseFirestore = firestoreModule;
    window.auth = auth;
    window.db = db;
    
    firebaseLoaded = true;
    console.log('Firebase initialized successfully');
  } catch (error) {
    console.error('Firebase initialization failed:', error);
    showToast('Failed to initialize app. Please refresh.', 'error');
    return;
  }

  function escapeHtml(text) {
    const map = {
      '&': '&amp;',
      '<': '&lt;',
      '>': '&gt;',
      '"': '&quot;',
      "'": '&#039;'
    };
    return String(text || '').replace(/[&<>"']/g, m => map[m]);
  }

  function showLoading(show = true) {
    const overlay = $('loadingOverlay');
    if (overlay) {
      overlay.classList.toggle('show', show);
    }
  }

    function showToast(message, type = 'success') {
    const toast = $('toast');
    if (!toast) return;
    toast.textContent = message;
    toast.className = `toast show ${type}`;
    setTimeout(() => toast.classList.remove('show'), 3000);
  }

  const ADMIN_UID = "EenXHJIvZpavhkGTCI8EZyFAfH93";

  let currentUser = null;
  let productsCache = [];
  let selectedProduct = null;
  let selectedRating = 0;

  const {
    onAuthStateChanged,
    GoogleAuthProvider,
    signInWithPopup,
    signOut
  } = window.firebaseAuth;

  const {
    collection, addDoc, getDocs, doc, deleteDoc,
    query, where, orderBy, serverTimestamp
  } = window.firebaseFirestore;

  onAuthStateChanged(auth, async (user) => {
    currentUser = user;
    $('loginShowBtn').style.display = user ? 'none' : 'inline-block';
    $('signOutBtn').style.display = user ? 'inline-block' : 'none';
    $('myOrdersBtn').style.display = user ? 'inline-block' : 'none';
    $('userBadge').style.display = user ? 'inline-block' : 'none';
    $('adminBtn').style.display = (user && user.uid === ADMIN_UID) ? 'inline-block' : 'none';

    if (user) {
      $('userBadge').textContent = user.displayName || user.email;
      showToast('Signed in successfully');
    }
  });

  $('loginShowBtn').onclick = () => $('loginModal').classList.add('show');
  $('closeLogin').onclick = () => $('loginModal').classList.remove('show');

  $('googleSignInBtn').onclick = async () => {
    try {
      showLoading(true);
      const provider = new GoogleAuthProvider();
      await signInWithPopup(auth, provider);
      $('loginModal').classList.remove('show');
    } catch (e) {
      $('loginError').textContent = e.message;
      $('loginError').classList.add('show');
    } finally {
      showLoading(false);
    }
  };

  $('signOutBtn').onclick = async () => {
    await signOut(auth);
    showToast('Signed out');
  };

  async function loadProducts() {
    showLoading(true);
    const snap = await getDocs(collection(db, 'products'));
    productsCache = snap.docs.map(d => ({ id: d.id, ...d.data() }));
    renderProducts(productsCache);
    showLoading(false);
  }

  function renderProducts(list) {
    const grid = $('productGrid');
    grid.innerHTML = '';

    if (!list.length) {
      grid.innerHTML = `<div class="empty-state">
        <h3>No Products Available</h3>
        <div class="small">Products will appear here once added by admin.</div>
      </div>`;
      return;
    }

    list.forEach(p => {
      const card = document.createElement('div');
      card.className = 'card';
      card.innerHTML = `
        <div class="imgwrap">
          ${p.tag ? `<div class="tag">${escapeHtml(p.tag)}</div>` : ''}
          <img src="${p.images[0]}" alt="">
        </div>
        <h3>${escapeHtml(p.title)}</h3>
        <div class="price-wrap">
          ${p.mrp ? `<span class="price-old">₹${p.mrp}</span>` : ''}
          <span class="price-new">₹${p.price}</span>
        </div>
      `;
      card.onclick = () => openProductDetail(p);
      grid.appendChild(card);
    });
  }

  function openProductDetail(p) {
    selectedProduct = p;
    $('pdTitle').textContent = p.title;
    $('pdPrice').textContent = `₹${p.price}`;
    $('pdMainImg').src = p.images[0];

    const thumbs = $('pdThumbs');
    thumbs.innerHTML = '';
    p.images.forEach((img, i) => {
      const t = document.createElement('img');
      t.src = img;
      if (i === 0) t.classList.add('active');
      t.onclick = () => {
        $('pdMainImg').src = img;
        [...thumbs.children].forEach(x => x.classList.remove('active'));
        t.classList.add('active');
      };
      thumbs.appendChild(t);
    });

    $('productDetailModal').classList.add('show');
    loadReviews(p.id);
  }

  $('closeProductDetail').onclick = () => {
    $('productDetailModal').classList.remove('show');
  };

  $('pdOrderBtn').onclick = () => {
    if (!currentUser) {
      showToast('Please sign in to order', 'error');
      return;
    }
    $('selectedProduct').textContent = selectedProduct.title;
    $('orderModal').classList.add('show');
  };

  $('closeOrderModal').onclick =
  $('cancelOrder').onclick = () =>
    $('orderModal').classList.remove('show');

  $('orderForm').onsubmit = async (e) => {
    e.preventDefault();
    showLoading(true);

    await addDoc(collection(db, 'orders'), {
      uid: currentUser.uid,
      productId: selectedProduct.id,
      product: selectedProduct.title,
      price: selectedProduct.price,
      name: custName.value,
      phone: custPhone.value,
      address: custAddress.value,
      createdAt: serverTimestamp()
    });

    $('orderModal').classList.remove('show');
    showToast('Order placed successfully');
    showLoading(false);
  };

  $('reviewStars').onclick = (e) => {
    if (!e.target.dataset.val) return;
    selectedRating = Number(e.target.dataset.val);
    [...$('reviewStars').children].forEach(s =>
      s.classList.toggle('active', s.dataset.val <= selectedRating)
    );
  };

  $('submitReview').onclick = async () => {
    if (!currentUser || !selectedRating) {
      showToast('Login & select rating', 'error');
      return;
    }
    await addDoc(collection(db, 'reviews'), {
      productId: selectedProduct.id,
      uid: currentUser.uid,
      rating: selectedRating,
      text: reviewText.value,
      createdAt: serverTimestamp()
    });
    reviewText.value = '';
    selectedRating = 0;
    loadReviews(selectedProduct.id);
    showToast('Review submitted');
  };

  async function loadReviews(pid) {
    const q = query(collection(db, 'reviews'), where('productId', '==', pid));
    const snap = await getDocs(q);
    const box = $('reviewsList');
    box.innerHTML = '';
    snap.forEach(d => {
      const r = d.data();
      box.innerHTML += `<div class="review-item">
        <strong>${'★'.repeat(r.rating)}</strong>
        <div class="small">${escapeHtml(r.text || '')}</div>
      </div>`;
    });
  }

  $('adminBtn').onclick = () => {
    $('adminModal').classList.add('show');
    renderAdminProducts();
  };
  $('closeAdmin').onclick =
  $('adminCloseBtn').onclick = () =>
    $('adminModal').classList.remove('show');

  $('addImageUrl').onclick = () => {
    const i = document.createElement('input');
    i.className = 'imageUrlInput';
    i.placeholder = 'Image URL';
    i.style.cssText = $('imageUrlsContainer').firstElementChild.style.cssText;
    $('imageUrlsContainer').appendChild(i);
  };

  $('adminProductForm').onsubmit = async (e) => {
    e.preventDefault();
    const images = [...document.querySelectorAll('.imageUrlInput')]
      .map(i => i.value).filter(Boolean);

    await addDoc(collection(db, 'products'), {
      title: adminTitle.value,
      price: Number(adminPrice.value),
      mrp: Number(adminMrp.value || 0),
      tag: adminTag.value,
      images,
      createdAt: serverTimestamp()
    });

    showToast('Product added');
    loadProducts();
  };

  async function renderAdminProducts() {
    const box = $('adminProductsList');
    box.innerHTML = '';
    productsCache.forEach(p => {
      const row = document.createElement('div');
      row.className = 'admin-product-row';
      row.innerHTML = `
        <span>${p.title}</span>
        <button class="btn-danger btn">Delete</button>
      `;
      row.querySelector('button').onclick = async () => {
        await deleteDoc(doc(db, 'products', p.id));
        loadProducts();
        renderAdminProducts();
      };
      box.appendChild(row);
    });
  }

  loadProducts();
})();
</script>

