<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Orders - Hamsa Sarees</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<body>
    <div class="page-container">
        <header class="header">
            <div class="logo-container">
                <a href="index.html" class="logo-link">
                    <span class="logo-text">Hamsa Sarees</span>
                    <span class="tagline">Handpicked • Ethnic • Quality</span>
                </a>
            </div>
            <nav class="navigation">
                <a href="index.html" class="nav-link">Shop</a>
                <a href="yourorders.html" class="nav-link active">My Orders</a>
            </nav>
            <div class="user-actions">
                <div id="user-info" class="user-info" style="display: none;">
                    <i class="fas fa-user-circle"></i>
                    <span id="user-name"></span>
                </div>
                <button id="auth-btn" class="btn primary-btn"></button>
            </div>
        </header>

        <main class="main-content">
            <div class="orders-header">
                <h1>Your Orders</h1>
                <p>View and manage your saved orders. Please sign in to see your orders.</p>
            </div>
            <div id="orders-container" class="orders-container">
                <!-- Orders will be loaded here -->
            </div>
        </main>

        <div id="toast" class="toast" role="status" aria-live="polite"></div>

        <div id="order-detail-modal" class="modal" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-header">
                    <h2>Order Details</h2>
                    <button id="close-modal-btn" class="close-btn">&times;</button>
                </div>
                <div id="order-detail-content" class="modal-body">
                    <!-- Order details will be shown here -->
                </div>
            </div>
        </div>

        <footer class="footer">
            © 2025 Hamsa Sarees. All Rights Reserved. Designed by Terminal Joint.
        </footer>
    </div>

    <script type="module">
        (async function() {
            if (document.readyState === 'loading') {
                await new Promise(r => document.addEventListener('DOMContentLoaded', r));
            }

            const firebaseConfig = {
                apiKey: "AIzaSyBozW19Rjc9nj0YabOIE3DlW0qVHtU5XLA",
                authDomain: "hamsasarees-24738.firebaseapp.com",
                projectId: "hamsasarees-24738",
                storageBucket: "hamsasarees-24738.firebasestorage.app",
                messagingSenderId: "16303342424",
                appId: "1:16303342424:web:d68d26160d45472713db2d",
                measurementId: "G-1G1HQGJ5XS"
            };

            function escapeHtml(s) {
                return String(s === undefined || s === null ? '' : s).replace(/[&<>"']/g, c => ({
                    '&': '&amp;',
                    '<': '&lt;',
                    '>': '&gt;',
                    '"': '&quot;',
                    "'": '&#39;'
                } [c]));
            }

            try {
                const { initializeApp } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js');
                const { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js');
                const { getFirestore, collection, query, orderBy, getDocs, doc, deleteDoc } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');

                const app = initializeApp(firebaseConfig);
                const auth = getAuth(app);
                const db = getFirestore(app);
                const googleProvider = new GoogleAuthProvider();

                const $ = id => document.getElementById(id);
                const userInfo = $('user-info');
                const userName = $('user-name');
                const authBtn = $('auth-btn');
                const ordersContainer = $('orders-container');
                const toastEl = $('toast');
                const orderDetailModal = $('order-detail-modal');
                const orderDetailContent = $('order-detail-content');
                const closeModalBtn = $('close-modal-btn');

                function showToast(msg, isError = false) {
                    toastEl.textContent = msg;
                    toastEl.className = `toast show ${isError ? 'error' : ''}`;
                    setTimeout(() => {
                        toastEl.className = 'toast';
                    }, 3000);
                }

                function showModal() {
                    orderDetailModal.classList.add('show');
                    orderDetailModal.setAttribute('aria-hidden', 'false');
                }

                function closeModal() {
                    orderDetailModal.classList.remove('show');
                    orderDetailModal.setAttribute('aria-hidden', 'true');
                }

                closeModalBtn.addEventListener('click', closeModal);
                orderDetailModal.addEventListener('click', (e) => {
                    if (e.target === orderDetailModal) {
                        closeModal();
                    }
                });

                authBtn.addEventListener('click', () => {
                    if (auth.currentUser) {
                        signOut(auth).catch(e => showToast(`Sign-out failed: ${e.message}`, true));
                    } else {
                        signInWithPopup(auth, googleProvider).catch(e => showToast(`Sign-in failed: ${e.message}`, true));
                    }
                });

                onAuthStateChanged(auth, user => {
                    if (user) {
                        userInfo.style.display = 'flex';
                        userName.textContent = user.displayName || user.email;
                        authBtn.textContent = 'Sign Out';
                        authBtn.classList.remove('primary-btn');
                        authBtn.classList.add('secondary-btn');
                        loadUserOrders();
                    } else {
                        userInfo.style.display = 'none';
                        authBtn.textContent = 'Sign In';
                        authBtn.classList.remove('secondary-btn');
                        authBtn.classList.add('primary-btn');
                        ordersContainer.innerHTML = '<p class="placeholder-text">Please sign in to view your orders.</p>';
                    }
                });

                async function loadUserOrders() {
                    if (!auth.currentUser) return;
                    ordersContainer.innerHTML = '<div class="loader"></div>';

                    try {
                        const q = query(collection(db, `users/${auth.currentUser.uid}/orders`), orderBy('createdAt', 'desc'));
                        const snap = await getDocs(q);

                        if (snap.empty) {
                            ordersContainer.innerHTML = '<p class="placeholder-text">No orders yet. <a href="index.html">Start shopping!</a></p>';
                            return;
                        }

                        ordersContainer.innerHTML = '';
                        snap.forEach(docSnap => {
                            const order = docSnap.data();
                            const orderId = docSnap.id;
                            const orderDate = order.createdAt?.toDate().toLocaleDateString() || 'N/A';

                            const card = document.createElement('div');
                            card.className = 'order-card';
                            card.innerHTML = `
                                <div class="order-card-body">
                                    <div class="order-details">
                                        <h4>${escapeHtml(order.product || 'Unnamed Product')}</h4>
                                        <p><strong>Order ID:</strong> ${escapeHtml(orderId)}</p>
                                        <p><strong>Date:</strong> ${escapeHtml(orderDate)}</p>
                                    </div>
                                    <div class="order-actions">
                                        <button class="btn view-btn" data-id="${orderId}">Details</button>
                                        <button class="btn delete-btn" data-id="${orderId}"><i class="fas fa-trash-alt"></i></button>
                                    </div>
                                </div>
                            `;
                            ordersContainer.appendChild(card);

                            card.querySelector('.view-btn').addEventListener('click', () => {
                                orderDetailContent.innerHTML = `
                                    <p><strong>Product:</strong> ${escapeHtml(order.product)}</p>
                                    <p><strong>Name:</strong> ${escapeHtml(order.name)}</p>
                                    <p><strong>Phone:</strong> ${escapeHtml(order.phone)}</p>
                                    <p><strong>Address:</strong> ${escapeHtml(order.address)}</p>
                                    <p><strong>Order Date:</strong> ${orderDate}</p>
                                `;
                                showModal();
                            });

                            card.querySelector('.delete-btn').addEventListener('click', async () => {
                                if (confirm('Are you sure you want to delete this order?')) {
                                    try {
                                        await deleteDoc(doc(db, 'users', auth.currentUser.uid, 'orders', orderId));
                                        showToast('Order deleted successfully.');
                                        loadUserOrders();
                                    } catch (e) {
                                        showToast('Failed to delete order.', true);
                                    }
                                }
                            });
                        });
                    } catch (e) {
                        ordersContainer.innerHTML = '<p class="placeholder-text error">Failed to load orders. Please try again.</p>';
                        showToast(`Error: ${e.message}`, true);
                    }
                }

            } catch (err) {
                console.error('Initialization error', err);
                document.body.innerHTML = `<div style="text-align: center; padding: 50px; font-family: sans-serif; color: #d9534f;"><h1>Initialization Failed</h1><p>Could not load necessary components. Please check your internet connection and try again.</p></div>`;
            }
        })();
    </script>
</body>
</html>
