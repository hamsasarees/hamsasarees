<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Hamsa Sarees â€” Payment</title>

  <!-- âœ… FINAL, STABLE CSP FOR RAZORPAY + GOOGLE FORMS -->
  <!-- This version is PROVEN to work with Razorpay checkout -->
  <meta http-equiv="Content-Security-Policy" content="
    default-src 'self' https: data: blob:;
    script-src 'self' 'unsafe-inline' https://checkout.razorpay.com;
    style-src 'self' 'unsafe-inline' https://fonts.googleapis.com;
    font-src https://fonts.gstatic.com data:;
    frame-src https://checkout.razorpay.com https://api.razorpay.com;
    connect-src
  https://api.razorpay.com
  https://checkout.razorpay.com
  https://docs.google.com
  https://firestore.googleapis.com
  https://identitytoolkit.googleapis.com;

    img-src 'self' data: https:;
  " />

  <link href="https://fonts.googleapis.com/css2?familyInter:wght@300;400;600;700;800&display=swap" rel="stylesheet">

  <style>
    body{margin:0;font-family:Inter,system-ui,Arial,sans-serif;background:linear-gradient(180deg,#001f3f,#00306b);color:#eaf6ff;display:flex;align-items:center;justify-content:center;min-height:100vh}
    .card{background:linear-gradient(180deg,#071522,#06121a);border-radius:14px;padding:24px;max-width:420px;width:100%;box-shadow:0 20px 60px rgba(0,0,0,.45);border:1px solid rgba(255,255,255,0.05)}
    h1{margin:0 0 6px;font-size:22px;font-weight:800}
    .small{color:#9fb8d9;font-size:14px;margin-bottom:14px}
    .row{margin-bottom:12px}
    label{display:block;font-size:13px;color:#9fb8d9;margin-bottom:6px}
    input{width:100%;padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,0.08);background:#0b1220;color:#fff;font-size:14px}
    .price{font-size:20px;font-weight:800;color:#4dd0e1;margin:8px 0 14px}
    button{width:100%;padding:14px;border-radius:12px;border:none;background:linear-gradient(90deg,#00aaff,#ff5aa3);color:#fff;font-weight:800;font-size:15px;cursor:pointer}
    button:disabled{opacity:.6;cursor:not-allowed}
  </style>
</head>
<body>

  <div class="card">
    <h1>Secure Payment</h1>
    <div class="small">Powered by Razorpay</div>

    <div class="row">
      <label>Product</label>
      <input id="product" readonly />
    </div>

    <div class="row">
      <label>Amount</label>
      <div class="price" id="priceText">â‚¹0</div>
    </div>

    <div class="row">
      <label>Your Name</label>
      <input id="name" />
    </div>

    <div class="row">
      <label>Email</label>
      <input id="email" type="email" placeholder="optional" />
    </div>

    <div class="row">
      <label>Phone</label>
      <input id="phone" />
    </div>

    <button id="payBtn">Pay Now</button>
  </div>

  <!-- Razorpay checkout MUST be before inline script -->
  <script src="https://checkout.razorpay.com/v1/checkout.js"></script>

  <script>
    // ---------- READ URL PARAMS ----------
   const rawOrder = sessionStorage.getItem('pendingOrder');

if (!rawOrder) {
  alert('Invalid access. Please place order again.');
  window.location.href = 'index.html';
}

const order = JSON.parse(rawOrder);

    const productEl = document.getElementById('product');
    const priceText = document.getElementById('priceText');
    const nameEl = document.getElementById('name');
    const phoneEl = document.getElementById('phone');
    const emailEl = document.getElementById('email');
    const payBtn = document.getElementById('payBtn');

    if (!price || isNaN(price) || price <= 0) {
      alert('Invalid payment link. Please place order again.');
      payBtn.disabled = true;
    } else {
      priceText.innerText = 'â‚¹' + price;
    }
const price = Number(order.price);
const product = order.product;

productEl.value = order.product;
priceText.innerText = 'â‚¹' + order.price;
nameEl.value = order.name;
phoneEl.value = order.phone;

    // ---------- RAZORPAY ----------
    <script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import { getFirestore, doc, setDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyBozW19Rjc9nj0YabOIE3DlW0qVHtU5XLA",
  authDomain: "hamsasarees-24738.firebaseapp.com",
  projectId: "hamsasarees-24738"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

let currentUser = null;

onAuthStateChanged(auth, user => {
  if (!user) {
    alert('Please sign in first');
    window.location.href = 'index.html';
  }
  currentUser = user;
});
</script>
<script>
payBtn.addEventListener('click', function () {
  if (typeof Razorpay === 'undefined') {
    alert('Razorpay SDK not loaded. Open via HTTPS / Live Server.');
    return;
  }

  payBtn.disabled = true;
  const amountPaise = Math.round(price * 100);

  const options = {
    key: 'rzp_live_Rqulhc8rZRz8Iw',
    amount: amountPaise,
    currency: 'INR',
    name: 'Hamsa Sarees',
    description: product || 'Order Payment',

    handler: async function (response) {
      const orderId = crypto.randomUUID();

      // ðŸ”¹ SAVE TO FIRESTORE
      await setDoc(
        doc(db, 'users', currentUser.uid, 'orders', orderId),
        {
          product: order.product,
          price: order.price,
          name: order.name,
          phone: order.phone,
          address: order.address,
          paymentId: response.razorpay_payment_id,
          status: 'PAID',
          createdAt: serverTimestamp()
        }
      );

      // ðŸ”¹ SEND TO GOOGLE FORM
      const formUrl =
        'https://docs.google.com/forms/d/e/1FAIpQLSfREKvTld9R59UADJQK6jxQIbM64tt1iP0M-XiPq4ykOOwe5w/formResponse';

      const fd = new FormData();
      fd.append('entry.1128392407', order.name);
      fd.append('entry.654904844', order.address);
      fd.append('entry.1644126654', order.phone);
      fd.append('entry.1866699911', order.product);

      fetch(formUrl, { method: 'POST', body: fd, mode: 'no-cors' });

      sessionStorage.removeItem('pendingOrder');
      alert('Payment successful!');
      window.location.href = 'yourorders.html';
    },

    prefill: {
      name: nameEl.value,
      email: emailEl.value,
      contact: phoneEl.value
    },

    theme: { color: '#00aaff' }
  };

  const rzp = new Razorpay(options);

  rzp.on('payment.failed', function (resp) {
    alert('Payment failed: ' + resp.error.description);
    payBtn.disabled = false;
  });

  rzp.open();
});
  
  </script>
</body>
</html>
