<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Hamsa Sarees — Professional Shop</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
<style>
  :root{--accent:#e91e63;--muted:#6b7280;--bg:#f7f7fb;--card:#ffffff}
  *{box-sizing:border-box}
  body{font-family:Inter,system-ui,Arial,sans-serif;margin:0;background:var(--bg);color:#0f172a}
  header{background:linear-gradient(90deg,#0b1220,#111827);color:#fff;padding:14px 24px;display:flex;align-items:center;justify-content:space-between}
  .brand{font-weight:700;font-size:20px}
  nav{display:flex;gap:12px;align-items:center}
  .btn{cursor:pointer;border-radius:8px;padding:8px 12px;border:none;font-weight:600}
  .btn-ghost{background:transparent;color:#fff;border:1px solid rgba(255,255,255,0.08)}
  .btn-primary{background:var(--accent);color:#fff}
  .container{max-width:1100px;margin:28px auto;padding:0 18px}
  .hero{display:flex;gap:24px;align-items:center}
  .hero-left{flex:1}
  .hero h1{margin:0;font-size:28px}
  .small{color:var(--muted)}
  .grid{display:grid;grid-template-columns:repeat(3,1fr);gap:18px;margin-top:22px}
  .card{background:var(--card);border-radius:12px;padding:14px;box-shadow:0 6px 18px rgba(12,20,40,0.06);display:flex;flex-direction:column}
  .imgwrap{height:220px;border-radius:10px;background:#f1f5f9;display:flex;align-items:center;justify-content:center;color:#94a3b8;font-weight:600}
  .card h3{margin:12px 0 6px;font-size:18px}
  .price{color:#059669;font-weight:700}
  .card-foot{margin-top:auto}
  .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(2,6,23,0.6);z-index:1000;padding:18px}
  .modal-box{max-width:720px;width:100%;background:#fff;border-radius:12px;padding:18px}
  .modal-box h2{margin:0 0 8px}
  .field{display:flex;flex-direction:column;margin-bottom:10px}
  .field input,.field textarea{padding:10px;border-radius:8px;border:1px solid #e6e9ef;font-size:15px}
  .modal-footer{display:flex;gap:10px;margin-top:10px}
  footer{max-width:1100px;margin:36px auto 80px;padding:0 18px;color:var(--muted);font-size:14px}
  .orders-list{max-height:300px;overflow:auto;border:1px solid #eef2f6;padding:10px;border-radius:8px}
  @media(max-width:900px){.grid{grid-template-columns:repeat(2,1fr)}.hero{flex-direction:column;align-items:flex-start}}
  @media(max-width:600px){.grid{grid-template-columns:1fr}.imgwrap{height:180px}}
</style>
</head>
<body>

<header>
  <div class="brand">Hamsa Sarees</div>
  <nav>
    <div id="userBadge" style="display:none;background:rgba(255,255,255,0.06);padding:8px 10px;border-radius:8px;color:#fff;font-weight:600"></div>
    <button id="myOrdersBtn" class="btn btn-ghost" style="display:none">My Orders</button>
    <button id="signOutBtn" class="btn btn-ghost" style="display:none">Sign out</button>
    <button id="loginShowBtn" class="btn btn-primary">Sign in</button>
  </nav>
</header>

<main class="container">
  <section class="hero">
    <div class="hero-left">
      <h1>Handpicked sarees. Fast delivery.</h1>
      <p class="small">Quality fabrics, classic designs — sign in with Google or Apple to place orders. Your orders will be saved under your account.</p>
      <div style="margin-top:16px"><button id="shopNow" class="btn btn-primary">Shop Now</button></div>
    </div>
    <div class="hero-right">
      <div style="background:#fff;border-radius:12px;padding:12px;box-shadow:0 6px 18px rgba(12,20,40,0.04);width:260px">
        <strong>Best Seller</strong>
        <div style="margin-top:8px;color:var(--muted)">Elegant Cotton Saree</div>
        <div style="margin-top:10px;font-weight:700;color:#059669">₹1499</div>
      </div>
    </div>
  </section>

  <section>
    <div style="display:flex;align-items:center;justify-content:space-between">
      <h2 style="margin:22px 0 0">Products</h2>
      <div class="small" style="margin-top:22px">Signed-in users can place orders; orders saved to your account</div>
    </div>

    <div class="grid" id="productGrid">
      <div class="card">
        <div class="imgwrap" id="img1">Upload Image Here</div>
        <h3>Beautiful Saree</h3>
        <div class="price">₹1499</div>
        <div class="card-foot"><button class="btn btn-primary orderBtn" style="width:100%;margin-top:12px" data-product="Beautiful Saree">Order Now</button></div>
      </div>

      <div class="card">
        <div class="imgwrap" id="img2">Upload Image Here</div>
        <h3>Designer Saree</h3>
        <div class="price">₹1799</div>
        <div class="card-foot"><button class="btn btn-primary orderBtn" style="width:100%;margin-top:12px" data-product="Designer Saree">Order Now</button></div>
      </div>

      <div class="card">
        <div class="imgwrap">New Arrival</div>
        <h3>Silk Blend Saree</h3>
        <div class="price">₹2199</div>
        <div class="card-foot"><button class="btn btn-primary orderBtn" style="width:100%;margin-top:12px" data-product="Silk Blend Saree">Order Now</button></div>
      </div>

    </div>
  </section>
</main>

<!-- Order Modal -->
<div class="modal" id="orderModal">
  <div class="modal-box" style="position:relative">
    <h2>Confirm Your Order</h2><button id="closeOrderModal" class="btn btn-ghost" style="position:absolute;top:12px;right:12px">✕</button>
    <p class="small" id="selectedProduct"> </p>
    <form id="orderForm" method="POST" action="https://docs.google.com/forms/d/e/1FAIpQLSfREKvTld9R59UADJQK6jxQIbM64tt1iP0M-XiPq4ykOOwe5w/formResponse" target="hiddenFrame">
      <div class="field"><input id="custName" name="entry.1128392407" placeholder="Your Name" required></div>
      <div class="field"><textarea id="custAddress" name="entry.654904844" placeholder="Address" required></textarea></div>
      <div class="field"><input id="custPhone" name="entry.1644126654" placeholder="Mobile Number" required></div>
      <div class="field"><input id="productField" name="entry.1866699911" readonly></div>
      <div style="display:flex;gap:10px;align-items:center">
        <button class="btn btn-primary" id="placeOrder">Place Order</button>
        <button type="button" class="btn btn-ghost" id="cancelOrder">Cancel</button>
      </div>
    </form>
    <div id="orderStatus" class="small" style="margin-top:10px;color:green;display:none">Order placed. Thank you!</div>
  </div>
</div>

<!-- Login Modal -->
<div class="modal" id="loginModal">
  <div class="modal-box" style="position:relative">
    <h2>Sign in</h2><button id="closeLogin" class="btn btn-ghost" style="position:absolute;top:12px;right:12px">✕</button>
    <p class="small">Use Google or Apple to sign in. No typing required.</p>
    <div style="display:flex;gap:10px;justify-content:center;margin-top:12px">
      <button id="googleBtnLarge" class="btn btn-primary">Sign in with Google</button>
      <button id="appleBtnLarge" class="btn" style="background:#111;color:#fff">Sign in with Apple</button>
    </div>
    <p id="loginErr" class="small" style="margin-top:12px;color:#b91c1c;display:none"></p>
    <p class="small" style="margin-top:10px">If popup is blocked, allow popups or try again in a new tab.</p>
  </div>
</div>

<!-- My Orders Modal -->
<div class="modal" id="myOrdersModal">
  <div class="modal-box" style="position:relative">
    <h2>My Orders</h2><button id="closeMyOrdersX" class="btn btn-ghost" style="position:absolute;top:12px;right:12px">✕</button>
    <div class="orders-list" id="ordersList"></div>
    <div style="display:flex;gap:10px;margin-top:12px"><button id="closeOrders" class="btn btn-ghost">Close</button></div>
  </div>
</div>

<iframe name="hiddenFrame" style="display:none;"></iframe>
<footer>© Hamsa Sarees • Built with care</footer>

<script type="module">
document.addEventListener('DOMContentLoaded', async () => {
  try{
    const { initializeApp } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js');
    const { getAuth, GoogleAuthProvider, OAuthProvider, signInWithPopup, signInWithRedirect, getRedirectResult, signOut, onAuthStateChanged } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js');
    const { getFirestore, collection, addDoc, serverTimestamp, query, orderBy, getDocs } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');

    const firebaseConfig = {
      apiKey: "AIzaSyBozW19Rjc9nj0YabOIE3DlW0qVHtU5XLA",
      authDomain: "hamsasarees-24738.firebaseapp.com",
      projectId: "hamsasarees-24738",
      storageBucket: "hamsasarees-24738.firebasestorage.app",
      messagingSenderId: "16303342424",
      appId: "1:16303342424:web:d68d26160d45472713db2d",
      measurementId: "G-1G1HQGJ5XS"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const googleProvider = new GoogleAuthProvider();
    const appleProvider = new OAuthProvider('apple.com');
    appleProvider.addScope('email');

    // DOM
    const loginModal = document.getElementById('loginModal');
    const myOrdersModal = document.getElementById('myOrdersModal');
    const orderModal = document.getElementById('orderModal');
    const loginErr = document.getElementById('loginErr');
    const loginShowBtn = document.getElementById('loginShowBtn');
    const googleBtnLarge = document.getElementById('googleBtnLarge');
    const appleBtnLarge = document.getElementById('appleBtnLarge');
    const userBadge = document.getElementById('userBadge');
    const signOutBtn = document.getElementById('signOutBtn');
    const myOrdersBtn = document.getElementById('myOrdersBtn');
    const ordersList = document.getElementById('ordersList');

    function showLoginError(msg){ if(loginErr){ loginErr.innerText = msg; loginErr.style.display = msg ? 'block' : 'none'; } }

    // handle redirect result
    try{ const rr = await getRedirectResult(auth); if(rr && rr.user) console.log('redirect result user', rr.user.uid); }catch(e){ console.warn('redirect result error', e && e.code); }

    async function signInWithProviderPopup(provider){ showLoginError(''); try{ const res = await signInWithPopup(auth, provider); console.log('signed-in', res.user.uid); }catch(e){ console.error('popup error', e && e.code, e && e.message); const popupErrors = ['auth/popup-blocked','auth/popup-closed-by-user','auth/cancelled-popup-request']; if(e && popupErrors.includes(e.code)){ try{ await signInWithRedirect(auth, provider); return; }catch(err){ showLoginError('Popup blocked and redirect failed. Allow popups or try another browser.'); return; } } if(e && e.code === 'auth/unauthorized-domain'){ showLoginError('Domain not authorized. Add your GitHub Pages domain in Firebase console → Authentication → Authorized domains.'); } else{ showLoginError(e && e.message ? e.message : 'Sign-in failed'); } } }

    googleBtnLarge && googleBtnLarge.addEventListener('click', () => signInWithProviderPopup(googleProvider));
    appleBtnLarge && appleBtnLarge.addEventListener('click', () => signInWithProviderPopup(appleProvider));
    loginShowBtn && loginShowBtn.addEventListener('click', () => { if(loginModal) loginModal.style.display = 'flex'; });

    signOutBtn && signOutBtn.addEventListener('click', async () => { try{ await signOut(auth); }catch(e){ console.error('signout failed', e); } });

    // order button click
    document.querySelectorAll('.orderBtn').forEach(btn => btn.addEventListener('click', (ev)=>{
      const prod = ev.currentTarget.getAttribute('data-product');
      if(!auth.currentUser){ if(loginModal) loginModal.style.display='flex'; showLoginError('Please sign in to place orders'); return; }
      document.getElementById('selectedProduct').innerText = prod;
      document.getElementById('productField').value = prod;
      if(orderModal) orderModal.style.display = 'flex';
    }));

    document.getElementById('cancelOrder').addEventListener('click', ()=>{ if(orderModal) orderModal.style.display='none'; });

    // close buttons for modals
    const closeLogin = document.getElementById('closeLogin');
    if(closeLogin) closeLogin.addEventListener('click', ()=>{ if(loginModal) loginModal.style.display='none'; });

    const closeOrderModalBtn = document.getElementById('closeOrderModal');
    if(closeOrderModalBtn) closeOrderModalBtn.addEventListener('click', ()=>{ if(orderModal) orderModal.style.display='none'; });

    const closeMyOrdersX = document.getElementById('closeMyOrdersX');
    if(closeMyOrdersX) closeMyOrdersX.addEventListener('click', ()=>{ if(myOrdersModal) myOrdersModal.style.display='none'; });

    // place order: submit form and save under user's account
    document.getElementById('placeOrder').addEventListener('click', async (ev)=>{
      ev.preventDefault();
      const name = document.getElementById('custName').value.trim();
      const address = document.getElementById('custAddress').value.trim();
      const phone = document.getElementById('custPhone').value.trim();
      const product = document.getElementById('productField').value;
      if(!name || !address || !phone){ alert('Fill all fields'); return; }

      // submit original Google Form
      const form = document.getElementById('orderForm'); form.submit();

      // Save under users/{uid}/orders and also root orders for admin
      try{
        const uid = auth.currentUser ? auth.currentUser.uid : null;
        const orderData = { product, name, address, phone, user: uid, userEmail: auth.currentUser ? auth.currentUser.email : null, createdAt: serverTimestamp() };
        if(uid){
          await addDoc(collection(db, `users/${uid}/orders`), orderData);
        }
        await addDoc(collection(db, 'orders'), orderData);
        document.getElementById('orderStatus').style.display='block';
        // redirect to payment page after brief confirmation
        setTimeout(()=>{ window.location.href = 'payment.html'; }, 1200);
      }catch(e){ console.error('save order failed', e); showLoginError('Order recorded to form but server save failed. See console.'); }
    });

    // My Orders
    myOrdersBtn && myOrdersBtn.addEventListener('click', async ()=>{
      if(!auth.currentUser){ if(loginModal) loginModal.style.display='flex'; showLoginError('Please sign in to view your orders'); return; }
      // fetch user's orders
      ordersList.innerHTML = 'Loading...';
      try{
        const uid = auth.currentUser.uid;
        const q = query(collection(db, `users/${uid}/orders`), orderBy('createdAt','desc'));
        const snap = await getDocs(q);
        if(snap.empty){ ordersList.innerHTML = '<div class="small">No orders yet</div>'; } else {
          ordersList.innerHTML = '';
          snap.forEach(doc => {
            const o = doc.data();
            const el = document.createElement('div');
            el.style.padding='8px'; el.style.borderBottom='1px solid #f1f5f9';
            el.innerHTML = `<strong>${o.product||''}</strong><div class='small'>${o.name||''} • ${o.phone||''}</div><div class='small'>${o.address||''}</div><div class='small' style='color:#64748b'>${o.createdAt ? new Date(o.createdAt.seconds*1000).toLocaleString() : ''}</div>`;
            ordersList.appendChild(el);
          });
        }
        if(myOrdersModal) myOrdersModal.style.display='flex';
      }catch(e){ console.error('fetch orders failed', e); ordersList.innerHTML = '<div class="small">Failed to load orders</div>'; }
    });

    document.getElementById('closeOrders').addEventListener('click', ()=>{ if(myOrdersModal) myOrdersModal.style.display='none'; });

    // auth state
    onAuthStateChanged(auth, (user)=>{
      if(user){ if(loginModal) loginModal.style.display='none'; if(userBadge){ userBadge.style.display='inline-block'; userBadge.innerText = user.displayName || user.email; } if(signOutBtn) signOutBtn.style.display='inline-block'; if(myOrdersBtn) myOrdersBtn.style.display='inline-block'; loginShowBtn.style.display='none'; } else { if(loginModal) loginModal.style.display='flex'; if(userBadge) userBadge.style.display='none'; if(signOutBtn) signOutBtn.style.display='none'; if(myOrdersBtn) myOrdersBtn.style.display='none'; loginShowBtn.style.display='inline-block'; } });

    // shop now
    document.getElementById('shopNow').addEventListener('click', ()=>{ document.getElementById('productGrid').scrollIntoView({behavior:'smooth'}); });

    // initial UI
    if(!auth.currentUser){ if(loginModal) loginModal.style.display='flex'; }

  }catch(err){ console.error('Init error', err); const le = document.getElementById('loginErr'); if(le){ le.innerText='Initialization error. See console.'; le.style.display='block'; } }
});
</script>


<!-- Extra safety script: ensure modal close buttons exist and placeOrder redirects properly -->
<script>
(function(){
  function safe(q){return document.querySelector(q);} 
  function addCloseButton(modalId, btnId){
    const modal = safe('#'+modalId);
    if(!modal) return;
    const box = modal.querySelector('.modal-box');
    if(!box) return;
    if(box.querySelector('#'+btnId)) return; // already exists
    const btn = document.createElement('button');
    btn.id = btnId;
    btn.className = 'btn btn-ghost';
    btn.style.position = 'absolute';
    btn.style.top = '12px';
    btn.style.right = '12px';
    btn.innerText = '✕';
    btn.style.color = '#ff2b2b';
    btn.style.fontWeight = '700';
    box.style.position = box.style.position || 'relative';
    box.appendChild(btn);
    btn.addEventListener('click', ()=>{ modal.style.display = 'none'; });
  }

  function ensureCloseButtons(){
    addCloseButton('loginModal','closeLogin');
    addCloseButton('orderModal','closeOrderModal');
    addCloseButton('myOrdersModal','closeMyOrdersX');
  }

  // Ensure placeOrder redirects after submit/save
  function ensurePlaceOrderRedirect(){
    const placeBtn = safe('#placeOrder');
    if(!placeBtn) return;
    // remove existing handlers to avoid double-submit
    placeBtn.replaceWith(placeBtn.cloneNode(true));
    const newBtn = safe('#placeOrder');
    newBtn.addEventListener('click', async function(ev){
      ev.preventDefault();
      const form = document.getElementById('orderForm');
      if(!form){ alert('Form not found'); return; }
      // submit the form to Google Forms (iframe target)
      try{ form.submit(); }catch(e){ console.warn('form.submit failed', e); }
      // small delay to let iframe submit, then redirect to payment
      setTimeout(()=>{
        try{ window.location.href = 'payment.html'; }catch(e){ console.error('redirect failed', e); }
      }, 900);
    });
  }

  // run after DOM ready
  if(document.readyState === 'loading') document.addEventListener('DOMContentLoaded', ()=>{ ensureCloseButtons(); ensurePlaceOrderRedirect(); });
  else { ensureCloseButtons(); ensurePlaceOrderRedirect(); }
})();
</script>
</body>
</html>
