<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Hamsa Sarees — Rebuilt</title>
  <meta name="description" content="Hamsa Sarees — curated cotton, silk and traditional sarees. Mobile-first, simple checkout and Google sign-in." />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">
  <meta name="theme-color" content="#001f3f">
  <style>
    :root{
      --bg1:#001f3f; --bg2:#00306b; --accent:#00aaff; --accent2:#4dd0e1; --muted:#9fb8d9; --success:#10b981;
      --card:#071522; --glass:rgba(255,255,255,0.03);
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:Inter,system-ui,Arial,sans-serif;background:linear-gradient(180deg,var(--bg1),var(--bg2));color:#eaf6ff;-webkit-font-smoothing:antialiased}
    a{color:inherit}
    .container{max-width:1100px;margin:20px auto;padding:0 16px}
    header{display:flex;align-items:center;justify-content:space-between;gap:12px;padding:12px}
    .brand{display:flex;gap:12px;align-items:center}
    .logo{width:44px;height:44px;border-radius:10px;background:linear-gradient(135deg,var(--accent),var(--accent2));display:flex;align-items:center;justify-content:center;font-weight:800;color:#032033;box-shadow:0 12px 40px rgba(0,170,255,0.12)}
    .title{font-weight:800}
    .search{display:flex;align-items:center;background:var(--glass);padding:8px;border-radius:10px;gap:8px;border:1px solid rgba(255,255,255,0.02)}
    .search input{background:transparent;border:none;color:#eaf6ff;outline:none;width:220px}
    .actions{display:flex;gap:8px;align-items:center}
    .btn{cursor:pointer;border-radius:10px;padding:9px 14px;border:none;font-weight:700;background:linear-gradient(90deg,var(--accent),#ff5aa3);color:#fff;box-shadow:0 8px 24px rgba(0,170,255,0.12);transition:transform .15s,filter .15s}
    .btn:active{transform:translateY(1px)}
    .btn-ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);color:#fff;padding:8px 12px;border-radius:10px}
    .hero{display:flex;gap:16px;align-items:flex-start;margin-top:8px}
    .hero-card{flex:1;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));padding:18px;border-radius:12px;backdrop-filter: blur(6px)}
    .promo{width:260px;padding:12px;border-radius:10px;background:linear-gradient(135deg,#061526,#072234);box-shadow:0 10px 40px rgba(0,0,0,0.4)}
    .grid{display:grid;grid-template-columns:repeat(3,1fr);gap:14px;margin-top:16px}
    .card{background:linear-gradient(180deg,#071522,#06121a);padding:12px;border-radius:12px;transition:transform .2s,box-shadow .2s;overflow:hidden;position:relative}
    .card:hover{transform:translateY(-8px);box-shadow:0 24px 60px rgba(2,6,23,0.6)}
    .imgwrap{height:180px;border-radius:10px;background:#081522;display:flex;align-items:center;justify-content:center;overflow:hidden}
    .imgwrap img{width:100%;height:100%;object-fit:cover;display:block}
    h3{margin:10px 0 6px;color:#eaf6ff}
    .price{color:#7ee0b2;font-weight:800}
    .tag{position:absolute;top:10px;left:10px;background:rgba(0,0,0,0.4);padding:6px 8px;border-radius:8px;font-size:12px}
    .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:linear-gradient(180deg,rgba(3,8,20,0.6),rgba(2,8,18,0.85));z-index:1200;padding:12px}
    .modal-box{max-width:720px;width:100%;background:linear-gradient(180deg,#071522,#06121a);border-radius:12px;padding:16px;color:#eaf6ff;position:relative;box-shadow:0 30px 80px rgba(2,6,23,0.6)}
    .close-x{position:absolute;top:12px;right:12px;background:transparent;border:none;color:#ff3b3b;font-weight:800;font-size:18px;cursor:pointer}
    .field{display:flex;flex-direction:column;margin-top:10px}
    .field input,.field textarea,select{padding:12px;border-radius:10px;border:none;background:#08121a;color:#dbeafe}
    .small{color:var(--muted)}
    .orders-list{max-height:60vh;overflow:auto;border-radius:10px;padding:8px;background:linear-gradient(180deg,#06131a,#071722)}
    .toast{position:fixed;right:16px;bottom:16px;background:#0b1220;padding:10px 14px;border-radius:10px;color:#d1fae5;border-left:4px solid var(--success);box-shadow:0 8px 30px rgba(2,6,23,0.6);display:none}
    @media (max-width:1000px){ .grid{grid-template-columns:repeat(2,1fr)} .promo{display:none} .search input{width:140px} }
    @media (max-width:640px){
      header{flex-direction:column;align-items:stretch;padding:12px 16px}
      .search{width:100%;margin-top:8px}
      .grid{grid-template-columns:1fr}
      .imgwrap{height:200px}
      .modal-box{width:100%;height:100%;border-radius:12px 12px 0 0;max-width:none;display:flex;flex-direction:column;overflow:auto;padding:14px}
    }
    @keyframes floaty{0%{transform:translateY(0)}50%{transform:translateY(-6px)}100%{transform:translateY(0)}}
    .imgwrap img{animation:floaty 6s ease-in-out infinite}
    button:focus,input:focus,select:focus{outline:3px solid rgba(0,170,255,0.12);outline-offset:3px}
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="brand">
        <div class="logo" aria-hidden="true">HS</div>
        <div>
          <div class="title">Hamsa Sarees</div>
          <div class="small">Handpicked • Ethnic • Quality</div>
        </div>
      </div>

      <div style="flex:1;display:flex;justify-content:center">
        <div class="search" role="search" aria-label="Search products">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M21 21l-4.35-4.35" stroke="#9fb6c9" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
          <input id="searchBox" placeholder="Search sarees, cotton, silk..." aria-label="Search products" />
        </div>
      </div>

      <div class="actions" aria-hidden="false">
        <div id="userBadge" style="display:none;background:rgba(255,255,255,0.03);padding:8px 10px;border-radius:10px;color:#fff;font-weight:700"></div>
        <button id="myOrdersBtn" class="btn-ghost" style="display:none">My Orders</button>
        <button id="signOutBtn" class="btn-ghost" style="display:none">Sign out</button>
        <button id="loginShowBtn" class="btn">Sign in</button>
      </div>
    </header>

    <main>
      <section class="hero" style="gap:16px">
        <div class="hero-card">
          <h1>Real sarees. Real people. Real style.</h1>
          <p class="small">Curated collection, saved orders for your account, and a smooth checkout. Mobile-first.</p>
          <div style="margin-top:14px;display:flex;gap:10px">
            <button id="shopNow" class="btn">Shop Now</button>
            <button id="exploreBtn" class="btn-ghost">Collections</button>
          </div>
        </div>

        <aside class="promo" aria-hidden="true">
          <strong>Limited Offer</strong>
          <div class="small" style="margin-top:8px">Free shipping on orders above ₹3000</div>
          <div style="margin-top:12px;font-weight:800;color:#7ee0b2">Best Seller: Elegant Cotton — ₹1499</div>
        </aside>
      </section>

      <section style="margin-top:12px">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <h2 style="margin:0">Products</h2>
          <div class="small">Sign in to place orders; orders saved to your account</div>
        </div>

        <div class="grid" id="productGrid">
          <!-- Product cards: use reasonable Unsplash params so images are deterministic -->
          <!-- Reusable card template (static for single-file demo) -->
          <div class="card">
            <div class="tag">New</div>
            <div class="imgwrap" id="img1"><img src="https://images.unsplash.com/photo-1520975918016-4d0b5b0b2f3d?auto=format&fit=crop&w=1200&q=80" alt="Beautiful Saree"/></div>
            <h3>Beautiful Saree</h3>
            <div style="display:flex;justify-content:space-between;align-items:center"><div class="price">₹1499</div><div class="small" aria-hidden="true">★★★★☆</div></div>
            <div style="margin-top:8px"><button class="orderBtn btn" data-product="Beautiful Saree">Order Now</button></div>
          </div>

          <div class="card">
            <div class="imgwrap" id="img2"><img src="https://images.unsplash.com/photo-1541099649105-f69ad21f3246?auto=format&fit=crop&w=1200&q=80" alt="Designer Saree"/></div>
            <h3>Designer Saree</h3>
            <div style="display:flex;justify-content:space-between;align-items:center"><div class="price">₹1799</div><div class="small" aria-hidden="true">★★★★★</div></div>
            <div style="margin-top:8px"><button class="orderBtn btn" data-product="Designer Saree">Order Now</button></div>
          </div>

          <!-- More products -->
          <script type="application/json" id="product-data">[
            {"title":"Silk Blend Saree","price":"₹2199","img":"https://images.unsplash.com/photo-1512436991641-6745cdb1723f?auto=format&fit=crop&w=1200&q=80","rating":"★★★★☆"},
            {"title":"Traditional Silk Saree","price":"₹2499","img":"https://images.unsplash.com/photo-1526170375885-4d8ecf77b99f?auto=format&fit=crop&w=800&q=80","rating":"★★★★★"},
            {"title":"Printed Saree","price":"₹1299","img":"https://images.unsplash.com/photo-1520975708797-6c2adbb7b6f8?auto=format&fit=crop&w=800&q=80","rating":"★★★★☆"},
            {"title":"Kanchipuram Saree","price":"₹3999","img":"https://images.unsplash.com/photo-1600093463592-573f8b75edc0?auto=format&fit=crop&w=800&q=80","rating":"★★★★★"},
            {"title":"Banarasi Saree","price":"₹3499","img":"https://images.unsplash.com/photo-1583391733956-3cfb32c36ffa?auto=format&fit=crop&w=800&q=80","rating":"★★★★★"},
            {"title":"Cotton Daily Wear Saree","price":"₹999","img":"https://images.unsplash.com/photo-1607345366925-3b4a2b50b5df?auto=format&fit=crop&w=800&q=80","rating":"★★★☆☆"},
            {"title":"Georgette Saree","price":"₹1599","img":"https://images.unsplash.com/photo-1610030462145-49d1c7e5d0a4?auto=format&fit=crop&w=800&q=80","rating":"★★★★☆"}
          ]</script>
        </div>
      </section>
    </main>
  </div>

  <!-- Modals -->
  <div class="modal" id="orderModal" aria-hidden="true">
    <div class="modal-box" role="dialog" aria-modal="true" aria-labelledby="orderTitle">
      <button class="close-x" id="closeOrderModal" title="Close">✕</button>
      <h2 id="orderTitle">Confirm Your Order</h2>
      <p class="small" id="selectedProduct"></p>
      <form id="orderForm" method="POST" target="hiddenFrame" action="https://docs.google.com/forms/d/e/1FAIpQLSfREKvTld9R59UADJQK6jxQIbM64tt1iP0M-XiPq4ykOOwe5w/formResponse">
        <label class="small" for="custName">Name</label>
        <div class="field"><input id="custName" name="entry.1128392407" placeholder="Your Name" required></div>
        <label class="small" for="custAddress">Address</label>
        <div class="field"><textarea id="custAddress" name="entry.654904844" placeholder="Address" required></textarea></div>
        <label class="small" for="custPhone">Mobile</label>
        <div class="field"><input id="custPhone" name="entry.1644126654" placeholder="Mobile Number" required></div>
        <div class="field"><input id="productField" name="entry.1866699911" readonly aria-readonly="true"></div>
        <div class="modal-footer" style="margin-top:12px;display:flex;gap:8px">
          <button type="submit" class="btn" id="placeOrder">Place Order</button>
          <button type="button" class="btn-ghost" id="cancelOrder">Cancel</button>
        </div>
      </form>
      <div id="orderStatus" class="small" style="margin-top:10px;color:var(--success);display:none">Order placed. Thank you!</div>
    </div>
  </div>

  <div class="modal" id="loginModal" aria-hidden="true">
    <div class="modal-box" role="dialog" aria-modal="true" aria-labelledby="loginTitle">
      <button class="close-x" id="closeLogin" title="Close">✕</button>
      <h2 id="loginTitle">Sign in with Google</h2>
      <p class="small">No typing required — uses Google auth.</p>
      <div style="display:flex;justify-content:center;margin-top:12px">
        <button id="googleBtnLarge" class="btn">Sign in with Google</button>
      </div>
      <p id="loginErr" class="small" style="margin-top:12px;color:#ffb4b4;display:none"></p>
    </div>
  </div>

  <div class="modal" id="paymentModal" aria-hidden="true">
    <div class="modal-box" role="dialog" aria-modal="true" aria-labelledby="paymentTitle">
      <button class="close-x" id="closePayment" title="Close">✕</button>
      <h2 id="paymentTitle">Payment</h2>
      <p class="small" id="paymentSummary" style="white-space:pre-line"></p>
      <div style="margin-top:12px;display:flex;gap:10px;flex-direction:column">
        <label class="small" for="paymentMethod">Select Payment Method</label>
        <select id="paymentMethod" style="padding:12px;border-radius:10px;border:none;background:#08121a;color:#dbeafe">
          <option value="card">Card (Test)</option>
          <option value="upi">UPI (Test)</option>
          <option value="cod">Cash on Delivery</option>
        </select>
        <button class="btn" id="payNow">Pay Now</button>
      </div>
      <div id="paymentMsg" class="small" style="margin-top:10px;color:var(--success);display:none">Payment successful. Finalizing order...</div>
    </div>
  </div>

  <div class="modal" id="myOrdersModal" aria-hidden="true">
    <div class="modal-box" role="dialog" aria-modal="true" aria-labelledby="ordersTitle">
      <button class="close-x" id="closeMyOrdersX" title="Close">✕</button>
      <h2 id="ordersTitle">My Orders</h2>
      <div class="orders-list" id="ordersList"></div>
      <div style="display:flex;gap:10px;margin-top:12px"><button id="closeOrders" class="btn-ghost">Close</button></div>
    </div>
  </div>

  <iframe name="hiddenFrame" style="display:none"></iframe>
  <div id="toast" class="toast" role="status" aria-live="polite">Saved.</div>

  <!-- Application JS (module) -->
  <script type="module">
  (async function(){
    if(document.readyState === 'loading') await new Promise(r=>document.addEventListener('DOMContentLoaded', r));

    const $ = id => document.getElementById(id);

    // small helper: show/hide modal and support click-outside-to-close
    function openModal(modal){
      if(!modal) return;
      modal.style.display = 'flex';
      modal.setAttribute('aria-hidden','false');
    }
    function closeModal(modal){
      if(!modal) return;
      modal.style.display = 'none';
      modal.setAttribute('aria-hidden','true');
    }
    document.querySelectorAll('.modal').forEach(m => {
      m.addEventListener('click', (ev) => {
        if(ev.target === m) closeModal(m); // click backdrop closes
      });
    });

    function toast(msg){
      const t = $('toast'); if(!t) return;
      t.innerText = msg; t.style.display = 'block';
      setTimeout(()=> t.style.display = 'none', 2100);
    }

    // Populate extra products from JSON block (keeps HTML readable)
    try{
      const pjson = document.getElementById('product-data');
      if(pjson){
        const data = JSON.parse(pjson.textContent || '[]');
        const grid = document.getElementById('productGrid');
        data.forEach(item=>{
          const d = document.createElement('div');
          d.className = 'card';
          d.innerHTML = `
            <div class="imgwrap"><img src="${item.img}" alt="${item.title}"></div>
            <h3>${item.title}</h3>
            <div style="display:flex;justify-content:space-between;align-items:center"><div class="price">${item.price}</div><div class="small">${item.rating}</div></div>
            <div style="margin-top:8px"><button class="orderBtn btn" data-product="${item.title}">Order Now</button></div>
          `;
          grid.appendChild(d);
        });
      }
    }catch(e){ console.warn('populate products failed', e); }

    // Defensive DOM refs
    const loginModal = $('loginModal'), orderModal = $('orderModal'), paymentModal = $('paymentModal'), myOrdersModal = $('myOrdersModal');
    const loginErr = $('loginErr'), userBadge = $('userBadge'), signOutBtn = $('signOutBtn'), loginShowBtn = $('loginShowBtn'), googleBtnLarge = $('googleBtnLarge');
    const myOrdersBtn = $('myOrdersBtn'), ordersList = $('ordersList'), toastEl = $('toast');

    function showLoginError(msg){ if(!loginErr) return; loginErr.innerText = msg; loginErr.style.display = msg ? 'block' : 'none'; }

    // Try to initialize Firebase only if available (CDN)
    let firebaseAvailable = false;
    let auth = null, db = null, authModule = null, fsModule = null;
    try{
      // dynamic import - these will fail on file:// so hosting is required
      const { initializeApp } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js');
      authModule = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js');
      fsModule = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');

      const { getAuth, GoogleAuthProvider, signInWithPopup, signInWithRedirect, getRedirectResult, signOut, onAuthStateChanged } = authModule;
      const { getFirestore, collection, addDoc, serverTimestamp, query, orderBy, getDocs } = fsModule;

      // Keep firebaseConfig present (it's public client config). Replace project values if you have your own.
      const firebaseConfig = {
        apiKey: "AIzaSyBozW19Rjc9nj0YabOIE3DlW0qVHtU5XLA",
        authDomain: "hamsasarees-24738.firebaseapp.com",
        projectId: "hamsasarees-24738",
        storageBucket: "hamsasarees-24738.firebasestorage.app",
        messagingSenderId: "16303342424",
        appId: "1:16303342424:web:d68d26160d45472713db2d",
        measurementId: "G-1G1HQGJ5XS"
      };

      const app = initializeApp(firebaseConfig);
      auth = getAuth(app);
      db = getFirestore(app);
      window._firebaseHelpers = { auth, db, authModule, fsModule }; // dev helper
      firebaseAvailable = true;

      // handle redirect fallback
      try{ await getRedirectResult(auth); }catch(e){ console.debug('redirect result problem', e && e.code); }

      // sign-in helper
      async function signInPopup(){
        showLoginError('');
        try{
          const googleProvider = new authModule.GoogleAuthProvider();
          const res = await signInWithPopup(auth, googleProvider);
          toast('Signed in');
        }catch(e){
          console.error('sign-in error', e && e.code);
          const popupErrors = ['auth/popup-blocked','auth/popup-closed-by-user','auth/cancelled-popup-request'];
          if(e && popupErrors.includes(e.code)){
            try{ await signInWithRedirect(auth, new authModule.GoogleAuthProvider()); return; }catch(err){ showLoginError('Popup blocked and redirect failed. Allow popups.'); return; }
          }
          if(e && e.code === 'auth/unauthorized-domain'){
            showLoginError('Domain not authorized. Add your hosting domain in Firebase console → Authentication → Authorized domains.');
          } else showLoginError(e && e.message ? e.message : 'Sign-in failed');
        }
      }

      if(googleBtnLarge) googleBtnLarge.addEventListener('click', signInPopup);
      if(loginShowBtn) loginShowBtn.addEventListener('click', ()=> openModal(loginModal));
      if(signOutBtn) signOutBtn.addEventListener('click', async ()=> { try{ await signOut(auth); toast('Signed out'); }catch(e){ console.error(e);} });

      // auth state handler
      onAuthStateChanged(auth, user=>{
        if(user){
          if(loginModal) closeModal(loginModal);
          if(userBadge){ userBadge.style.display='inline-block'; userBadge.innerText = user.displayName || user.email; userBadge.setAttribute('title', user.email || '') }
          if(signOutBtn) signOutBtn.style.display='inline-block';
          if(myOrdersBtn) myOrdersBtn.style.display='inline-block';
          if(loginShowBtn) loginShowBtn.style.display='none';
        }else{
          if(userBadge) userBadge.style.display='none';
          if(signOutBtn) signOutBtn.style.display='none';
          if(myOrdersBtn) myOrdersBtn.style.display='none';
          if(loginShowBtn) loginShowBtn.style.display='inline-block';
          // open login modal only on first load, not forcibly during user flow
          // openModal(loginModal);
        }
      });

      // My Orders
      if(myOrdersBtn){
        myOrdersBtn.addEventListener('click', async ()=>{
          if(!auth.currentUser){ openModal(loginModal); showLoginError('Please sign in to view your orders'); return; }
          ordersList.innerHTML = '<div class="small">Loading...</div>';
          try{
            const uid = auth.currentUser.uid;
            const q = query(collection(db, `users/${uid}/orders`), orderBy('createdAt','desc'));
            const snap = await getDocs(q);
            if(snap.empty){ ordersList.innerHTML = '<div class="small">No orders yet</div>'; }
            else {
              ordersList.innerHTML = '';
              snap.forEach(doc=>{
                const o = doc.data();
                const el = document.createElement('div');
                el.style.padding = '10px'; el.style.borderBottom = '1px solid rgba(255,255,255,0.03)';
                const dt = o.createdAt && o.createdAt.seconds ? new Date(o.createdAt.seconds*1000).toLocaleString() : '';
                el.innerHTML = `<strong style="color:#fff">${o.product||''}</strong><div class="small">${o.name||''} • ${o.phone||''}</div><div class="small">${o.address||''}</div><div class="small" style="color:var(--muted)">${dt}</div>`;
                ordersList.appendChild(el);
              });
            }
            openModal(myOrdersModal);
          }catch(e){
            console.error('fetch orders failed', e);
            ordersList.innerHTML = '<div class="small">Failed to load orders</div>';
          }
        });
      }

    }catch(e){
      console.warn('Firebase not available or failed to load. Continuing in fallback mode.', e);
      // Firebase optional: app will still work for demo (form submit + local toast)
      firebaseAvailable = false;
      if(googleBtnLarge) googleBtnLarge.addEventListener('click', ()=> showLoginError('Firebase auth not loaded. Deploy on HTTPS hosting for Google sign-in.'));
      if(loginShowBtn) loginShowBtn.addEventListener('click', ()=> openModal(loginModal));
    }

    // Generic order flow (works even if Firebase missing)
    // Bind order buttons (delegation)
    document.addEventListener('click', (ev) => {
      const btn = ev.target.closest && ev.target.closest('.orderBtn');
      if(!btn) return;
      const prod = btn.getAttribute('data-product') || '';
      // If auth present and required, check sign-in. We'll be conservative: check window._firebaseHelpers.auth if present
      const isSignedIn = window._firebaseHelpers && window._firebaseHelpers.auth && window._firebaseHelpers.auth.currentUser;
      if(!isSignedIn){
        openModal(loginModal);
        showLoginError('Please sign in with Google to place orders');
        return;
      }
      const sel = $('selectedProduct'); if(sel) sel.innerText = prod;
      const pf = $('productField'); if(pf) pf.value = prod;
      openModal(orderModal);
    });

    // Close buttons
    ['closeOrderModal','cancelOrder','closeLogin','closePayment','closeMyOrdersX','closeOrders'].forEach(id=>{
      const el = $(id);
      if(el) el.addEventListener('click', ()=>{ const modal = el.closest('.modal'); if(modal) closeModal(modal); });
    });

    // Order form submit -> open payment modal (prevent real submit here; submit moved to pay)
    const placeOrderBtn = $('placeOrder');
    if(placeOrderBtn){
      placeOrderBtn.addEventListener('click', (ev) => {
        ev.preventDefault && ev.preventDefault();
        const name = $('custName') ? $('custName').value.trim() : '';
        const address = $('custAddress') ? $('custAddress').value.trim() : '';
        const phone = $('custPhone') ? $('custPhone').value.trim() : '';
        const product = $('productField') ? $('productField').value : '';
        if(!name || !address || !phone){ alert('Fill all fields'); return; }
        window.pendingOrder = { product, name, address, phone };
        if(orderModal) closeModal(orderModal);
        const ps = $('paymentSummary'); if(ps) ps.innerText = `${product}\nName: ${name}\nPhone: ${phone}`;
        openModal(paymentModal);
      });
    }

    // Pay now: submit Google Form via iframe (so page doesn't navigate) and attempt to save to Firestore if available
    const payNowBtn = $('payNow');
    if(payNowBtn){
      payNowBtn.addEventListener('click', async ()=>{
        payNowBtn.disabled = true;
        const paymentMsg = $('paymentMsg'); if(paymentMsg) paymentMsg.style.display = 'block';
        // Submit google form (orderForm exists)
        try{ const form = $('orderForm'); if(form) form.submit(); }catch(e){ console.warn('form.submit failed', e); }
        // simulate processing then save via firestore if available
        setTimeout(async ()=>{
          try{
            const uid = window._firebaseHelpers && window._firebaseHelpers.auth && window._firebaseHelpers.auth.currentUser ? window._firebaseHelpers.auth.currentUser.uid : null;
            const userEmail = window._firebaseHelpers && window._firebaseHelpers.auth && window._firebaseHelpers.auth.currentUser ? window._firebaseHelpers.auth.currentUser.email : null;
            const orderData = { ...(window.pendingOrder || {}), user: uid, userEmail, createdAt: (window._firebaseHelpers && window._firebaseHelpers.fsModule) ? window._firebaseHelpers.fsModule.serverTimestamp() : new Date().toISOString() };
            // save if db available
            if(window._firebaseHelpers && window._firebaseHelpers.db){
              try{
                const { collection, addDoc } = window._firebaseHelpers.fsModule;
                await addDoc(collection(window._firebaseHelpers.db, 'orders'), orderData);
                if(uid) await addDoc(collection(window._firebaseHelpers.db, `users/${uid}/orders`), orderData);
              }catch(err){ console.warn('firestore save failed', err); }
            }else{
              // fallback: save to localStorage (demo)
              const saved = JSON.parse(localStorage.getItem('demoOrders')||'[]');
              saved.unshift(orderData);
              localStorage.setItem('demoOrders', JSON.stringify(saved));
            }
            if(paymentMsg) paymentMsg.style.display = 'none';
            const os = $('orderStatus'); if(os){ os.innerText = 'Order placed and payment received. Thank you!'; os.style.display='block'; }
            toast('Order successful');
            setTimeout(()=>{
              closeModal(paymentModal);
              if(os) os.style.display='none';
              const form = $('orderForm'); if(form) form.reset();
              window.pendingOrder = null;
              payNowBtn.disabled = false;
            }, 1200);
          }catch(err){
            console.error('save after payment failed', err);
            showLoginError('Payment succeeded but saving order failed. Check console.');
            payNowBtn.disabled = false;
          }
        }, 900);
      });
    }

    // My Orders fallback to localStorage if no firebase
    const localOrdersBtn = $('myOrdersBtn');
    if(localOrdersBtn){
      localOrdersBtn.addEventListener('click', ()=>{
        if(window._firebaseHelpers && window._firebaseHelpers.auth && window._firebaseHelpers.auth.currentUser){
          // handled by firebase-specific handler earlier
          return;
        }
        const saved = JSON.parse(localStorage.getItem('demoOrders')||'[]');
        ordersList.innerHTML = saved.length ? saved.map(o=>`<div style="padding:10px;border-bottom:1px solid rgba(255,255,255,0.03)"><strong style="color:#fff">${o.product||''}</strong><div class="small">${o.name||''} • ${o.phone||''}</div><div class="small">${o.address||''}</div></div>`).join('') : '<div class="small">No orders yet</div>';
        openModal(myOrdersModal);
      });
    }

    // Search filter
    const searchBox = $('searchBox');
    if(searchBox){
      searchBox.addEventListener('input', e=>{
        const v = e.target.value.toLowerCase();
        document.querySelectorAll('#productGrid .card').forEach(card=>{
          const t = (card.querySelector('h3')||{innerText:''}).innerText.toLowerCase();
          card.style.display = t.includes(v) ? 'block' : 'none';
        });
      });
    }

    // Smooth scroll for Shop Now
    const shopNow = $('shopNow'); if(shopNow) shopNow.addEventListener('click', ()=>{ const grid=document.getElementById('productGrid'); if(grid) grid.scrollIntoView({behavior:'smooth'}); });

    // Close modals with Esc
    document.addEventListener('keydown', (ev)=>{ if(ev.key === 'Escape') document.querySelectorAll('.modal').forEach(m => closeModal(m)); });

    // Initially close all modals
    document.querySelectorAll('.modal').forEach(m => closeModal(m));

    console.log('Rebuilt UI ready. Firebase available:', !!firebaseAvailable);
  })();
  </script>
</body>
</html>
